<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>BOLD700 — UX Review Platform</title>
<style>
  :root {
    --bg: #0a0a0a;
    --surface: #141414;
    --surface2: #1e1e1e;
    --surface3: #282828;
    --border: #333;
    --text: #f0f0f0;
    --text-muted: #888;
    --accent: #ff5003;
    --accent-hover: #ff7233;
    --accent-glow: rgba(255,80,3,0.15);
    --brand-blue: #1728c8;
    --green: #22c55e;
    --yellow: #eab308;
    --red: #ef4444;
    --blue: #3b82f6;
    --purple: #a855f7;
    --radius: 12px;
    --radius-sm: 8px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
  }

  .hidden { display: none !important; }

  /* ─── SHARED ─── */
  .logo { font-weight: 800; letter-spacing: -0.5px; color: var(--accent); display: inline-flex; align-items: center; }
  .logo svg.brand-b { height: 1em; width: auto; display: inline-block; vertical-align: middle; }
  .logo svg.brand-b path { fill: var(--accent); }
  /* Logo draw animation */
  @keyframes logoDrawIn {
    0% { stroke-dashoffset: 1200; fill-opacity: 0; }
    70% { fill-opacity: 0; }
    100% { stroke-dashoffset: 0; fill-opacity: 1; }
  }
  .logo svg.brand-b.animate path {
    stroke: var(--accent); stroke-width: 3; fill: var(--accent); fill-opacity: 0;
    stroke-dasharray: 1200; stroke-dashoffset: 1200;
    animation: logoDrawIn 1.8s ease-out forwards;
  }
  .btn {
    padding: 10px 20px; border-radius: var(--radius); font-size: 13px; font-weight: 600;
    cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; border: none;
  }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: var(--accent-hover); }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: #555; }
  .btn-success { background: var(--green); color: #fff; }
  .btn-success:hover { background: #16a34a; }
  .btn-lg { padding: 14px 28px; font-size: 15px; }

  /* ═══ SCREEN 1: DASHBOARD ═══ */
  .dashboard {
    height: 100vh;
    overflow-y: auto;
    background: var(--bg);
  }

  .dash-topbar {
    height: 56px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 24px;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .dash-topbar .logo { font-size: 18px; }

  .dash-topbar-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  /* ─── AUTH SCREEN ─── */
  .auth-screen {
    display: flex; align-items: center; justify-content: center;
    min-height: 100vh; background: var(--bg); padding: 24px;
  }
  .auth-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 24px;
    padding: 48px; width: 440px; max-width: 100%; text-align: center;
  }
  .auth-card .logo { font-size: 32px; display: flex; justify-content: center; margin-bottom: 8px; }
  .auth-card h1 { font-size: 24px; font-weight: 800; color: #fff; margin-bottom: 6px; }
  .auth-card h1 span { color: var(--accent); }
  .auth-card .auth-sub { color: var(--text-muted); font-size: 14px; margin-bottom: 28px; line-height: 1.6; }
  .auth-card .form-group { text-align: left; }
  .auth-cta {
    width: 100%; padding: 14px; font-size: 15px; font-weight: 700;
    background: var(--accent); color: #fff; border: none; border-radius: var(--radius);
    cursor: pointer; transition: all 0.2s; margin-top: 8px;
  }
  .auth-cta:hover { background: var(--accent-hover); transform: translateY(-1px); }
  .auth-cta:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .auth-toggle { margin-top: 20px; font-size: 13px; color: var(--text-muted); }
  .auth-toggle a { color: var(--accent); cursor: pointer; text-decoration: none; font-weight: 600; }
  .auth-toggle a:hover { text-decoration: underline; }
  .auth-error {
    background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: var(--radius-sm);
    padding: 10px 14px; font-size: 13px; color: var(--red); text-align: left; margin-top: 12px;
  }
  .auth-steps {
    display: flex; gap: 12px; margin-top: 28px; padding-top: 24px; border-top: 1px solid var(--border);
  }
  .auth-step {
    flex: 1; text-align: center; font-size: 11px; color: var(--text-muted); line-height: 1.5;
  }
  .auth-step .step-num {
    width: 24px; height: 24px; border-radius: 50%; background: var(--surface3);
    color: var(--accent); font-weight: 700; font-size: 12px;
    display: inline-flex; align-items: center; justify-content: center; margin-bottom: 6px;
  }
  .auth-forgot { font-size: 12px; text-align: right; margin-top: 4px; }
  .auth-forgot a { color: var(--text-muted); cursor: pointer; text-decoration: none; }
  .auth-forgot a:hover { color: var(--accent); }

  /* ─── VISITOR LANDING PAGE (now = user dashboard after login) ─── */
  .landing-screen {
    display: flex; align-items: center; justify-content: center;
    min-height: 100vh; background: var(--bg); padding: 24px;
  }
  .landing-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 24px;
    padding: 48px; width: 560px; max-width: 100%; text-align: center;
  }
  .landing-card .logo { font-size: 28px; display: flex; justify-content: center; margin-bottom: 8px; }
  .landing-card h1, .landing-card h2 { font-weight: 800; color: #fff; margin-bottom: 6px; }
  .landing-card h1 { font-size: 26px; }
  .landing-card h1 span { color: var(--accent); }
  .landing-card .landing-sub {
    color: var(--text-muted); font-size: 14px; margin-bottom: 32px; line-height: 1.6;
  }
  .landing-card .form-group { text-align: left; }
  .landing-card .landing-cta {
    width: 100%; padding: 14px; font-size: 15px; font-weight: 700;
    background: var(--accent); color: #fff; border: none; border-radius: var(--radius);
    cursor: pointer; transition: all 0.2s; margin-top: 8px;
  }
  .landing-card .landing-cta:hover { background: var(--accent-hover); transform: translateY(-1px); }
  /* Visitor mini-dashboard (returning users) */
  .visitor-projects { text-align: left; margin-top: 16px; }
  .visitor-projects h3 { font-size: 14px; font-weight: 700; margin-bottom: 10px; color: var(--text); }
  .visitor-project-card {
    background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm);
    padding: 14px 16px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;
    display: flex; justify-content: space-between; align-items: center;
  }
  .visitor-project-card:hover { border-color: var(--accent); background: var(--surface3); }
  .visitor-project-card .vp-info { flex: 1; }
  .visitor-project-card .vp-name { font-weight: 700; font-size: 14px; }
  .visitor-project-card .vp-date { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
  .visitor-project-card .vp-score { font-weight: 800; font-size: 18px; min-width: 40px; text-align: right; }
  .visitor-project-card .vp-score.good { color: var(--green); }
  .visitor-project-card .vp-score.ok { color: var(--yellow); }
  .visitor-project-card .vp-score.bad { color: var(--red); }
  .visitor-project-card .vp-score.none { color: var(--text-muted); font-size: 13px; }
  .vp-actions { display: flex; gap: 4px; margin-left: 8px; }
  .vp-delete { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 16px; padding: 4px 8px; border-radius: 6px; }
  .vp-delete:hover { color: var(--red); background: rgba(239,68,68,0.1); }
  .landing-divider { display: flex; align-items: center; gap: 12px; margin: 20px 0; color: var(--text-muted); font-size: 12px; }
  .landing-divider::before, .landing-divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
  .free-counter { font-size: 12px; color: var(--text-muted); margin-top: 10px; }
  .free-counter strong { color: var(--accent); }
  .upgrade-card {
    background: linear-gradient(135deg, var(--surface2), var(--surface3)); border: 1px solid var(--accent);
    border-radius: var(--radius); padding: 24px; text-align: center; margin-top: 16px;
  }
  .upgrade-card h3 { font-size: 16px; font-weight: 800; color: var(--accent); margin-bottom: 8px; }
  .upgrade-card p { font-size: 13px; color: var(--text-muted); line-height: 1.5; margin-bottom: 16px; }
  .user-topbar {
    display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; width: 100%;
  }
  .user-email-badge { font-size: 12px; color: var(--text-muted); }
  .user-logout { height: 36px; padding: 0 14px; background: var(--surface2); color: var(--text-muted); border: 1px solid var(--border); border-radius: var(--radius); font-size: 13px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
  .user-logout:hover { border-color: var(--red); color: var(--red); }
  .role-badge { font-size: 11px; font-weight: 700; padding: 3px 10px; border-radius: 12px; letter-spacing: 0.03em; }
  .role-badge.role-admin { background: var(--accent); color: #fff; }
  .role-badge.role-pro { background: var(--brand-blue); color: #fff; }
  .role-badge.role-free { background: var(--surface3); color: var(--text-muted); border: 1px solid var(--border); }

  .dash-content {
    max-width: 1100px;
    margin: 0 auto;
    padding: 40px 32px;
  }

  .dash-hero {
    text-align: center;
    margin-bottom: 48px;
  }

  .dash-hero h1 {
    font-size: 36px;
    font-weight: 800;
    margin-bottom: 8px;
    color: #fff;
  }
  .dash-hero h1 span { color: var(--accent); }

  .dash-hero p { color: var(--text-muted); font-size: 16px; letter-spacing: 0.02em; }

  /* ── Dashboard Tabs ── */
  .dash-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-bottom: 24px;
    border-bottom: 2px solid var(--border);
    padding-bottom: 0;
  }
  .dash-tab {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px 16px;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-muted);
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    cursor: pointer;
    white-space: nowrap;
    transition: color 0.2s, border-color 0.2s;
  }
  .dash-tab:hover { color: var(--text); }
  .dash-tab.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }
  .dash-tab .tab-badge {
    background: var(--accent);
    color: #fff;
    font-size: 10px;
    font-weight: 700;
    padding: 1px 6px;
    border-radius: 10px;
    min-width: 18px;
    text-align: center;
  }
  .dash-tab-content { display: none; }
  .dash-tab-content.active { display: block; }

  /* ── Domain Group Cards ── */
  .domain-group { border-left: 3px solid var(--accent); }
  .domain-group:hover { border-color: var(--text); }
  .domain-group-stats {
    display: flex;
    gap: 16px;
    margin: 12px 0 8px;
    padding: 10px 0;
    border-top: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
  }
  .dg-stat { display: flex; flex-direction: column; align-items: center; }
  .review-count-badge {
    background: var(--accent);
    color: #fff;
    font-size: 13px;
    font-weight: 700;
    padding: 2px 10px;
    border-radius: 12px;
    min-width: 28px;
    text-align: center;
  }

  /* ── Domain Review Modal ── */
  .domain-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }
  .domain-modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    width: 100%;
    max-width: 900px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.4);
  }
  .domain-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
  }
  .domain-modal-body {
    overflow-y: auto;
    padding: 0;
  }
  .domain-reviews-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  .domain-reviews-table th {
    text-align: left;
    padding: 10px 16px;
    font-size: 11px;
    font-weight: 600;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border);
    background: var(--surface2);
    position: sticky;
    top: 0;
  }
  .domain-reviews-table td {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
  }
  .domain-review-row.clickable { cursor: pointer; }
  .domain-review-row.clickable:hover { background: var(--surface2); }
  .btn-icon-sm {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
  }
  .btn-icon-sm:hover { color: var(--text); background: var(--surface2); }

  .dash-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    text-align: center;
  }

  .stat-card .stat-num { font-size: 28px; font-weight: 800; margin-bottom: 4px; }
  .stat-card .stat-num.accent { color: var(--accent); }
  .stat-card .stat-num.green { color: var(--green); }
  .stat-card .stat-num.yellow { color: var(--yellow); }
  .stat-card .stat-num.red { color: var(--red); }
  .stat-card .stat-label { font-size: 12px; color: var(--text-muted); }

  .dash-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .dash-section-header h2 { font-size: 18px; font-weight: 700; }

  .projects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
  }

  .project-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }

  .project-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 32px rgba(0,0,0,0.3); }

  .project-card.new-project {
    border-style: dashed;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 200px;
    gap: 12px;
    color: var(--text-muted);
  }

  .project-card.new-project:hover { color: var(--accent); border-color: var(--accent); }

  .project-card.new-project svg { width: 40px; height: 40px; opacity: 0.5; }
  .project-card.new-project span { font-size: 14px; font-weight: 600; }

  .pc-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 12px; }
  .pc-name { font-size: 16px; font-weight: 700; }
  .pc-client { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

  .pc-badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    flex-shrink: 0;
  }

  .pc-badge.in-progress { background: rgba(59,130,246,0.15); color: var(--blue); }
  .pc-badge.completed { background: rgba(34,197,94,0.15); color: var(--green); }
  .pc-badge.not-started { background: var(--surface2); color: var(--text-muted); }

  .pc-url { font-size: 12px; color: var(--text-muted); margin-bottom: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  .pc-score-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }

  .pc-score-bar .bar-track {
    flex: 1;
    height: 6px;
    background: var(--surface2);
    border-radius: 3px;
    overflow: hidden;
  }

  .pc-score-bar .bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s; }
  .pc-score-bar .bar-fill.good { background: var(--green); }
  .pc-score-bar .bar-fill.ok { background: var(--yellow); }
  .pc-score-bar .bar-fill.bad { background: var(--red); }

  .pc-score-num { font-size: 14px; font-weight: 800; min-width: 36px; text-align: right; }
  .pc-score-num.good { color: var(--green); }
  .pc-score-num.ok { color: var(--yellow); }
  .pc-score-num.bad { color: var(--red); }
  .pc-score-num.na { color: var(--text-muted); }

  .pc-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 11px;
    color: var(--text-muted);
  }

  .pc-package {
    padding: 2px 8px;
    background: var(--surface2);
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
  }

  .pc-delete {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: none;
    background: var(--surface2);
    color: var(--text-muted);
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.2s;
  }

  .project-card:hover .pc-delete { display: flex; }
  .pc-delete:hover { background: rgba(239,68,68,0.2); color: var(--red); }

  /* ═══ SCREEN 2: NEW PROJECT (Full-screen wizard) ═══ */
  .new-project-screen {
    display: flex;
    flex-direction: column;
    height: 100vh;
    height: 100dvh; /* Safari: respect dynamic viewport */
    background: var(--bg);
    overflow: hidden;
  }

  /* ── Topbar: logo + stepper + close ── */
  .np-topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 64px;
    padding: 0 32px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    flex-shrink: 0;
  }
  .np-topbar .logo { font-size: 22px; margin: 0; }
  .np-topbar-close {
    width: 36px; height: 36px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    background: transparent; border: 1px solid var(--border);
    color: var(--text-muted); cursor: pointer; transition: all 0.15s;
  }
  .np-topbar-close:hover { background: var(--surface2); color: var(--text); border-color: var(--text-muted); }

  /* ── Body: centered content area ── */
  .np-body {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow-y: auto;
    padding: 32px 24px;
  }

  /* ── Content: max-width container ── */
  .np-content {
    max-width: 640px;
    width: 100%;
  }

  /* ── Footer: navigation buttons ── */
  .np-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 72px;
    padding: 0 32px;
    border-top: 1px solid var(--border);
    background: var(--surface);
    flex-shrink: 0;
  }
  .np-footer .btn { min-width: 140px; justify-content: center; }

  .np-subtitle { color: var(--text-muted); font-size: 14px; text-align: center; margin-bottom: 32px; display: none; }

  /* Template grid for quick scan selection */
  .template-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 8px; margin: 6px 0;
  }
  .template-card {
    padding: 10px 6px; border: 2px solid var(--border);
    border-radius: var(--radius); cursor: pointer;
    text-align: center; transition: all 0.15s;
    background: var(--surface2);
  }
  .template-card:hover { border-color: var(--accent); background: rgba(255,107,0,0.04); }
  .template-card.selected { border-color: var(--accent); background: rgba(255,107,0,0.08); }
  .template-card-icon { margin-bottom: 3px; color: var(--text-muted); }
  .template-card.selected .template-card-icon { color: var(--accent); }
  .template-card-name { font-size: 11px; font-weight: 600; line-height: 1.2; color: var(--text); }
  .template-card-meta { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
  .template-card.selected .template-card-name { color: var(--accent); }
  .btn-detect {
    background: var(--surface2); border: 1px solid var(--border); color: var(--text-muted);
    padding: 6px 12px; border-radius: var(--radius); font-size: 11px; cursor: pointer;
    display: inline-flex; align-items: center; gap: 4px; transition: all 0.15s;
  }
  .btn-detect:hover { border-color: var(--accent); color: var(--accent); }

  .form-group { text-align: left; margin-bottom: 16px; }
  .form-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--text-muted); }

  .form-input, .form-select {
    width: 100%; padding: 12px 16px; background: var(--surface2); border: 1px solid var(--border);
    border-radius: var(--radius); color: var(--text); font-size: 14px; outline: none; transition: border-color 0.2s;
  }

  .form-input:focus, .form-select:focus { border-color: var(--accent); }
  .form-input::placeholder { color: #555; }

  .form-select {
    appearance: none; cursor: pointer;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23888' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 14px center;
  }

  .mode-choice {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
  }

  .mode-option {
    padding: 20px 16px;
    background: var(--surface2);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }

  .mode-option:hover { border-color: #555; }

  .mode-option.selected {
    border-color: var(--accent);
    background: var(--accent-glow);
  }

  .mode-option .mode-icon { font-size: 24px; margin-bottom: 8px; }
  .mode-option .mode-name { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
  .mode-option .mode-desc { font-size: 11px; color: var(--text-muted); line-height: 1.4; }

  .np-actions { display: none; /* moved to np-footer */ }

  /* Wizard stepper (in topbar) */
  .np-stepper { display:flex; align-items:center; justify-content:center; gap:0; }
  .np-step { display:flex; align-items:center; gap:6px; }
  .np-step-dot { width:28px; height:28px; border-radius:50%; border:2px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; color:var(--text-muted); transition:all 0.2s; }
  .np-step.active .np-step-dot { border-color:var(--accent); background:var(--accent); color:#fff; }
  .np-step.done .np-step-dot { border-color:var(--green); background:var(--green); color:#fff; }
  .np-step.done .np-step-dot::after { content:'✓'; font-size:13px; }
  .np-step-num { display:inline; }
  .np-step.done .np-step-num { display:none; }
  .np-step-label { font-size:12px; color:var(--text-muted); }
  .np-step.active .np-step-label { color:var(--accent); font-weight:600; }
  .np-step.done .np-step-label { color:var(--green); }
  .np-step-line { width:48px; height:2px; background:var(--border); margin:0 8px; transition:background 0.2s; }
  .np-step-line.done { background:var(--green); }

  /* Hide/show form groups by wizard step */
  .np-content [data-np-step] { display:none; }
  .np-content [data-np-step].np-visible { display:block; }

  /* Step title within wizard */
  .np-step-title { font-size:18px; font-weight:700; margin-bottom:4px; }
  .np-step-desc { font-size:13px; color:var(--text-muted); margin-bottom:20px; }

  /* ═══ SCREEN 3: REVIEW INTERFACE ═══ */

  /* URL toolbar (full-width, very top) */
  .url-toolbar {
    display: flex; align-items: center; gap: 8px; padding: 6px 16px;
    padding-top: calc(6px + env(safe-area-inset-top, 0px));
    background: var(--surface); border-bottom: 1px solid var(--border);
    position: sticky; top: 0; z-index: 101;
  }
  .url-bar {
    display: flex; align-items: center; background: var(--surface2); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 0 10px; height: 32px; flex: 1; min-width: 100px; gap: 6px;
  }
  .url-bar svg { flex-shrink: 0; color: var(--text-muted); }
  .url-bar input { flex: 1; background: none; border: none; color: var(--text); font-size: 13px; outline: none; }
  .url-bar input::placeholder { color: var(--text-muted); }

  .btn-go {
    height: 32px; padding: 0 14px; background: var(--accent); color: #fff; border: none;
    border-radius: var(--radius); font-weight: 600; font-size: 12px; cursor: pointer; transition: background 0.2s;
    flex-shrink: 0;
  }
  .btn-go:hover { background: var(--accent-hover); }
  .btn-open-ext { background: var(--surface2); color: var(--text-muted); border: 1px solid var(--border); padding: 0 14px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 5px; }
  .btn-open-ext:hover { background: var(--accent); color: #fff; border-color: var(--accent); }
  .btn-open-ext.active { background: var(--accent); color: #fff; border-color: var(--accent); }

  .back-btn {
    width: 28px; height: 28px; border-radius: var(--radius-sm); border: 1px solid var(--border);
    background: var(--surface2); color: var(--text-muted); cursor: pointer; display: flex;
    align-items: center; justify-content: center; transition: all 0.2s; font-size: 14px; flex-shrink: 0;
  }
  .back-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* Navigation topbar (below URL bar) */
  .topbar {
    background: var(--surface); border-bottom: 1px solid var(--border);
    position: sticky; top: calc(44px + env(safe-area-inset-top, 0px)); z-index: 100;
  }
  .topbar-row {
    display: flex; align-items: center; justify-content: space-between; padding: 6px 16px;
  }
  .topbar-center {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    flex: 1; min-width: 0;
  }
  .topbar-title { font-size: 14px; font-weight: 700; color: var(--text); line-height: 1.2; }
  .topbar-subtitle {
    display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-muted);
  }
  .topbar-sep { opacity: 0.3; }

  .topbar-left { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
  .topbar-right { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
  .topbar-right .btn-icon { flex-shrink: 0; min-width: 28px; min-height: 28px; }
  .topbar-right .btn-nav { flex-shrink: 0; white-space: nowrap; }

  /* Scan URL input — only visible in review-mode (side-by-side) */
  .scan-url-input { display: none; height: 28px; padding: 0 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; background: var(--bg); color: var(--text); width: 220px; outline: none; transition: border-color 0.2s; }
  .scan-url-input:focus { border-color: var(--accent); }
  .main.review-mode ~ .topbar .scan-url-input,
  .review-mode .scan-url-input { display: block; }
  /* Figma source choice + frame picker */
  .source-choice { display: flex; gap: 10px; margin-bottom: 12px; }
  .source-option { flex: 1; padding: 14px; border: 2px solid var(--border); border-radius: var(--radius); cursor: pointer; transition: all 0.2s; text-align: center; }
  .source-option:hover { border-color: #555; }
  .source-option.selected { border-color: var(--accent); background: var(--accent-glow); }
  .source-option .source-icon { margin-bottom: 4px; color: var(--text-muted); }
  .source-option.selected .source-icon { color: var(--accent); }
  .source-option .source-name { font-size: 13px; font-weight: 700; }
  .source-option .source-desc { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
  .figma-frame-chip { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: all 0.15s; font-size: 12px; background: var(--surface2); }
  .figma-frame-chip:hover { border-color: #555; }
  .figma-frame-chip.selected { border-color: var(--accent); background: var(--accent-glow); }
  .figma-frame-chip input { display: none; }
  .chip-name { font-weight: 600; color: var(--text); }
  .chip-size { font-size: 10px; color: var(--text-muted); }

  .lucide, i[data-lucide] { width: 1em; height: 1em; display: inline-block; vertical-align: -0.125em; stroke-width: 2; }
  .icon-inline { display: inline-flex; align-items: center; gap: 4px; }

  /* Nav buttons (in topbar) */
  .btn-nav {
    padding: 6px 16px; border-radius: var(--radius); font-size: 13px; font-weight: 600;
    cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;
  }
  .btn-prev { background: var(--surface2); border: 1px solid var(--border); color: var(--text); }
  .btn-prev:hover { border-color: #555; }
  .btn-next { background: var(--accent); border: 1px solid var(--accent); color: #fff; }
  .btn-next:hover { background: var(--accent-hover); }

  /* Tool icon buttons (topbar) */
  .btn-icon {
    width: 28px; height: 28px; background: var(--surface2); color: var(--text);
    border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 12px;
    cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; padding: 0;
  }
  .btn-icon:hover { border-color: var(--accent); color: var(--accent); }
  .btn-icon.scanning { animation: scanPulse 1.5s ease-in-out infinite; }
  @keyframes scanPulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; box-shadow: 0 0 8px rgba(59,130,246,0.4); } }

  /* Device bar (above preview frame) */
  .preview-device-bar {
    display: flex; align-items: center; justify-content: center; gap: 2px;
    padding: 6px 0; width: 100%;
  }
  #deviceBarReview { display: none; align-items: center; gap: 6px; }

  .device-btn {
    padding: 4px 12px; background: none;
    border: 1px solid transparent; border-radius: var(--radius-sm); color: var(--text-muted);
    font-size: 11px; cursor: pointer; transition: all 0.2s;
  }
  .device-btn:hover { color: var(--text); background: var(--surface2); }
  .device-btn.active { color: var(--accent); background: rgba(255,107,0,0.1); border-color: rgba(255,107,0,0.3); }

  /* Main layout */
  .main { display: flex; height: calc(100vh - 88px); }

  /* ─ Review Modus (site in apart venster) ─ */
  .main.review-mode .preview-panel { display: none !important; }
  .main.review-mode .review-panel { width: 100% !important; max-width: 100% !important; min-width: 100% !important; border-right: none; }
  .main.review-mode .review-body { max-width: 100%; }
  .main.review-mode .questions-area { max-width: 100%; }
  .main.review-mode .step-stepper { width: 200px; }

  .review-mode-info { display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-muted); }
  .dot-live { width: 6px; height: 6px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; display: inline-block; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
  .main.review-mode .screenshot-btn.capture-primary { display: none !important; }

  /* Preview panel */
  .preview-panel {
    flex: 1; display: flex; flex-direction: column; align-items: center;
    background: #0d0d0d; overflow: auto; position: relative;
  }

  .preview-frame-wrapper {
    background: #fff; border-radius: var(--radius); overflow: hidden;
    box-shadow: 0 0 60px rgba(0,0,0,0.5); transition: width 0.4s ease, height 0.3s ease;
    position: relative; margin: 0 24px 24px;
  }

  .preview-frame-wrapper.desktop { width: calc(100% - 48px); max-width: 1440px; height: calc(100vh - 160px); }
  .preview-frame-wrapper.tablet { width: 768px; height: calc(100vh - 160px); }
  .preview-frame-wrapper.mobile { width: 375px; height: calc(100vh - 160px); border-radius: 32px; }

  .preview-frame-wrapper.mobile::before {
    content: ''; position: absolute; top: 8px; left: 50%; transform: translateX(-50%);
    width: 80px; height: 4px; background: #333; border-radius: 4px; z-index: 10;
  }

  .preview-frame-wrapper iframe { width: 100%; height: 100%; border: none; display: block; }

  .preview-empty {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    height: 100%; width: 100%; color: var(--text-muted); text-align: center; gap: 16px;
  }
  .preview-empty svg { width: 64px; height: 64px; opacity: 0.3; }
  .preview-empty p { font-size: 14px; max-width: 300px; line-height: 1.6; }

  /* Static thumbnail preview (when iframe is blocked) */
  .static-preview {
    position: relative; width: 100%; height: 100%; display: flex; flex-direction: column;
  }
  .static-preview-img {
    width: 100%; flex: 1; object-fit: cover; object-position: top; display: block;
    border-radius: var(--radius) var(--radius) 0 0;
  }
  .static-preview-loading {
    flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 12px; color: var(--text-muted);
  }
  .static-preview-spinner {
    width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent);
    border-radius: 50%; animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .static-preview-badge {
    position: absolute; bottom: 0; left: 0; right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.85));
    padding: 24px 16px 14px; display: flex; align-items: center; justify-content: space-between;
    gap: 8px; flex-wrap: wrap;
  }
  .static-preview-badge .badge-label {
    font-size: 11px; color: rgba(255,255,255,0.8); font-weight: 600;
    display: flex; align-items: center; gap: 6px;
  }
  .static-preview-badge .badge-label .dot {
    width: 6px; height: 6px; background: var(--amber); border-radius: 50%; display: inline-block;
  }
  .static-preview-actions { display: flex; gap: 6px; }
  .static-preview-actions a, .static-preview-actions button {
    padding: 7px 14px; border-radius: var(--radius-sm); font-size: 11px; font-weight: 600;
    cursor: pointer; text-decoration: none; border: none; transition: all 0.2s;
  }
  .static-preview-actions .btn-open {
    background: var(--accent); color: #fff;
  }
  .static-preview-actions .btn-open:hover { background: var(--accent-hover); }
  .static-preview-actions .btn-side {
    background: rgba(255,255,255,0.15); color: #fff; border: 1px solid rgba(255,255,255,0.25);
  }
  .static-preview-actions .btn-side:hover { background: rgba(255,255,255,0.25); }
  .static-preview-error {
    flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 12px; color: var(--text-muted); padding: 24px;
  }

  /* Floating "site niet zichtbaar?" helper */
  .iframe-help-btn {
    position: absolute; bottom: 16px; right: 16px; z-index: 20;
    background: rgba(0,0,0,0.85); color: #fff; border: 1px solid rgba(255,255,255,0.2);
    padding: 10px 16px; border-radius: var(--radius); font-size: 12px; font-weight: 600;
    cursor: pointer; display: flex; align-items: center; gap: 8px;
    backdrop-filter: blur(8px); transition: all 0.3s ease;
    animation: helpFadeIn 0.4s ease-out;
  }
  .iframe-help-btn:hover { background: var(--accent); border-color: var(--accent); transform: translateY(-2px); }
  @keyframes helpFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* Hidden thumbnail pre-loader */
  .thumb-preloader { display: none; }

  /* Review panel */
  .review-panel {
    width: 580px; min-width: 500px; max-width: 700px; background: var(--surface);
    border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden;
  }

  .review-body {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  .step-indicator { font-size: 12px; color: var(--text-muted); font-weight: 600; }

  /* Vertical Stepper */
  .step-stepper {
    width: 160px;
    flex-shrink: 0;
    background: var(--surface2);
    border-right: 1px solid var(--border);
    overflow-y: auto;
    padding: 12px 0;
    scrollbar-width: thin;
    scrollbar-color: var(--surface3) transparent;
  }
  .stepper-progress { padding: 0 14px 14px; border-bottom: 1px solid var(--border); margin-bottom: 8px; }
  .stepper-progress-label { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
  .stepper-progress-row { display: flex; align-items: center; gap: 8px; }
  .stepper-progress-bar { height: 4px; background: var(--surface3); border-radius: 2px; overflow: hidden; flex: 1; }
  .stepper-progress-fill { height: 100%; border-radius: 2px; transition: width 0.4s ease; }
  .stepper-progress-pct { font-size: 12px; font-weight: 800; white-space: nowrap; }
  .step-stepper::-webkit-scrollbar { width: 4px; }
  .step-stepper::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 2px; }

  .stepper-module-header {
    padding: 8px 14px 4px 14px;
    margin-top: 4px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .stepper-item {
    display: flex;
    gap: 10px;
    padding: 0 14px;
    cursor: pointer;
    transition: background 0.15s;
  }
  .stepper-item:hover { background: var(--surface2); }

  .stepper-track {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-shrink: 0;
    align-self: stretch;
  }

  .stepper-circle {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    border: 2px solid;
    flex-shrink: 0;
    transition: all 0.2s;
  }

  .stepper-line {
    width: 2px;
    flex: 1;
    transition: background 0.2s;
    margin: -1px 0;
  }
  .stepper-line.line-top { min-height: 10px; }
  .stepper-line.line-btm { min-height: 10px; }
  .stepper-line.line-hidden { background: transparent !important; }

  .stepper-label {
    font-size: 11px;
    font-weight: 600;
    line-height: 1.3;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: color 0.2s;
  }
  .stepper-info { display: flex; flex-direction: column; justify-content: center; min-height: 26px; padding: 3px 0; overflow: hidden; min-width: 0; }

  /* Stepper states */
  .stepper-item.pending .stepper-circle { border-color: var(--mod-color, var(--border)); color: var(--text-muted); background: transparent; opacity: 0.5; }
  .stepper-item.pending .stepper-line { background: var(--border); }
  .stepper-item.pending .stepper-label { color: var(--text-muted); }

  .stepper-item.active .stepper-circle { border-color: var(--mod-color, var(--accent)); color: #fff; background: var(--mod-color, var(--accent)); box-shadow: 0 0 12px color-mix(in srgb, var(--mod-color, var(--accent)) 40%, transparent); }
  .stepper-item.active .stepper-line { background: var(--border); }
  .stepper-item.active .stepper-label { color: var(--mod-color, var(--accent)); font-weight: 700; }

  .stepper-item.completed .stepper-circle { border-color: var(--mod-color, var(--green)); color: #fff; background: var(--mod-color, var(--green)); }
  .stepper-item.completed .stepper-line { background: var(--mod-color, var(--green)); }
  .stepper-item.completed .stepper-label { color: var(--mod-color, var(--green)); }

  .stepper-meta { font-size: 10px; font-weight: 400; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; margin-top: 1px; color: var(--text-muted); }

  /* Questions */
  .questions-area {
    flex: 1; overflow-y: auto; padding: 20px; min-width: 0;
  }
  .questions-area.focus-mode {
    display: flex; flex-direction: column;
  }
  .questions-area::-webkit-scrollbar { width: 6px; }
  .questions-area::-webkit-scrollbar-track { background: transparent; }
  .questions-area::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 3px; }

  .module-badge { display: inline-flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; padding: 4px 10px; border-radius: 6px; margin-bottom: 8px; }
  .module-badge .lucide { width: 14px; height: 14px; }
  .category-title { font-size: 18px; font-weight: 800; margin-bottom: 4px; }
  .category-desc { font-size: 13px; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5; }
  .sev-badge { display: inline-block; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; padding: 2px 6px; border-radius: 4px; margin-left: 6px; vertical-align: middle; }
  .sev-badge.sev-critical { background: rgba(239,68,68,0.15); color: var(--red); }
  .check-impact { font-size: 11px; color: var(--yellow); margin-bottom: 8px; display: flex; align-items: flex-start; gap: 6px; line-height: 1.5; padding: 6px 8px; background: rgba(234,179,8,0.08); border-radius: 6px; }
  .check-fix { font-size: 11px; color: var(--green); margin-bottom: 8px; display: flex; align-items: flex-start; gap: 6px; line-height: 1.5; padding: 6px 8px; background: rgba(34,197,94,0.08); border-radius: 6px; }

  .question-card {
    background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 20px; margin-bottom: 12px; transition: border-color 0.2s;
  }
  /* Focus mode: hide all question cards, show only active at full height */
  .focus-mode .question-card { display: none; }
  .focus-mode .question-card.q-focus-active {
    display: flex; flex-direction: column;
    flex: 1; min-height: 0;
    border: none; background: transparent; padding: 0;
  }
  .focus-mode .question-card.q-focus-active .question-label {
    font-size: 15px; margin-bottom: 16px;
  }
  .focus-mode .question-card.q-focus-active .notes-input {
    flex: 1; min-height: 120px; resize: none;
  }
  .focus-mode .question-card.q-focus-active .score-row {
    margin-bottom: 14px;
  }
  .focus-mode .question-card.q-focus-active .score-btn {
    padding: 10px 6px; font-size: 13px;
  }
  /* Compact category header in focus mode */
  .focus-mode .score-summary {
    padding: 8px 12px; margin-bottom: 12px;
  }
  .focus-mode .score-circle {
    width: 36px; height: 36px; font-size: 14px; border-width: 2px;
  }
  .focus-mode .category-title { font-size: 15px; margin-bottom: 2px; }
  .focus-mode .category-desc { font-size: 12px; margin-bottom: 12px; }
  .question-card:hover { border-color: #444; }
  .question-card.answered { border-color: rgba(34,197,94,0.3); }
  .question-card.answered-nvt { border-color: rgba(100,100,100,0.3); opacity: 0.55; }

  /* Focus navigation bar */
  .focus-nav {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 0; padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
    margin-top: auto; border-top: 1px solid var(--border);
    flex-shrink: 0;
  }
  .focus-nav-btn {
    display: flex; align-items: center; gap: 6px;
    padding: 8px 16px; border: 1px solid var(--border); border-radius: var(--radius);
    background: var(--surface); color: var(--text); font-size: 13px; font-weight: 600;
    cursor: pointer; transition: all 0.15s;
  }
  .focus-nav-btn:hover { border-color: var(--accent); color: var(--accent); }
  .focus-nav-btn:disabled { opacity: 0.3; cursor: default; border-color: var(--border); color: var(--text-muted); }
  .focus-nav-counter {
    display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-muted);
  }
  .focus-dots { display: flex; gap: 4px; }
  .focus-dot {
    width: 8px; height: 8px; border-radius: 50%; background: var(--border); transition: all 0.15s; cursor: pointer;
  }
  .focus-dot.dot-active { background: var(--accent); transform: scale(1.25); }
  .focus-dot.dot-answered { background: var(--green); }
  .focus-dot.dot-nvt { background: #666; }

  .question-label { font-size: 13px; font-weight: 600; margin-bottom: 10px; line-height: 1.5; }
  .question-label .q-num { color: var(--accent); margin-right: 6px; }
  .auto-badge { display: inline-flex; align-items: center; gap: 3px; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--blue); background: rgba(59,130,246,0.12); padding: 2px 6px; border-radius: 4px; margin-left: 6px; vertical-align: middle; }
  .auto-badge .lucide { width: 10px; height: 10px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .btn-icon [data-lucide="loader"] { animation: spin 1s linear infinite; }

  .score-row { display: flex; gap: 6px; margin-bottom: 10px; }

  .score-btn {
    flex: 1; padding: 8px 4px; border: 1px solid var(--border); border-radius: var(--radius-sm);
    background: var(--surface); color: var(--text-muted); font-size: 12px; font-weight: 600;
    cursor: pointer; transition: all 0.2s; text-align: center;
  }
  .score-btn:hover { border-color: #555; color: var(--text); }
  .score-btn.selected.score-bad { border-color: var(--red); color: var(--red); background: rgba(239,68,68,0.1); }
  .score-btn.selected.score-ok { border-color: var(--yellow); color: var(--yellow); background: rgba(234,179,8,0.1); }
  .score-btn.selected.score-good { border-color: var(--green); color: var(--green); background: rgba(34,197,94,0.1); }
  .score-btn.selected.score-nvt { border-color: #666; color: #999; background: rgba(100,100,100,0.15); }

  .notes-input {
    width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm);
    padding: 10px 12px; color: var(--text); font-size: 13px; font-family: inherit;
    resize: vertical; min-height: 60px; outline: none; transition: border-color 0.2s; margin-top: 2px;
  }
  .notes-input:focus { border-color: var(--accent); }
  .notes-input::placeholder { color: #555; }

  .screenshot-row { display: flex; align-items: center; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
  .screenshot-thumb { position: relative; display: inline-block; }
  .screenshot-btn {
    padding: 6px 12px; border-radius: var(--radius-sm); font-size: 11px; font-weight: 600;
    cursor: pointer; border: 1px dashed var(--border); background: transparent;
    color: var(--text-muted); transition: all 0.2s; display: flex; align-items: center; gap: 4px;
  }
  .screenshot-btn:hover { border-color: var(--accent); color: var(--accent); }
  .screenshot-btn.capture-primary {
    border-style: solid; background: var(--accent); color: #fff; border-color: var(--accent);
  }
  .screenshot-btn.capture-primary:hover { background: var(--accent-hover); border-color: var(--accent-hover); color: #fff; }
  .screenshot-btn.capture-primary:disabled { opacity: 0.6; cursor: wait; }
  .screenshot-hint { font-size: 10px; color: var(--text-muted); opacity: 0.6; display: flex; align-items: center; gap: 3px; }
  .screenshot-row.paste-target { border-left: 2px solid var(--accent); padding-left: 8px; }
  .screenshot-row.paste-target .screenshot-hint { color: var(--accent); opacity: 1; }
  .capture-flash {
    position: absolute; inset: 0; background: rgba(255,255,255,0.8); z-index: 100;
    display: flex; align-items: center; justify-content: center; border-radius: var(--radius);
    animation: flashFade 0.5s ease-out forwards;
  }
  @keyframes flashFade { from { opacity: 1; } to { opacity: 0; } }
  .screenshot-preview {
    width: 80px; height: 50px; border-radius: 6px; object-fit: cover;
    border: 1px solid var(--border); cursor: pointer; transition: transform 0.2s;
  }
  .screenshot-preview:hover { transform: scale(1.05); }
  .screenshot-remove {
    position: absolute; top: -6px; right: -6px;
    width: 18px; height: 18px; border-radius: 50%; border: none; background: var(--red);
    color: #fff; font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.2s;
  }
  .screenshot-thumb:hover .screenshot-remove { opacity: 1; }
  .screenshot-lightbox {
    position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
  }
  .screenshot-lightbox img { max-width: 90%; max-height: 90%; border-radius: var(--radius); }

  .severity-row { display: flex; gap: 6px; margin-top: 8px; margin-bottom: 10px; }

  .sev-btn {
    padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;
    cursor: pointer; border: 1px solid var(--border); background: var(--surface);
    color: var(--text-muted); transition: all 0.2s;
  }
  .sev-btn:hover { border-color: #555; }
  .sev-btn.selected.sev-quickwin { background: rgba(34,197,94,0.15); color: var(--green); border-color: var(--green); }
  .sev-btn.selected.sev-strategic { background: rgba(59,130,246,0.15); color: var(--blue); border-color: var(--blue); }
  .sev-btn.selected.sev-filler { background: rgba(234,179,8,0.15); color: var(--yellow); border-color: var(--yellow); }
  .sev-btn.selected.sev-notnow { background: rgba(255,255,255,0.08); color: var(--text-muted); border-color: var(--text-muted); }

  .score-summary {
    display: flex; align-items: center; gap: 12px; padding: 12px 16px;
    background: var(--surface2); border-radius: var(--radius); margin-bottom: 16px;
  }

  .score-circle {
    width: 52px; height: 52px; border-radius: 50%; display: flex; align-items: center;
    justify-content: center; font-size: 20px; font-weight: 800; border: 3px solid; flex-shrink: 0;
  }
  .score-circle.good { border-color: var(--green); color: var(--green); }
  .score-circle.ok { border-color: var(--yellow); color: var(--yellow); }
  .score-circle.bad { border-color: var(--red); color: var(--red); }
  .score-circle.neutral { border-color: var(--border); color: var(--text-muted); }

  .score-meta { flex: 1; }
  .score-meta .label { font-size: 13px; font-weight: 600; }
  .score-meta .sublabel { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

  /* Footer nav (removed - nav buttons now in topbar) */

  /* ═══ SCREEN 4: SCORECARD ═══ */
  /* ═══ DASHBOARD SCORECARD ═══ */
  .scorecard-overlay {
    position: fixed; inset: 0; background: var(--bg); z-index: 2000;
    overflow-y: auto; padding: 0;
  }
  .scorecard-container { max-width: 1240px; margin: 0 auto; padding: 0 24px 40px; }

  /* ─ Scorecard Topbar (full-width, outside container) ─ */
  #scorecardTopbar .dash-topbar {
    height: 56px; position: sticky; top: 0; z-index: 100;
    background: var(--surface); border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between; padding: 0 24px; gap: 16px;
  }
  #scorecardTopbar .dash-topbar-left { display: flex; align-items: center; gap: 12px; }
  #scorecardTopbar .dash-topbar-left .logo { font-size: 18px; }
  #scorecardTopbar .dash-topbar-title { font-size: 14px; font-weight: 400; color: var(--text-muted); padding-left: 16px; border-left: 1px solid var(--border); }
  #scorecardTopbar .dash-topbar-meta { font-size: 11px; color: var(--text-muted); padding-right: 8px; border-right: 1px solid var(--border); }
  #scorecardTopbar .dash-topbar-right { display: flex; gap: 8px; align-items: center; flex-shrink: 0; }
  #scorecardTopbar .dash-topbar-right .btn-icon {
    width: auto; height: 32px; padding: 0 12px; gap: 4px;
    font-size: 12px; font-weight: 600; white-space: nowrap;
  }

  /* ─ KPI Strip ─ */
  .kpi-strip { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 20px 0; }
  .kpi-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 20px; display: flex; flex-direction: column; gap: 4px; position: relative; overflow: hidden;
  }
  .kpi-card.kpi-accent { border-color: rgba(255,80,3,0.3); }
  .kpi-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); }
  .kpi-value { font-size: 32px; font-weight: 900; line-height: 1.1; }
  .kpi-value.sc-good { color: var(--green); }
  .kpi-value.sc-ok { color: var(--yellow); }
  .kpi-value.sc-bad { color: var(--red); }
  .kpi-sub { font-size: 11px; color: var(--text-muted); }
  .kpi-bar { width: 100%; height: 4px; background: var(--surface2); border-radius: 2px; margin-top: 8px; overflow: hidden; }
  .kpi-bar-fill { height: 100%; border-radius: 2px; transition: width 1s ease; }

  /* ─ Dashboard Grid ─ */
  .dash-grid { display: grid; grid-template-columns: 3fr 2fr; gap: 16px; margin-bottom: 16px; }
  .dash-grid-full { grid-column: 1 / -1; }

  /* ─ Dashboard Card ─ */
  .dash-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    overflow: hidden; display: flex; flex-direction: column;
  }
  .dash-card-head {
    display: flex; align-items: center; justify-content: space-between; gap: 8px;
    padding: 14px 20px; border-bottom: 1px solid var(--border); flex-shrink: 0;
  }
  .dash-card-head h3 { font-size: 13px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
  .dash-card-body { padding: 16px 20px; flex: 1; overflow-y: auto; }
  .dash-card-body.compact { padding: 0; }

  /* ─ AI Plan in dashboard ─ */
  .ai-plan-section { margin: 0; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
  .ai-plan-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 14px 20px; background: linear-gradient(135deg, rgba(59,130,246,0.08), rgba(168,85,247,0.08)); border-bottom: 1px solid var(--border); }
  .ai-plan-header h3 { font-size: 13px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
  .ai-plan-header h3 .lucide { color: var(--purple); }
  .ai-plan-generate { background: var(--purple); color: #fff; border: none; padding: 8px 16px; border-radius: var(--radius-sm); font-size: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: all 0.15s; }
  .ai-plan-generate:hover { filter: brightness(1.15); transform: translateY(-1px); }
  .ai-plan-generate:disabled { opacity: 0.5; pointer-events: none; }
  .ai-plan-body { padding: 20px; max-height: 500px; overflow-y: auto; }
  .ai-plan-empty { text-align: center; padding: 24px; color: var(--text-muted); font-size: 12px; line-height: 1.8; }
  .ai-plan-content { font-size: 13px; line-height: 1.7; color: var(--text); }
  .ai-plan-content h2 { font-size: 16px; font-weight: 800; margin: 20px 0 8px; color: var(--text); }
  .ai-plan-content h2:first-child { margin-top: 0; }
  .ai-plan-content h3 { font-size: 14px; font-weight: 700; margin: 16px 0 6px; color: var(--accent); }
  .ai-plan-content p { margin-bottom: 8px; }
  .ai-plan-content ul, .ai-plan-content ol { margin: 6px 0 12px 18px; }
  .ai-plan-content li { margin-bottom: 4px; }
  .ai-plan-content strong { color: var(--text); }
  .ai-plan-content em { color: var(--text-muted); font-style: italic; }
  .ai-plan-content blockquote { border-left: 3px solid var(--accent); padding: 6px 14px; margin: 10px 0; background: rgba(255,80,3,0.05); border-radius: 0 var(--radius-sm) var(--radius-sm) 0; font-size: 12px; }
  .ai-plan-actions { display: flex; gap: 8px; justify-content: flex-end; padding: 10px 20px; border-top: 1px solid var(--border); background: var(--surface2); }
  .ai-plan-actions button { font-size: 11px; padding: 5px 12px; border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; gap: 4px; }

  /* ─ Scan toast banner ─ */
  .scan-toast { position: fixed; top: 56px; left: 50%; transform: translateX(-50%); z-index: 9999; min-width: 320px; max-width: 480px; padding: 12px 20px; border-radius: var(--radius); display: flex; align-items: center; gap: 10px; font-size: 13px; font-weight: 600; box-shadow: 0 8px 32px rgba(0,0,0,0.4); animation: toastSlide 0.3s ease; pointer-events: auto; }
  .scan-toast.scanning { background: var(--surface2); border: 1px solid var(--blue); color: var(--blue); }
  .scan-toast.success { background: var(--surface2); border: 1px solid var(--green); color: var(--green); }
  .scan-toast.error { background: var(--surface2); border: 1px solid var(--red); color: var(--red); }
  .scan-toast .toast-icon { flex-shrink: 0; display: flex; align-items: center; }
  .scan-toast .toast-text { flex: 1; }
  .scan-toast .toast-sub { font-size: 11px; font-weight: 400; color: var(--text-muted); margin-top: 2px; }
  .scan-toast .toast-spinner { animation: spin 1s linear infinite; }
  .scan-toast .toast-progress { height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 8px; overflow: hidden; }
  .scan-toast .toast-progress-bar { height: 100%; border-radius: 2px; transition: width 0.5s ease; }
  @keyframes toastSlide { from { transform: translateX(-50%) translateY(-20px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }
  @keyframes toastFade { from { opacity: 1; } to { opacity: 0; transform: translateX(-50%) translateY(-10px); } }

  /* ─ Audit workflow ─ */
  .audit-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 10px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; }
  .audit-badge.pending { background: rgba(234,179,8,0.12); color: var(--yellow); border: 1px solid rgba(234,179,8,0.25); }
  .audit-badge.assigned { background: rgba(59,130,246,0.12); color: var(--blue); border: 1px solid rgba(59,130,246,0.25); }
  .audit-badge.in_progress { background: rgba(34,197,94,0.12); color: #22d3ee; border: 1px solid rgba(34,211,238,0.25); }
  .audit-badge.completed { background: rgba(34,197,94,0.12); color: var(--green); border: 1px solid rgba(34,197,94,0.25); }
  .role-badge.role-auditor { background: rgba(168,85,247,0.2); color: #a855f7; border: 1px solid rgba(168,85,247,0.3); }
  .project-card.professional { border-color: rgba(168,85,247,0.3); }
  .project-card.professional::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, #a855f7, transparent); border-radius: var(--radius) var(--radius) 0 0; }
  .project-card.locked { opacity: 0.85; cursor: default; }
  .project-card.locked:hover { border-color: rgba(168,85,247,0.3); transform: none; }
  .audit-status-msg { font-size: 11px; color: var(--text-muted); margin-top: 8px; padding: 8px 10px; background: var(--surface2); border-radius: var(--radius-sm); display: flex; align-items: center; gap: 6px; line-height: 1.4; }
  .audit-status-msg.status-pending { border-left: 2px solid var(--yellow); }
  .audit-status-msg.status-assigned { border-left: 2px solid var(--blue); }
  .audit-status-msg.status-in_progress { border-left: 2px solid #22d3ee; }
  .audit-status-msg.status-completed { border-left: 2px solid var(--green); }
  .pro-info-box { display: flex; gap: 10px; padding: 12px 14px; background: rgba(255,80,3,0.06); border: 1px solid rgba(255,80,3,0.15); border-radius: var(--radius-sm); font-size: 12px; color: var(--text-muted); line-height: 1.6; }
  .pro-info-box strong { color: var(--text); display: block; margin-bottom: 2px; }

  /* ─ Audit queue table ─ */
  .audit-queue-wrap { overflow-x: auto; }
  .audit-queue-table { width: 100%; border-collapse: collapse; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
  .audit-queue-table th { background: var(--surface2); padding: 10px 14px; text-align: left; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-muted); border-bottom: 1px solid var(--border); }
  .audit-queue-table td { padding: 12px 14px; border-bottom: 1px solid var(--border); font-size: 13px; }
  .audit-queue-table tr:last-child td { border-bottom: none; }
  .audit-queue-table tr:hover td { background: var(--surface2); }
  .btn-sm { padding: 4px 10px; font-size: 11px; font-weight: 600; border-radius: var(--radius-sm); cursor: pointer; border: 1px solid var(--border); background: var(--surface2); color: var(--text); display: inline-flex; align-items: center; gap: 4px; transition: all 0.15s; }
  .btn-sm:hover { border-color: var(--accent); color: var(--accent); }
  .btn-accent { background: var(--accent); color: #fff; border-color: var(--accent); }
  .btn-accent:hover { background: var(--accent-hover); color: #fff; }
  .stat-num.blue { color: var(--blue); }

  /* ─ Modal overlay ─ */
  .modal-overlay { position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; }
  .modal-box { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); width: 420px; max-width: 90vw; max-height: 80vh; overflow-y: auto; box-shadow: 0 16px 48px rgba(0,0,0,0.5); }
  .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--border); }
  .modal-header h3 { font-size: 16px; font-weight: 700; }
  .modal-close { background: none; border: none; color: var(--text-muted); font-size: 20px; cursor: pointer; padding: 4px; }
  .modal-close:hover { color: var(--text); }
  .modal-sub { padding: 10px 20px; font-size: 12px; color: var(--text-muted); border-bottom: 1px solid var(--border); }
  .modal-body { padding: 8px; }
  .auditor-option { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; cursor: pointer; border-radius: var(--radius-sm); transition: background 0.15s; }
  .auditor-option:hover { background: var(--surface2); }
  .auditor-option-info { display: flex; flex-direction: column; gap: 2px; }
  .auditor-option-info strong { font-size: 13px; }

  /* ─ User management ─ */
  .role-select { background: var(--surface2); color: var(--text); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 4px 8px; font-size: 12px; font-weight: 600; cursor: pointer; outline: none; transition: border-color 0.15s; -webkit-appearance: none; appearance: none; }
  .role-select:hover { border-color: var(--accent); }
  .role-select:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(255,80,3,0.15); }
  .role-tag { display: inline-block; padding: 3px 8px; border-radius: var(--radius-sm); font-size: 11px; font-weight: 700; }
  .role-tag.role-admin { background: rgba(255,80,3,0.12); color: var(--accent); }
  .role-tag.role-auditor { background: rgba(168,85,247,0.12); color: #a855f7; }
  .role-tag.role-user { background: var(--surface3); color: var(--text-muted); }

  /* ─ Auditor Application ─ */
  .auditor-apply-card { background: linear-gradient(135deg, rgba(168,85,247,0.06), rgba(168,85,247,0.02)); border: 1px solid rgba(168,85,247,0.18); border-radius: var(--radius); padding: 20px 24px; margin-top: 24px; }
  .auditor-apply-card h3 { font-size: 16px; font-weight: 700; margin: 0 0 8px; display: flex; align-items: center; gap: 8px; color: #a855f7; }
  .auditor-apply-card p { font-size: 13px; color: var(--text-muted); margin: 0 0 14px; line-height: 1.5; }
  .auditor-apply-card .apply-perks { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
  .auditor-apply-card .apply-perk { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-muted); background: var(--surface2); padding: 4px 10px; border-radius: var(--radius-sm); }
  .auditor-apply-card .apply-perk i { color: #a855f7; }
  .auditor-apply-form textarea { width: 100%; min-height: 80px; background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 10px 12px; font-size: 13px; color: var(--text); resize: vertical; font-family: inherit; outline: none; transition: border-color 0.15s; box-sizing: border-box; }
  .auditor-apply-form textarea:focus { border-color: #a855f7; box-shadow: 0 0 0 2px rgba(168,85,247,0.15); }
  .auditor-apply-form textarea::placeholder { color: var(--text-muted); opacity: 0.6; }
  .btn-auditor { background: linear-gradient(135deg, #a855f7, #9333ea); color: #fff; border: none; padding: 10px 20px; border-radius: var(--radius-sm); font-size: 13px; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; transition: opacity 0.15s, transform 0.1s; }
  .btn-auditor:hover { opacity: 0.9; transform: translateY(-1px); }
  .btn-auditor:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .apply-status { display: flex; align-items: center; gap: 10px; padding: 12px 16px; border-radius: var(--radius-sm); font-size: 13px; font-weight: 600; }
  .apply-status.status-pending { background: rgba(234,179,8,0.1); color: var(--yellow); border: 1px solid rgba(234,179,8,0.2); }
  .apply-status.status-rejected { background: rgba(239,68,68,0.1); color: var(--red); border: 1px solid rgba(239,68,68,0.2); }
  .application-row { display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: var(--surface2); border-radius: var(--radius-sm); margin-bottom: 6px; }
  .application-row .app-info { flex: 1; min-width: 0; }
  .application-row .app-email { font-size: 13px; font-weight: 600; }
  .application-row .app-msg { font-size: 11px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px; }
  .application-row .app-date { font-size: 11px; color: var(--text-muted); flex-shrink: 0; }
  .application-row .app-actions { display: flex; gap: 6px; flex-shrink: 0; }
  .btn-approve { background: rgba(34,197,94,0.12); color: var(--green); border: 1px solid rgba(34,197,94,0.2); padding: 4px 10px; border-radius: var(--radius-sm); font-size: 11px; font-weight: 700; cursor: pointer; transition: background 0.15s; }
  .btn-approve:hover { background: rgba(34,197,94,0.2); }
  .btn-reject { background: rgba(239,68,68,0.12); color: var(--red); border: 1px solid rgba(239,68,68,0.2); padding: 4px 10px; border-radius: var(--radius-sm); font-size: 11px; font-weight: 700; cursor: pointer; transition: background 0.15s; }
  .btn-reject:hover { background: rgba(239,68,68,0.2); }

  /* ─ Category rows ─ */
  .cat-row { display: flex; align-items: center; gap: 12px; padding: 10px 20px; border-bottom: 1px solid var(--border); transition: background 0.1s; }
  .cat-row:last-child { border-bottom: none; }
  .cat-row:hover { background: var(--surface2); }
  .cat-row-score { font-size: 14px; font-weight: 800; width: 36px; text-align: right; flex-shrink: 0; }
  .cat-row-score.sc-good, .mod-group-score.sc-good { color: var(--green); }
  .cat-row-score.sc-ok, .mod-group-score.sc-ok { color: var(--yellow); }
  .cat-row-score.sc-bad, .mod-group-score.sc-bad { color: var(--red); }
  .cat-row-score.sc-na, .mod-group-score.sc-na { color: var(--text-muted); }
  .cat-row-name { font-size: 12px; font-weight: 600; flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .cat-row-bar { width: 80px; height: 6px; background: var(--surface3); border-radius: 3px; overflow: hidden; flex-shrink: 0; }
  .cat-row-fill { height: 100%; border-radius: 3px; }
  .cat-row-status { font-size: 10px; font-weight: 600; width: 60px; text-align: right; flex-shrink: 0; }
  .cat-row-status.st-good, .mod-group-status.st-good { color: var(--green); }
  .cat-row-status.st-ok, .mod-group-status.st-ok { color: var(--yellow); }
  .cat-row-status.st-bad, .mod-group-status.st-bad { color: var(--red); }
  .cat-row-status.st-na, .mod-group-status.st-na { color: var(--text-muted); }

  /* ─ Module group in scorecard ─ */
  .mod-group { border-bottom: 1px solid var(--border); }
  .mod-group:last-child { border-bottom: none; }
  .mod-group-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; cursor: pointer; transition: background 0.15s; border-left: 3px solid var(--mg-color, var(--accent)); }
  .mod-group-header:hover { background: var(--surface2); }
  .mod-group-left { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; }
  .mod-group-name { font-size: 13px; font-weight: 700; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .mod-group-count { font-size: 10px; font-weight: 600; color: var(--text-muted); background: var(--surface3); padding: 1px 6px; border-radius: 8px; flex-shrink: 0; }
  .mod-group-right { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
  .mod-group-bar { width: 60px; height: 6px; background: var(--surface3); border-radius: 3px; overflow: hidden; }
  .mod-group-bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
  .mod-group-score { font-size: 15px; font-weight: 800; width: 36px; text-align: right; }
  .mod-group-status { font-size: 10px; font-weight: 600; width: 60px; text-align: right; }
  .mod-group-chevron { transition: transform 0.2s; flex-shrink: 0; }
  .mod-group.collapsed .mod-group-chevron { transform: rotate(-90deg); }
  .mod-group.collapsed .mod-group-body { display: none; }
  .mod-group-body { background: var(--surface); }
  .cat-row.cat-row-sub { padding-left: 44px; }
  .cat-row.cat-row-sub .cat-row-name { font-weight: 500; font-size: 11px; color: var(--text-muted); }
  .cat-row.cat-row-sub .cat-row-score { font-size: 12px; font-weight: 700; }

  /* ─ Quick Win / Strategic items ─ */
  .action-item { padding: 10px 20px; border-bottom: 1px solid var(--border); font-size: 12px; line-height: 1.5; display: flex; gap: 8px; align-items: flex-start; }
  .action-item:last-child { border-bottom: none; }
  .action-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; margin-top: 5px; }
  .action-dot.green { background: var(--green); }
  .action-dot.blue { background: var(--blue); }
  .action-dot.yellow { background: var(--yellow); }
  .action-dot.muted { background: var(--text-muted); }
  .action-text { color: var(--text-muted); }
  .action-empty { padding: 20px; text-align: center; font-size: 11px; color: #555; }

  /* ─ Priority Matrix compact ─ */
  .matrix-compact { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; border-radius: var(--radius-sm); overflow: hidden; }
  .matrix-compact .mc { padding: 12px; background: var(--surface2); }
  .matrix-compact .mc h4 { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
  .matrix-compact .mc.qw h4 { color: var(--green); }
  .matrix-compact .mc.sp h4 { color: var(--blue); }
  .matrix-compact .mc.fi h4 { color: var(--yellow); }
  .matrix-compact .mc.nn h4 { color: var(--text-muted); }
  .matrix-compact .mc .mc-count { font-size: 24px; font-weight: 900; line-height: 1; }

  /* ─ Site Insights (Premium) ─ */
  .site-insights-card { margin-bottom: 16px; }
  .premium-badge { display: inline-flex; align-items: center; gap: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; padding: 3px 8px; border-radius: 6px; background: rgba(234,179,8,0.12); color: #d4a017; border: 1px solid rgba(234,179,8,0.25); }
  .premium-badge.active { background: rgba(34,197,94,0.12); color: var(--green); border-color: rgba(34,197,94,0.25); }
  .insights-locked-overlay { position: absolute; inset: 0; z-index: 2; display: flex; align-items: center; justify-content: center; background: rgba(var(--bg-rgb, 15,15,15), 0.7); backdrop-filter: blur(4px); border-radius: var(--radius); }
  .insights-locked-content { text-align: center; padding: 24px; }
  .insights-locked-content strong { display: block; font-size: 14px; color: var(--text); margin-bottom: 6px; }
  .insights-locked-content p { font-size: 12px; color: var(--text-muted); line-height: 1.6; max-width: 280px; }
  .insights-preview-blur { filter: blur(3px); opacity: 0.5; pointer-events: none; padding: 16px 20px; }
  .insights-domain { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 600; color: var(--text-muted); padding: 0 20px 12px; border-bottom: 1px solid var(--border); margin-bottom: 12px; }
  .insights-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; padding: 0 20px; }
  .insight-stat { text-align: center; padding: 12px 8px; background: var(--surface2); border-radius: var(--radius-sm); }
  .insight-stat-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 4px; }
  .insight-stat-value { font-size: 20px; font-weight: 900; color: var(--text); line-height: 1.2; display: flex; align-items: center; justify-content: center; gap: 4px; }
  .insight-stat-sub { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
  .delta-up { color: var(--green) !important; }
  .delta-down { color: var(--red) !important; }
  .delta-flat { color: var(--text-muted) !important; }
  .insights-chart { padding: 12px 20px 0; }
  .insights-chart-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 8px; }
  .insights-chart-body { display: flex; flex-direction: column; gap: 6px; }
  .insights-chart-points { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); }
  .insights-chart-points small { font-size: 9px; }
  .insights-point { text-align: center; }
  .insights-empty-chart { display: flex; align-items: center; gap: 10px; padding: 16px 20px; font-size: 11px; color: var(--text-muted); }
  .insights-history { padding: 12px 20px 4px; border-top: 1px solid var(--border); margin-top: 12px; }
  .insights-history-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 8px; }
  .insights-history-row { display: flex; align-items: center; gap: 10px; padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 12px; }
  .insights-history-row:last-child { border-bottom: none; }
  .insights-h-score { font-weight: 800; width: 32px; text-align: right; flex-shrink: 0; }
  .insights-h-name { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text); }
  .insights-h-date { font-size: 10px; color: var(--text-muted); flex-shrink: 0; }
  .insight-loading { display: inline-flex; }
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

  /* ─ Collapsible findings ─ */
  .findings-toggle {
    width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 14px 20px; display: flex; align-items: center; justify-content: space-between;
    cursor: pointer; font-size: 13px; font-weight: 700; color: var(--text); transition: background 0.15s;
  }
  .findings-toggle:hover { background: var(--surface2); }
  .findings-toggle .ft-arrow { transition: transform 0.2s; font-size: 16px; color: var(--text-muted); }
  .findings-toggle.open .ft-arrow { transform: rotate(180deg); }
  .findings-body { background: var(--surface); border: 1px solid var(--border); border-top: none; border-radius: 0 0 var(--radius) var(--radius); padding: 0 20px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
  .findings-body.open { max-height: 5000px; padding: 16px 20px; }
  .issue-row { display: flex; align-items: flex-start; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); }
  .issue-row:last-child { border-bottom: none; }
  .issue-badge { padding: 2px 8px; border-radius: 20px; font-size: 10px; font-weight: 700; flex-shrink: 0; text-transform: uppercase; }
  .issue-badge.ib-high { background: rgba(234,179,8,0.15); color: var(--yellow); }
  .issue-badge.ib-low { background: rgba(100,100,100,0.15); color: var(--text-muted); }
  .issue-text { font-size: 12px; line-height: 1.5; }
  .issue-note { font-size: 11px; color: var(--text-muted); margin-top: 3px; }
  .issue-screenshot { width: 120px; height: 72px; border-radius: 6px; object-fit: cover; border: 1px solid var(--border); cursor: pointer; transition: transform 0.2s; flex-shrink: 0; margin-top: 6px; }
  .issue-screenshot:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
  .action-screenshot { width: 40px; height: 28px; border-radius: 4px; object-fit: cover; border: 1px solid var(--border); cursor: pointer; flex-shrink: 0; }
  .action-screenshot:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.3); }

  /* ─ Upsell (kept) ─ */
  .upsell-card { background: linear-gradient(135deg, #1a1205, #1a0f05); border: 2px solid var(--accent); border-radius: var(--radius); padding: 32px; text-align: center; margin-bottom: 16px; position: relative; overflow: hidden; }
  .upsell-card * { position: relative; z-index: 1; }
  .upsell-card .upsell-tag { display: inline-block; padding: 3px 12px; background: var(--accent); color: #fff; border-radius: 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; margin-bottom: 12px; }
  .upsell-card h2 { font-size: 20px; font-weight: 800; margin-bottom: 6px; }
  .upsell-card p { color: var(--text-muted); font-size: 13px; line-height: 1.6; margin-bottom: 16px; }
  .upsell-benefits { display: flex; justify-content: center; gap: 20px; font-size: 11px; color: var(--text-muted); }
  .upsell-benefits span::before { content: '✓ '; color: var(--green); font-weight: 700; }
  .lead-gated { filter: blur(6px); pointer-events: none; user-select: none; }
  .ai-key-setup { display: flex; gap: 8px; align-items: center; }
  .ai-key-setup input { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); padding: 8px 12px; font-size: 12px; font-family: monospace; width: 280px; }
  .ai-key-setup input::placeholder { color: var(--text-muted); }
  @keyframes aiPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  .ai-loading { animation: aiPulse 1.5s ease-in-out infinite; }

  .priority-matrix {
    display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto auto;
    gap: 2px; margin-top: 20px; border-radius: var(--radius); overflow: hidden;
  }

  .matrix-cell { padding: 16px; background: var(--surface2); }
  .matrix-cell h4 { font-size: 12px; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
  .matrix-cell.qw h4 { color: var(--green); }
  .matrix-cell.sp h4 { color: var(--blue); }
  .matrix-cell.fi h4 { color: var(--yellow); }
  .matrix-cell.nn h4 { color: var(--text-muted); }
  .matrix-cell ul { list-style: none; font-size: 12px; color: var(--text-muted); line-height: 1.8; }

  .matrix-label-row {
    display: grid; grid-template-columns: 1fr 1fr; gap: 2px; text-align: center;
    font-size: 11px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px;
  }

  /* ═══ MODALS ═══ */
  /* ─── CONTRAST CHECKER PANEL ─── */
  .cc-panel {
    position: fixed; top: 64px; right: 0; width: 340px; height: calc(100vh - 64px);
    background: var(--surface); border-left: 1px solid var(--border);
    z-index: 900; overflow-y: auto; padding: 24px;
    transform: translateX(100%); transition: transform 0.25s ease;
  }
  .cc-panel.open { transform: translateX(0); }
  .cc-panel h3 { font-size: 16px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; }
  .cc-panel h3 button { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 18px; }
  .cc-panel h3 button:hover { color: var(--text); }
  .cc-colors { display: flex; gap: 12px; margin-bottom: 16px; }
  .cc-color-group { flex: 1; }
  .cc-color-group label { font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 4px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
  .cc-color-input {
    display: flex; align-items: center; gap: 8px; background: var(--surface2); border: 1px solid var(--border);
    border-radius: var(--radius-sm); padding: 6px 10px;
  }
  .cc-color-input input[type="color"] { width: 28px; height: 28px; border: none; cursor: pointer; background: none; padding: 0; }
  .cc-color-input input[type="text"] {
    background: none; border: none; color: var(--text); font-size: 13px; font-family: monospace; width: 80px; outline: none;
  }
  .cc-swap { background: none; border: 1px solid var(--border); color: var(--text-muted); cursor: pointer; border-radius: 6px; padding: 4px 8px; font-size: 14px; align-self: flex-end; margin-bottom: 16px; }
  .cc-swap:hover { border-color: var(--accent); color: var(--accent); }
  .cc-preview {
    border-radius: var(--radius); padding: 20px; text-align: center; margin-bottom: 16px;
    border: 1px solid var(--border);
  }
  .cc-preview .preview-large { font-size: 22px; font-weight: 700; margin-bottom: 4px; }
  .cc-preview .preview-small { font-size: 14px; }
  .cc-ratio-display { text-align: center; margin-bottom: 20px; }
  .cc-ratio-num { font-size: 36px; font-weight: 900; }
  .cc-ratio-label { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
  .cc-results { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px; }
  .cc-result {
    background: var(--surface2); border-radius: var(--radius-sm); padding: 12px; text-align: center;
    border: 1px solid var(--border);
  }
  .cc-result .cc-level { font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em; }
  .cc-result .cc-status { font-size: 14px; font-weight: 800; }
  .cc-result .cc-status.pass { color: var(--green); }
  .cc-result .cc-status.fail { color: var(--red); }
  .cc-result .cc-req { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
  .cc-presets { margin-top: 16px; }
  .cc-presets h4 { font-size: 12px; font-weight: 700; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; }
  .cc-preset-btn {
    display: flex; align-items: center; gap: 8px; width: 100%; background: var(--surface2);
    border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 8px 12px;
    cursor: pointer; margin-bottom: 4px; color: var(--text); font-size: 12px;
  }
  .cc-preset-btn:hover { border-color: var(--accent); }
  .cc-preset-swatch { width: 24px; height: 16px; border-radius: 3px; border: 1px solid rgba(255,255,255,0.1); }

  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7);
    display: flex; align-items: center; justify-content: center; z-index: 3000;
  }

  .modal {
    background: var(--surface); border: 1px solid var(--border); border-radius: 20px;
    padding: 32px; width: 500px; max-height: 80vh; overflow-y: auto;
  }
  .modal h2 { font-size: 18px; margin-bottom: 16px; }
  .modal pre {
    background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 16px; font-size: 12px; color: var(--text); white-space: pre-wrap;
    word-break: break-word; max-height: 400px; overflow-y: auto;
  }
  .modal-actions { display: flex; gap: 8px; margin-top: 16px; justify-content: flex-end; }

  .upsell-success {
    text-align: center;
    padding: 20px;
    background: rgba(34,197,94,0.1);
    border: 1px solid rgba(34,197,94,0.3);
    border-radius: var(--radius);
    margin-top: 16px;
    font-size: 14px;
    color: var(--green);
  }

  @media (max-width: 1200px) {
    .review-panel { width: 460px; min-width: 400px; }
    .step-stepper { display: none !important; }
    .stepper-module-header { display: none; }
    .topbar-subtitle { font-size: 10px; gap: 4px; }
    .topbar-center { flex: 0 1 auto; min-width: 0; }
    .topbar-title { font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .topbar-row { padding: 6px 8px; gap: 4px; }
    .dash-stats { grid-template-columns: repeat(2, 1fr); }
    .dash-tabs { gap: 2px; }
    .dash-tab { padding: 8px 10px; font-size: 12px; gap: 4px; }
    .dash-tab i[data-lucide] { display: none; }
    /* Buttons: icon-only on small screens */
    .btn-label { display: none; }
    .btn-open-ext { padding: 0 10px; }
    .screenshot-btn { padding: 6px 8px; }
    .screenshot-hint { display: none; }
    .btn-nav { padding: 4px 8px; font-size: 11px; }
    .topbar-right { gap: 3px; }
    .topbar-right .btn-icon { width: 24px; height: 24px; font-size: 10px; min-width: 24px; min-height: 24px; }
    .topbar-right .btn-icon i[data-lucide] { width: 12px; height: 12px; }
    /* Review mode: stepper terug, full-width panel */
    .main.review-mode .review-panel { width: 100%; min-width: 100%; }
    .main.review-mode .step-stepper { display: block !important; width: 180px; }
    .main.review-mode .stepper-label { display: block; }
    .main.review-mode .stepper-progress { display: block; }
    .main.review-mode .stepper-module-header { display: block; }
  }

  @media (max-width: 768px) {
    /* ─── Review topbar mobile ─── */
    .url-toolbar { padding: 4px 10px; padding-top: calc(4px + env(safe-area-inset-top, 0px)); gap: 6px; }
    .url-toolbar .url-bar { font-size: 12px; padding: 4px 8px; }
    .url-toolbar .btn-open-ext { display: none; }
    .topbar { top: calc(38px + env(safe-area-inset-top, 0px)); }
    .topbar-center { display: none; }
    .topbar-row { justify-content: space-between; padding: 4px 8px; }
    .topbar-right .btn-icon { width: 28px; height: 28px; min-width: 28px; min-height: 28px; }
    .topbar-right .btn-icon i[data-lucide] { width: 14px; height: 14px; }
    .topbar-right { gap: 3px; }
    .btn-nav { padding: 4px 10px; font-size: 12px; }
    /* Verberg minder belangrijke knoppen op mobile */
    #btnAutoScan { display: none; }
    /* Review-mode: stepper verbergen op mobile */
    .main.review-mode .step-stepper { display: none !important; }

    /* ─── Dashboard mobile fixes ─── */
    .dash-topbar { padding: 0 12px; height: 48px; }
    .dash-topbar-right { gap: 6px; }
    .dash-topbar-right #dashUserEmail { display: none; }
    .dash-topbar-right .role-badge { font-size: 9px; padding: 2px 6px; }
    .dash-topbar-right .user-logout { font-size: 11px; padding: 4px 8px; }

    .dash-content { padding: 20px 14px; }
    .dash-hero { margin-bottom: 24px; }
    .dash-hero h1 { font-size: 22px; }
    .dash-hero p { font-size: 13px; }

    .dash-tabs { gap: 0; overflow-x: auto; -webkit-overflow-scrolling: touch; flex-wrap: nowrap; scrollbar-width: none; }
    .dash-tabs::-webkit-scrollbar { display: none; }
    .dash-tab { padding: 8px 10px; font-size: 11px; gap: 3px; white-space: nowrap; flex-shrink: 0; }
    .dash-tab i[data-lucide] { display: none; }

    .dash-stats { grid-template-columns: repeat(2, 1fr); gap: 6px; }

    .project-card { padding: 14px; }
    .project-card.new-project { padding: 20px; }

    /* ─── New Project wizard mobile ─── */
    .np-topbar { padding: 0 12px; height: 48px; }
    .np-topbar .logo { font-size: 16px; }
    .np-topbar-close { width: 32px; height: 32px; }
    .np-stepper .np-step-label { display: none; }
    .np-stepper .np-step-dot { width: 24px; height: 24px; font-size: 11px; }
    .np-stepper .np-step-line { width: 20px; margin: 0 3px; }
    .np-body { padding: 16px; align-items: flex-start; }
    .np-content { max-width: 100%; }
    .np-step-title { font-size: 16px; }
    .np-step-desc { font-size: 12px; margin-bottom: 14px; }
    .np-footer {
      padding: 0 16px; height: auto;
      padding-top: 12px; padding-bottom: calc(12px + env(safe-area-inset-bottom, 16px));
    }
    .np-footer .btn { min-width: 110px; font-size: 13px; padding: 10px 16px; }
    .mode-choice { grid-template-columns: 1fr; gap: 10px; }
    .mode-option { padding: 14px 12px; }
    .mode-option .mode-icon { font-size: 20px; margin-bottom: 4px; }
    .mode-option .mode-name { font-size: 13px; }
    .source-choice { grid-template-columns: 1fr 1fr; gap: 8px; }
    .source-option { padding: 10px 8px; }
    .template-grid { grid-template-columns: repeat(2, 1fr); gap: 6px; }
    .template-card { padding: 8px 4px; }
    .template-card-name { font-size: 10px; }
    .form-group { margin-bottom: 12px; }
    .form-input, .form-select { padding: 10px 12px; font-size: 14px; }

    .modal { padding: 20px; width: 100%; max-width: 95vw; border-radius: 12px; }

    /* ─── Stepper: verbergen op kleine schermen ─── */
    .step-stepper { display: none !important; }
    .main.review-mode .step-stepper { display: none !important; }
    .review-panel { width: 100% !important; min-width: 100% !important; }
    .main.review-mode .review-panel { width: 100% !important; min-width: 100% !important; }
  }

  /* ─ Scorecard Dashboard responsive ─ */
  @media (max-width: 900px) {
    .scorecard-container { padding: 0 12px 24px; }
    #scorecardTopbar .dash-topbar { padding: 0 12px; }
    #scorecardTopbar .dash-topbar-meta { display: none; }
    .kpi-strip { grid-template-columns: repeat(2, 1fr); gap: 8px; margin: 12px 0; }
    .kpi-card { padding: 14px; }
    .kpi-value { font-size: 24px; }
    .dash-grid { grid-template-columns: 1fr; gap: 12px; margin-bottom: 12px; }
    .cat-row-bar { width: 60px; }
    .cat-row-status { width: 50px; font-size: 9px; }
  }
  @media (max-width: 480px) {
    .kpi-strip { grid-template-columns: 1fr 1fr; gap: 6px; }
    .kpi-card { padding: 10px; }
    .kpi-value { font-size: 20px; }
    .kpi-label { font-size: 9px; }
    #scorecardTopbar .dash-topbar-title { font-size: 12px; }
    #scorecardTopbar .dash-topbar-right .btn-icon { font-size: 10px; padding: 0 8px; height: 30px; }
  }

  /* ═══ SCREEN 5: PREVIEW / LEAD GENERATION ═══ */
  .preview-container { max-width: 720px; margin: 0 auto; padding: 24px; min-height: 100vh; background: var(--bg); }
  .preview-header { display: flex; align-items: center; justify-content: center; padding: 16px 0 24px; }
  .preview-logo { display: flex; align-items: center; gap: 8px; }
  .preview-logo-text { font-size: 13px; color: var(--text-muted); font-weight: 500; }
  .preview-hero { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 32px; margin-bottom: 24px; }
  .preview-custom-msg { background: none; border: none; border-left: 2px solid var(--accent); padding: 0 0 0 16px; font-size: 15px; line-height: 1.7; margin-bottom: 24px; color: var(--text-muted); font-style: italic; }
  .preview-score-row { display: flex; align-items: center; gap: 24px; }
  .preview-score-circle { width: 88px; height: 88px; border-radius: 50%; border: 3px solid; display: flex; flex-direction: column; align-items: center; justify-content: center; flex-shrink: 0; background: var(--surface2); }
  .preview-score-num { font-size: 28px; font-weight: 900; line-height: 1; }
  .preview-score-label { font-size: 11px; color: var(--text-muted); }
  .preview-title { font-size: 22px; font-weight: 800; margin-bottom: 8px; line-height: 1.3; }
  .preview-meta-row { display: flex; flex-wrap: wrap; gap: 6px; font-size: 13px; color: var(--text-muted); margin-bottom: 12px; }
  .preview-summary { display: flex; gap: 8px; flex-wrap: wrap; }
  .preview-tag { font-size: 12px; font-weight: 700; padding: 4px 10px; border-radius: 6px; }
  .preview-tag.bad { background: rgba(239,68,68,0.15); color: var(--red); }
  .preview-tag.ok { background: rgba(234,179,8,0.15); color: var(--yellow); }
  .preview-tag.good { background: rgba(34,197,94,0.15); color: var(--green); }
  .preview-findings { margin-bottom: 32px; }
  .preview-findings h2 { font-size: 18px; font-weight: 800; margin-bottom: 16px; }
  .preview-finding { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 12px; border-left: 3px solid var(--border); }
  .preview-finding.bad { border-left-color: var(--red); }
  .preview-finding.ok { border-left-color: var(--yellow); }
  .preview-finding-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
  .preview-finding-badge { font-size: 11px; font-weight: 700; padding: 3px 8px; border-radius: 4px; }
  .preview-finding-badge.bad { background: rgba(239,68,68,0.15); color: var(--red); }
  .preview-finding-badge.ok { background: rgba(234,179,8,0.15); color: var(--yellow); }
  .preview-finding-sev { font-size: 10px; font-weight: 600; color: var(--red); text-transform: uppercase; letter-spacing: 0.05em; }
  .preview-finding-text { font-size: 15px; font-weight: 600; margin-bottom: 8px; line-height: 1.4; }
  .preview-finding-notes { font-size: 13px; color: var(--text-muted); margin-bottom: 8px; line-height: 1.5; font-style: italic; }
  .preview-finding-impact { font-size: 13px; line-height: 1.5; margin-bottom: 4px; color: var(--text); }
  .preview-finding-fix { font-size: 13px; line-height: 1.5; color: var(--text-muted); }
  .preview-locked-section { position: relative; margin-top: 12px; border-radius: var(--radius); overflow: hidden; }
  .preview-locked-blur { filter: blur(6px); opacity: 0.4; pointer-events: none; user-select: none; }
  .preview-finding-fake { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 12px; }
  .fake-badge { width: 80px; height: 20px; background: var(--surface3, #e5e7eb); border-radius: 4px; margin-bottom: 12px; }
  .fake-line { height: 12px; background: var(--surface3, #e5e7eb); border-radius: 4px; margin-bottom: 8px; }
  .fake-line.long { width: 90%; } .fake-line.medium { width: 70%; } .fake-line.short { width: 45%; }
  .preview-locked-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2; text-align: center; padding: 32px; }
  .preview-locked-icon { font-size: 36px; margin-bottom: 12px; }
  .preview-locked-title { font-size: 18px; font-weight: 800; margin-bottom: 8px; }
  .preview-locked-desc { font-size: 14px; color: var(--text-muted); max-width: 400px; line-height: 1.6; }
  .preview-cta-section { margin-bottom: 48px; }
  .preview-cta-section h2 { font-size: 18px; font-weight: 800; margin-bottom: 16px; }
  .preview-cta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .preview-cta-card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 28px; text-align: center; }
  .preview-cta-card.contact { border-color: var(--blue); }
  .preview-cta-card.unlock { border-color: var(--accent); }
  .preview-cta-icon { font-size: 28px; margin-bottom: 12px; }
  .preview-cta-card h3 { font-size: 16px; font-weight: 700; margin-bottom: 8px; }
  .preview-cta-card p { font-size: 13px; color: var(--text-muted); line-height: 1.5; margin-bottom: 16px; }
  .preview-cta-btn { display: inline-block; padding: 12px 24px; border-radius: var(--radius); font-size: 14px; font-weight: 700; text-decoration: none; transition: all 0.2s; }
  .preview-cta-btn.contact { background: var(--blue); color: #fff; }
  .preview-cta-btn.contact:hover { background: #2563eb; }
  .preview-cta-btn.unlock { background: var(--accent); color: #fff; }
  .preview-cta-btn.unlock:hover { background: var(--accent-hover); }
  .preview-cta-phone { font-size: 12px; color: var(--text-muted); margin-top: 8px; }
  .preview-cta-phone a { color: var(--accent); text-decoration: none; }
  .preview-footer { text-align: center; padding: 24px 0; border-top: 1px solid var(--border); }
  .preview-footer-logo { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px; }
  .preview-footer-logo span { font-size: 13px; font-weight: 600; color: var(--text-muted); }
  .preview-footer-text { font-size: 11px; color: var(--text-muted); }
  .pc-preview-btn { position: absolute; top: 8px; right: 28px; background: none; border: 1px solid var(--border); border-radius: 6px; padding: 3px 6px; cursor: pointer; color: var(--text-muted); transition: all 0.2s; }
  .pc-preview-btn:hover { border-color: var(--accent); color: var(--accent); }
  @media (max-width: 640px) {
    .preview-container { padding: 16px; }
    .preview-hero { padding: 20px; }
    .preview-score-row { flex-direction: column; text-align: center; }
    .preview-score-circle { width: 72px; height: 72px; }
    .preview-score-num { font-size: 24px; }
    .preview-title { font-size: 18px; }
    .preview-cta-grid { grid-template-columns: 1fr; }
  }

  /* ═══ FREE-FORM REVIEW ═══ */
  .ff-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 0; margin-bottom: 8px;
  }
  .ff-stats { display: flex; gap: 16px; flex-wrap: wrap; }
  .ff-stat { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text-muted); }
  .dot { width: 8px; height: 8px; border-radius: 50%; }
  .dot-bad { background: var(--score-bad); }
  .dot-ok { background: var(--score-ok); }
  .dot-good { background: var(--score-good); }
  .dot-unscored { background: var(--border); }

  .ff-card { cursor: grab; transition: box-shadow 0.2s, opacity 0.2s; }
  .ff-card.dragging { opacity: 0.5; }
  .ff-card-header {
    display: flex; align-items: center; gap: 8px; margin-bottom: 8px;
  }
  .ff-card-number {
    width: 24px; height: 24px; border-radius: 50%; background: var(--surface2);
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; color: var(--text-muted); flex-shrink: 0;
  }
  .ff-card-spacer { flex: 1; }
  .ff-notes-main { min-height: 60px; margin-bottom: 8px; }
  .ff-bottom-row { display: flex; flex-direction: column; gap: 8px; }
  .ff-delete-btn {
    background: none; border: none; color: var(--text-muted); cursor: pointer;
    padding: 4px; border-radius: 4px; opacity: 0; transition: opacity 0.2s;
  }
  .ff-card:hover .ff-delete-btn { opacity: 0.5; }
  .ff-delete-btn:hover { opacity: 1 !important; color: var(--score-bad); }

  .ff-category-row {
    display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 10px;
  }
  .ff-cat-tag {
    font-size: 11px; padding: 3px 8px; border-radius: 12px;
    border: 1px solid var(--border); background: var(--surface);
    color: var(--text-muted); cursor: pointer; display: flex; align-items: center; gap: 4px;
    transition: all 0.15s;
  }
  .ff-cat-tag:hover { border-color: var(--text-muted); }
  .ff-cat-tag.selected { font-weight: 600; }

  .ff-screenshots { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
  .ff-screenshot-large {
    width: 200px !important; height: 120px !important; object-fit: cover;
  }

  .ff-add-btn {
    width: 100%; padding: 16px; margin-top: 8px;
    border: 2px dashed var(--border); border-radius: var(--radius);
    background: transparent; color: var(--text-muted); cursor: pointer;
    font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: all 0.2s;
  }
  .ff-add-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(255,107,53,0.03); }

  .ff-paste-zone {
    padding: 24px; margin-top: 12px; text-align: center;
    border: 1px dashed var(--border); border-radius: var(--radius);
    color: var(--text-muted); font-size: 13px;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    opacity: 0.6;
  }

  .ff-footer {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 0; margin-top: 16px; border-top: 1px solid var(--border);
  }
  .ff-footer-info { font-size: 13px; color: var(--text-muted); }
  .ff-scorecard-btn {
    padding: 8px 16px; display: flex; align-items: center; gap: 6px;
    font-size: 13px; font-weight: 600; border-radius: var(--radius);
    border: 1px solid var(--border); background: var(--surface);
    color: var(--text); cursor: pointer; transition: all 0.15s;
  }
  .ff-scorecard-btn:hover { border-color: var(--accent); color: var(--accent); }
  .ff-scorecard-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* ═══ HEATMAP SETUP OVERLAY ═══ */

  /* Free-form scorecard issue cards & groups */
  .issues-section { margin-top: 8px; }
  .issue-group { margin-bottom: 16px; }
  .issue-group-title { font-size: 13px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
  .ff-issue-card {
    padding: 12px 16px; border: 1px solid var(--border); border-left: 3px solid var(--yellow);
    border-radius: var(--radius); margin-bottom: 8px; background: var(--surface);
  }
  .ff-issue-card-top { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .ff-issue-badge { font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 10px; }
  .ff-issue-impact { font-size: 11px; font-weight: 600; }
  .ff-issue-card-text { font-size: 13px; font-weight: 600; color: var(--text); line-height: 1.4; }
  .ff-issue-card-notes { font-size: 12px; color: var(--text-muted); margin-top: 4px; line-height: 1.5; }
  .ff-issue-cats { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; }
  .ff-issue-cat-tag { font-size: 10px; padding: 2px 8px; border-radius: 10px; background: var(--bg); color: var(--text-muted); border: 1px solid var(--border); }
  .ff-issue-shots { display: flex; gap: 6px; align-items: center; margin-top: 8px; }
  .ff-issue-shot { width: 64px; height: 48px; object-fit: cover; border-radius: 4px; border: 1px solid var(--border); cursor: pointer; transition: opacity 0.15s; }
  .ff-issue-shot:hover { opacity: 0.8; }
  .issue-card { padding: 10px 14px; border: 1px solid var(--border); border-left: 3px solid var(--green); border-radius: var(--radius); margin-bottom: 6px; background: var(--surface); }
  .issue-card-text { font-size: 13px; font-weight: 600; color: var(--text); }
  .issue-card-notes { font-size: 12px; color: var(--text-muted); margin-top: 3px; }

  @media (max-width: 600px) {
    .ff-screenshot-large { width: 100% !important; height: auto !important; }
    .ff-category-row { gap: 3px; }
    .ff-cat-tag { font-size: 10px; padding: 2px 6px; }
  }

  /* ═══ FREE-FORM MOBILE: telefoon als notitieblok ═══ */
  @media (max-width: 768px) {
    .ff-mobile-mode .preview-panel { display: none !important; }
    .ff-mobile-mode .review-panel {
      width: 100% !important; max-width: 100% !important;
      min-width: 100% !important; border-right: none;
    }
    .ff-mobile-mode .step-stepper { display: none !important; }
    .ff-mobile-mode .review-body { max-width: 100%; }
    .ff-mobile-mode .questions-area { max-width: 100%; padding: 12px; }
    .ff-mobile-mode .url-toolbar { display: none !important; }
    .ff-mobile-mode .ff-paste-zone { display: none; }
    .ff-mobile-mode .ff-notes-main { min-height: 80px; font-size: 15px; }
    .ff-mobile-mode .score-btn { padding: 8px 14px; font-size: 13px; }
    .ff-mobile-mode .ff-add-btn { padding: 14px; font-size: 15px; }
    .ff-mobile-mode .ff-footer { flex-direction: column; gap: 12px; text-align: center; }

    /* Focus nav mobile */
    .focus-nav { padding: 10px 0; padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px)); }
    .focus-nav-btn { padding: 8px 12px; font-size: 12px; }
    .focus-dot { width: 6px; height: 6px; }
  }
</style>
<!-- Firebase SDK (compat for single-file usage) -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>
<script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.min.js"></script>
</head>
<body>

<!-- ═══ SCREEN 0A: AUTH (Login / Register) ═══ -->
<div id="authScreen" class="auth-screen">
  <div class="auth-card">
    <div class="logo" id="authLogo"></div>
    <h1><span>Gratis</span> UX Review</h1>
    <p class="auth-sub">Ontdek in 15 minuten waarom je website niet converteert.<br>Ontvang direct je score en verbeterpunten.</p>

    <div id="authFormLogin">
      <div class="form-group">
        <label>E-mailadres</label>
        <input type="email" id="authEmail" class="form-input" placeholder="naam@bedrijf.nl" onkeydown="if(event.key==='Enter')document.getElementById('authPassword').focus()">
      </div>
      <div class="form-group">
        <label>Wachtwoord</label>
        <input type="password" id="authPassword" class="form-input" placeholder="••••••••" onkeydown="if(event.key==='Enter')handleAuth()">
        <div class="auth-forgot" id="authForgotLink"><a onclick="resetPassword()">Wachtwoord vergeten?</a></div>
      </div>
      <button class="auth-cta" id="authBtn" onclick="handleAuth()">Inloggen →</button>
      <div id="authError" class="auth-error hidden"></div>
      <div class="auth-toggle" id="authToggle">Nog geen account? <a onclick="toggleAuthMode()">Registreer gratis</a></div>
    </div>

    <div class="auth-steps">
      <div class="auth-step"><div class="step-num">1</div><br>Maak een account</div>
      <div class="auth-step"><div class="step-num">2</div><br>Beantwoord 85 vragen</div>
      <div class="auth-step"><div class="step-num">3</div><br>Ontvang je scorecard</div>
    </div>
  </div>
</div>

<!-- ═══ SCREEN 1: DASHBOARD ═══ -->
<div id="dashboardScreen" class="dashboard">
  <div class="dash-topbar">
    <div class="topbar-left" style="display:flex;align-items:center;gap:16px">
      <div class="logo" id="dashLogo"></div>
    </div>
    <div class="dash-topbar-right">
      <span class="role-badge" id="dashRoleBadge"></span>
      <span style="font-size:12px;color:var(--text-muted)" id="dashUserEmail"></span>
      <button class="user-logout" onclick="logoutUser()">Uitloggen</button>
    </div>
  </div>
  <div class="dash-content">
    <div class="dash-hero">
      <h1><span>UX</span> Review Platform</h1>
      <p>Ontdek waarom je website niet converteert. Doorloop een professionele UX audit.</p>
    </div>

    <div class="dash-stats" id="dashStats"></div>

    <!-- Admin/Auditor Tab Navigation -->
    <div class="dash-tabs" id="dashTabs" style="display:none">
      <button class="dash-tab active" data-tab="projects" onclick="switchDashTab('projects')">
        <i data-lucide="folder" style="width:14px;height:14px"></i> Projecten
      </button>
      <button class="dash-tab" data-tab="auditQueue" onclick="switchDashTab('auditQueue')" id="tabAuditQueue" style="display:none">
        <i data-lucide="clipboard-list" style="width:14px;height:14px"></i> Audit Queue
      </button>
      <button class="dash-tab" data-tab="auditorApps" onclick="switchDashTab('auditorApps')" id="tabAuditorApps" style="display:none">
        <i data-lucide="user-plus" style="width:14px;height:14px"></i> Aanvragen
      </button>
      <button class="dash-tab" data-tab="users" onclick="switchDashTab('users')" id="tabUsers" style="display:none">
        <i data-lucide="users" style="width:14px;height:14px"></i> Gebruikers
      </button>
      <button class="dash-tab" data-tab="settings" onclick="switchDashTab('settings')" id="tabSettings" style="display:none">
        <i data-lucide="settings" style="width:14px;height:14px"></i> Instellingen
      </button>
    </div>

    <!-- Tab: Projects (default) -->
    <div class="dash-tab-content active" id="tabContentProjects" data-tab="projects">
      <div class="dash-section-header">
        <h2>Projecten</h2>
      </div>
      <div class="projects-grid" id="projectsGrid"></div>
      <div id="projectsLoadMore" style="display:none;text-align:center;padding:16px">
        <button class="btn btn-outline" onclick="loadMoreProjects()" id="loadMoreBtn">Meer laden…</button>
      </div>
    </div>

    <!-- Tab: Audit Queue (admin only) -->
    <div class="dash-tab-content" id="tabContentAuditQueue" data-tab="auditQueue" style="display:none">
      <div id="auditQueueSection"></div>
    </div>

    <!-- Tab: Auditor Applications (admin only) -->
    <div class="dash-tab-content" id="tabContentAuditorApps" data-tab="auditorApps" style="display:none">
      <div id="auditorApplicationsSection"></div>
    </div>

    <!-- Tab: Users (admin only) -->
    <div class="dash-tab-content" id="tabContentUsers" data-tab="users" style="display:none">
      <div id="userManagementSection"></div>
    </div>

    <!-- Tab: Settings (admin only) -->
    <div class="dash-tab-content" id="tabContentSettings" data-tab="settings" style="display:none">
      <div id="adminConfigSection"></div>
    </div>

    <!-- Non-admin sections (no tabs) -->
    <div id="auditorApplySection" style="display:none"></div>
  </div>
</div>

<!-- ═══ SCREEN 2: NEW PROJECT ═══ -->
<div id="newProjectScreen" class="new-project-screen hidden">
  <!-- ── Topbar ── -->
  <div class="np-topbar">
    <span class="logo" id="npLogo"></span>
    <div class="np-stepper" id="npStepper">
      <div class="np-step active" data-step="1"><span class="np-step-dot"><span class="np-step-num">1</span></span><span class="np-step-label">Modus</span></div>
      <div class="np-step-line"></div>
      <div class="np-step" data-step="2"><span class="np-step-dot"><span class="np-step-num">2</span></span><span class="np-step-label">Type</span></div>
      <div class="np-step-line"></div>
      <div class="np-step" data-step="3"><span class="np-step-dot"><span class="np-step-num">3</span></span><span class="np-step-label">Details</span></div>
    </div>
    <button class="np-topbar-close" onclick="showDashboard()" title="Sluiten"><i data-lucide="x" style="width:18px;height:18px"></i></button>
  </div>

  <!-- ── Body ── -->
  <div class="np-body">
    <div class="np-content">

      <!-- ═══ STEP 1: Modus ═══ -->
      <div data-np-step="1" class="np-visible">
        <div class="np-step-title">Hoe wil je reviewen?</div>
        <div class="np-step-desc">Kies of je zelf aan de slag gaat of een expert inschakelt.</div>
        <div id="npModeFields">
          <div class="mode-choice">
            <div class="mode-option selected" onclick="selectMode('self-service', this)">
              <div class="mode-icon"><i data-lucide="scan-search"></i></div>
              <div class="mode-name">Self-Service</div>
              <div class="mode-desc">Ik doe het zelf.</div>
            </div>
            <div class="mode-option" onclick="selectMode('professional', this)">
              <div class="mode-icon"><i data-lucide="briefcase"></i></div>
              <div class="mode-name">Professional</div>
              <div class="mode-desc">Laat een expert dit doen.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ═══ STEP 2: Bron + Type ═══ -->
      <div data-np-step="2">
        <div class="np-step-title">Wat wil je reviewen?</div>
        <div class="np-step-desc">Kies de bron en het type scan.</div>
        <div class="form-group" style="margin-bottom:16px">
          <label>Bron</label>
          <div class="source-choice" id="sourceChoice">
            <div class="source-option selected" onclick="selectSource('url', this)">
              <div class="source-icon"><i data-lucide="globe" style="width:20px;height:20px"></i></div>
              <div class="source-name">Website URL</div>
              <div class="source-desc">Live website reviewen</div>
            </div>
            <div class="source-option" onclick="selectSource('figma', this)">
              <div class="source-icon"><i data-lucide="figma" style="width:20px;height:20px"></i></div>
              <div class="source-name">Figma Design</div>
              <div class="source-desc">Design file reviewen</div>
            </div>
          </div>
        </div>
        <div class="template-grid" id="templateGrid"></div>
        <div id="autoDetectRow" style="display:none;margin-top:6px">
          <button class="btn-detect" id="btnDetectType" onclick="detectPageType()">
            <i data-lucide="search" style="width:12px;height:12px"></i> Auto-detecteer pagina-type
          </button>
          <span id="detectResult" style="font-size:11px;color:var(--text-muted);margin-left:8px"></span>
        </div>
      </div>

      <!-- ═══ STEP 3: Details ═══ -->
      <div data-np-step="3">
        <div class="np-step-title">Project details</div>
        <div class="np-step-desc">Vul de details in om te starten.</div>

        <!-- Project selector: nieuw domein of toevoegen aan bestaand domein -->
        <div class="form-group" id="npProjectSelectGroup">
          <label>Toevoegen aan</label>
          <select id="npProjectSelect" class="form-select" onchange="onNpProjectSelectChange()">
            <option value="__new">+ Nieuw domein</option>
          </select>
        </div>

        <div class="form-group" id="npUrlGroup">
          <label>Website URL *</label>
          <input type="url" id="npUrl" class="form-input" placeholder="https://jouwwebsite.nl" oninput="onNpUrlChange()">
        </div>
        <div class="form-group hidden" id="npFigmaGroup">
          <label>Figma URL *</label>
          <input type="url" id="npFigmaUrl" class="form-input" placeholder="https://www.figma.com/design/ABC123/..." oninput="onFigmaUrlChange()">
          <div id="figmaFramePicker" class="hidden" style="margin-top:12px"></div>
        </div>
        <div class="form-group">
          <label>Projectnaam <span style="font-weight:400;color:var(--text-muted)">(automatisch)</span></label>
          <input type="text" id="npName" class="form-input" placeholder="Wordt ingevuld op basis van URL" oninput="onNpNameInput()">
        </div>
        <!-- Professional-only fields (shown conditionally) -->
        <div class="form-group hidden" id="npClientGroup">
          <label>Bedrijfsnaam klant *</label>
          <input type="text" id="npClient" class="form-input" placeholder="bijv. Bakkerij de Goudkorst">
        </div>
        <div class="form-group hidden" id="npPackageGroup">
          <label>Pakket</label>
          <select id="npPackage" class="form-select">
            <option value="quick">Quick Scan — €497</option>
            <option value="deep">Deep Review — €997</option>
            <option value="full">Full Audit + Redesign — €2.497</option>
          </select>
        </div>
        <div class="form-group hidden" id="npProInfo">
          <div class="pro-info-box">
            <i data-lucide="info" style="width:14px;height:14px;flex-shrink:0;margin-top:1px"></i>
            <div>
              <strong>Hoe werkt het?</strong><br>
              Na het indienen wordt je aanvraag beoordeeld en toegewezen aan een erkende UX auditor. Je ontvangt een volledig rapport met concrete verbeterpunten.
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ── Footer ── -->
  <div class="np-footer">
    <button class="btn btn-secondary" id="npBtnBack" onclick="npPrev()">Annuleer</button>
    <button class="btn btn-primary btn-lg" id="npBtnNext" onclick="npNext()">Volgende →</button>
  </div>
</div>

<!-- ═══ SCREEN 3: REVIEW INTERFACE ═══ -->
<div id="reviewScreen" class="hidden">
  <!-- URL bar (full-width, top) -->
  <div class="url-toolbar" id="urlToolbar">
    <button class="back-btn" onclick="backToDashboard()" title="Dashboard"><svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1.5" y="1.5" width="5" height="5.5" rx="1"/><rect x="9.5" y="1.5" width="5" height="3.5" rx="1"/><rect x="1.5" y="9.5" width="5" height="3.5" rx="1"/><rect x="9.5" y="7.5" width="5" height="5.5" rx="1"/></svg></button>
    <div class="url-bar">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
      <input type="url" id="urlInput" placeholder="Voer URL in..." onkeydown="if(event.key==='Enter')loadUrl()">
    </div>
    <button class="btn-go" onclick="loadUrl()">Laden</button>
    <button class="btn-go btn-open-ext" id="btnOpenExt" onclick="toggleSiteWindow()" title="Open site in nieuw tabblad"><i data-lucide="external-link" style="width:13px;height:13px"></i><span class="btn-label"> Open in tabblad</span></button>
  </div>

  <!-- Navigation topbar -->
  <div class="topbar">
    <div class="topbar-row">
      <div class="topbar-left">
      </div>
      <div class="topbar-center">
        <div class="topbar-title">UX Review <span id="topbarProjectName" style="opacity:0.5;font-weight:400"> </span></div>
        <div class="topbar-subtitle">
          <span class="step-indicator" id="stepIndicator">Stap 1 / 19</span>
          <div id="deviceBarReview">
            <span class="topbar-sep">·</span>
            <span class="dot-live"></span>
            <span>Site in ander tabblad</span>
            <span class="topbar-sep">·</span>
            <a href="#" onclick="event.preventDefault();toggleSiteWindow()" style="color:var(--accent);text-decoration:none;font-weight:600">Terug naar preview</a>
          </div>
        </div>
      </div>
      <div class="topbar-right">
        <input type="url" id="scanUrlInput" class="scan-url-input" placeholder="Pagina URL voor scan…" title="URL van de pagina die je wilt scannen">
        <button class="btn-icon" onclick="toggleContrastChecker()" style="border-color:var(--purple);color:var(--purple)" title="Contrast"><i data-lucide="contrast"></i></button>
        <button class="btn-icon" onclick="runAutoScan()" id="btnAutoScan" style="border-color:var(--blue);color:var(--blue)" title="Auto-Scan"><i data-lucide="zap"></i></button>
        <button class="btn-icon" onclick="showScorecard()" style="border-color:var(--green);color:var(--green)" title="Scorecard"><i data-lucide="check-circle"></i></button>
        <button class="btn-icon" onclick="exportResults()" title="Exporteer"><i data-lucide="download"></i></button>
      </div>
    </div>
  </div>

  <!-- Main content -->
  <div class="main">
    <div class="review-panel">
      <div class="review-body">
        <div class="step-stepper" id="stepStepper"></div>
        <div class="questions-area" id="questionsArea"></div>
      </div>
    </div>

    <div class="preview-panel">
      <div id="deviceBarNormal" class="preview-device-bar">
        <button class="device-btn active" onclick="switchDevice('desktop', this)">Desktop</button>
        <button class="device-btn" onclick="switchDevice('tablet', this)">Tablet</button>
        <button class="device-btn" onclick="switchDevice('mobile', this)">Mobile</button>
      </div>
      <div id="previewWrapper" class="preview-frame-wrapper desktop">
        <div id="previewEmpty" class="preview-empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          <p>Voer een URL in om de website te bekijken</p>
        </div>
        <iframe id="previewFrame" class="hidden" sandbox="allow-scripts allow-same-origin allow-forms" loading="lazy"></iframe>
      </div>
    </div>
  </div>
</div>

<!-- ═══ SCORECARD SCREEN ═══ -->
<div id="scorecardScreen" class="scorecard-overlay hidden">
  <div id="scorecardTopbar"></div>
  <div class="scorecard-container" id="scorecardContent"></div>
</div>

<!-- ═══ SCREEN 5: PREVIEW / LEAD GENERATION ═══ -->
<div id="previewScreen" class="hidden" style="overflow-y:auto;height:100vh;background:var(--bg)"></div>

<!-- ═══ CONTRAST CHECKER PANEL ═══ -->
<div id="contrastPanel" class="cc-panel">
  <h3>Contrast Checker <button onclick="toggleContrastChecker()">×</button></h3>

  <div class="cc-colors">
    <div class="cc-color-group">
      <label>Voorgrond (tekst)</label>
      <div class="cc-color-input">
        <input type="color" id="ccFg" value="#333333" oninput="syncColorText('ccFg','ccFgHex');updateContrast()">
        <input type="text" id="ccFgHex" value="#333333" oninput="syncColorPicker('ccFgHex','ccFg');updateContrast()" maxlength="7">
      </div>
    </div>
    <div class="cc-color-group">
      <label>Achtergrond</label>
      <div class="cc-color-input">
        <input type="color" id="ccBg" value="#FFFFFF" oninput="syncColorText('ccBg','ccBgHex');updateContrast()">
        <input type="text" id="ccBgHex" value="#FFFFFF" oninput="syncColorPicker('ccBgHex','ccBg');updateContrast()" maxlength="7">
      </div>
    </div>
  </div>

  <div style="text-align:center;margin-bottom:12px">
    <button class="cc-swap" onclick="swapColors()">⇅ Wissel kleuren</button>
  </div>

  <div class="cc-preview" id="ccPreview" style="background:#FFFFFF;color:#333333">
    <div class="preview-large">Aa Tekst Voorbeeld</div>
    <div class="preview-small">Dit is een voorbeeld van de leesbaarheid van deze kleurencombinatie op jouw website.</div>
  </div>

  <div class="cc-ratio-display">
    <div class="cc-ratio-num" id="ccRatio">—</div>
    <div class="cc-ratio-label">Contrast ratio</div>
  </div>

  <div class="cc-results" id="ccResults">
    <div class="cc-result">
      <div class="cc-level">AA Normaal</div>
      <div class="cc-status" id="ccAAnorm">—</div>
      <div class="cc-req">≥ 4.5:1</div>
    </div>
    <div class="cc-result">
      <div class="cc-level">AA Groot</div>
      <div class="cc-status" id="ccAAlarge">—</div>
      <div class="cc-req">≥ 3:1</div>
    </div>
    <div class="cc-result">
      <div class="cc-level">AAA Normaal</div>
      <div class="cc-status" id="ccAAAnorm">—</div>
      <div class="cc-req">≥ 7:1</div>
    </div>
    <div class="cc-result">
      <div class="cc-level">AAA Groot</div>
      <div class="cc-status" id="ccAAAlarge">—</div>
      <div class="cc-req">≥ 4.5:1</div>
    </div>
  </div>

  <div class="cc-presets">
    <h4>Veel voorkomend</h4>
    <button class="cc-preset-btn" onclick="setContrastColors('#000000','#FFFFFF')">
      <div class="cc-preset-swatch" style="background:#000;border:1px solid #333"></div> Zwart op wit (21:1)
    </button>
    <button class="cc-preset-btn" onclick="setContrastColors('#FFFFFF','#ff5003')">
      <div class="cc-preset-swatch" style="background:#ff5003"></div> Wit op BOLD700 oranje
    </button>
    <button class="cc-preset-btn" onclick="setContrastColors('#FFFFFF','#1728c8')">
      <div class="cc-preset-swatch" style="background:#1728c8"></div> Wit op BOLD700 blauw
    </button>
    <button class="cc-preset-btn" onclick="setContrastColors('#767676','#FFFFFF')">
      <div class="cc-preset-swatch" style="background:#767676"></div> Grijs op wit (AA grens)
    </button>
  </div>
</div>

<!-- ═══ EXPORT MODAL ═══ -->
<div id="exportModal" class="modal-overlay hidden" onclick="if(event.target===this)closeExport()">
  <div class="modal">
    <h2>Exporteer Review Resultaten</h2>
    <pre id="exportContent"></pre>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeExport()">Sluiten</button>
      <button class="btn btn-primary" onclick="copyExport()">Kopieer naar Klembord</button>
    </div>
  </div>
</div>

<script src="modules/module-data.js"></script>
<script>
// ═══════════════ XSS ESCAPE HELPER ═══════════════
function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}

// ═══════════════ SEVERITY WEIGHTS (weighted scoring) ═══════════════
const SEVERITY_WEIGHTS = { critical: 3, high: 2, medium: 1, low: 1 };

function calcWeightedScore(questions, answers) {
  let weightedSum = 0, totalWeight = 0, skipped = 0, answered = 0;
  questions.forEach(q => {
    const a = answers[q.id];
    const weight = SEVERITY_WEIGHTS[q.severity || q.priority || 'medium'] || 1;
    if (!a?.score || a.score === 'nvt') {
      // Onbeantwoord/nvt: telt WEL mee in totaal (als 0 punten), behalve nvt
      if (a?.score === 'nvt') { skipped++; }
      else { totalWeight += weight * 10; /* 0 punten, telt mee */ }
      return;
    }
    answered++;
    const value = a.score === 'good' ? 10 : a.score === 'ok' ? 5 : 0;
    weightedSum += value * weight;
    totalWeight += weight * 10;
  });
  if (totalWeight === 0) return { score: 0, answered, total: questions.length, skipped };
  return { score: (weightedSum / totalWeight) * 10, answered, total: questions.length, skipped };
}

// ═══════════════ ERROR BOUNDARY HELPER ═══════════════
function safeRender(fn, containerId) {
  try { fn(); } catch(e) {
    console.error('[RenderError]', e);
    const el = containerId ? document.getElementById(containerId) : null;
    if (el) el.innerHTML = `<div style="padding:24px;text-align:center;color:var(--red)"><p style="font-size:14px;font-weight:600">Er ging iets mis bij het laden.</p><p style="font-size:12px;color:var(--text-muted);margin-top:8px">${esc(e.message)}</p><button class="btn btn-secondary" onclick="location.reload()" style="margin-top:12px">Herlaad pagina</button></div>`;
  }
}

// ═══════════════ AI RATE LIMITING ═══════════════
const AI_RATE_LIMIT = { maxPerHour: 5, requests: [] };
function canCallAI() {
  const hourAgo = Date.now() - 3600000;
  AI_RATE_LIMIT.requests = AI_RATE_LIMIT.requests.filter(t => t > hourAgo);
  return AI_RATE_LIMIT.requests.length < AI_RATE_LIMIT.maxPerHour;
}
function trackAICall() { AI_RATE_LIMIT.requests.push(Date.now()); }

// ═══════════════ BRAND LOGO SVG ═══════════════
function brandLogo(size, animate) {
  return `<svg class="brand-b${animate ? ' animate' : ''}" viewBox="0 0 238 245" style="height:${size || '1em'}" xmlns="http://www.w3.org/2000/svg">
    <path d="M194.252 118.59C207.964 113.052 218.412 104.907 226.247 94.1556C234.082 83.4043 238 70.6981 238 55.7114C238 37.7926 230.818 23.7832 216.453 14.3351C202.741 5.21277 183.805 0.325798 158.993 0H0V61.25H46.3594V46.2633H88.8011L0 245H116.878C150.178 245 176.949 238.484 197.191 225.452C217.432 212.42 227.226 193.198 227.226 167.786C227.226 155.731 224.288 145.957 218.738 137.487C213.188 129.016 205.026 122.826 194.252 118.59ZM157.687 193.198C148.872 199.388 136.466 202.32 120.469 202.32H69.5391L96.6365 141.722H134.181C158.667 141.722 171.073 150.193 171.073 166.809C171.073 178.537 166.502 187.008 157.687 193.198ZM166.176 92.2008C158.014 97.7394 146.261 100.672 131.243 100.672H114.919L139.078 46.5891H142.669C166.829 46.5891 178.908 53.7566 178.908 68.0918C178.582 78.5173 174.337 86.6622 166.176 92.2008Z"/>
  </svg>`;
}

// ═══════════════════════════════════════════════════════════
// DATA: Module-based review steps (loaded from modules/module-data.js)
// Falls back to legacy steps if module data not loaded
// ═══════════════════════════════════════════════════════════
let reviewSteps = [];
const LEGACY_STEPS_BACKUP = [
  {
    id: 'heuristic1', title: '1. Zichtbaarheid Systeemstatus', shortTitle: 'Systeemstatus', impact: 'high',
    desc: 'Nielsen Heuristic #1 — Het systeem moet gebruikers altijd op de hoogte houden van wat er gebeurt.',
    questions: [
      { id: 'h1q1', text: 'Ziet de gebruiker waar hij/zij zich bevindt in de navigatie? (breadcrumbs, actieve menu-items)' },
      { id: 'h1q2', text: 'Is er een laad-indicator wanneer content wordt geladen?' },
      { id: 'h1q3', text: 'Krijgt de gebruiker bevestiging na een actie? (formulier verstuurd, item in wagen)' },
      { id: 'h1q4', text: 'Is er een progressie-indicator bij multi-step processen?' },
      { id: 'h1q5', text: 'Wordt de huidige pagina/sectie visueel onderscheiden in het menu?' },
      { id: 'h1q6', text: 'Bij e-commerce: is de winkelwagen-status altijd zichtbaar?' },
      { id: 'h1q7', text: 'Bij formulieren: is er real-time validatie?' }
    ]
  },
  {
    id: 'heuristic2', title: '2. Aansluiting Echte Wereld', shortTitle: 'Echte Wereld', impact: 'low',
    desc: 'Nielsen Heuristic #2 — Het systeem moet de taal van de gebruiker spreken.',
    questions: [
      { id: 'h2q1', text: 'Is de taal begrijpelijk voor de doelgroep? (geen jargon tenzij verwacht)' },
      { id: 'h2q2', text: 'Worden iconen gebruikt die universeel begrepen worden?' },
      { id: 'h2q3', text: 'Volgt de informatieopbouw een logische, natuurlijke volgorde?' },
      { id: 'h2q4', text: 'Zijn labels en knoppen beschrijvend? ("Verstuur aanvraag" i.p.v. "Submit")' },
      { id: 'h2q5', text: 'Gebruikt de site metaforen die aansluiten bij de echte wereld?' },
      { id: 'h2q6', text: 'Is de tone of voice consistent met het merk en de doelgroep?' }
    ]
  },
  {
    id: 'heuristic3', title: '3. Gebruikerscontrole & Vrijheid', shortTitle: 'Controle', impact: 'high',
    desc: 'Nielsen Heuristic #3 — Gebruikers hebben een duidelijke "nooduitgang" nodig.',
    questions: [
      { id: 'h3q1', text: 'Kan de gebruiker een stap terug in het proces?' },
      { id: 'h3q2', text: 'Is er een duidelijke "terug"-knop of annuleeroptie?' },
      { id: 'h3q3', text: 'Kan een formulier verlaten worden zonder data te verliezen?' },
      { id: 'h3q4', text: 'Is er undo/redo functionaliteit waar relevant?' },
      { id: 'h3q5', text: 'Kan de gebruiker eenvoudig een item uit de winkelwagen verwijderen?' },
      { id: 'h3q6', text: 'Zijn pop-ups en modals makkelijk te sluiten?' }
    ]
  },
  {
    id: 'heuristic4', title: '4. Consistentie & Standaarden', shortTitle: 'Consistentie', impact: 'low',
    desc: 'Nielsen Heuristic #4 — Volg platform- en industrieconventies.',
    questions: [
      { id: 'h4q1', text: 'Zijn knoppen consistent in stijl, kleur en positie?' },
      { id: 'h4q2', text: 'Wordt dezelfde terminologie overal op de site gebruikt?' },
      { id: 'h4q3', text: 'Volgt het ontwerp gangbare webconventies? (logo links = home, etc.)' },
      { id: 'h4q4', text: 'Is de typografie consistent? (fonts, groottes, hiërarchie)' },
      { id: 'h4q5', text: 'Gedragen interactieve elementen zich voorspelbaar? (hover states, klik-feedback)' },
      { id: 'h4q6', text: 'Is de layout consistent tussen pagina\'s?' }
    ]
  },
  {
    id: 'heuristic5', title: '5. Foutpreventie', shortTitle: 'Foutpreventie', impact: 'high',
    desc: 'Nielsen Heuristic #5 — Voorkom problemen door zorgvuldig ontwerp.',
    questions: [
      { id: 'h5q1', text: 'Worden formuliervelden gevalideerd vóór versturen?' },
      { id: 'h5q2', text: 'Zijn er bevestigingsdialogen bij onomkeerbare acties?' },
      { id: 'h5q3', text: 'Worden invulvelden voorzien van hints en voorbeelden?' },
      { id: 'h5q4', text: 'Is het duidelijk welke velden verplicht zijn?' },
      { id: 'h5q5', text: 'Worden fouten voorkomen door slim ontwerp? (datumkiezers i.p.v. tekst)' },
      { id: 'h5q6', text: 'Zijn destructieve knoppen visueel onderscheiden van constructieve?' }
    ]
  },
  {
    id: 'heuristic6', title: '6. Herkenning > Herinnering', shortTitle: 'Herkenning', impact: 'low',
    desc: 'Nielsen Heuristic #6 — Minimaliseer de geheugenbelasting.',
    questions: [
      { id: 'h6q1', text: 'Zijn de belangrijkste acties altijd zichtbaar? (niet in menu\'s verstopt)' },
      { id: 'h6q2', text: 'Worden recent bekeken items of pagina\'s getoond?' },
      { id: 'h6q3', text: 'Is de navigatie altijd bereikbaar? (sticky header/sidebar)' },
      { id: 'h6q4', text: 'Bij formulieren: zijn eerder ingevulde gegevens zichtbaar bij overzicht?' },
      { id: 'h6q5', text: 'Worden opties getoond i.p.v. dat de gebruiker ze moet onthouden?' },
      { id: 'h6q6', text: 'Is de zoekfunctie makkelijk vindbaar en bruikbaar?' }
    ]
  },
  {
    id: 'heuristic7', title: '7. Flexibiliteit & Efficiëntie', shortTitle: 'Flexibiliteit', impact: 'low',
    desc: 'Nielsen Heuristic #7 — Bedien zowel beginners als ervaren gebruikers.',
    questions: [
      { id: 'h7q1', text: 'Zijn er snelkoppelingen voor veelgebruikte acties?' },
      { id: 'h7q2', text: 'Kunnen ervaren gebruikers stappen overslaan?' },
      { id: 'h7q3', text: 'Is er een zoekfunctie naast navigatie?' },
      { id: 'h7q4', text: 'Zijn formulieren slim? (auto-complete, adres-lookup)' },
      { id: 'h7q5', text: 'Is het mogelijk om acties in bulk uit te voeren?' }
    ]
  },
  {
    id: 'heuristic8', title: '8. Esthetisch & Minimalistisch Design', shortTitle: 'Design', impact: 'low',
    desc: 'Nielsen Heuristic #8 — Elk extra element concurreert met relevante informatie.',
    questions: [
      { id: 'h8q1', text: 'Is er een duidelijke visuele hiërarchie? (primaire vs. secundaire content)' },
      { id: 'h8q2', text: 'Is er voldoende white space / ademruimte tussen elementen?' },
      { id: 'h8q3', text: 'Staat de belangrijkste informatie above the fold?' },
      { id: 'h8q4', text: 'Zijn er afleidende elementen? (auto-play video, pop-ups, banners)' },
      { id: 'h8q5', text: 'Zijn CTA\'s duidelijk en niet overwoekerd door andere content?' },
      { id: 'h8q6', text: 'Ondersteunen afbeeldingen de boodschap of zijn ze decoratief?' }
    ]
  },
  {
    id: 'heuristic9', title: '9. Foutherstel', shortTitle: 'Foutherstel', impact: 'high',
    desc: 'Nielsen Heuristic #9 — Foutmeldingen moeten in gewone taal en constructief zijn.',
    questions: [
      { id: 'h9q1', text: 'Zijn foutmeldingen in begrijpelijke taal? (niet "Error 404")' },
      { id: 'h9q2', text: 'Wordt er aangegeven wat de gebruiker moet doen om de fout op te lossen?' },
      { id: 'h9q3', text: 'Zijn foutmeldingen visueel opvallend? (rode rand, icoon)' },
      { id: 'h9q4', text: 'Wordt de fout bij het juiste veld getoond?' },
      { id: 'h9q5', text: 'Is de 404-pagina nuttig? (zoekfunctie, links)' },
      { id: 'h9q6', text: 'Worden technische foutmeldingen vertaald naar gebruikerstaal?' }
    ]
  },
  {
    id: 'heuristic10', title: '10. Help & Documentatie', shortTitle: 'Help', impact: 'low',
    desc: 'Nielsen Heuristic #10 — Bied hulp en documentatie die taakgericht is.',
    questions: [
      { id: 'h10q1', text: 'Is er een FAQ-sectie die veelgestelde vragen beantwoordt?' },
      { id: 'h10q2', text: 'Is er contextgevoelige hulp? (tooltips, inline uitleg)' },
      { id: 'h10q3', text: 'Is contactinformatie makkelijk te vinden?' },
      { id: 'h10q4', text: 'Bij complexe producten: is er een onboarding flow?' },
      { id: 'h10q5', text: 'Is er een chatfunctie of ander direct contactkanaal?' },
      { id: 'h10q6', text: 'Zijn helpartikelen doorzoekbaar en goed georganiseerd?' }
    ]
  },
  {
    id: 'honeycomb', title: '11. UX Honeycomb', shortTitle: 'Honeycomb', impact: 'low',
    desc: 'Peter Morville\'s 7 facetten van gebruikerservaring — score elk facet.',
    questions: [
      { id: 'hcq1', text: 'Useful — Lost dit product een echt probleem op?' },
      { id: 'hcq2', text: 'Usable — Is het makkelijk te gebruiken?' },
      { id: 'hcq3', text: 'Desirable — Wil je het gebruiken? Voelt het goed?' },
      { id: 'hcq4', text: 'Findable — Kun je vinden wat je zoekt?' },
      { id: 'hcq5', text: 'Accessible — Is het toegankelijk voor iedereen?' },
      { id: 'hcq6', text: 'Credible — Vertrouw je het?' },
      { id: 'hcq7', text: 'Valuable — Levert het waarde?' }
    ]
  },
  {
    id: 'conversion', title: '12. Conversie & Performance', shortTitle: 'Conversie', impact: 'high',
    desc: 'Harde metrics en conversie-elementen die direct omzet beïnvloeden.',
    questions: [
      { id: 'cvq1', text: 'Is de primaire CTA direct zichtbaar boven de fold?' },
      { id: 'cvq2', text: 'Is de waardepropositie binnen 5 seconden duidelijk?' },
      { id: 'cvq3', text: 'Zijn er vertrouwenssignalen? (reviews, keurmerken, klantenlogo\'s)' },
      { id: 'cvq4', text: 'Is het contactformulier kort genoeg?' },
      { id: 'cvq5', text: 'Is er social proof zichtbaar op de belangrijkste pagina\'s?' },
      { id: 'cvq6', text: 'Laadtijd: onder 3 seconden (liefst onder 2)?' },
      { id: 'cvq7', text: 'LCP onder 2,5 seconden? CLS onder 0,1? INP onder 200ms?' }
    ]
  },
  {
    id: 'mobile', title: '13. Mobiele Ervaring', shortTitle: 'Mobiel', impact: 'high',
    desc: 'Specifieke checks voor de mobiele gebruikerservaring.',
    questions: [
      { id: 'mbq1', text: 'Is de site volledig responsive?' },
      { id: 'mbq2', text: 'Zijn touch targets groot genoeg? (min 44x44px)' },
      { id: 'mbq3', text: 'Is tekst leesbaar zonder zoomen?' },
      { id: 'mbq4', text: 'Werken formulieren goed op mobiel? (juiste toetsenbordtypes)' },
      { id: 'mbq5', text: 'Is de mobiele navigatie intuïtief? (hamburger, sticky nav)' }
    ]
  },
  {
    id: 'seo', title: '14. SEO & Vindbaarheid', shortTitle: 'SEO', impact: 'low',
    desc: 'Basis SEO-checks die bijdragen aan vindbaarheid en professionele uitstraling.',
    questions: [
      { id: 'seq1', text: 'Heeft elke pagina een unieke, beschrijvende title tag?' },
      { id: 'seq2', text: 'Zijn meta descriptions ingevuld en aantrekkelijk?' },
      { id: 'seq3', text: 'Worden heading tags (H1, H2, H3) correct gebruikt?' },
      { id: 'seq4', text: 'Zijn afbeeldingen voorzien van alt-teksten?' },
      { id: 'seq5', text: 'Is de URL-structuur clean en logisch?' }
    ]
  },
  {
    id: 'a11y', title: '15. Toegankelijkheid & Contrast', shortTitle: 'Contrast', impact: 'high',
    desc: 'WCAG-richtlijnen voor kleurcontrast, leesbaarheid en toegankelijkheid. Gebruik de ingebouwde contrast checker om kleuren te testen.',
    questions: [
      { id: 'a11q1', text: 'Heeft de body tekst voldoende contrast? (WCAG AA: 4.5:1 ratio)', hasContrastChecker: true },
      { id: 'a11q2', text: 'Hebben knoppen en links voldoende contrast met hun achtergrond?' },
      { id: 'a11q3', text: 'Is placeholder tekst in formulieren leesbaar? (vaak te licht)' },
      { id: 'a11q4', text: 'Is tekst op afbeeldingen/banners leesbaar? (overlay contrast)' },
      { id: 'a11q5', text: 'Wordt kleur niet als enige middel gebruikt om info over te brengen?' },
      { id: 'a11q6', text: 'Zijn focus-states duidelijk zichtbaar voor toetsenbordnavigatie?' },
      { id: 'a11q7', text: 'Is de tekst minstens 16px en de regelafstand minstens 1.5?' }
    ]
  },
  {
    id: 'wcag_keyboard', title: '16. Toetsenbord & Navigatie', shortTitle: 'Toetsenbord', impact: 'high',
    desc: 'WCAG 2.1.1, 2.1.2, 2.4.1, 2.4.2, 2.4.3, 2.4.5, 2.4.7 — Alle functionaliteit moet bereikbaar zijn via het toetsenbord met logische focusvolgorde.',
    questions: [
      { id: 'kb1', text: 'Is alle functionaliteit bereikbaar met alleen het toetsenbord? (WCAG 2.1.1)' },
      { id: 'kb2', text: 'Kan de gebruiker nergens vast komen te zitten met het toetsenbord? Geen keyboard traps? (WCAG 2.1.2)' },
      { id: 'kb3', text: 'Is er een "Skip to content" link aanwezig om navigatie over te slaan? (WCAG 2.4.1)' },
      { id: 'kb4', text: 'Heeft elke pagina een beschrijvende, unieke \\u003Ctitle\\u003E? (WCAG 2.4.2)' },
      { id: 'kb5', text: 'Is de tab-volgorde logisch en voorspelbaar? (WCAG 2.4.3)' },
      { id: 'kb6', text: 'Zijn er meerdere manieren om pagina\'s te vinden? (menu, zoekfunctie, sitemap) (WCAG 2.4.5)' },
      { id: 'kb7', text: 'Is de focus-indicator altijd duidelijk zichtbaar bij toetsenbordnavigatie? (WCAG 2.4.7)' }
    ]
  },
  {
    id: 'wcag_media', title: '17. Media & Timing', shortTitle: 'Media', impact: 'low',
    desc: 'WCAG 1.2.1–1.2.5, 1.4.2, 2.2.1, 2.2.2, 2.3.1 — Tijdgebaseerde media moet alternatieven bieden, auto-play onder controle, en geen content die aanvallen kan veroorzaken.',
    questions: [
      { id: 'md1', text: 'Hebben audio-only bestanden een teksttranscriptie? (WCAG 1.2.1)' },
      { id: 'md2', text: 'Hebben video\'s ondertiteling (captions)? (WCAG 1.2.2)' },
      { id: 'md3', text: 'Is er een audiodescriptie of tekst-alternatief voor video-inhoud? (WCAG 1.2.3 / 1.2.5)' },
      { id: 'md4', text: 'Hebben live video-uitzendingen ondertiteling? (WCAG 1.2.4)' },
      { id: 'md5', text: 'Kan audio die automatisch afspeelt gepauzeerd of gedempt worden? (WCAG 1.4.2)' },
      { id: 'md6', text: 'Kan de gebruiker tijdslimieten verlengen, uitschakelen of aanpassen? (WCAG 2.2.1)' },
      { id: 'md7', text: 'Kan bewegende, knipperende of auto-scrollende content gepauzeerd worden? (WCAG 2.2.2)' },
      { id: 'md8', text: 'Bevat de pagina geen content die meer dan 3x per seconde flitst? (WCAG 2.3.1)' }
    ]
  },
  {
    id: 'wcag_forms', title: '18. Formulieren & Foutafhandeling', shortTitle: 'Formulieren', impact: 'high',
    desc: 'WCAG 1.3.1, 3.3.1, 3.3.2, 3.3.3, 3.3.4, 3.1.1, 3.1.2 — Formulieren moeten labels hebben, fouten duidelijk melden, en taalinstelling correct zijn.',
    questions: [
      { id: 'fm1', text: 'Heeft elk formulierveld een zichtbaar en gekoppeld \\u003Clabel\\u003E? (WCAG 3.3.2 / 1.3.1)' },
      { id: 'fm2', text: 'Worden fouten duidelijk geïdentificeerd en in tekst beschreven? (WCAG 3.3.1)' },
      { id: 'fm3', text: 'Worden suggesties gegeven bij invoerfouten? (bijv. "Voer een geldig e-mailadres in") (WCAG 3.3.3)' },
      { id: 'fm4', text: 'Kunnen juridische/financiële acties ongedaan gemaakt, gecontroleerd of bevestigd worden? (WCAG 3.3.4)' },
      { id: 'fm5', text: 'Heeft de HTML-pagina een correct lang-attribuut? (bijv. lang="nl") (WCAG 3.1.1)' },
      { id: 'fm6', text: 'Worden wisselingen van taal in de content gemarkeerd met lang-attribuut? (WCAG 3.1.2)' },
      { id: 'fm7', text: 'Zijn verplichte velden duidelijk aangegeven (niet alleen met kleur)? (WCAG 1.3.1)' },
      { id: 'fm8', text: 'Worden instructies gegeven vóór het formulier waar nodig? (formaat, vereisten) (WCAG 3.3.2)' }
    ]
  },
  {
    id: 'wcag_structure', title: '19. Semantiek & Structuur', shortTitle: 'Semantiek', impact: 'low',
    desc: 'WCAG 1.3.1, 1.3.2, 1.3.3, 1.3.4, 1.3.5, 1.4.4, 1.4.10, 1.4.13, 4.1.1, 4.1.2, 2.5.1, 2.5.2, 2.5.3, 2.5.4 — Correcte HTML-structuur, ARIA-gebruik, responsive zoom en touch-interacties.',
    questions: [
      { id: 'sm1', text: 'Is de heading-hiërarchie logisch (h1 → h2 → h3, geen niveaus overgeslagen)? (WCAG 1.3.1)' },
      { id: 'sm2', text: 'Hebben alle interactieve elementen een toegankelijke naam (aria-label of zichtbare tekst)? (WCAG 4.1.2)' },
      { id: 'sm3', text: 'Zijn ARIA-rollen correct gebruikt? (geen div als button zonder role="button") (WCAG 4.1.2)' },
      { id: 'sm4', text: 'Is de volgorde van content in de DOM logisch, ook zonder CSS? (WCAG 1.3.2)' },
      { id: 'sm5', text: 'Werkt de layout correct bij 200% zoom zonder horizontaal scrollen? (WCAG 1.4.4 / 1.4.10)' },
      { id: 'sm6', text: 'Verdwijnt content die verschijnt bij hover/focus niet onverwacht? Kan deze gesloten worden? (WCAG 1.4.13)' },
      { id: 'sm7', text: 'Hebben formuliervelden autocomplete-attributen voor persoonlijke data? (naam, e-mail, adres) (WCAG 1.3.5)' },
      { id: 'sm8', text: 'Werkt de content in zowel portrait als landscape modus? (WCAG 1.3.4)' },
      { id: 'sm9', text: 'Zijn complexe gebaren (pinch, swipe) ook beschikbaar via een single-pointer alternatief? (WCAG 2.5.1)' },
      { id: 'sm10', text: 'Kan een pointer-actie afgebroken worden? (geen actie bij alleen down-event) (WCAG 2.5.2)' },
      { id: 'sm11', text: 'Komt de accessible name overeen met de zichtbare labeltekst? (WCAG 2.5.3)' },
      { id: 'sm12', text: 'Is er geen functionaliteit die alleen via device-motion werkt (schudden, kantelen) zonder alternatief? (WCAG 2.5.4)' }
    ]
  }
];

// Initialize module-based steps if module data is available
if (typeof buildReviewSteps === 'function' && typeof MODULE_CHECKS !== 'undefined') {
  reviewSteps = buildReviewSteps(null); // null = use default config, will be rebuilt per project
} else {
  reviewSteps = LEGACY_STEPS_BACKUP; // Fallback if module-data.js not loaded
}

// ═══════════════ TIPS PER VRAAG ═══════════════
// Auto-generated from module data (with legacy fallback)
const questionTips = {};
if (typeof MODULE_CHECKS !== 'undefined') {
  Object.values(MODULE_CHECKS).flat().forEach(function(check) {
    if (check.fix_suggestion_nl) {
      questionTips[check.id] = check.fix_suggestion_nl;
      if (check.legacy_id) questionTips[check.legacy_id] = check.fix_suggestion_nl;
    }
  });
} else {
  // Legacy tips fallback
  Object.assign(questionTips, {
  h1q1:'Voeg breadcrumbs toe en markeer actieve menu-item visueel',
  h1q2:'Implementeer skeleton loaders bij asynchroon laden',
  h1q3:'Toon visuele feedback (toast/animatie) na elke actie',
  h1q4:'Voeg een progress bar toe voor multi-step processen',
  h1q5:'Markeer huidige pagina in menu met duidelijke active state',
  h1q6:'Maak winkelwagen-totaal en aantal items altijd zichtbaar',
  h1q7:'Valideer formuliervelden live terwijl de gebruiker typt',
  h2q1:'Vereenvoudig taal naar het niveau van je doelgroep',
  h2q2:'Kies universeel erkende iconen of voeg labels toe',
  h2q3:'Reorganiseer informatie in logische, natuurlijke volgorde',
  h2q4:'Maak knoplabels beschrijvend en actiegericht',
  h2q5:'Gebruik metaforen die aansluiten bij de echte wereld',
  h2q6:'Zet tone of voice consistent in met merkidentiteit',
  h3q1:'Voeg terug-functie toe zodat gebruiker vorige stap kan bereiken',
  h3q2:'Plaats duidelijke terug/annuleer knop op alle pagina\'s',
  h3q3:'Sla formuliergegevens automatisch op bij paginaverlating',
  h3q4:'Voeg undo/redo-functie toe waar acties onomkeerbaar zijn',
  h3q5:'Maak winkelwagenitems eenvoudig verwijderbaar',
  h3q6:'Maak pop-ups sluitbaar met X-knop en ESC-toets',
  h4q1:'Standaardiseer knoppen in kleur, grootte en positie',
  h4q2:'Gebruik dezelfde termen consistent op de hele site',
  h4q3:'Volg gevestigde webconventies (logo links, etc.)',
  h4q4:'Zorg dat fonts, groottes en gewichten consistent zijn',
  h4q5:'Maak hover/klik-states voorspelbaar en consistent',
  h4q6:'Herhaal layout-structuur consistent over pagina\'s',
  h5q1:'Valideer alle verplichte velden vóór formulierinzending',
  h5q2:'Toon bevestigingsdialoog voor onomkeerbare acties',
  h5q3:'Voeg hints en voorbeeldtekst toe in formuliervelden',
  h5q4:'Markeer verplichte velden met asterisk (*) of label',
  h5q5:'Gebruik datumkiezers en dropdowns i.p.v. vrije tekst',
  h5q6:'Maak destructieve knoppen visueel anders (rood/oranje)',
  h6q1:'Maak primaire acties altijd zichtbaar zonder scrollen',
  h6q2:'Toon recent bekeken items voor snelle terugkeer',
  h6q3:'Maak navigatie sticky zodat deze altijd bereikbaar is',
  h6q4:'Toon eerder ingevulde gegevens in formulieroverzicht',
  h6q5:'Toon beschikbare opties i.p.v. gebruiker te laten raden',
  h6q6:'Plaats zoekfunctie prominent bovenaan de pagina',
  h7q1:'Bied keyboard shortcuts aan voor veelgebruikte acties',
  h7q2:'Laat ervaren gebruikers intro-stappen overslaan',
  h7q3:'Zet zoekfunctie naast of boven primaire navigatie',
  h7q4:'Vul formuliervelden slim in met auto-complete',
  h7q5:'Voeg bulk-acties toe voor meervoudig items verwerken',
  h8q1:'Maak visuele hiërarchie duidelijk via grootte en kleur',
  h8q2:'Voeg voldoende witruimte toe rond elementen',
  h8q3:'Zorg dat belangrijkste content above the fold staat',
  h8q4:'Verwijder afleidende pop-ups, autoplay en banners',
  h8q5:'Maak CTA\'s opvallend via kleur, grootte en plaatsing',
  h8q6:'Kies afbeeldingen die de boodschap ondersteunen',
  h9q1:'Schrijf foutmeldingen in begrijpelijke, niet-technische taal',
  h9q2:'Geef duidelijke instructies wat gebruiker moet doen',
  h9q3:'Maak foutmeldingen visueel opvallend (rood + icoon)',
  h9q4:'Toon foutmeldingen inline bij het juiste veld',
  h9q5:'Maak nuttige 404-pagina met zoekfunctie en links',
  h9q6:'Vertaal technische foutcodes naar gebruikerstaal',
  h10q1:'Maak FAQ-sectie met veelgestelde vragen',
  h10q2:'Voeg contextgevoelige tooltips en inline uitleg toe',
  h10q3:'Plaats contactinfo makkelijk vindbaar in footer/header',
  h10q4:'Maak onboarding-flow voor complexe producten',
  h10q5:'Voeg chatfunctie of WhatsApp-knop toe',
  h10q6:'Zorg dat helpartikelen doorzoekbaar en geordend zijn',
  hcq1:'Maak duidelijk welk probleem je product oplost',
  hcq2:'Vereenvoudig interface en workflows voor intuïtief gebruik',
  hcq3:'Maak het product visueel aantrekkelijk en wenselijk',
  hcq4:'Verbeter navigatie en zoekfunctionaliteit',
  hcq5:'Implementeer WCAG-richtlijnen voor toegankelijkheid',
  hcq6:'Voeg vertrouwenssignalen toe (certificaten, reviews)',
  hcq7:'Toon concrete waarde en voordelen voor gebruiker',
  cvq1:'Plaats primaire CTA direct zichtbaar boven de fold',
  cvq2:'Maak waardepropositie binnen 5 seconden glashelder',
  cvq3:'Voeg reviews, keurmerken en klantenlogo\'s toe',
  cvq4:'Houd contactformulier kort: max 5 velden',
  cvq5:'Toon testimonials, ratings en gebruikersaantallen',
  cvq6:'Optimaliseer laadtijd: onder 3 seconden (liefst 2)',
  cvq7:'Optimaliseer Core Web Vitals (LCP, CLS, INP)',
  mbq1:'Zorg dat site responsive is op alle schermgroottes',
  mbq2:'Maak touch targets minstens 44×44px groot',
  mbq3:'Zorg voor leesbare tekst zonder zoomen (min 16px)',
  mbq4:'Optimaliseer formulieren voor mobiel (juiste keyboards)',
  mbq5:'Maak intuïtief mobiel menu (hamburger + sticky nav)',
  seq1:'Geef elke pagina een unieke, beschrijvende title tag',
  seq2:'Vul meta descriptions in voor alle pagina\'s',
  seq3:'Gebruik heading tags (H1-H6) correct en hiërarchisch',
  seq4:'Voeg beschrijvende alt-teksten toe aan afbeeldingen',
  seq5:'Maak URL-structuur schoon, leesbaar en logisch',
  a11q1:'Body tekst moet minimaal 4.5:1 contrast ratio hebben (WCAG AA). Test met de contrast checker: klik de Contrast-knop hierboven.',
  a11q2:'Knoppen, links en interactieve elementen moeten opvallen. Minimaal 3:1 voor grote tekst, 4.5:1 voor normale tekst.',
  a11q3:'Placeholder tekst is vaak #999 op #fff (2.7:1) — dat faalt WCAG. Gebruik labels in plaats van alleen placeholders.',
  a11q4:'Tekst op hero images/banners moet leesbaar zijn. Gebruik een semi-transparante overlay of text-shadow.',
  a11q5:'Gebruik niet alleen kleur (bijv. rood/groen) om fouten of succes te tonen. Voeg ook iconen of tekst toe.',
  a11q6:'Tab door de pagina — elk interactief element moet een duidelijk zichtbare focus ring hebben.',
  a11q7:'Gebruik minimaal font-size: 16px voor body tekst en line-height: 1.5 voor goede leesbaarheid.',
  kb1:'Tab door de hele pagina. Elke knop, link, formulierveld en interactief element moet bereikbaar zijn zonder muis.',
  kb2:'Let op modals, dropdowns en sliders — de focus mag niet "gevangen" raken. Escape moet altijd werken om te sluiten.',
  kb3:'Voeg bovenaan de pagina een verborgen "Skip to main content" link toe die zichtbaar wordt bij focus: &lt;a href="#main" class="skip-link"&gt;.',
  kb4:'Elke pagina moet een unieke &lt;title&gt; hebben die de inhoud beschrijft, bijv. "Winkelwagen | Webshop" in plaats van alleen "Webshop".',
  kb5:'Tab door de pagina en controleer of de volgorde visueel logisch is: van links naar rechts, van boven naar beneden. Geen rare sprongen.',
  kb6:'Bied minstens twee navigatiemethoden: hoofdmenu, zoekfunctie, sitemap, of breadcrumbs.',
  kb7:'De focus-ring moet altijd zichtbaar zijn. Gebruik outline: 2px solid en verwijder nooit outline:none zonder vervanging.',
  md1:'Bied een volledige tekstversie aan van audio-only content (bijv. podcasts). Plaats het transcript direct onder de speler.',
  md2:'Voeg ondertiteling toe aan alle video\\u0027s. Gebruik &lt;track kind="captions"&gt; voor HTML5 video of de ingebouwde captioning van YouTube/Vimeo.',
  md3:'Beschrijf visuele content in video\'s via audiodescriptie of een tekst-alternatief dat de visuele informatie dekt.',
  md4:'Live streams moeten real-time ondertiteling hebben. Gebruik services als Google Live Transcribe of professionele CART-diensten.',
  md5:'Audio mag niet automatisch starten, of moet binnen 3 seconden te stoppen/dempen zijn. Bied een duidelijke mute-knop.',
  md6:'Als er een tijdslimiet is (bijv. sessie-timeout), waarschuw 20 sec. van tevoren en laat de gebruiker verlengen.',
  md7:'Carousels, nieuws-tickers, auto-play video\'s: bied een duidelijke pauze/stop-knop. Content mag niet oneindig bewegen.',
  md8:'Geen content die meer dan 3x per seconde knippert of flitst. Dit kan epileptische aanvallen veroorzaken.',
  fm1:'Elk input-veld moet een &lt;label for="id"&gt; hebben, of gebruik aria-label. Placeholder alleen is NIET voldoende als label.',
  fm2:'Toon foutmeldingen in tekst bij het veld zelf (niet alleen rood kleuren). Gebruik role="alert" voor schermlezers.',
  fm3:'Geef specifieke hints: "Voer een e-mailadres in zoals naam@voorbeeld.nl" in plaats van alleen "Ongeldig".',
  fm4:'Bij bestellingen of juridische acties: toon een bevestigingspagina, of bied een "ongedaan maken" optie na verzending.',
  fm5:'Voeg lang="nl" toe aan het &lt;html&gt; element. Dit helpt schermlezers de juiste taal en uitspraak te kiezen.',
  fm6:'Als een alinea of citaat in een andere taal is, markeer dit met lang="en" op dat element.',
  fm7:'Markeer verplichte velden met een asterisk (*) en leg bovenaan uit: "* = verplicht". Gebruik ook aria-required="true".',
  fm8:'Geef vóór complexe formulieren instructies over formaat (bijv. "Datum: DD-MM-JJJJ") en vereisten.',
  sm1:'Gebruik één h1 per pagina, gevolgd door h2 voor secties, h3 voor subsecties. Sla geen niveaus over (geen h1 → h3).',
  sm2:'Knoppen met alleen een icoon moeten een aria-label hebben, bijv. &lt;button aria-label="Sluiten"&gt;✕&lt;/button&gt;.',
  sm3:'Gebruik &lt;button&gt; voor klikbare acties, &lt;a&gt; voor navigatie. Vermijd &lt;div onclick=""&gt;. Gebruik role en tabindex als het niet anders kan.',
  sm4:'Schakel CSS uit en controleer of de content in een logische leesvolgorde staat. DOM-volgorde = leesvolgorde.',
  sm5:'Zoom naar 200% en controleer of alle content zichtbaar blijft zonder horizontaal te scrollen (op 1280px viewport).',
  sm6:'Tooltips en hover-content moeten: (1) zichtbaar blijven tot de gebruiker ze sluit, (2) hoverable zijn, (3) met Escape te sluiten.',
  sm7:'Gebruik autocomplete="name", autocomplete="email", autocomplete="street-address" etc. op formuliervelden voor persoonlijke data.',
  sm8:'Test de site in zowel portrait als landscape. Content mag niet beperkt zijn tot één oriëntatie, tenzij noodzakelijk.',
  sm9:'Bied voor pinch-to-zoom, multi-finger swipes etc. altijd een single-tap of knop-alternatief.',
  sm10:'Gebruik onclick (up-event) in plaats van onmousedown. Gebruikers moeten een klik kunnen annuleren door weg te slepen.',
  sm11:'Als een knop "Zoeken" zegt, moet de aria-label ook "Zoeken" zijn — niet iets anders. Zichtbare tekst = accessible name.',
  sm12:'Als je device-motion gebruikt (schudden om te resetten), bied dan altijd een knop-alternatief en laat de motion uitschakelbaar zijn.'
  });
}

// ═══════════════ FIREBASE CONFIG ═══════════════
const firebaseConfig = {
  apiKey: "AIzaSyDPQdEZk574PO7ft7aHTSPjzxwgSXFtf-o",
  authDomain: "bold700-ux-reviews.firebaseapp.com",
  projectId: "bold700-ux-reviews",
  storageBucket: "bold700-ux-reviews.firebasestorage.app",
  messagingSenderId: "61806362887",
  appId: "1:61806362887:web:8e0667d1d01119279fc5a2",
  measurementId: "G-94SCL9W7X3"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// ═══════════════ STATE ═══════════════
let projects = [];
let activeProjectId = null;
let currentStep = 0;
let newProjectMode = 'self-service';
let isAdmin = false;
let isAuditor = false;
let currentUser = null;    // Firebase Auth user object
let userProfile = null;    // Firestore user profile { role, createdAt, ... }
let allAuditors = [];      // Cached auditor list (admin only)
let auditRequests = [];    // Professional projects for admin/auditor views
let saveTimer = null;
let authMode = 'login';    // 'login' or 'register'

// URL params
const urlParams = new URLSearchParams(window.location.search);
const urlProjectId = urlParams.get('p');
const urlPreviewId = urlParams.get('preview');

function getActiveProject() { return projects.find(p => p.id === activeProjectId); }
function getAnswers() { const p = getActiveProject(); return p ? p.answers : {}; }

// ── Debounced save: writes to Firestore + localStorage backup ──
function saveState() {
  // Always save to localStorage as backup
  try { localStorage.setItem('bold700_projects', JSON.stringify(projects)); } catch(e) {}

  // Debounce Firestore writes (500ms)
  if (saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    const project = getActiveProject();
    if (project) syncProjectToFirestore(project);
  }, 500);
}

// ── Sync single project to Firestore ──
async function syncProjectToFirestore(project) {
  try {
    const docData = { ...project, updatedAt: new Date().toISOString() };
    // Ensure userId and email are always stored
    if (currentUser && !docData.userId) docData.userId = currentUser.uid;
    if (currentUser && !docData.leadEmail) docData.leadEmail = currentUser.email;
    // Don't store base64 screenshots in Firestore (too large)
    // They'll be uploaded to Storage separately
    const cleanAnswers = {};
    for (const [qId, ans] of Object.entries(docData.answers || {})) {
      cleanAnswers[qId] = { ...ans };
      delete cleanAnswers[qId].screenshot; // Remove base64, use Storage instead
      delete cleanAnswers[qId].screenshots;
    }
    docData.answers = cleanAnswers;
    await db.collection('projects').doc(project.id).set(docData, { merge: true });
  } catch(e) {
    console.warn('[Firebase] Save failed:', e.message);
  }
}

// ── Load from Firestore based on auth state ──
async function loadState() {
  if (!currentUser) { projects = []; return; }

  try {
    if (isAdmin) {
      // Admin: load ALL projects
      const snapshot = await db.collection('projects').orderBy('createdAt', 'desc').get();
      projects = snapshot.docs.map(d => ({ ...d.data(), id: d.id }));
      console.log('[Firebase] Loaded', projects.length, 'projects (admin mode)');
    } else if (isAuditor) {
      // Auditor: load projects assigned to them + their own self-service projects
      let snapshot;
      try {
        snapshot = await db.collection('projects').where('assignedTo', '==', currentUser.uid).get();
      } catch(e) { snapshot = { docs: [] }; }
      const assignedProjects = snapshot.docs.map(d => ({ ...d.data(), id: d.id }));
      // Also load their own projects (if they do self-service reviews too)
      let ownSnapshot;
      try {
        ownSnapshot = await db.collection('projects').where('userId', '==', currentUser.uid).get();
      } catch(e) { ownSnapshot = { docs: [] }; }
      const ownProjects = ownSnapshot.docs.map(d => ({ ...d.data(), id: d.id }));
      // Merge without duplicates
      const seen = new Set();
      projects = [...assignedProjects, ...ownProjects].filter(p => { if (seen.has(p.id)) return false; seen.add(p.id); return true; });
      projects.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));
      console.log('[Firebase] Loaded', projects.length, 'projects for auditor', currentUser.uid);
    } else {
      // Regular user: load only their projects by userId
      let snapshot;
      try {
        snapshot = await db.collection('projects').where('userId', '==', currentUser.uid).orderBy('createdAt', 'desc').get();
      } catch(indexErr) {
        console.warn('[Firebase] Index not ready, using fallback:', indexErr.message);
        snapshot = await db.collection('projects').where('userId', '==', currentUser.uid).get();
      }
      projects = snapshot.docs.map(d => ({ ...d.data(), id: d.id }));
      projects.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));
      console.log('[Firebase] Loaded', projects.length, 'projects for user', currentUser.uid);

      // Migrate localStorage projects ONLY if they belong to this user (or have no owner)
      try {
        const saved = localStorage.getItem('bold700_projects');
        if (saved) {
          const localProjects = JSON.parse(saved);
          let migrated = 0;
          for (const lp of localProjects) {
            // Skip projects that already exist in Firestore for this user
            if (projects.find(p => p.id === lp.id)) continue;
            // Only migrate if project has no userId (legacy) or belongs to this user
            if (lp.userId && lp.userId !== currentUser.uid) {
              console.log('[Firebase] Skipping localStorage project', lp.id, '— belongs to another user');
              continue;
            }
            lp.userId = currentUser.uid;
            lp.leadEmail = currentUser.email;
            projects.push(lp);
            await syncProjectToFirestore(lp);
            migrated++;
          }
          localStorage.removeItem('bold700_projects'); // Clean up after migration
          if (migrated > 0) console.log('[Firebase] Migrated', migrated, 'localStorage projects');
        }
      } catch(e) {}
    }
  } catch(e) {
    console.warn('[Firebase] Load failed:', e.message);
    projects = [];
  }
}

// ── Load audit requests (admin sees all, auditor sees pending + their own) ──
async function loadAuditRequests() {
  auditRequests = [];
  try {
    const snapshot = await db.collection('projects').where('mode', '==', 'professional').get();
    auditRequests = snapshot.docs.map(d => ({ ...d.data(), id: d.id }));
    auditRequests.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));
    console.log('[Firebase] Loaded', auditRequests.length, 'audit requests');
  } catch(e) {
    console.warn('[Firebase] Audit requests load failed:', e.message);
    // Fallback: filter from already loaded projects
    auditRequests = projects.filter(p => p.mode === 'professional');
  }
}

// ── Load auditor list (admin only) ──
async function loadAuditors() {
  if (!isAdmin) return;
  try {
    const snapshot = await db.collection('users').where('role', '==', 'auditor').get();
    allAuditors = snapshot.docs.map(d => ({ uid: d.id, ...d.data() }));
    console.log('[Firebase] Loaded', allAuditors.length, 'auditors');
  } catch(e) {
    console.warn('[Firebase] Auditors load failed:', e.message);
    allAuditors = [];
  }
}

// ── Assign project to auditor ──
async function assignToAuditor(projectId, auditorId, auditorName) {
  try {
    await db.collection('projects').doc(projectId).update({
      assignedTo: auditorId,
      assignedToName: auditorName || '',
      auditStatus: 'assigned',
      assignedAt: new Date().toISOString()
    });
    // Update local state
    const p = auditRequests.find(r => r.id === projectId) || projects.find(r => r.id === projectId);
    if (p) { p.assignedTo = auditorId; p.assignedToName = auditorName; p.auditStatus = 'assigned'; p.assignedAt = new Date().toISOString(); }
    if (isAdmin) renderAuditQueue();
    showScanToast('success', 'Audit toegewezen', `Toegewezen aan ${auditorName}`, 3000);
  } catch(e) {
    console.error('[Firebase] Assign failed:', e);
    showScanToast('error', 'Toewijzing mislukt', e.message, 4000);
  }
}

// ── Update audit status ──
async function updateAuditStatus(projectId, newStatus) {
  const updates = { auditStatus: newStatus };
  if (newStatus === 'in_progress') updates.startedAt = new Date().toISOString();
  if (newStatus === 'completed') updates.completedAt = new Date().toISOString();
  try {
    await db.collection('projects').doc(projectId).update(updates);
    const p = auditRequests.find(r => r.id === projectId) || projects.find(r => r.id === projectId);
    if (p) Object.assign(p, updates);
    if (isAuditor) renderAuditorDashboard();
    if (isAdmin) renderAuditQueue();
  } catch(e) {
    console.error('[Firebase] Status update failed:', e);
  }
}

// ── Auditor claims an open request ──
async function claimAuditRequest(projectId) {
  if (!currentUser) return;
  const name = userProfile?.email || currentUser.email || 'Auditor';
  await assignToAuditor(projectId, currentUser.uid, name);
  // Reload into auditor's project list
  const req = auditRequests.find(r => r.id === projectId);
  if (req && !projects.find(p => p.id === projectId)) projects.push(req);
  if (isAuditor) renderAuditorDashboard();
}

// ── Upload screenshot to Firebase Storage ──
async function uploadScreenshotToStorage(projectId, questionId, dataUrl) {
  try {
    const ref = storage.ref(`screenshots/${projectId}/${questionId}.jpg`);
    await ref.putString(dataUrl, 'data_url');
    const downloadUrl = await ref.getDownloadURL();
    return downloadUrl;
  } catch(e) {
    console.warn('[Firebase] Screenshot upload failed:', e.message);
    return null;
  }
}

// ── Get screenshot URL from Firebase Storage ──
async function getScreenshotFromStorage(projectId, questionId) {
  try {
    const ref = storage.ref(`screenshots/${projectId}/${questionId}.jpg`);
    return await ref.getDownloadURL();
  } catch(e) {
    return null;
  }
}

function calcProjectScore(project) {
  const ans = project.answers || {};
  // Build steps for this specific project's module config
  const config = project.moduleConfig || (typeof getDefaultModuleConfig === 'function' ? getDefaultModuleConfig() : null);
  const projSteps = (typeof buildReviewSteps === 'function' && config) ? buildReviewSteps(config) : reviewSteps;
  const allQ = projSteps.flatMap(s => s.questions);
  const totalQ = allQ.length;
  // Only count answers that belong to this project's steps
  const stepQIds = new Set(allQ.map(q => q.id));
  const nvtCount = allQ.filter(q => ans[q.id]?.score === 'nvt').length;
  const answered = allQ.filter(q => ans[q.id]?.score && ans[q.id].score !== 'nvt').length;
  const effectiveTotal = totalQ - nvtCount;
  if (effectiveTotal === 0) return { avg: 0, answered: 0, total: totalQ, effectiveTotal: 0, nvt: nvtCount };
  // Weighted scoring: critical=3x, high=2x, medium/low=1x
  const ws = calcWeightedScore(allQ, ans);
  return { avg: ws.score, answered, total: totalQ, effectiveTotal, nvt: nvtCount };
}

// ═══════════════ DASHBOARD ═══════════════
function showDashboard() {
  if (!currentUser) { showAuthScreen(); return; }
  document.getElementById('authScreen').classList.add('hidden');
  document.getElementById('dashboardScreen').classList.remove('hidden');

  document.getElementById('newProjectScreen').classList.add('hidden');
  document.getElementById('reviewScreen').classList.add('hidden');
  document.getElementById('scorecardScreen').classList.add('hidden');

  // Clear project URL param so refresh lands on dashboard
  clearUrlParam('p');
  document.body.style.overflow = 'hidden';
  // Show email + role badge
  const emailEl = document.getElementById('dashUserEmail');
  if (emailEl && currentUser) emailEl.textContent = currentUser.email;
  const roleBadge = document.getElementById('dashRoleBadge');
  if (roleBadge) {
    const role = isAdmin ? 'admin' : isAuditor ? 'auditor' : (userProfile && userProfile.plan === 'pro') ? 'pro' : 'free';
    const labels = { admin: 'Admin', auditor: 'Auditor', pro: 'Pro', free: 'Free' };
    roleBadge.textContent = labels[role];
    roleBadge.className = 'role-badge role-' + role;
  }
  renderDashboard();
}

// ═══════════════ DASHBOARD TAB SYSTEM ═══════════════
let _activeTab = 'projects';
const PROJECTS_PER_PAGE = 20;
let _projectsShown = PROJECTS_PER_PAGE;

function switchDashTab(tabName) {
  _activeTab = tabName;
  // Update tab buttons
  document.querySelectorAll('.dash-tab').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === tabName);
  });
  // Update tab content panels
  document.querySelectorAll('.dash-tab-content').forEach(panel => {
    panel.classList.toggle('active', panel.dataset.tab === tabName);
    panel.style.display = panel.dataset.tab === tabName ? 'block' : 'none';
  });
  // Lazy render: only render content when tab is first activated
  if (tabName === 'auditQueue') renderAuditQueue();
  if (tabName === 'auditorApps') renderAuditorApplicationsAdmin();
  if (tabName === 'users') renderUserManagement();
  if (tabName === 'settings') renderAdminConfig();
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

function loadMoreProjects() {
  _projectsShown += PROJECTS_PER_PAGE;
  renderProjectCards();
}

function renderProjectCard(p) {
  const score = calcProjectScore(p) || { answered: 0, total: 1, avg: 0, nvt: 0 };
  const pct = Math.min(Math.round((score.answered / score.total) * 100), 100);
  const scoreClass = score.avg >= 7.5 ? 'good' : score.avg >= 5 ? 'ok' : score.avg > 0 ? 'bad' : 'na';
  const pkgLabels = { quick: 'Quick Scan', deep: 'Deep Review', full: 'Full Audit' };
  const isProfessional = p.mode === 'professional';
  const auditSt = p.auditStatus || (isProfessional ? 'pending' : null);

  let status, statusLabel;
  if (isProfessional && !isAdmin) {
    status = auditSt || 'pending';
    const auditLabels = { pending: 'In afwachting', assigned: 'Toegewezen', in_progress: 'Audit loopt', completed: 'Afgerond' };
    statusLabel = auditLabels[status] || 'In afwachting';
  } else {
    status = pct === 100 ? 'completed' : pct > 0 ? 'in-progress' : 'not-started';
    statusLabel = pct === 100 ? 'Afgerond' : pct > 0 ? `${pct}% klaar` : 'Niet gestart';
  }

  const adminInfo = isAdmin && p.leadEmail ? `<div style="font-size:11px;color:var(--green);margin-top:4px"><i data-lucide="mail" style="width:12px;height:12px"></i> ${p.leadEmail}</div>` : '';
  const shareLink = isAdmin ? `<button class="pc-share-btn" onclick="event.stopPropagation();copyShareLink('${p.id}')" title="Kopieer deelbare link" style="position:absolute;top:8px;right:32px;background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px;padding:4px"><i data-lucide="link" style="width:14px;height:14px"></i></button>` : '';

  let auditStatusHtml = '';
  if (isProfessional && !isAdmin) {
    const msgs = {
      pending: 'Je aanvraag is ontvangen. Een auditor wordt binnenkort toegewezen.',
      assigned: `Toegewezen aan ${p.assignedToName || 'een auditor'} op ${p.assignedAt ? new Date(p.assignedAt).toLocaleDateString('nl-NL') : '—'}`,
      in_progress: `Audit is gestart${p.startedAt ? ' op ' + new Date(p.startedAt).toLocaleDateString('nl-NL') : ''}. Je ontvangt binnenkort resultaten.`,
      completed: 'Je audit is afgerond! Klik om het rapport te bekijken.'
    };
    auditStatusHtml = `<div class="audit-status-msg status-${auditSt}"><i data-lucide="${auditSt === 'completed' ? 'check-circle' : auditSt === 'in_progress' ? 'loader' : auditSt === 'assigned' ? 'user-check' : 'clock'}" style="width:12px;height:12px"></i> ${msgs[auditSt] || msgs.pending}</div>`;
  }

  const canOpen = !isProfessional || isAdmin || auditSt === 'completed';
  const clickAction = canOpen ? `openProject('${p.id}')` : '';
  const cardClass = `project-card${isProfessional ? ' professional' : ''}${!canOpen ? ' locked' : ''}`;

  return `
    <div class="${cardClass}" ${canOpen ? `onclick="${clickAction}"` : ''} style="position:relative">
      ${shareLink}
      ${(isAdmin || isAuditor) ? `<button class="pc-preview-btn" onclick="event.stopPropagation();showPreviewModal('${p.id}')" title="Preview link voor lead"><i data-lucide="share-2" style="width:12px;height:12px"></i></button>` : ''}
      <button class="pc-delete" onclick="event.stopPropagation();deleteProject('${p.id}')" title="Verwijder project">×</button>
      <div class="pc-header">
        <div>
          <div class="pc-name">${esc(p.name)}</div>
          ${p.client ? `<div class="pc-client">${esc(p.client)}</div>` : ''}
        </div>
        ${isProfessional ? `<span class="audit-badge ${auditSt}">${statusLabel}</span>` : `<span class="pc-badge ${status}">${statusLabel}</span>`}
      </div>
      <div class="pc-url">${esc(p.url)}</div>
      ${adminInfo}
      ${auditStatusHtml}
      ${!isProfessional || auditSt === 'completed' ? `
      <div class="pc-score-bar">
        <div class="bar-track"><div class="bar-fill ${scoreClass}" style="width:${score.avg > 0 ? score.avg * 10 : 0}%"></div></div>
        <div class="pc-score-num ${scoreClass}">${score.avg > 0 ? score.avg.toFixed(1) : '—'}</div>
      </div>` : ''}
      <div class="pc-footer">
        <span class="pc-package">${(() => {
          const tpl = p.selectedTemplate;
          const b = tpl && typeof MODULE_REGISTRY !== 'undefined' ? MODULE_REGISTRY.bundles[tpl] : null;
          if (b) return `<i data-lucide="${b.icon_lucide}" style="width:11px;height:11px"></i> ${b.name_nl.replace(' Quick Scan','')}`;
          return isProfessional ? pkgLabels[p.package] || 'Professional' : 'Volledige Audit';
        })()}</span>
        <span>${new Date(p.createdAt).toLocaleDateString('nl-NL')}</span>
      </div>
    </div>
  `;
}

function getDomain(url) {
  try {
    return new URL(url.startsWith('http') ? url : 'https://' + url).hostname.replace(/^www\./, '');
  } catch(e) { return url || 'onbekend'; }
}

function getProjectGroup(project) {
  // Figma projects: group by file name or client, not "figma.com"
  if (project.sourceType === 'figma') {
    return project.client || project.figmaFileName || project.name || 'Figma Design';
  }
  return getDomain(project.url);
}

function getUserEmail(userId) {
  if (!userId) return '—';
  const u = allUsers.find(u => u.uid === userId);
  return u ? (u.email || '—') : userId.substring(0, 8) + '…';
}

function showDomainReviews(domain) {
  const visibleProjects = (isAdmin || isAuditor)
    ? projects
    : projects.filter(p => p.userId === currentUser?.uid);

  const domainProjects = visibleProjects
    .filter(p => getProjectGroup(p) === domain)
    .sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

  const overlay = document.createElement('div');
  overlay.className = 'domain-modal-overlay';
  overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };

  let rows = '';
  domainProjects.forEach(p => {
    const score = calcProjectScore(p) || { answered: 0, total: 1, avg: 0, nvt: 0 };
    const pct = Math.min(Math.round((score.answered / score.total) * 100), 100);
    const scoreClass = score.avg >= 7.5 ? 'good' : score.avg >= 5 ? 'ok' : score.avg > 0 ? 'bad' : 'na';
    const isPro = p.mode === 'professional';
    const auditSt = p.auditStatus || (isPro ? 'pending' : null);
    const canOpen = !isPro || isAdmin || auditSt === 'completed';
    const status = pct === 100 ? 'Afgerond' : pct > 0 ? `${pct}%` : 'Niet gestart';
    const pkgLabels = { quick: 'Quick', deep: 'Deep', full: 'Full' };
    const userEmail = isAdmin ? getUserEmail(p.userId) : '';

    // Determine template/scan type label
    const tplId = p.selectedTemplate;
    const tplBundle = tplId && typeof MODULE_REGISTRY !== 'undefined' ? MODULE_REGISTRY.bundles[tplId] : null;
    const tplLabel = tplBundle ? tplBundle.name_nl.replace(' Quick Scan','') : (isPro ? pkgLabels[p.package] || 'Pro' : 'Volledige Audit');
    const tplIcon = tplBundle ? tplBundle.icon_lucide : (isPro ? 'briefcase' : 'layout-grid');

    rows += `
      <tr class="domain-review-row ${canOpen ? 'clickable' : ''}" ${canOpen ? `onclick="document.querySelector('.domain-modal-overlay').remove();openProject('${p.id}')"` : ''}>
        <td><strong>${esc(p.name)}</strong>${p.client ? `<br><span style="color:var(--text-muted);font-size:11px">${esc(p.client)}</span>` : ''}</td>
        ${isAdmin ? `<td style="font-size:11px">${esc(userEmail)}</td>` : ''}
        <td><span class="pc-badge ${pct === 100 ? 'completed' : pct > 0 ? 'in-progress' : 'not-started'}" style="font-size:11px">${isPro ? (auditSt || 'pending') : status}</span></td>
        <td><span class="pc-score-num ${scoreClass}" style="font-size:13px;font-weight:700">${score.avg > 0 ? score.avg.toFixed(1) : '—'}</span></td>
        <td style="font-size:11px;color:var(--text-muted)"><span style="display:inline-flex;align-items:center;gap:3px"><i data-lucide="${tplIcon}" style="width:12px;height:12px"></i> ${tplLabel}</span></td>
        <td style="font-size:11px;color:var(--text-muted)">${new Date(p.createdAt).toLocaleDateString('nl-NL')}</td>
        <td>
          ${(isAdmin || isAuditor) ? `<button class="btn-icon-sm" onclick="event.stopPropagation();document.querySelector('.domain-modal-overlay').remove();showPreviewModal('${p.id}')" title="Preview link">
            <i data-lucide="share-2" style="width:13px;height:13px"></i>
          </button>` : ''}
          <button class="btn-icon-sm" onclick="event.stopPropagation();document.querySelector('.domain-modal-overlay').remove();deleteProject('${p.id}')" title="Verwijder">
            <i data-lucide="trash-2" style="width:13px;height:13px"></i>
          </button>
          ${isAdmin ? `<button class="btn-icon-sm" onclick="event.stopPropagation();copyShareLink('${p.id}')" title="Kopieer link">
            <i data-lucide="link" style="width:13px;height:13px"></i>
          </button>` : ''}
        </td>
      </tr>`;
  });

  overlay.innerHTML = `
    <div class="domain-modal">
      <div class="domain-modal-header">
        <div>
          <h2 style="font-size:18px;font-weight:700;margin:0;display:flex;align-items:center;gap:8px">
            <i data-lucide="globe" style="width:18px;height:18px;color:var(--accent)"></i> ${esc(domain)}
          </h2>
          <p style="margin:4px 0 0;font-size:12px;color:var(--text-muted)">${domainProjects.length} review${domainProjects.length !== 1 ? 's' : ''}</p>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <button onclick="this.closest('.domain-modal-overlay').remove();addScanToDomain('${domain}')" class="btn btn-primary" style="font-size:12px;padding:6px 14px;display:flex;align-items:center;gap:5px"><i data-lucide="plus" style="width:13px;height:13px"></i> Nieuwe scan</button>
          <button onclick="this.closest('.domain-modal-overlay').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:20px;padding:4px 8px">✕</button>
        </div>
      </div>
      <div class="domain-modal-body">
        <table class="domain-reviews-table">
          <thead>
            <tr>
              <th>Project</th>
              ${isAdmin ? '<th>Gebruiker</th>' : ''}
              <th>Status</th>
              <th>Score</th>
              <th>Scan Type</th>
              <th>Datum</th>
              <th></th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </div>`;

  document.body.appendChild(overlay);
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

// Add a new scan to an existing domain — opens wizard at step 2 with URL/client pre-filled
function addScanToDomain(domain) {
  // Find an existing project for this domain to copy URL/client info
  const existing = projects.find(p => getProjectGroup(p) === domain);
  const baseUrl = existing ? existing.url : domain;
  const client = existing ? (existing.client || '') : '';
  const mode = existing ? existing.mode : 'self-service';

  // Open new project wizard
  showNewProject();

  // Pre-fill mode from existing project
  newProjectMode = mode;
  document.querySelectorAll('.mode-option').forEach((e, i) => {
    e.classList.toggle('selected', mode === 'professional' ? i === 1 : i === 0);
  });

  // Pre-fill URL and client for step 3
  const npUrl = document.getElementById('npUrl'); if (npUrl) npUrl.value = baseUrl;
  const npClient = document.getElementById('npClient'); if (npClient) npClient.value = client;

  // Skip step 1 (mode) — go directly to step 2 (scan type)
  showNpStep(2);
}

function renderProjectCards() {
  const gridEl = document.getElementById('projectsGrid');
  const loadMoreEl = document.getElementById('projectsLoadMore');
  if (!gridEl) return;

  const visibleProjects = (isAdmin || isAuditor)
    ? projects
    : projects.filter(p => p.userId === currentUser?.uid);

  // Sort newest first
  const sorted = visibleProjects.slice().sort((a, b) =>
    new Date(b.createdAt || 0) - new Date(a.createdAt || 0)
  );

  const isFree = !isAdmin && !(userProfile && userProfile.plan === 'pro');
  const selfServiceProjects = visibleProjects.filter(p => p.mode !== 'professional');
  const remaining = FREE_PROJECT_LIMIT - selfServiceProjects.length;
  const canCreate = isAdmin || !isFree || remaining > 0;

  let cards = '';
  if (canCreate) {
    cards += `
      <div class="project-card new-project" onclick="showNewProject()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        <span>Nieuw Project</span>
      </div>
    `;
  } else {
    cards += `
      <div class="project-card new-project" onclick="alert('Je hebt je 3 gratis reviews gebruikt. Upgrade naar Pro voor onbeperkte reviews.')" style="opacity:0.5">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        <span>Upgrade naar Pro</span>
      </div>
    `;
  }

  // ── Admin/Auditor: Group by domain ──
  if (isAdmin || isAuditor) {
    const domainMap = new Map();
    sorted.forEach(p => {
      const domain = getProjectGroup(p);
      if (!domainMap.has(domain)) domainMap.set(domain, []);
      domainMap.get(domain).push(p);
    });

    // Sort domains: most reviews first, then most recent
    const domainEntries = Array.from(domainMap.entries()).sort((a, b) => {
      if (b[1].length !== a[1].length) return b[1].length - a[1].length;
      return new Date(b[1][0].createdAt || 0) - new Date(a[1][0].createdAt || 0);
    });

    // Lazy load domains
    const visibleDomains = domainEntries.slice(0, _projectsShown);
    const hasMore = domainEntries.length > _projectsShown;

    visibleDomains.forEach(([domain, domainProjects]) => {
      const totalReviews = domainProjects.length;
      const scores = domainProjects.map(p => calcProjectScore(p)).filter(s => s && s.avg > 0);
      const avgScore = scores.length > 0 ? scores.reduce((sum, s) => sum + s.avg, 0) / scores.length : 0;
      const scoreClass = avgScore >= 7.5 ? 'good' : avgScore >= 5 ? 'ok' : avgScore > 0 ? 'bad' : 'na';
      const completedCount = domainProjects.filter(p => {
        const s = calcProjectScore(p);
        return s && (s.answered + (s.nvt||0)) === s.total;
      }).length;
      const latestDate = new Date(domainProjects[0].createdAt).toLocaleDateString('nl-NL');
      const uniqueUsers = new Set(domainProjects.map(p => p.userId)).size;

      // If only 1 review for this domain, show it directly as a card
      if (totalReviews === 1) {
        cards += renderProjectCard(domainProjects[0]);
        return;
      }

      cards += `
        <div class="project-card domain-group" onclick="showDomainReviews('${domain}')" style="cursor:pointer;position:relative">
          <div class="pc-header">
            <div>
              <div class="pc-name" style="display:flex;align-items:center;gap:6px">
                <i data-lucide="${domainProjects[0].sourceType === 'figma' ? 'figma' : 'globe'}" style="width:14px;height:14px;color:${domainProjects[0].sourceType === 'figma' ? '#a259ff' : 'var(--accent)'}"></i> ${esc(domain)}
              </div>
              <div class="pc-client" style="font-size:11px">${totalReviews} reviews · ${uniqueUsers} gebruiker${uniqueUsers !== 1 ? 's' : ''}</div>
            </div>
            <span class="review-count-badge">${totalReviews}</span>
          </div>
          <div class="domain-group-stats">
            <div class="dg-stat">
              <span class="pc-score-num ${scoreClass}" style="font-size:16px;font-weight:700">${avgScore > 0 ? avgScore.toFixed(1) : '—'}</span>
              <span style="font-size:10px;color:var(--text-muted)">gem. score</span>
            </div>
            <div class="dg-stat">
              <span style="font-size:16px;font-weight:700;color:var(--green)">${completedCount}</span>
              <span style="font-size:10px;color:var(--text-muted)">afgerond</span>
            </div>
            <div class="dg-stat">
              <span style="font-size:16px;font-weight:700">${totalReviews - completedCount}</span>
              <span style="font-size:10px;color:var(--text-muted)">actief</span>
            </div>
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:8px">
            ${(() => {
              const typeCounts = {};
              domainProjects.forEach(p => {
                const tplId = p.selectedTemplate;
                const b = tplId && typeof MODULE_REGISTRY !== 'undefined' ? MODULE_REGISTRY.bundles[tplId] : null;
                const label = b ? b.name_nl.replace(' Quick Scan','') : 'Volledige Audit';
                const icon = b ? b.icon_lucide : 'layout-grid';
                const key = label;
                if (!typeCounts[key]) typeCounts[key] = { count: 0, icon };
                typeCounts[key].count++;
              });
              return Object.entries(typeCounts).map(([label, {count, icon}]) =>
                `<span style="font-size:10px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:2px 8px;display:inline-flex;align-items:center;gap:3px"><i data-lucide="${icon}" style="width:10px;height:10px"></i>${label}${count > 1 ? ' ×' + count : ''}</span>`
              ).join('');
            })()}
          </div>
          <div class="pc-footer">
            <span style="font-size:11px;color:var(--text-muted)">Laatste: ${latestDate}</span>
            <span style="font-size:11px;color:var(--accent);font-weight:600">Bekijk reviews →</span>
          </div>
        </div>
      `;
    });

    // Show/hide load more
    if (loadMoreEl) {
      loadMoreEl.style.display = hasMore ? 'block' : 'none';
      const rem = domainEntries.length - _projectsShown;
      const btn = document.getElementById('loadMoreBtn');
      if (btn && rem > 0) btn.textContent = `Meer laden (${rem} resterend)`;
    }

  } else {
    // ── Regular users: flat list (no grouping) ──
    const visible = sorted.slice(0, _projectsShown);
    const hasMore = sorted.length > _projectsShown;
    visible.forEach(p => { cards += renderProjectCard(p); });
    if (loadMoreEl) {
      loadMoreEl.style.display = hasMore ? 'block' : 'none';
      const rem = sorted.length - _projectsShown;
      const btn = document.getElementById('loadMoreBtn');
      if (btn && rem > 0) btn.textContent = `Meer laden (${rem} resterend)`;
    }
  }

  gridEl.innerHTML = cards;
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

function renderDashboard() { try {
  const statsEl = document.getElementById('dashStats');
  const tabsEl = document.getElementById('dashTabs');

  // Filter: non-admin/auditor users only see their own projects
  const visibleProjects = (isAdmin || isAuditor)
    ? projects
    : projects.filter(p => p.userId === currentUser?.uid);

  const totalProjects = visibleProjects.length;
  const selfServiceProjects = visibleProjects.filter(p => p.mode !== 'professional');
  const completedProjects = visibleProjects.filter(p => {
    const s = calcProjectScore(p);
    return s && (s.answered + (s.nvt||0)) === s.total;
  }).length;
  const needsHelp = visibleProjects.filter(p => { const s = calcProjectScore(p); return s && s.avg > 0 && s.avg < 7; }).length;
  const isFree = !isAdmin && !(userProfile && userProfile.plan === 'pro');
  const remaining = FREE_PROJECT_LIMIT - selfServiceProjects.length;

  // Stats row
  if (isAdmin) {
    const pendingAudits = auditRequests.filter(r => !r.auditStatus || r.auditStatus === 'pending').length;
    const activeAudits = auditRequests.filter(r => r.auditStatus === 'assigned' || r.auditStatus === 'in_progress').length;
    const pendingApps = (typeof auditorApplications !== 'undefined') ? auditorApplications.filter(a => a.status === 'pending').length : 0;
    statsEl.innerHTML = `
      <div class="stat-card"><div class="stat-num accent">${totalProjects}</div><div class="stat-label">Projecten</div></div>
      <div class="stat-card"><div class="stat-num green">${completedProjects}</div><div class="stat-label">Afgerond</div></div>
      <div class="stat-card"><div class="stat-num ${pendingAudits > 0 ? 'yellow' : ''}">${pendingAudits}</div><div class="stat-label">Open Aanvragen</div></div>
      <div class="stat-card"><div class="stat-num blue">${activeAudits}</div><div class="stat-label">Actieve Audits</div></div>
    `;
  } else {
    statsEl.innerHTML = `
      <div class="stat-card"><div class="stat-num accent">${totalProjects}</div><div class="stat-label">Projecten</div></div>
      <div class="stat-card"><div class="stat-num green">${completedProjects}</div><div class="stat-label">Afgerond</div></div>
      <div class="stat-card"><div class="stat-num red">${needsHelp}</div><div class="stat-label">Hulp Nodig</div></div>
      ${isFree ? `<div class="stat-card"><div class="stat-num ${remaining > 0 ? 'yellow' : 'red'}">${remaining > 0 ? remaining : 0}</div><div class="stat-label">Reviews over</div></div>` :
      `<div class="stat-card"><div class="stat-num green">∞</div><div class="stat-label">Onbeperkt</div></div>`}
    `;
  }

  // Show/hide tabs based on role
  if (tabsEl) {
    if (isAdmin) {
      tabsEl.style.display = 'flex';
      document.getElementById('tabAuditQueue').style.display = '';
      document.getElementById('tabAuditorApps').style.display = '';
      document.getElementById('tabUsers').style.display = '';
      document.getElementById('tabSettings').style.display = '';
      // Add badge counts to tabs
      const pendingAudits = auditRequests.filter(r => !r.auditStatus || r.auditStatus === 'pending').length;
      const pendingApps = (typeof auditorApplications !== 'undefined') ? auditorApplications.filter(a => a.status === 'pending').length : 0;
      const queueTab = document.getElementById('tabAuditQueue');
      const appsTab = document.getElementById('tabAuditorApps');
      if (queueTab && pendingAudits > 0) queueTab.innerHTML = `<i data-lucide="clipboard-list" style="width:14px;height:14px"></i> Audit Queue <span class="tab-badge">${pendingAudits}</span>`;
      if (appsTab && pendingApps > 0) appsTab.innerHTML = `<i data-lucide="user-plus" style="width:14px;height:14px"></i> Aanvragen <span class="tab-badge">${pendingApps}</span>`;
    } else {
      tabsEl.style.display = 'none';
    }
  }

  // Render project cards with lazy loading
  _projectsShown = PROJECTS_PER_PAGE;
  renderProjectCards();

  // Admin: render active tab content
  if (isAdmin) {
    // Ensure the sections exist
    switchDashTab(_activeTab);
  }

  // Non-admin sections
  const applyEl = document.getElementById('auditorApplySection');
  if (!isAdmin && !isAuditor && applyEl) {
    applyEl.style.display = '';
    renderAuditorApplySection();
  } else if (applyEl) {
    applyEl.style.display = 'none';
  }

  if (typeof lucide !== 'undefined') lucide.createIcons();
} catch(e) { console.error('[RenderError] renderDashboard:', e); const el = document.getElementById('projectsGrid'); if (el) el.innerHTML = `<div style="padding:24px;text-align:center;color:var(--red)"><p style="font-weight:600">Er ging iets mis bij het laden.</p><p style="font-size:12px;color:var(--text-muted);margin-top:8px">${esc(e.message)}</p><button class="btn btn-secondary" onclick="location.reload()" style="margin-top:12px">Herlaad pagina</button></div>`; } }

function renderAdminConfig() {
  const el = document.getElementById('adminConfigSection');
  if (!el || !isAdmin) return;

  const hasProxy = !!_aiProxyUrl;

  el.innerHTML = `
    <div style="margin-top:24px">
      <h2 style="font-size:18px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px">
        <i data-lucide="settings" style="width:18px;height:18px;color:var(--accent)"></i> Platform Instellingen
      </h2>

      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:16px 20px">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
          <div>
            <div style="font-size:13px;font-weight:700;margin-bottom:4px">AI Actieplan (Proxy URL)</div>
            <div style="font-size:11px;color:var(--text-muted)">${hasProxy ? `Actief · ${_aiProxyUrl}` : 'Niet ingesteld — AI Actieplan is uitgeschakeld'}</div>
            <div style="font-size:10px;color:var(--text-muted);margin-top:4px">Cloudflare Worker URL. API key staat veilig op de server, niet in de browser.</div>
          </div>
          <div style="display:flex;gap:6px">
            <input type="url" id="adminAiProxyInput" placeholder="https://bold700-ai.workers.dev" value="${_aiProxyUrl || ''}" style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px 10px;font-size:12px;color:var(--text);width:320px;font-family:monospace;outline:none" />
            <button class="btn btn-accent btn-sm" onclick="saveAiConfig(document.getElementById('adminAiProxyInput').value.trim())">Opslaan</button>
          </div>
        </div>
      </div>
    </div>`;

  if (typeof lucide !== 'undefined') lucide.createIcons();
}

// ═══════════════ ADMIN: USER MANAGEMENT ═══════════════
let allUsers = [];

async function loadAllUsers() {
  if (!isAdmin) return;
  try {
    const snapshot = await db.collection('users').get();
    allUsers = snapshot.docs.map(d => ({ uid: d.id, ...d.data() }));
    allUsers.sort((a, b) => (a.email || '').localeCompare(b.email || ''));
    console.log('[Admin] Loaded', allUsers.length, 'users');
  } catch(e) {
    console.warn('[Firebase] Users load failed:', e.message);
    allUsers = [];
  }
}

async function changeUserRole(uid, newRole) {
  if (!isAdmin || !uid) return;
  // Safety: can't change your own role
  if (uid === currentUser?.uid) { alert('Je kunt je eigen rol niet wijzigen.'); return; }
  const validRoles = ['user', 'auditor', 'admin'];
  if (!validRoles.includes(newRole)) return;

  try {
    await db.collection('users').doc(uid).update({ role: newRole });
    // Update local cache
    const u = allUsers.find(u => u.uid === uid);
    if (u) u.role = newRole;
    // Also update allAuditors cache
    if (newRole === 'auditor') {
      if (!allAuditors.find(a => a.uid === uid)) allAuditors.push(u || { uid });
    } else {
      allAuditors = allAuditors.filter(a => a.uid !== uid);
    }
    showScanToast('success', 'Rol bijgewerkt', `${u?.email || uid} is nu ${newRole}`, 3000);
    renderUserManagement();
  } catch(e) {
    console.error('[Firebase] Role change failed:', e);
    showScanToast('error', 'Rol wijzigen mislukt', e.message, 4000);
  }
}

async function changeUserPlan(uid, newPlan) {
  if (!isAdmin || !uid) return;
  try {
    await db.collection('users').doc(uid).update({ plan: newPlan });
    const u = allUsers.find(u => u.uid === uid);
    if (u) u.plan = newPlan;
    showScanToast('success', 'Plan bijgewerkt', `${u?.email || uid} is nu ${newPlan}`, 3000);
    renderUserManagement();
  } catch(e) {
    console.error('[Firebase] Plan change failed:', e);
    showScanToast('error', 'Plan wijzigen mislukt', e.message, 4000);
  }
}

async function renderUserManagement() { try {
  const el = document.getElementById('userManagementSection');
  if (!el) return;

  // Load users if not yet loaded
  if (allUsers.length === 0) await loadAllUsers();

  const roleIcons = { admin: 'shield', auditor: 'briefcase', user: 'user' };
  const roleColors = { admin: 'var(--accent)', auditor: '#a855f7', user: 'var(--text-muted)' };
  const planColors = { pro: 'var(--green)', free: 'var(--text-muted)' };

  el.innerHTML = `
    <div style="margin-top:24px">
      <h2 style="font-size:18px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px">
        <i data-lucide="users" style="width:18px;height:18px;color:var(--accent)"></i> Gebruikers Beheer
        <span style="font-size:12px;font-weight:400;color:var(--text-muted)">${allUsers.length} gebruikers</span>
      </h2>
      <div class="audit-queue-wrap">
        <table class="audit-queue-table">
          <thead><tr>
            <th>E-mail</th>
            <th>Rol</th>
            <th>Plan</th>
            <th>Projecten</th>
            <th>Aangemeld</th>
            <th>Acties</th>
          </tr></thead>
          <tbody>
            ${allUsers.map(u => {
              const isSelf = u.uid === currentUser?.uid;
              const role = u.role || 'user';
              const plan = u.plan || 'free';
              const userProjectCount = projects.filter(p => p.userId === u.uid).length;
              return `<tr>
                <td>
                  <div style="display:flex;align-items:center;gap:8px">
                    <i data-lucide="${roleIcons[role] || 'user'}" style="width:14px;height:14px;color:${roleColors[role] || 'var(--text-muted)'}"></i>
                    <span style="font-size:13px">${esc(u.email || u.uid)}</span>
                    ${isSelf ? '<span style="font-size:9px;background:var(--accent);color:#fff;padding:1px 5px;border-radius:4px;font-weight:700">JIJ</span>' : ''}
                  </div>
                </td>
                <td>
                  ${isSelf ? `<span class="role-tag role-${role}">${role}</span>` : `
                  <select class="role-select" onchange="changeUserRole('${u.uid}', this.value)" ${isSelf ? 'disabled' : ''}>
                    <option value="user" ${role === 'user' ? 'selected' : ''}>User</option>
                    <option value="auditor" ${role === 'auditor' ? 'selected' : ''}>Auditor</option>
                    <option value="admin" ${role === 'admin' ? 'selected' : ''}>Admin</option>
                  </select>`}
                </td>
                <td>
                  <select class="role-select" onchange="changeUserPlan('${u.uid}', this.value)">
                    <option value="free" ${plan === 'free' ? 'selected' : ''}>Free</option>
                    <option value="pro" ${plan === 'pro' ? 'selected' : ''}>Pro</option>
                  </select>
                </td>
                <td>
                  ${userProjectCount > 0 ? `<button class="btn btn-sm" onclick="showUserProjects('${u.uid}','${(u.email || u.uid).replace(/'/g, "\\'")}')" style="font-size:11px;padding:3px 8px">${userProjectCount} <i data-lucide="external-link" style="width:10px;height:10px"></i></button>` : '<span style="font-size:11px;color:var(--text-muted)">0</span>'}
                </td>
                <td style="font-size:11px;color:var(--text-muted)">${u.createdAt ? new Date(u.createdAt).toLocaleDateString('nl-NL') : '—'}</td>
                <td>
                  <div style="display:flex;align-items:center;gap:6px">
                    ${u.role === 'auditor' ? `<span style="font-size:10px;color:#a855f7"><i data-lucide="briefcase" style="width:10px;height:10px"></i> Auditor</span>` : ''}
                    ${!isSelf ? `<button class="btn-reject" onclick="adminDeleteUser('${u.uid}','${(u.email || u.uid).replace(/'/g, "\\'")}')" style="font-size:10px;padding:2px 6px" title="Verwijder profiel"><i data-lucide="trash-2" style="width:10px;height:10px"></i></button>` : ''}
                  </div>
                </td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>`;

  if (typeof lucide !== 'undefined') lucide.createIcons();
} catch(e) { console.error('[RenderError] renderUserManagement:', e); const el = document.getElementById('userManagementSection'); if (el) el.innerHTML = `<div style="padding:24px;text-align:center;color:var(--red)"><p style="font-weight:600">Er ging iets mis bij het laden.</p><p style="font-size:12px;color:var(--text-muted);margin-top:8px">${esc(e.message)}</p><button class="btn btn-secondary" onclick="location.reload()" style="margin-top:12px">Herlaad pagina</button></div>`; } }

// ═══════════════ ADMIN: PROJECT MANAGEMENT PER USER ═══════════════
function showUserProjects(uid, email) {
  if (!isAdmin) return;
  const userProjects = projects.filter(p => p.userId === uid);
  if (userProjects.length === 0) { showScanToast('info', 'Geen projecten', `${email} heeft geen projecten.`, 2000); return; }

  // Build user list for reassignment (exclude current owner)
  const otherUsers = allUsers.filter(u => u.uid !== uid);

  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };

  const pkgLabels = { quick: 'Quick Scan', deep: 'Deep Review', full: 'Full Audit' };

  overlay.innerHTML = `
    <div class="modal-box" style="max-width:600px;max-height:80vh;overflow-y:auto">
      <h3 style="font-size:16px;font-weight:700;margin:0 0 16px;display:flex;align-items:center;gap:8px">
        <i data-lucide="folder" style="width:16px;height:16px;color:var(--accent)"></i>
        Projecten van ${esc(email)}
        <span style="font-size:12px;font-weight:400;color:var(--text-muted)">${userProjects.length} project${userProjects.length !== 1 ? 'en' : ''}</span>
      </h3>
      <div style="display:flex;flex-direction:column;gap:8px">
        ${userProjects.map(p => {
          const score = calcProjectScore(p) || { avg: 0 };
          const mode = p.mode === 'professional' ? 'Professional' : 'Self-Service';
          return `
          <div class="application-row" style="flex-wrap:wrap;gap:8px" id="uproj-${p.id}">
            <div class="app-info" style="min-width:180px">
              <div class="app-email">${esc(p.name || '—')}</div>
              <div class="app-msg">${esc(p.url || '—')} · ${mode} · ${score.avg > 0 ? score.avg.toFixed(1) : '—'}</div>
            </div>
            <div class="app-date">${p.createdAt ? new Date(p.createdAt).toLocaleDateString('nl-NL') : '—'}</div>
            <div class="app-actions" style="flex-wrap:wrap">
              <select class="role-select" id="reassign-${p.id}" style="font-size:10px;padding:2px 6px;max-width:160px">
                <option value="">Hertoewijzen aan...</option>
                ${otherUsers.map(u => `<option value="${u.uid}">${u.email || u.uid}</option>`).join('')}
              </select>
              <button class="btn-approve" onclick="reassignProject('${p.id}', document.getElementById('reassign-${p.id}').value)" style="font-size:10px">
                <i data-lucide="arrow-right" style="width:10px;height:10px"></i> Wijs toe
              </button>
              <button class="btn-reject" onclick="adminDeleteProject('${p.id}','${uid}','${email.replace(/'/g, "\\'")}')" style="font-size:10px">
                <i data-lucide="trash-2" style="width:10px;height:10px"></i> Verwijder
              </button>
            </div>
          </div>`;
        }).join('')}
      </div>
      <div style="margin-top:16px;text-align:right">
        <button class="btn btn-secondary btn-sm" onclick="this.closest('.modal-overlay').remove()">Sluiten</button>
      </div>
    </div>`;

  document.body.appendChild(overlay);
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

async function reassignProject(projectId, newUserId) {
  if (!isAdmin || !projectId || !newUserId) {
    showScanToast('error', 'Selecteer gebruiker', 'Kies eerst een gebruiker om aan toe te wijzen.', 2000);
    return;
  }
  const newUser = allUsers.find(u => u.uid === newUserId);
  try {
    await db.collection('projects').doc(projectId).update({
      userId: newUserId,
      leadEmail: newUser?.email || ''
    });
    // Update local cache
    const p = projects.find(p => p.id === projectId);
    if (p) { p.userId = newUserId; p.leadEmail = newUser?.email || ''; }
    showScanToast('success', 'Hertoegewezen', `Project naar ${newUser?.email || newUserId}`, 3000);
    // Remove row from modal
    const row = document.getElementById('uproj-' + projectId);
    if (row) row.style.display = 'none';
  } catch(e) {
    console.error('[Firebase] Reassign failed:', e);
    showScanToast('error', 'Mislukt', e.message, 4000);
  }
}

async function adminDeleteProject(projectId, ownerUid, ownerEmail) {
  if (!isAdmin || !projectId) return;
  if (!confirm(`Project "${projectId}" verwijderen van ${ownerEmail}? Dit kan niet ongedaan worden.`)) return;
  try {
    await db.collection('projects').doc(projectId).delete();
    projects = projects.filter(p => p.id !== projectId);
    showScanToast('success', 'Verwijderd', 'Project is verwijderd.', 3000);
    const row = document.getElementById('uproj-' + projectId);
    if (row) row.style.display = 'none';
  } catch(e) {
    console.error('[Firebase] Delete failed:', e);
    showScanToast('error', 'Verwijderen mislukt', e.message, 4000);
  }
}

async function adminDeleteUser(uid, email) {
  if (!isAdmin || !uid) return;
  if (uid === currentUser?.uid) { showScanToast('error', 'Niet mogelijk', 'Je kunt je eigen profiel niet verwijderen.', 3000); return; }

  const userProjects = projects.filter(p => p.userId === uid);
  const msg = userProjects.length > 0
    ? `Profiel "${email}" verwijderen inclusief ${userProjects.length} project(en)?\n\nDit verwijdert:\n• Gebruikersprofiel uit Firestore\n• Alle ${userProjects.length} project(en)\n• Eventuele auditor aanvraag\n\nDit kan niet ongedaan worden.`
    : `Profiel "${email}" verwijderen uit Firestore?\n\nDit kan niet ongedaan worden.`;

  if (!confirm(msg)) return;

  try {
    // Delete all user's projects
    for (const p of userProjects) {
      await db.collection('projects').doc(p.id).delete();
    }
    projects = projects.filter(p => p.userId !== uid);

    // Delete auditor application if exists
    try { await db.collection('auditor_applications').doc(uid).delete(); } catch(e) {}

    // Delete user profile
    await db.collection('users').doc(uid).delete();

    // Update local caches
    allUsers = allUsers.filter(u => u.uid !== uid);
    allAuditors = allAuditors.filter(a => a.uid !== uid);
    auditorApplications = auditorApplications.filter(a => a.id !== uid);

    showScanToast('success', 'Profiel verwijderd', `${email} en ${userProjects.length} project(en) verwijderd.`, 4000);
    renderUserManagement();
    renderDashboard();
  } catch(e) {
    console.error('[Firebase] User delete failed:', e);
    showScanToast('error', 'Verwijderen mislukt', e.message, 4000);
  }
}

// ═══════════════ AUDITOR APPLICATION ═══════════════
let myAuditorApplication = null; // Cached application status for current user

async function checkAuditorApplication() {
  if (!currentUser || isAdmin || isAuditor) { myAuditorApplication = null; return; }
  try {
    const doc = await db.collection('auditor_applications').doc(currentUser.uid).get();
    myAuditorApplication = doc.exists ? doc.data() : null;
  } catch(e) {
    console.warn('[Firebase] Could not check auditor application:', e.message);
    myAuditorApplication = null;
  }
}

async function submitAuditorApplication() {
  if (!currentUser) return;
  const textarea = document.getElementById('auditorApplyMsg');
  const message = textarea ? textarea.value.trim() : '';
  if (message.length < 10) {
    showScanToast('error', 'Te kort', 'Schrijf minimaal een korte motivatie (10+ tekens).', 3000);
    return;
  }

  const btn = document.getElementById('auditorApplyBtn');
  if (btn) { btn.disabled = true; btn.innerHTML = '<i data-lucide="loader" style="width:12px;height:12px;animation:spin 1s linear infinite"></i> Versturen...'; }

  try {
    const application = {
      userId: currentUser.uid,
      email: currentUser.email,
      displayName: currentUser.displayName || currentUser.email,
      message: message,
      status: 'pending',
      createdAt: new Date().toISOString()
    };
    await db.collection('auditor_applications').doc(currentUser.uid).set(application);
    myAuditorApplication = application;
    showScanToast('success', 'Aanvraag verstuurd!', 'We beoordelen je aanvraag zo snel mogelijk.', 4000);
    renderAuditorApplySection();
  } catch(e) {
    console.error('[Firebase] Application submit failed:', e);
    showScanToast('error', 'Mislukt', 'Kon aanvraag niet versturen: ' + e.message, 4000);
    if (btn) { btn.disabled = false; btn.innerHTML = '<i data-lucide="send" style="width:12px;height:12px"></i> Aanvraag Versturen'; }
  }
}

function renderAuditorApplySection() {
  // Only show for regular users (not admin, not auditor)
  if (isAdmin || isAuditor) return;

  let el = document.getElementById('auditorApplySection');
  if (!el) {
    el = document.createElement('div');
    el.id = 'auditorApplySection';
    const gridEl = document.getElementById('projectsGrid');
    if (gridEl && gridEl.parentElement) gridEl.parentElement.appendChild(el);
    else return;
  }

  // Already an auditor? Don't show
  if (userProfile && userProfile.role === 'auditor') { el.innerHTML = ''; return; }

  const app = myAuditorApplication;

  if (app && app.status === 'pending') {
    // Application submitted, waiting
    el.innerHTML = `
      <div class="auditor-apply-card">
        <h3><i data-lucide="clock" style="width:18px;height:18px"></i> Auditor Aanvraag Verstuurd</h3>
        <div class="apply-status status-pending">
          <i data-lucide="hourglass" style="width:14px;height:14px"></i>
          Je aanvraag wordt beoordeeld. We laten je zo snel mogelijk weten of je bent goedgekeurd.
        </div>
        <p style="margin-top:10px;font-size:11px;color:var(--text-muted)">Ingediend op ${app.createdAt ? new Date(app.createdAt).toLocaleDateString('nl-NL', { day: 'numeric', month: 'long', year: 'numeric' }) : '—'}</p>
      </div>`;
  } else if (app && app.status === 'rejected') {
    // Rejected — can reapply
    el.innerHTML = `
      <div class="auditor-apply-card">
        <h3><i data-lucide="briefcase" style="width:18px;height:18px"></i> Word Auditor</h3>
        <div class="apply-status status-rejected">
          <i data-lucide="x-circle" style="width:14px;height:14px"></i>
          Je eerdere aanvraag is helaas afgewezen.${app.rejectReason ? ' Reden: ' + app.rejectReason : ''}
        </div>
        <p style="margin-top:12px">Je kunt opnieuw een aanvraag indienen met aanvullende informatie.</p>
        <div class="auditor-apply-form">
          <textarea id="auditorApplyMsg" placeholder="Vertel waarom je een goede UX auditor zou zijn. Bijv. ervaring, achtergrond, motivatie..."></textarea>
          <button class="btn-auditor" id="auditorApplyBtn" onclick="submitAuditorApplication()" style="margin-top:8px">
            <i data-lucide="send" style="width:12px;height:12px"></i> Opnieuw Aanvragen
          </button>
        </div>
      </div>`;
  } else {
    // No application yet — show apply form
    el.innerHTML = `
      <div class="auditor-apply-card">
        <h3><i data-lucide="briefcase" style="width:18px;height:18px"></i> Word Auditor</h3>
        <p>Heb je ervaring met UX en wil je professionele audits uitvoeren voor klanten? Vraag het auditor-account aan.</p>
        <div class="apply-perks">
          <div class="apply-perk"><i data-lucide="check-circle" style="width:12px;height:12px"></i> Voer audits uit voor klanten</div>
          <div class="apply-perk"><i data-lucide="check-circle" style="width:12px;height:12px"></i> Claim open aanvragen</div>
          <div class="apply-perk"><i data-lucide="check-circle" style="width:12px;height:12px"></i> Auditor badge op je profiel</div>
        </div>
        <div class="auditor-apply-form">
          <textarea id="auditorApplyMsg" placeholder="Vertel kort over je UX-ervaring en waarom je auditor wilt worden..."></textarea>
          <button class="btn-auditor" id="auditorApplyBtn" onclick="submitAuditorApplication()" style="margin-top:8px">
            <i data-lucide="send" style="width:12px;height:12px"></i> Aanvraag Versturen
          </button>
        </div>
      </div>`;
  }

  if (typeof lucide !== 'undefined') lucide.createIcons();
}

// ── Admin: load & manage auditor applications ──
let auditorApplications = [];

async function loadAuditorApplications() {
  if (!isAdmin) return;
  try {
    const snapshot = await db.collection('auditor_applications').get();
    auditorApplications = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    auditorApplications.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));
  } catch(e) {
    console.warn('[Firebase] Auditor applications load failed:', e.message);
    auditorApplications = [];
  }
}

async function approveAuditorApplication(userId) {
  if (!isAdmin || !userId) return;
  try {
    // Update application status
    await db.collection('auditor_applications').doc(userId).update({ status: 'approved', reviewedAt: new Date().toISOString(), reviewedBy: currentUser.uid });
    // Change user role to auditor
    await db.collection('users').doc(userId).update({ role: 'auditor' });
    // Update local caches
    const app = auditorApplications.find(a => a.id === userId);
    if (app) app.status = 'approved';
    const user = allUsers.find(u => u.uid === userId);
    if (user) user.role = 'auditor';
    if (!allAuditors.find(a => a.uid === userId)) allAuditors.push(user || { uid: userId });
    showScanToast('success', 'Goedgekeurd!', `${app?.email || userId} is nu auditor.`, 3000);
    renderAuditorApplicationsAdmin();
    renderUserManagement();
  } catch(e) {
    console.error('[Firebase] Approve application failed:', e);
    showScanToast('error', 'Goedkeuring mislukt', e.message, 4000);
  }
}

async function rejectAuditorApplication(userId) {
  if (!isAdmin || !userId) return;
  try {
    await db.collection('auditor_applications').doc(userId).update({ status: 'rejected', reviewedAt: new Date().toISOString(), reviewedBy: currentUser.uid });
    const app = auditorApplications.find(a => a.id === userId);
    if (app) app.status = 'rejected';
    showScanToast('success', 'Afgewezen', `Aanvraag van ${app?.email || userId} afgewezen.`, 3000);
    renderAuditorApplicationsAdmin();
  } catch(e) {
    console.error('[Firebase] Reject application failed:', e);
    showScanToast('error', 'Afwijzing mislukt', e.message, 4000);
  }
}

function renderAuditorApplicationsAdmin() {
  let el = document.getElementById('auditorApplicationsSection');
  if (!el || !isAdmin) return;

  const pending = auditorApplications.filter(a => a.status === 'pending');
  const recent = auditorApplications.filter(a => a.status !== 'pending').slice(0, 5);

  if (auditorApplications.length === 0) {
    el.innerHTML = '';
    return;
  }

  el.innerHTML = `
    <div style="margin-top:24px">
      <h2 style="font-size:18px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px">
        <i data-lucide="user-check" style="width:18px;height:18px;color:#a855f7"></i> Auditor Aanvragen
        ${pending.length > 0 ? `<span class="audit-badge pending">${pending.length} nieuw</span>` : ''}
      </h2>
      ${pending.length > 0 ? `
        <div style="margin-bottom:12px">
          ${pending.map(a => `
            <div class="application-row">
              <div class="app-info">
                <div class="app-email">${esc(a.email || a.displayName || a.id)}</div>
                <div class="app-msg" title="${(a.message || '').replace(/"/g, '&quot;')}">${esc(a.message || '—')}</div>
              </div>
              <div class="app-date">${a.createdAt ? new Date(a.createdAt).toLocaleDateString('nl-NL') : '—'}</div>
              <div class="app-actions">
                <button class="btn-approve" onclick="approveAuditorApplication('${a.id}')"><i data-lucide="check" style="width:10px;height:10px"></i> Goedkeuren</button>
                <button class="btn-reject" onclick="rejectAuditorApplication('${a.id}')"><i data-lucide="x" style="width:10px;height:10px"></i> Afwijzen</button>
              </div>
            </div>
          `).join('')}
        </div>
      ` : '<div style="color:var(--text-muted);font-size:13px;margin-bottom:12px">Geen openstaande aanvragen.</div>'}
      ${recent.length > 0 ? `
        <details style="margin-top:4px">
          <summary style="font-size:12px;color:var(--text-muted);cursor:pointer;user-select:none">Recent beoordeeld (${recent.length})</summary>
          <div style="margin-top:8px">
            ${recent.map(a => `
              <div class="application-row" style="opacity:0.6">
                <div class="app-info">
                  <div class="app-email">${esc(a.email || a.id)}</div>
                </div>
                <span class="role-tag role-${a.status === 'approved' ? 'auditor' : 'user'}">${a.status === 'approved' ? 'Goedgekeurd' : 'Afgewezen'}</span>
                <div class="app-date">${a.reviewedAt ? new Date(a.reviewedAt).toLocaleDateString('nl-NL') : '—'}</div>
              </div>
            `).join('')}
          </div>
        </details>
      ` : ''}
    </div>`;

  if (typeof lucide !== 'undefined') lucide.createIcons();
}

// ═══════════════ ADMIN: AUDIT QUEUE ═══════════════
function renderAuditQueue() { try {
  const el = document.getElementById('auditQueueSection');
  if (!el) return;

  const pending = auditRequests.filter(r => !r.auditStatus || r.auditStatus === 'pending');
  const assigned = auditRequests.filter(r => r.auditStatus === 'assigned');
  const inProgress = auditRequests.filter(r => r.auditStatus === 'in_progress');
  const completed = auditRequests.filter(r => r.auditStatus === 'completed');
  const pkgLabels = { quick: 'Quick Scan', deep: 'Deep Review', full: 'Full Audit' };

  function auditRow(r, showActions) {
    const st = r.auditStatus || 'pending';
    const stLabel = { pending: 'In afwachting', assigned: 'Toegewezen', in_progress: 'Bezig', completed: 'Afgerond' }[st];
    return `<tr class="aq-row">
      <td><strong>${esc(r.name || '—')}</strong>${r.client ? '<br><span style="font-size:11px;color:var(--text-muted)">' + esc(r.client) + '</span>' : ''}</td>
      <td style="font-size:12px">${r.url ? esc(r.url.replace(/^https?:\/\/(www\.)?/, '').substring(0, 30)) : '—'}</td>
      <td><span class="audit-badge ${st}">${stLabel}</span></td>
      <td style="font-size:12px">${pkgLabels[r.package] || r.package || '—'}</td>
      <td style="font-size:12px">${esc(r.assignedToName) || '<span style="color:var(--text-muted)">—</span>'}</td>
      <td style="font-size:11px;color:var(--text-muted)">${r.createdAt ? new Date(r.createdAt).toLocaleDateString('nl-NL') : '—'}</td>
      <td>${showActions ? `<button class="btn btn-sm btn-accent" onclick="event.stopPropagation();showAssignModal('${r.id}')"><i data-lucide="user-plus" style="width:11px;height:11px"></i> Toewijzen</button>` :
        st === 'assigned' ? `<button class="btn btn-sm" onclick="event.stopPropagation();showAssignModal('${r.id}')">Herwijzen</button>` :
        st === 'completed' ? `<button class="btn btn-sm" onclick="event.stopPropagation();openProject('${r.id}')">Bekijk</button>` : ''}</td>
    </tr>`;
  }

  el.innerHTML = `
    <div style="margin-top:24px">
      <h2 style="font-size:18px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px">
        <i data-lucide="clipboard-list" style="width:18px;height:18px;color:var(--accent)"></i> Audit Aanvragen
        ${pending.length > 0 ? `<span class="audit-badge pending">${pending.length} nieuw</span>` : ''}
      </h2>
      ${auditRequests.length === 0 ? '<div style="color:var(--text-muted);font-size:13px;padding:20px 0">Nog geen audit aanvragen.</div>' : `
      <div class="audit-queue-wrap">
        <table class="audit-queue-table">
          <thead><tr>
            <th>Project</th><th>Website</th><th>Status</th><th>Pakket</th><th>Auditor</th><th>Datum</th><th>Acties</th>
          </tr></thead>
          <tbody>
            ${pending.map(r => auditRow(r, true)).join('')}
            ${assigned.map(r => auditRow(r, false)).join('')}
            ${inProgress.map(r => auditRow(r, false)).join('')}
            ${completed.map(r => auditRow(r, false)).join('')}
          </tbody>
        </table>
      </div>`}
    </div>`;

  if (typeof lucide !== 'undefined') lucide.createIcons();
} catch(e) { console.error('[RenderError] renderAuditQueue:', e); const el = document.getElementById('auditQueueSection'); if (el) el.innerHTML = `<div style="padding:24px;text-align:center;color:var(--red)"><p style="font-weight:600">Er ging iets mis bij het laden.</p><p style="font-size:12px;color:var(--text-muted);margin-top:8px">${esc(e.message)}</p><button class="btn btn-secondary" onclick="location.reload()" style="margin-top:12px">Herlaad pagina</button></div>`; } }

// ── Admin: Auditor assignment modal ──
async function showAssignModal(projectId) {
  await loadAuditors();
  const project = auditRequests.find(r => r.id === projectId) || projects.find(p => p.id === projectId);
  if (!project) return;

  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };

  const auditorList = allAuditors.length > 0
    ? allAuditors.map(a => `
      <div class="auditor-option" onclick="selectAuditorAndAssign('${projectId}', '${a.uid}', '${(a.email || '').replace(/'/g, '')}', this)">
        <div class="auditor-option-info">
          <strong>${esc(a.email || a.uid)}</strong>
          ${a.auditCount ? `<span style="font-size:10px;color:var(--text-muted)">${a.auditCount} audits voltooid</span>` : ''}
        </div>
        <i data-lucide="chevron-right" style="width:14px;height:14px;color:var(--text-muted)"></i>
      </div>`).join('')
    : '<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:13px">Geen auditors gevonden.<br>Maak eerst een account aan met role: auditor.</div>';

  overlay.innerHTML = `
    <div class="modal-box">
      <div class="modal-header">
        <h3>Auditor Toewijzen</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
      </div>
      <div class="modal-sub">Project: <strong>${esc(project.name)}</strong> · ${esc(project.client || project.url)}</div>
      <div class="modal-body">${auditorList}</div>
    </div>`;

  document.body.appendChild(overlay);
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

async function selectAuditorAndAssign(projectId, auditorId, auditorName, el) {
  el.style.opacity = '0.5';
  el.style.pointerEvents = 'none';
  await assignToAuditor(projectId, auditorId, auditorName);
  const overlay = el.closest('.modal-overlay');
  if (overlay) overlay.remove();
}

// ═══════════════ AUDITOR DASHBOARD ═══════════════
function showAuditorDashboard() {
  if (!currentUser) { showAuthScreen(); return; }
  document.getElementById('authScreen').classList.add('hidden');
  document.getElementById('dashboardScreen').classList.remove('hidden');
  document.getElementById('newProjectScreen').classList.add('hidden');
  document.getElementById('reviewScreen').classList.add('hidden');
  document.getElementById('scorecardScreen').classList.add('hidden');
  clearUrlParam('p');
  document.body.style.overflow = 'hidden';

  const emailEl = document.getElementById('dashUserEmail');
  if (emailEl && currentUser) emailEl.textContent = currentUser.email;
  const roleBadge = document.getElementById('dashRoleBadge');
  if (roleBadge) { roleBadge.textContent = 'Auditor'; roleBadge.className = 'role-badge role-auditor'; }

  renderAuditorDashboard();
}

function renderAuditorDashboard() { try {
  const statsEl = document.getElementById('dashStats');
  const gridEl = document.getElementById('projectsGrid');
  const uid = currentUser?.uid;

  const myAssigned = auditRequests.filter(r => r.assignedTo === uid && (r.auditStatus === 'assigned' || r.auditStatus === 'in_progress'));
  const myCompleted = auditRequests.filter(r => r.assignedTo === uid && r.auditStatus === 'completed');
  const openRequests = auditRequests.filter(r => !r.auditStatus || r.auditStatus === 'pending');
  const pkgLabels = { quick: 'Quick Scan', deep: 'Deep Review', full: 'Full Audit' };

  // Own self-service projects (not assigned audits)
  const assignedIds = new Set(auditRequests.filter(r => r.assignedTo === uid).map(r => r.id));
  const myOwnProjects = projects.filter(p => p.userId === uid && !assignedIds.has(p.id));

  statsEl.innerHTML = `
    <div class="stat-card"><div class="stat-num accent">${myAssigned.length}</div><div class="stat-label">Actieve Audits</div></div>
    <div class="stat-card"><div class="stat-num green">${myCompleted.length}</div><div class="stat-label">Audit Afgerond</div></div>
    <div class="stat-card"><div class="stat-num ${openRequests.length > 0 ? 'yellow' : ''}">${openRequests.length}</div><div class="stat-label">Open Aanvragen</div></div>
    <div class="stat-card"><div class="stat-num">${myOwnProjects.length}</div><div class="stat-label">Eigen Reviews</div></div>
  `;

  let html = '';

  // ── Mijn Audits (assigned + in_progress) ──
  if (myAssigned.length > 0) {
    html += '<h2 style="font-size:16px;font-weight:700;margin:0 0 12px;grid-column:1/-1;display:flex;align-items:center;gap:6px"><i data-lucide="clipboard-check" style="width:16px;height:16px;color:var(--accent)"></i> Mijn Audits</h2>';
    myAssigned.forEach(r => {
      const st = r.auditStatus || 'assigned';
      html += `
        <div class="project-card professional" onclick="${st === 'assigned' ? `updateAuditStatus('${r.id}','in_progress');openProject('${r.id}')` : `openProject('${r.id}')`}" style="position:relative;cursor:pointer">
          <div class="pc-header">
            <div>
              <div class="pc-name">${esc(r.name)}</div>
              ${r.client ? `<div class="pc-client">${esc(r.client)}</div>` : ''}
            </div>
            <span class="audit-badge ${st}">${st === 'assigned' ? 'Start Audit' : 'Bezig'}</span>
          </div>
          <div class="pc-url">${esc(r.url)}</div>
          <div class="pc-footer">
            <span class="pc-package">${pkgLabels[r.package] || 'Professional'}</span>
            <span>${r.assignedAt ? new Date(r.assignedAt).toLocaleDateString('nl-NL') : '—'}</span>
          </div>
        </div>`;
    });
  }

  // ── Open Aanvragen (claimable) ──
  if (openRequests.length > 0) {
    html += '<h2 style="font-size:16px;font-weight:700;margin:16px 0 12px;grid-column:1/-1;display:flex;align-items:center;gap:6px"><i data-lucide="inbox" style="width:16px;height:16px;color:var(--yellow)"></i> Open Aanvragen</h2>';
    openRequests.forEach(r => {
      html += `
        <div class="project-card" style="position:relative">
          <div class="pc-header">
            <div>
              <div class="pc-name">${esc(r.name)}</div>
              ${r.client ? `<div class="pc-client">${esc(r.client)}</div>` : ''}
            </div>
            <span class="audit-badge pending">Open</span>
          </div>
          <div class="pc-url">${esc(r.url)}</div>
          <div class="pc-footer">
            <span class="pc-package">${pkgLabels[r.package] || 'Professional'}</span>
            <span>${r.createdAt ? new Date(r.createdAt).toLocaleDateString('nl-NL') : '—'}</span>
          </div>
          <button class="btn btn-accent btn-sm" style="margin-top:8px;width:100%" onclick="event.stopPropagation();claimAuditRequest('${r.id}')"><i data-lucide="hand" style="width:12px;height:12px"></i> Claim deze audit</button>
        </div>`;
    });
  }

  // ── Afgeronde Audits ──
  if (myCompleted.length > 0) {
    html += '<h2 style="font-size:16px;font-weight:700;margin:16px 0 12px;grid-column:1/-1;display:flex;align-items:center;gap:6px"><i data-lucide="check-circle" style="width:16px;height:16px;color:var(--green)"></i> Afgerond</h2>';
    myCompleted.forEach(r => {
      html += `
        <div class="project-card" onclick="openProject('${r.id}')" style="position:relative;cursor:pointer;opacity:0.7">
          <div class="pc-header">
            <div>
              <div class="pc-name">${esc(r.name)}</div>
              ${r.client ? `<div class="pc-client">${esc(r.client)}</div>` : ''}
            </div>
            <span class="audit-badge completed">Afgerond</span>
          </div>
          <div class="pc-url">${esc(r.url)}</div>
          <div class="pc-footer">
            <span class="pc-package">${pkgLabels[r.package] || 'Professional'}</span>
            <span>${r.completedAt ? new Date(r.completedAt).toLocaleDateString('nl-NL') : '—'}</span>
          </div>
        </div>`;
    });
  }

  // ── Eigen Reviews (self-service projects) ──
  html += `<h2 style="font-size:16px;font-weight:700;margin:16px 0 12px;grid-column:1/-1;display:flex;align-items:center;gap:6px"><i data-lucide="folder" style="width:16px;height:16px;color:var(--accent)"></i> Mijn Eigen Reviews</h2>`;

  // "New project" card
  html += `
    <div class="project-card new-project" onclick="showNewProject()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      <span>Eigen Review</span>
    </div>`;

  if (myOwnProjects.length > 0) {
    myOwnProjects.slice().reverse().forEach(p => {
      const score = calcProjectScore(p) || { answered: 0, total: 1, avg: 0, nvt: 0 };
      const pct = Math.min(Math.round((score.answered / score.total) * 100), 100);
      const scoreClass = score.avg >= 7.5 ? 'good' : score.avg >= 5 ? 'ok' : score.avg > 0 ? 'bad' : 'na';
      const status = pct === 100 ? 'completed' : pct > 0 ? 'in-progress' : 'not-started';
      const statusLabel = pct === 100 ? 'Afgerond' : pct > 0 ? `${pct}% klaar` : 'Niet gestart';

      html += `
        <div class="project-card" onclick="openProject('${p.id}')" style="position:relative;cursor:pointer">
          <button class="pc-preview-btn" onclick="event.stopPropagation();showPreviewModal('${p.id}')" title="Preview link voor lead"><i data-lucide="share-2" style="width:12px;height:12px"></i></button>
          <button class="pc-delete" onclick="event.stopPropagation();deleteProject('${p.id}')" title="Verwijder project">×</button>
          <div class="pc-header">
            <div>
              <div class="pc-name">${esc(p.name)}</div>
              ${p.client ? `<div class="pc-client">${esc(p.client)}</div>` : ''}
            </div>
            <span class="pc-badge ${status}">${statusLabel}</span>
          </div>
          <div class="pc-url">${esc(p.url)}</div>
          <div class="pc-score-bar">
            <div class="bar-track"><div class="bar-fill ${scoreClass}" style="width:${score.avg > 0 ? score.avg * 10 : 0}%"></div></div>
            <div class="pc-score-num ${scoreClass}">${score.avg > 0 ? score.avg.toFixed(1) : '—'}</div>
          </div>
          <div class="pc-footer">
            <span class="pc-package">Self-Service</span>
            <span>${new Date(p.createdAt).toLocaleDateString('nl-NL')}</span>
          </div>
        </div>`;
    });
  } else {
    html += '<div style="grid-column:1/-1;color:var(--text-muted);font-size:13px;padding:8px 0">Nog geen eigen reviews. Maak er een aan voor je eigen klanten.</div>';
  }

  gridEl.innerHTML = html;
  if (typeof lucide !== 'undefined') lucide.createIcons();
} catch(e) { console.error('[RenderError] renderAuditorDashboard:', e); const el = document.getElementById('projectsGrid'); if (el) el.innerHTML = `<div style="padding:24px;text-align:center;color:var(--red)"><p style="font-weight:600">Er ging iets mis bij het laden.</p><p style="font-size:12px;color:var(--text-muted);margin-top:8px">${esc(e.message)}</p><button class="btn btn-secondary" onclick="location.reload()" style="margin-top:12px">Herlaad pagina</button></div>`; } }

function copyShareLink(projectId) {
  const link = getShareableLink(projectId);
  navigator.clipboard.writeText(link).then(() => {
    // Brief visual feedback
    const toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--green);color:#fff;padding:10px 24px;border-radius:8px;font-size:13px;font-weight:600;z-index:5000';
    toast.innerHTML = '<i data-lucide="check" style="width:14px;height:14px"></i> Link gekopieerd!'; lucide.createIcons({nodes:[toast]});
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
  });
}



async function deleteProject(id) {
  if (!confirm('Weet je zeker dat je dit project wilt verwijderen?')) return;
  projects = projects.filter(p => p.id !== id);
  saveState();
  // Also delete from Firestore
  try { await db.collection('projects').doc(id).delete(); } catch(e) { console.warn('[Firebase] Delete failed:', e); }
  renderDashboard();
}

// ═══════════════ NEW PROJECT (WIZARD) ═══════════════
let selectedTemplate = null;
let npStep = 1;

function showNewProject() {
  document.getElementById('dashboardScreen').classList.add('hidden');
  document.getElementById('newProjectScreen').classList.remove('hidden');
  newProjectMode = 'self-service';
  selectedTemplate = null;
  npStep = 1;
  _npNameManuallyEdited = false;
  // Reset source choice to URL
  projectSource = 'url';
  selectedFigmaFrames = [];
  figmaFileData = null;
  // Reset mode selection visual
  document.querySelectorAll('.mode-option').forEach((e, i) => e.classList.toggle('selected', i === 0));
  // Reset source choice visual
  document.querySelectorAll('.source-option').forEach((e, i) => e.classList.toggle('selected', i === 0));
  const npUrlGroup = document.getElementById('npUrlGroup');
  const npFigmaGroup = document.getElementById('npFigmaGroup');
  if (npUrlGroup) { npUrlGroup.classList.remove('hidden'); npUrlGroup.style.display = ''; }
  if (npFigmaGroup) { npFigmaGroup.classList.add('hidden'); npFigmaGroup.style.display = ''; }
  // Reset form fields
  const npUrl = document.getElementById('npUrl'); if (npUrl) npUrl.value = '';
  const npName = document.getElementById('npName'); if (npName) npName.value = '';
  const npClient = document.getElementById('npClient'); if (npClient) npClient.value = '';
  const npFigmaUrl = document.getElementById('npFigmaUrl'); if (npFigmaUrl) npFigmaUrl.value = '';
  const framePicker = document.getElementById('figmaFramePicker'); if (framePicker) framePicker.innerHTML = '';
  renderTemplateSelector();
  showNpStep(1);
}

function showNpStep(step) {
  npStep = step;
  // Show/hide step content
  document.querySelectorAll('.np-content [data-np-step]').forEach(el => {
    el.classList.toggle('np-visible', el.getAttribute('data-np-step') == step);
  });
  // Update stepper dots
  document.querySelectorAll('.np-stepper .np-step').forEach(el => {
    const s = parseInt(el.getAttribute('data-step'));
    el.classList.toggle('active', s === step);
    el.classList.toggle('done', s < step);
  });
  // Update stepper lines
  document.querySelectorAll('.np-stepper .np-step-line').forEach((line, i) => {
    line.classList.toggle('done', (i + 1) < step);
  });
  // Update footer buttons
  const btnBack = document.getElementById('npBtnBack');
  const btnNext = document.getElementById('npBtnNext');
  if (step === 1) {
    btnBack.textContent = 'Annuleer';
    btnBack.onclick = () => showDashboard();
    btnNext.textContent = 'Volgende →';
    btnNext.onclick = () => npNext();
  } else if (step === 2) {
    btnBack.textContent = '← Terug';
    btnBack.onclick = () => npPrev();
    btnNext.textContent = 'Volgende →';
    btnNext.onclick = () => npNext();
  } else if (step === 3) {
    btnBack.textContent = '← Terug';
    btnBack.onclick = () => npPrev();
    const isPro = newProjectMode === 'professional';
    btnNext.textContent = isPro ? 'Aanvraag versturen →' : 'Start Review →';
    btnNext.onclick = () => createProject();
    // Populate existing project dropdown
    populateProjectDropdown();
    _npSelectedExistingProject = null;
    const pSel = document.getElementById('npProjectSelect');
    if (pSel) pSel.value = '__new';
    // Show/hide professional fields
    updateNewProjectForm();
  }
  // Refresh lucide icons for visible step
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

function npNext() {
  if (npStep >= 3) return;
  showNpStep(npStep + 1);
}

function npPrev() {
  if (npStep <= 1) return;
  showNpStep(npStep - 1);
}

function renderTemplateSelector() {
  const grid = document.getElementById('templateGrid');
  if (!grid || typeof MODULE_REGISTRY === 'undefined') return;
  // Filter bundles by source type: Figma bundles only when source is figma, URL bundles otherwise
  const currentSource = projectSource || 'url';
  const bundles = Object.entries(MODULE_REGISTRY.bundles).filter(([id, b]) => {
    if (!b.is_quick_scan) return false;
    const bundleSource = b.source_type || 'url';
    return bundleSource === currentSource;
  });

  let html = `<div class="template-card ${!selectedTemplate ? 'selected' : ''}" onclick="selectTemplate(null)">
    <div class="template-card-icon"><i data-lucide="layout-grid" style="width:20px;height:20px"></i></div>
    <div class="template-card-name">Volledige Audit</div>
    <div class="template-card-meta">Alle modules</div>
  </div>`;

  bundles.forEach(([id, b]) => {
    html += `<div class="template-card ${selectedTemplate === id ? 'selected' : ''}" id="tc-${id}" onclick="selectTemplate('${id}')">
      <div class="template-card-icon"><i data-lucide="${b.icon_lucide}" style="width:20px;height:20px"></i></div>
      <div class="template-card-name">${b.name_nl.replace(' Quick Scan','')}</div>
      <div class="template-card-meta">${b.estimated_duration_nl}</div>
    </div>`;
  });
  grid.innerHTML = html;
  if (typeof lucide !== 'undefined') lucide.createIcons({ nodes: [grid] });
}

function selectTemplate(bundleId) {
  selectedTemplate = bundleId;
  document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
  if (bundleId) {
    const el = document.getElementById('tc-' + bundleId);
    if (el) el.classList.add('selected');
  } else {
    const first = document.querySelector('.template-card');
    if (first) first.classList.add('selected');
  }
}

let _npNameManuallyEdited = false;
let _npSelectedExistingProject = null; // null = nieuw project

function populateProjectDropdown() {
  const sel = document.getElementById('npProjectSelect');
  if (!sel) return;
  sel.innerHTML = '<option value="__new">+ Nieuw project</option>';

  // Groepeer bestaande projecten per domein (zelfde logica als dashboard)
  const userProjects = projects.filter(p => p.userId === (currentUser ? currentUser.uid : null));
  const domainMap = new Map();
  userProjects.forEach(p => {
    const domain = typeof getProjectGroup === 'function' ? getProjectGroup(p) : extractDomain(p.url);
    if (!domainMap.has(domain)) domainMap.set(domain, []);
    domainMap.get(domain).push(p);
  });

  // Sorteer op meeste reviews, dan meest recent
  const sorted = Array.from(domainMap.entries()).sort((a, b) => {
    if (b[1].length !== a[1].length) return b[1].length - a[1].length;
    return new Date(b[1][0].createdAt || 0) - new Date(a[1][0].createdAt || 0);
  });

  sorted.forEach(([domain, domainProjects]) => {
    const count = domainProjects.length;
    // Gebruik het eerste project als "hoofd-project" voor de groep
    const mainProject = domainProjects[0];
    const label = domain + (count > 1 ? ` (${count} reviews)` : '');
    sel.innerHTML += `<option value="${mainProject.id}">${label}</option>`;
  });
}

function onNpProjectSelectChange() {
  const sel = document.getElementById('npProjectSelect');
  const val = sel ? sel.value : '__new';
  const isExisting = val !== '__new';
  _npSelectedExistingProject = isExisting ? val : null;

  // Verberg/toon velden op basis van keuze
  const nameGroup = document.getElementById('npName')?.closest('.form-group');
  const urlGroup = document.getElementById('npUrlGroup');
  const btnNext = document.getElementById('npBtnNext');

  if (isExisting) {
    // Bestaand domein → naam en URL verbergen (wordt automatisch overgenomen)
    if (nameGroup) nameGroup.style.display = 'none';
    if (urlGroup) urlGroup.style.display = 'none';
    if (btnNext) btnNext.textContent = 'Review starten →';
  } else {
    // Nieuw domein → alles tonen
    if (nameGroup) nameGroup.style.display = '';
    if (urlGroup) urlGroup.style.display = '';
    if (btnNext) {
      const isPro = newProjectMode === 'professional';
      btnNext.textContent = isPro ? 'Aanvraag versturen →' : 'Start Review →';
    }
    updateNewProjectForm();
  }
}

function onNpUrlChange() {
  const url = document.getElementById('npUrl').value.trim();
  const row = document.getElementById('autoDetectRow');
  if (row) row.style.display = url.length > 5 ? 'flex' : 'none';

  // Auto-fill projectnaam op basis van domein (alleen als gebruiker het niet handmatig heeft aangepast)
  const npName = document.getElementById('npName');
  if (!npName || _npNameManuallyEdited) return;
  const domain = extractDomain(url);
  if (domain) {
    // Capitalize first letter, bijv. "bold700.com" → "Bold700.com"
    npName.value = domain.charAt(0).toUpperCase() + domain.slice(1);
  }
}

function extractDomain(url) {
  try {
    let u = url.trim();
    if (!u) return '';
    if (!/^https?:\/\//i.test(u)) u = 'https://' + u;
    const hostname = new URL(u).hostname.replace(/^www\./, '');
    return hostname || '';
  } catch(e) { return ''; }
}

function onNpNameInput() {
  // Als de gebruiker handmatig typt, stop met auto-fill
  _npNameManuallyEdited = true;
}

// ═══════════════ FIGMA INTEGRATION ═══════════════
let projectSource = 'url'; // 'url' or 'figma'
let figmaFileData = null;
let selectedFigmaFrames = [];
const FIGMA_PROXY = ''; // Set to proxy URL if needed for CORS, e.g. 'https://figma-proxy.bold700.workers.dev/figma'

function selectSource(source, el) {
  projectSource = source;
  document.querySelectorAll('.source-option').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  const urlGroup = document.getElementById('npUrlGroup');
  const figmaGroup = document.getElementById('npFigmaGroup');
  if (source === 'figma') {
    urlGroup.classList.add('hidden');
    figmaGroup.classList.remove('hidden');
    figmaGroup.style.display = '';
    selectedTemplate = 'qs-figma-general';
  } else {
    urlGroup.classList.remove('hidden');
    figmaGroup.classList.add('hidden');
    selectedTemplate = null;
  }
  renderTemplateSelector();
}

function parseFigmaUrl(url) {
  const match = url.match(/figma\.com\/(design|file|proto)\/([a-zA-Z0-9]+)/);
  if (!match) return null;
  const fileKey = match[2];
  const nodeIdMatch = url.match(/node-id=([0-9]+(?:[:-][0-9]+)?)/);
  const nodeId = nodeIdMatch ? nodeIdMatch[1].replace('-', ':') : null;
  return { fileKey, nodeId };
}

function figmaApiUrl(path) {
  return FIGMA_PROXY ? FIGMA_PROXY + path : 'https://api.figma.com' + path;
}

async function onFigmaUrlChange() {
  const url = document.getElementById('npFigmaUrl').value.trim();
  const parsed = parseFigmaUrl(url);
  const picker = document.getElementById('figmaFramePicker');
  if (!parsed) { picker.classList.add('hidden'); return; }

  const token = userProfile?.figmaToken;
  if (!token) {
    picker.classList.remove('hidden');
    picker.innerHTML = `<div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;text-align:center">
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px">Koppel eerst je Figma account om designs te reviewen.</p>
      <button class="btn btn-primary btn-sm" onclick="showFigmaTokenModal()">Figma koppelen</button>
    </div>`;
    return;
  }

  picker.classList.remove('hidden');
  picker.innerHTML = '<div style="text-align:center;padding:12px;color:var(--text-muted);font-size:12px"><div class="static-preview-spinner" style="width:20px;height:20px;margin:0 auto 8px"></div>Figma file laden...</div>';

  try {
    const resp = await fetch(figmaApiUrl(`/v1/files/${parsed.fileKey}?depth=2`), {
      headers: { 'X-Figma-Token': token }
    });
    if (!resp.ok) {
      if (resp.status === 403) throw new Error('403: Geen toegang. Je token heeft geen rechten voor dit bestand, of het bestand is niet met je gedeeld.');
      if (resp.status === 404) throw new Error('404: Bestand niet gevonden. Controleer de Figma URL.');
      throw new Error(`Figma API error (${resp.status})`);
    }
    figmaFileData = await resp.json();
    const pages = figmaFileData.document.children || [];
    const nameInput = document.getElementById('npName');
    if (!nameInput.value) nameInput.value = figmaFileData.name + ' — Design Review';
    if (parsed.nodeId) selectedFigmaFrames = [parsed.nodeId];
    renderFramePicker(pages, parsed.nodeId);
  } catch(e) {
    console.error('[Figma]', e);
    picker.innerHTML = `<div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:var(--radius-sm);padding:12px;font-size:13px;color:var(--red)">
      <div style="margin-bottom:10px">${esc(e.message)}</div>
      <button class="btn btn-secondary btn-sm" onclick="showFigmaTokenModal()" style="font-size:12px">Token wijzigen</button>
    </div>`;
  }
}

function renderFramePicker(pages, preselectedNodeId) {
  const picker = document.getElementById('figmaFramePicker');
  let html = '<div style="font-size:12px;font-weight:600;margin-bottom:8px;color:var(--text)">Selecteer frames om te reviewen:</div>';
  pages.forEach(page => {
    const frames = (page.children || []).filter(c => c.type === 'FRAME' || c.type === 'COMPONENT' || c.type === 'COMPONENT_SET');
    if (frames.length === 0) return;
    html += `<div style="margin-bottom:12px">
      <div style="font-size:11px;color:var(--text-muted);font-weight:600;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em">${esc(page.name)}</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px">
        ${frames.map(frame => {
          const isSelected = selectedFigmaFrames.includes(frame.id) || frame.id === preselectedNodeId;
          if (isSelected && !selectedFigmaFrames.includes(frame.id)) selectedFigmaFrames.push(frame.id);
          const w = Math.round(frame.absoluteBoundingBox?.width || 0);
          const h = Math.round(frame.absoluteBoundingBox?.height || 0);
          return `<label class="figma-frame-chip ${isSelected ? 'selected' : ''}">
            <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleFigmaFrame('${frame.id}', this.checked, this.closest('.figma-frame-chip'))">
            <span class="chip-name">${esc(frame.name)}</span>
            <span class="chip-size">${w}×${h}</span>
          </label>`;
        }).join('')}
      </div>
    </div>`;
  });
  html += `<div style="font-size:11px;color:var(--text-muted);margin-top:8px">${selectedFigmaFrames.length} frame(s) geselecteerd</div>`;
  picker.innerHTML = html;
}

function toggleFigmaFrame(frameId, checked, chipEl) {
  if (checked) {
    if (!selectedFigmaFrames.includes(frameId)) selectedFigmaFrames.push(frameId);
    chipEl?.classList.add('selected');
  } else {
    selectedFigmaFrames = selectedFigmaFrames.filter(id => id !== frameId);
    chipEl?.classList.remove('selected');
  }
}

// ── Figma Token Management ──
function showFigmaTokenModal() {
  const existing = userProfile?.figmaToken ? '••••••••' + userProfile.figmaToken.slice(-4) : '';
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
  overlay.innerHTML = `
    <div class="modal-box" style="max-width:480px">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border)">
        <h3 style="margin:0;font-size:16px;font-weight:700">Figma Koppeling</h3>
        <button onclick="this.closest('.modal-overlay').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:20px">×</button>
      </div>
      <div style="padding:20px">
        <p style="font-size:13px;color:var(--text-muted);line-height:1.6;margin-bottom:16px">Om Figma designs te reviewen heb je een Personal Access Token nodig.</p>
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;margin-bottom:16px;font-size:12px;line-height:1.6">
          <strong>Token aanmaken:</strong><br>
          1. Ga naar <a href="https://www.figma.com/settings" target="_blank" style="color:var(--accent)">figma.com/settings</a><br>
          2. Scroll naar "Personal access tokens"<br>
          3. Klik "Generate new token"<br>
          4. Scope: <code>file_content:read</code><br>
          5. Plak het token hieronder
        </div>
        ${existing ? `<div style="font-size:12px;color:var(--green);margin-bottom:8px">✓ Token opgeslagen: ${existing}</div>` : ''}
        <div class="form-group" style="margin-bottom:16px">
          <label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px">Figma Personal Access Token</label>
          <input type="password" id="figmaTokenInput" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;background:var(--surface);color:var(--text)" placeholder="figd_xxxxxxxxxxxxxxxx">
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-primary" style="flex:1" onclick="saveFigmaToken()">Opslaan</button>
          ${existing ? `<button class="btn btn-secondary" onclick="removeFigmaToken()">Verwijder</button>` : ''}
        </div>
      </div>
    </div>`;
  document.body.appendChild(overlay);
}

async function saveFigmaToken() {
  const token = document.getElementById('figmaTokenInput').value.trim();
  if (!token || token.length < 10) { showScanToast('error', 'Ongeldig token', 'Plak je Figma Personal Access Token', 3000); return; }
  try {
    // Step 1: validate token identity
    const resp = await fetch(figmaApiUrl('/v1/me'), { headers: { 'X-Figma-Token': token } });
    if (!resp.ok) throw new Error('Token ongeldig — controleer of het token correct is gekopieerd.');
    const me = await resp.json();

    // Step 2: test file_content:read scope by trying to list user's files
    const figmaUrl = document.getElementById('npFigmaUrl')?.value?.trim();
    const parsed = figmaUrl ? parseFigmaUrl(figmaUrl) : null;
    if (parsed) {
      const fileResp = await fetch(figmaApiUrl(`/v1/files/${parsed.fileKey}?depth=1`), { headers: { 'X-Figma-Token': token } });
      if (fileResp.status === 403) {
        showScanToast('error', 'Token mist rechten', 'Je token heeft geen "file_content:read" scope. Maak een nieuwe token aan met die scope aangevinkt.', 6000);
        return;
      }
    }

    userProfile.figmaToken = token;
    await db.collection('users').doc(currentUser.uid).update({ figmaToken: token });
    document.querySelector('.modal-overlay')?.remove();
    showScanToast('success', 'Figma gekoppeld', `Ingelogd als ${me.handle || me.email}`, 3000);
    // Re-trigger URL parsing now that we have a token
    onFigmaUrlChange();
  } catch(e) {
    showScanToast('error', 'Token werkt niet', e.message || 'Controleer of het token correct is', 4000);
  }
}

async function removeFigmaToken() {
  userProfile.figmaToken = null;
  await db.collection('users').doc(currentUser.uid).update({ figmaToken: firebase.firestore.FieldValue.delete() });
  document.querySelector('.modal-overlay')?.remove();
  showScanToast('info', 'Token verwijderd', '', 2000);
}

// ── Figma Design Checks Engine ──
async function runFigmaDesignChecks(project, autoFill) {
  const token = userProfile?.figmaToken;
  if (!token) { showScanToast('error', 'Geen Figma token', 'Koppel eerst je Figma account', 3000); return 0; }
  const fileKey = project.figmaFileKey;
  const frameIds = project.figmaFrameIds || [];
  if (!fileKey || frameIds.length === 0) return 0;

  let filled = 0;
  const idsParam = frameIds.join(',');
  const resp = await fetch(figmaApiUrl(`/v1/files/${fileKey}/nodes?ids=${encodeURIComponent(idsParam)}`), { headers: { 'X-Figma-Token': token } });
  if (!resp.ok) throw new Error(`Figma API error: ${resp.status}`);
  const data = await resp.json();

  const allNodes = [], textNodes = [], frameNodes = [], imageNodes = [], componentInstances = [];
  function walkNodes(node, depth) {
    if (!node) return;
    allNodes.push({ ...node, _depth: depth });
    if (node.type === 'TEXT') textNodes.push(node);
    if (node.type === 'FRAME' || node.type === 'GROUP') frameNodes.push(node);
    if (node.type === 'INSTANCE') componentInstances.push(node);
    if (node.fills?.some(f => f.type === 'IMAGE')) imageNodes.push(node);
    if (node.children) node.children.forEach(child => walkNodes(child, depth + 1));
  }
  for (const [nodeId, nodeData] of Object.entries(data.nodes || {})) {
    if (nodeData?.document) walkNodes(nodeData.document, 0);
  }

  // CHECK 1: Kleurconsistentie
  const uniqueColors = new Set();
  allNodes.forEach(n => { (n.fills || []).forEach(f => { if (f.type === 'SOLID' && f.color) { const c = f.color; uniqueColors.add(`${Math.round(c.r*20)/20},${Math.round(c.g*20)/20},${Math.round(c.b*20)/20}`); } }); });
  autoFill('fig-color-consistency', uniqueColors.size <= 8 ? 'good' : uniqueColors.size <= 15 ? 'ok' : 'bad', `${uniqueColors.size} unieke kleuren gevonden.`); filled++;

  // CHECK 2: Font consistency
  const uniqueFonts = new Set(); const fontSizes = [];
  textNodes.forEach(n => { if (n.style?.fontFamily) uniqueFonts.add(n.style.fontFamily); if (n.style?.fontSize) fontSizes.push(n.style.fontSize); });
  autoFill('fig-font-consistency', uniqueFonts.size <= 2 ? 'good' : uniqueFonts.size <= 3 ? 'ok' : 'bad', `${uniqueFonts.size} font families: ${[...uniqueFonts].join(', ')}`); filled++;

  // CHECK 3: Type scale
  const uniqueSizes = [...new Set(fontSizes)].sort((a, b) => a - b);
  autoFill('fig-type-scale', uniqueSizes.length <= 6 ? 'good' : uniqueSizes.length <= 10 ? 'ok' : 'bad', `${uniqueSizes.length} unieke font sizes: ${uniqueSizes.map(s => s + 'px').join(', ')}`); filled++;

  // CHECK 4: Minimale tekstgrootte
  const tinyText = textNodes.filter(n => n.style?.fontSize && n.style.fontSize < 12);
  const smallBody = textNodes.filter(n => n.style?.fontSize && n.style.fontSize < 14 && (n.characters || '').length > 20);
  autoFill('fig-min-text-size', tinyText.length === 0 && smallBody.length === 0 ? 'good' : tinyText.length > 0 ? 'bad' : 'ok', tinyText.length > 0 ? `${tinyText.length} element(en) kleiner dan 12px.` : smallBody.length > 0 ? `${smallBody.length} bodytekst < 14px.` : 'Alle tekst ≥12px, body ≥14px.'); filled++;

  // CHECK 5: Contrast
  let contrastIssues = 0, contrastChecked = 0;
  textNodes.forEach(node => {
    const textFill = (node.fills || []).find(f => f.type === 'SOLID' && f.visible !== false);
    if (!textFill) return;
    const parentNode = allNodes.find(n => n.children?.some(c => c.id === node.id) && n.fills?.some(f => f.type === 'SOLID' && f.visible !== false));
    if (!parentNode) return;
    const bgFill = parentNode.fills.find(f => f.type === 'SOLID' && f.visible !== false);
    if (!bgFill) return;
    contrastChecked++;
    const ratio = calcContrastFromFigmaRgb(textFill.color, bgFill.color);
    const isLarge = (node.style?.fontSize || 16) >= 18 || ((node.style?.fontSize || 16) >= 14 && (node.style?.fontWeight || 400) >= 700);
    if (ratio < (isLarge ? 3 : 4.5)) contrastIssues++;
  });
  if (contrastChecked > 0) { autoFill('fig-contrast', contrastIssues === 0 ? 'good' : contrastIssues <= 2 ? 'ok' : 'bad', `${contrastIssues} van ${contrastChecked} combinaties voldoen niet aan WCAG AA.`); filled++; }

  // CHECK 6: Touch targets
  const interactiveNodes = allNodes.filter(n => { const nm = (n.name || '').toLowerCase(); return nm.includes('button') || nm.includes('btn') || nm.includes('cta') || nm.includes('link') || nm.includes('tab') || n.type === 'INSTANCE'; });
  const tooSmall = interactiveNodes.filter(n => n.absoluteBoundingBox && (n.absoluteBoundingBox.width < 44 || n.absoluteBoundingBox.height < 44));
  if (interactiveNodes.length > 0) { autoFill('fig-touch-targets', tooSmall.length === 0 ? 'good' : tooSmall.length <= 3 ? 'ok' : 'bad', `${tooSmall.length} van ${interactiveNodes.length} elementen < 44×44px.`); filled++; }

  // CHECK 7: Spacing grid
  const spacings = new Set();
  frameNodes.forEach(n => { [n.paddingLeft, n.paddingRight, n.paddingTop, n.paddingBottom, n.itemSpacing].forEach(v => { if (v !== undefined) spacings.add(Math.round(v)); }); });
  const on4Grid = [...spacings].filter(v => v % 4 === 0).length;
  const gridPct = spacings.size > 0 ? Math.round((on4Grid / spacings.size) * 100) : 100;
  autoFill('fig-spacing-grid', gridPct >= 90 ? 'good' : gridPct >= 70 ? 'ok' : 'bad', `${spacings.size} spacing-waarden, ${gridPct}% op 4px grid.`); filled++;

  // CHECK 8: Component hergebruik
  const instancePct = allNodes.length > 0 ? Math.round((componentInstances.length / allNodes.length) * 100) : 0;
  autoFill('fig-component-reuse', instancePct >= 30 ? 'good' : instancePct >= 15 ? 'ok' : 'bad', `${componentInstances.length}/${allNodes.length} elementen zijn instances (${instancePct}%).`); filled++;

  // CHECK 9: Auto-layout
  const autoLayoutFrames = frameNodes.filter(n => n.layoutMode === 'HORIZONTAL' || n.layoutMode === 'VERTICAL');
  const alPct = frameNodes.length > 0 ? Math.round((autoLayoutFrames.length / frameNodes.length) * 100) : 0;
  autoFill('fig-auto-layout', alPct >= 60 ? 'good' : alPct >= 30 ? 'ok' : 'bad', `${autoLayoutFrames.length}/${frameNodes.length} frames met auto-layout (${alPct}%).`); filled++;

  // CHECK 10: Line height
  const bodyTextNodes = textNodes.filter(n => (n.characters || '').length > 20);
  const tightLH = bodyTextNodes.filter(n => { const fs = n.style?.fontSize || 16; const lh = n.style?.lineHeightPx || fs * 1.2; return lh / fs < 1.4; });
  if (bodyTextNodes.length > 0) { autoFill('fig-line-height', tightLH.length === 0 ? 'good' : tightLH.length <= 2 ? 'ok' : 'bad', tightLH.length === 0 ? 'Regelafstand OK.' : `${tightLH.length} element(en) met te krappe regelafstand.`); filled++; }

  // CHECK 11: Text alignment
  const aligns = {}; textNodes.forEach(n => { const a = n.style?.textAlignHorizontal || 'LEFT'; aligns[a] = (aligns[a] || 0) + 1; });
  autoFill('fig-text-alignment', Object.keys(aligns).length <= 2 && !aligns['JUSTIFIED'] ? 'good' : Object.keys(aligns).length <= 3 ? 'ok' : 'bad', `Alignment: ${Object.entries(aligns).map(([k,v]) => `${k}: ${v}×`).join(', ')}`); filled++;

  // CHECK 12: Afbeeldingen
  autoFill('fig-images', imageNodes.length >= 2 ? 'good' : imageNodes.length === 1 ? 'ok' : 'bad', imageNodes.length === 0 ? 'Geen afbeeldingen — gebruik echte content.' : `${imageNodes.length} afbeelding(en).`); filled++;

  return filled;
}

function calcContrastFromFigmaRgb(fg, bg) {
  function lum(c) { const [r, g, b] = [c.r, c.g, c.b].map(v => v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4)); return 0.2126 * r + 0.7152 * g + 0.0722 * b; }
  const l1 = lum(fg), l2 = lum(bg);
  return (Math.max(l1, l2) + 0.05) / (Math.min(l1, l2) + 0.05);
}

// ── Figma Preview in Review Interface ──
async function loadFigmaPreview(project) {
  const token = userProfile?.figmaToken;
  const frame = document.getElementById('previewFrame');
  const empty = document.getElementById('previewEmpty');
  frame.classList.add('hidden');
  empty.classList.remove('hidden');

  if (!token || !project.figmaFileKey) {
    empty.innerHTML = `<div style="text-align:center;padding:24px"><i data-lucide="figma" style="width:48px;height:48px;color:#a259ff;opacity:0.5"></i><p style="margin-top:12px;color:var(--text-muted)">Figma preview niet beschikbaar</p><a href="${esc(project.url)}" target="_blank" class="btn btn-primary btn-sm" style="margin-top:12px">Open in Figma →</a></div>`;
    if (typeof lucide !== 'undefined') lucide.createIcons();
    return;
  }

  empty.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">Figma preview laden...</div>';
  try {
    const frameIds = (project.figmaFrameIds || []).join(',');
    const resp = await fetch(figmaApiUrl(`/v1/images/${project.figmaFileKey}?ids=${encodeURIComponent(frameIds)}&format=png&scale=1`), { headers: { 'X-Figma-Token': token } });
    if (!resp.ok) throw new Error('Kon thumbnails niet laden');
    const imgData = await resp.json();
    let html = `<div style="padding:12px;overflow-y:auto;height:100%;display:flex;flex-direction:column;gap:12px;align-items:center">
      <div style="display:flex;align-items:center;gap:8px;padding:8px;width:100%">
        <span style="font-size:12px;color:#a259ff;font-weight:600"><i data-lucide="figma" style="width:14px;height:14px"></i> ${esc(project.figmaFileName || 'Figma Design')}</span>
        <a href="${esc(project.url)}" target="_blank" style="margin-left:auto;font-size:11px;color:var(--accent);text-decoration:none">Open in Figma ↗</a>
      </div>`;
    for (const [nId, imgUrl] of Object.entries(imgData.images || {})) {
      if (imgUrl) html += `<img src="${imgUrl}" style="max-width:100%;border-radius:8px;border:1px solid var(--border);background:white" alt="Frame">`;
    }
    html += '</div>';
    empty.innerHTML = html;
    if (typeof lucide !== 'undefined') lucide.createIcons();
  } catch(e) {
    empty.innerHTML = `<div style="text-align:center;padding:24px"><p style="color:var(--text-muted);font-size:13px">Preview laden mislukt</p><a href="${esc(project.url)}" target="_blank" class="btn btn-primary btn-sm" style="margin-top:12px">Open in Figma →</a></div>`;
  }
}

async function detectPageType() {
  const url = document.getElementById('npUrl').value.trim();
  if (!url) return;
  const resultEl = document.getElementById('detectResult');
  const btn = document.getElementById('btnDetectType');
  btn.disabled = true;
  if (resultEl) resultEl.textContent = 'Analyseren...';

  let finalUrl = url;
  if (!url.startsWith('http')) finalUrl = 'https://' + url;

  try {
    const pageData = await getPageDocument(finalUrl);
    if (!pageData || !pageData.doc) {
      if (resultEl) resultEl.textContent = 'Kon pagina niet ophalen';
      btn.disabled = false;
      return;
    }
    const doc = pageData.doc;
    const pathname = new URL(finalUrl).pathname.toLowerCase();
    const scores = {};

    // Schema.org signal (+40%)
    try {
      const jsonLd = doc.querySelectorAll('script[type="application/ld+json"]');
      jsonLd.forEach(el => {
        try {
          const d = JSON.parse(el.textContent);
          const t = (d['@type'] || '').toLowerCase();
          if (t === 'product') scores['qs-product'] = (scores['qs-product']||0) + 40;
          if (t === 'blogposting' || t === 'article' || t === 'newsarticle') scores['qs-blog'] = (scores['qs-blog']||0) + 40;
          if (t === 'faqpage') scores['qs-pricing'] = (scores['qs-pricing']||0) + 20;
          if (t === 'contactpage') scores['qs-contact'] = (scores['qs-contact']||0) + 40;
          if (t === 'aboutpage') scores['qs-about'] = (scores['qs-about']||0) + 40;
        } catch(e) {}
      });
    } catch(e) {}

    // URL pattern signal (+25%)
    if (pathname === '/' || pathname === '/home' || pathname === '/index.html') scores['qs-homepage'] = (scores['qs-homepage']||0) + 25;
    if (/\/(product|products|item|shop\/|p\/)/.test(pathname)) scores['qs-product'] = (scores['qs-product']||0) + 25;
    if (/\/(checkout|cart|basket|order)/.test(pathname)) scores['qs-checkout'] = (scores['qs-checkout']||0) + 25;
    if (/\/(pricing|plans|packages)/.test(pathname)) scores['qs-pricing'] = (scores['qs-pricing']||0) + 25;
    if (/\/(blog|post|article|news)/.test(pathname) || /\/\d{4}\/\d{2}\//.test(pathname)) scores['qs-blog'] = (scores['qs-blog']||0) + 25;
    if (/\/(about|about-us|team|over-ons)/.test(pathname)) scores['qs-about'] = (scores['qs-about']||0) + 25;
    if (/\/(contact|contact-us|kontakt)/.test(pathname)) scores['qs-contact'] = (scores['qs-contact']||0) + 25;
    if (/\/(lp|landing)/.test(pathname) || finalUrl.includes('utm_')) scores['qs-landing'] = (scores['qs-landing']||0) + 25;
    if (/\/(launch|coming-soon|waitlist|early-access)/.test(pathname)) scores['qs-launch'] = (scores['qs-launch']||0) + 25;
    if (/\/(onboarding|welcome|get-started|signup)/.test(pathname)) scores['qs-onboarding'] = (scores['qs-onboarding']||0) + 25;

    // DOM signal (+25%)
    const addToCart = findAddToCart(doc);
    if (addToCart) scores['qs-product'] = (scores['qs-product']||0) + 25;
    const priceEl = doc.querySelector('[class*="price"], [itemprop="price"]');
    if (priceEl && addToCart) scores['qs-product'] = (scores['qs-product']||0) + 10;
    const checkoutForm = doc.querySelector('input[autocomplete="cc-number"], [class*="checkout"], [class*="payment-form"]');
    if (checkoutForm) scores['qs-checkout'] = (scores['qs-checkout']||0) + 25;
    const pricingTable = doc.querySelector('[class*="pricing"], [class*="plan-"], [class*="tier"]');
    if (pricingTable) scores['qs-pricing'] = (scores['qs-pricing']||0) + 25;
    const articleEl = doc.querySelector('article, [class*="blog-post"], [class*="article-body"]');
    const timeEl = doc.querySelector('time[datetime], [class*="publish-date"]');
    if (articleEl && timeEl) scores['qs-blog'] = (scores['qs-blog']||0) + 25;
    const contactForm = doc.querySelector('form[action*="contact"], form[class*="contact"]');
    const phoneLink = doc.querySelector('a[href^="tel:"]');
    if (contactForm || phoneLink) scores['qs-contact'] = (scores['qs-contact']||0) + 15;

    // Find best match
    const entries = Object.entries(scores).sort((a, b) => b[1] - a[1]);
    if (entries.length > 0 && entries[0][1] >= 25) {
      const bestId = entries[0][0];
      const conf = Math.min(entries[0][1], 100);
      selectTemplate(bestId);
      const bundle = MODULE_REGISTRY.bundles[bestId];
      if (resultEl) resultEl.textContent = `${bundle.name_nl.replace(' Quick Scan','')} gedetecteerd (${conf}% zeker)`;
    } else {
      if (resultEl) resultEl.textContent = 'Kon pagina-type niet bepalen — selecteer handmatig';
    }
  } catch(e) {
    console.warn('[AutoDetect]', e);
    if (resultEl) resultEl.textContent = 'Fout bij detectie';
  }
  btn.disabled = false;
}

function selectMode(mode, el) {
  newProjectMode = mode;
  document.querySelectorAll('.mode-option').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
}

function updateNewProjectForm() {
  const clientGroup = document.getElementById('npClientGroup');
  const packageGroup = document.getElementById('npPackageGroup');
  const proInfo = document.getElementById('npProInfo');
  const isPro = newProjectMode === 'professional';
  if (clientGroup) clientGroup.classList.toggle('hidden', !isPro);
  if (packageGroup) packageGroup.classList.toggle('hidden', !isPro);
  if (proInfo) proInfo.classList.toggle('hidden', !isPro);
}

function addUrlToExistingProject() {
  // Maak een NIEUW project aan, maar gebruik de naam/url van het bestaande domein
  const existingProject = projects.find(p => p.id === _npSelectedExistingProject);
  if (!existingProject) { alert('Project niet gevonden.'); return; }

  // Gebruik de URL uit het formulier, of fallback naar het bestaande project
  const newUrl = projectSource === 'figma'
    ? (document.getElementById('npFigmaUrl')?.value.trim() || '')
    : (document.getElementById('npUrl')?.value.trim() || '');
  const url = newUrl || existingProject.url;
  if (!url) { alert('Vul een URL in.'); return; }

  // Neem de naam over van het bestaande domein
  const name = existingProject.name || extractDomain(url) || 'Review';

  // Vul de verborgen velden in zodat createProject() ze kan lezen
  const npUrl = document.getElementById('npUrl');
  const npName = document.getElementById('npName');
  if (npUrl) npUrl.value = url;
  if (npName) npName.value = name;

  // Reset de selector zodat createProject() normaal doorgaat (als nieuw project)
  _npSelectedExistingProject = null;

  // Laat createProject() het werk doen met de geselecteerde template en modus
  createProject();
}

function createProject() {
  // ── Check: toevoegen aan bestaand project? ──
  if (_npSelectedExistingProject) {
    return addUrlToExistingProject();
  }

  let name = document.getElementById('npName').value.trim();
  const client = document.getElementById('npClient').value.trim();
  const pkg = document.getElementById('npPackage').value;

  // Figma or URL source
  let url;
  if (projectSource === 'figma') {
    url = document.getElementById('npFigmaUrl').value.trim();
    if (!url) { alert('Vul een Figma URL in.'); return; }
    if (!parseFigmaUrl(url)) { alert('Ongeldige Figma URL.'); return; }
    if (selectedFigmaFrames.length === 0) { alert('Selecteer minimaal één frame om te reviewen.'); return; }
    if (!name) name = figmaFileData ? figmaFileData.name : extractDomain(url) || 'Figma Review';
  } else {
    url = document.getElementById('npUrl').value.trim();
    if (!url) { alert('Vul een URL in.'); return; }
    // Auto-generate naam als die leeg is
    if (!name) name = extractDomain(url) || 'Review';
  }

  // Check free limit only for self-service mode (professional requests are always allowed)
  const isFreeUser = !isAdmin && !isAuditor && !(userProfile && userProfile.plan === 'pro');
  const selfServiceCount = projects.filter(p => p.mode !== 'professional' && p.userId === currentUser?.uid).length;
  if (isFreeUser && newProjectMode === 'self-service' && selfServiceCount >= FREE_PROJECT_LIMIT) {
    alert('Je hebt je ' + FREE_PROJECT_LIMIT + ' gratis reviews gebruikt. Upgrade naar Pro voor onbeperkte reviews.');
    return;
  }

  // Validate professional-specific fields
  if (newProjectMode === 'professional' && !client) {
    alert('Vul een bedrijfsnaam in voor de professional audit.');
    return;
  }

  // Generate Firestore-friendly ID
  const projectId = 'proj_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);

  const project = {
    id: projectId,
    name, url, urls: [url], client: newProjectMode === 'professional' ? client : '',
    package: newProjectMode === 'professional' ? pkg : 'self-service',
    mode: newProjectMode,
    sourceType: projectSource || 'url',
    userId: currentUser ? currentUser.uid : null,
    leadEmail: currentUser ? currentUser.email : '',
    answers: {}, currentStep: 0, createdAt: new Date().toISOString(),
    selectedTemplate: selectedTemplate || null,
    moduleConfig: selectedTemplate && typeof getBundleConfig === 'function'
      ? getBundleConfig(selectedTemplate)
      : (typeof getDefaultModuleConfig === 'function' ? getDefaultModuleConfig() : null)
  };

  // Free-form review: sla extra type flag op + start met 1 lege bevinding
  if (selectedTemplate === 'free-form') {
    project.reviewType = 'free-form';
    const fId = 'ff-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6);
    project.answers[fId] = {
      score: null, severity: null, notes: '',
      findingTitle: '', findingCategory: null,
      findingOrder: 0, screenshots: []
    };
  }

  // Figma source → add Figma-specific fields
  if (projectSource === 'figma') {
    const parsed = parseFigmaUrl(url);
    project.figmaFileKey = parsed.fileKey;
    project.figmaFrameIds = [...selectedFigmaFrames];
    project.figmaFileName = figmaFileData ? figmaFileData.name : '';
  }

  // Professional mode → add audit workflow fields
  if (newProjectMode === 'professional') {
    project.auditStatus = 'pending';
    project.assignedTo = null;
    project.assignedToName = null;
    project.assignedAt = null;
    project.completedAt = null;
  }

  projects.push(project);
  saveState();

  if (newProjectMode === 'professional') {
    // Show confirmation and go to dashboard (client can't start review themselves)
    showScanToast('success', 'Aanvraag ingediend!', 'Een auditor wordt binnenkort toegewezen.', 5000);
    showDashboard();
  } else {
    // Self-service → open project for review
    updateUrlParam('p', projectId);
    openProject(projectId);
  }
}

// ═══════════════ AUTH ═══════════════
const FREE_PROJECT_LIMIT = 3;

function toggleAuthMode() {
  authMode = authMode === 'login' ? 'register' : 'login';
  document.getElementById('authBtn').textContent = authMode === 'login' ? 'Inloggen →' : 'Account aanmaken →';
  document.getElementById('authToggle').innerHTML = authMode === 'login'
    ? 'Nog geen account? <a onclick="toggleAuthMode()">Registreer gratis</a>'
    : 'Al een account? <a onclick="toggleAuthMode()">Inloggen</a>';
  document.getElementById('authForgotLink').style.display = authMode === 'login' ? '' : 'none';
  document.getElementById('authError').classList.add('hidden');
}

async function handleAuth() {
  const email = document.getElementById('authEmail').value.trim();
  const password = document.getElementById('authPassword').value;
  const errorEl = document.getElementById('authError');
  const btn = document.getElementById('authBtn');

  if (!email || !email.includes('@')) { errorEl.textContent = 'Vul een geldig e-mailadres in.'; errorEl.classList.remove('hidden'); return; }
  if (!password || password.length < 6) { errorEl.textContent = 'Wachtwoord moet minimaal 6 tekens zijn.'; errorEl.classList.remove('hidden'); return; }

  btn.disabled = true;
  btn.textContent = 'Even geduld...';
  errorEl.classList.add('hidden');

  try {
    if (authMode === 'register') {
      const cred = await auth.createUserWithEmailAndPassword(email, password);
      // Create user profile in Firestore
      try {
        await db.collection('users').doc(cred.user.uid).set({
          email: email,
          role: 'user',
          plan: 'free',
          createdAt: new Date().toISOString()
        });
        console.log('[Auth] Registered + profile created:', email);
      } catch(profileErr) {
        console.error('[Auth] Profile creation failed (check Firestore Security Rules):', profileErr.message);
        // Auth account was created but profile wasn't — onAuthStateChanged will retry
      }
    } else {
      await auth.signInWithEmailAndPassword(email, password);
      console.log('[Auth] Logged in:', email);
    }
    // onAuthStateChanged will handle the rest
  } catch(e) {
    const messages = {
      'auth/email-already-in-use': 'Dit e-mailadres is al geregistreerd. Probeer in te loggen.',
      'auth/invalid-email': 'Ongeldig e-mailadres.',
      'auth/wrong-password': 'Verkeerd wachtwoord.',
      'auth/user-not-found': 'Geen account gevonden met dit e-mailadres.',
      'auth/weak-password': 'Wachtwoord moet minimaal 6 tekens zijn.',
      'auth/too-many-requests': 'Te veel pogingen. Probeer later opnieuw.',
      'auth/invalid-credential': 'Onjuiste inloggegevens. Controleer je e-mail en wachtwoord.'
    };
    errorEl.textContent = messages[e.code] || e.message;
    errorEl.classList.remove('hidden');
    btn.disabled = false;
    btn.textContent = authMode === 'login' ? 'Inloggen →' : 'Account aanmaken →';
  }
}

async function resetPassword() {
  const email = document.getElementById('authEmail').value.trim();
  if (!email || !email.includes('@')) { alert('Vul eerst je e-mailadres in.'); return; }
  try {
    await auth.sendPasswordResetEmail(email);
    alert('Reset-link verstuurd naar ' + email + '. Check je inbox.');
  } catch(e) {
    alert('Kon geen reset-link versturen: ' + e.message);
  }
}

function logoutUser() {
  auth.signOut();
}

function showAuthScreen() {
  document.getElementById('authScreen').classList.remove('hidden');

  document.getElementById('dashboardScreen').classList.add('hidden');
  document.getElementById('reviewScreen').classList.add('hidden');
  document.getElementById('newProjectScreen').classList.add('hidden');
  document.getElementById('scorecardScreen').classList.add('hidden');
}

// ── Show user dashboard (after login) — alias ──
// Legacy alias — now everyone uses the dashboard
function showLanding() {
  showDashboard();
}

// ── URL parameter management ──
function updateUrlParam(key, value) {
  const url = new URL(window.location.href);
  if (value === null || value === undefined) {
    url.searchParams.delete(key);
  } else {
    url.searchParams.set(key, value);
  }
  window.history.replaceState({}, '', url.toString());
}
function clearUrlParam(key) {
  const url = new URL(window.location.href);
  url.searchParams.delete(key);
  window.history.replaceState({}, '', url.toString());
}

function getShareableLink(projectId) {
  const url = new URL(window.location.href);
  url.search = ''; // Clear all params
  url.searchParams.set('p', projectId);
  return url.toString();
}

// ═══════════════ OPEN PROJECT ═══════════════
function openProject(id) {
  activeProjectId = id;
  const project = getActiveProject();
  if (!project) return;

  // ── Migrate legacy answers to new module IDs if needed ──
  if (project.answers && typeof LEGACY_ID_MAP !== 'undefined') {
    const hasLegacyIds = Object.keys(project.answers).some(k => LEGACY_ID_MAP[k]);
    if (hasLegacyIds) {
      project.answers = migrateLegacyAnswers(project.answers);
      saveState();
    }
  }

  // ── Build review steps from project module config ──
  if (project.reviewType === 'free-form') {
    // Free-form: no predefined steps, generate dynamically
    reviewSteps = [];
  } else if (typeof buildReviewSteps === 'function') {
    try {
      reviewSteps = buildReviewSteps(project.moduleConfig || (typeof getDefaultModuleConfig === 'function' ? getDefaultModuleConfig() : null));
    } catch(e) {
      console.error('[openProject] buildReviewSteps fout:', e);
      reviewSteps = typeof LEGACY_STEPS_BACKUP !== 'undefined' ? LEGACY_STEPS_BACKUP : [];
    }
  } else if (reviewSteps.length === 0) {
    reviewSteps = LEGACY_STEPS_BACKUP;
  }

  currentStep = project.currentStep || 0;
  if (reviewSteps.length > 0 && currentStep >= reviewSteps.length) currentStep = 0;

  // Update URL to reflect current project
  updateUrlParam('p', id);


  document.getElementById('dashboardScreen').classList.add('hidden');
  document.getElementById('newProjectScreen').classList.add('hidden');
  document.getElementById('reviewScreen').classList.remove('hidden');

  // Free-form op mobiel: verberg preview, full-width notities
  const mainEl = document.querySelector('.main');
  if (mainEl) {
    mainEl.classList.remove('ff-mobile-mode');
    if (project.reviewType === 'free-form') {
      mainEl.classList.add('ff-mobile-mode');
    }
  }

  const pnEl = document.getElementById('topbarProjectName');
  if (pnEl) {
    let label = '| ' + project.name;
    if (project.selectedTemplate && typeof MODULE_REGISTRY !== 'undefined') {
      const bundle = MODULE_REGISTRY.bundles[project.selectedTemplate];
      if (bundle) label += ` — ${bundle.name_nl.replace(' Quick Scan','')} Quick Scan`;
    }
    pnEl.textContent = label;
  }
  document.getElementById('urlInput').value = project.url;

  // ── Free-form review: andere UI ──
  if (project.reviewType === 'free-form') {
    renderFreeFormReview(project);
    document.querySelectorAll('.btn-prev, .btn-next').forEach(b => b.style.display = 'none');
  } else {
    // Restore nav buttons (might be hidden from previous free-form project)
    document.querySelectorAll('.btn-prev, .btn-next').forEach(b => b.style.display = '');
    buildStepper();
    renderStep(currentStep);
  }

  // Figma projects → load frame previews instead of URL iframe
  if (project.sourceType === 'figma') {
    loadFigmaPreview(project);
  } else {
    loadUrl();
  }
}

function backToDashboard() {
  saveCurrentAnswers();
  const project = getActiveProject();
  if (project) { project.currentStep = currentStep; saveState(); }
  document.getElementById('reviewScreen').classList.add('hidden');
  const mainEl = document.querySelector('.main');
  if (mainEl) mainEl.classList.remove('ff-mobile-mode');
  clearUrlParam('p');
  showDashboard();
}

// ═══════════════ FREE-FORM REVIEW ═══════════════

const FF_CATEGORIES = [
  { id: 'usability', label: 'Usability', icon: 'mouse-pointer', color: '#8b5cf6' },
  { id: 'visual', label: 'Visueel Design', icon: 'palette', color: '#ec4899' },
  { id: 'content', label: 'Content & Copy', icon: 'file-text', color: '#06b6d4' },
  { id: 'conversion', label: 'Conversie', icon: 'target', color: '#f59e0b' },
  { id: 'technical', label: 'Technisch', icon: 'code', color: '#10b981' },
  { id: 'ia', label: 'Navigatie & IA', icon: 'layout-grid', color: '#3b82f6' },
  { id: 'trust', label: 'Vertrouwen', icon: 'shield-check', color: '#14b8a6' },
  { id: 'other', label: 'Overig', icon: 'more-horizontal', color: '#6b7280' }
];

const FF_CAT_LABELS = {};
FF_CATEGORIES.forEach(c => FF_CAT_LABELS[c.id] = c.label);

function renderFreeFormReview(project) {
  const answers = project.answers || {};
  const findings = Object.keys(answers)
    .filter(k => k.startsWith('ff-'))
    .sort((a, b) => (answers[a].findingOrder || 0) - (answers[b].findingOrder || 0));

  const area = document.getElementById('questionsArea');

  // Update step indicator
  document.getElementById('stepIndicator').textContent = `Vrije Review · ${findings.length} bevinding${findings.length !== 1 ? 'en' : ''}`;

  // Stats
  const goodCount = findings.filter(f => answers[f]?.score === 'good').length;
  const okCount = findings.filter(f => answers[f]?.score === 'ok').length;
  const badCount = findings.filter(f => answers[f]?.score === 'bad').length;
  const unscoredCount = findings.filter(f => !answers[f]?.score).length;
  const scoredCount = findings.length - unscoredCount;

  // Build stepper for free-form (overview, geen voortgang%)
  const stepper = document.getElementById('stepStepper');
  if (stepper) {
    stepper.innerHTML = `
      <div style="padding:16px">
        <div style="font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);margin-bottom:12px">Bevindingen (${findings.length})</div>
        ${findings.map((fId, i) => {
          const a = answers[fId] || {};
          const scoreColor = a.score === 'good' ? 'var(--score-good)' : a.score === 'ok' ? 'var(--score-ok)' : a.score === 'bad' ? 'var(--score-bad)' : 'var(--border)';
          const label = a.findingTitle || (a.notes || '').split('\n')[0].substring(0, 40) || 'Bevinding ' + (i+1);
          return `<div style="padding:6px 8px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:12px;border-radius:6px;margin-bottom:2px;display:flex;align-items:center;gap:8px" onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background=''" onclick="document.getElementById('card-${fId}')?.scrollIntoView({behavior:'smooth',block:'center'})"><span style="width:8px;height:8px;border-radius:50%;background:${scoreColor};flex-shrink:0"></span>${esc(label)}</div>`;
        }).join('')}
        <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);font-size:11px;color:var(--text-muted)">
          ${badCount > 0 ? `<span style="color:var(--score-bad)">${badCount} niet ok</span> · ` : ''}${okCount > 0 ? `<span style="color:var(--score-ok)">${okCount} matig</span> · ` : ''}${goodCount > 0 ? `<span style="color:var(--score-good)">${goodCount} goed</span>` : ''}
        </div>
      </div>`;
  }

  area.innerHTML = `
    <div class="ff-header">
      <div class="ff-stats">
        <span class="ff-stat"><span class="dot dot-bad"></span> ${badCount} Niet OK</span>
        <span class="ff-stat"><span class="dot dot-ok"></span> ${okCount} Matig</span>
        <span class="ff-stat"><span class="dot dot-good"></span> ${goodCount} Goed</span>
        ${unscoredCount > 0 ? `<span class="ff-stat"><span class="dot dot-unscored"></span> ${unscoredCount} Onbeoordeeld</span>` : ''}
      </div>
    </div>

    <div id="ff-findings-list">
      ${findings.map((fId, idx) => renderFindingCard(fId, answers[fId], idx)).join('')}
    </div>

    <button class="ff-add-btn" onclick="addFreeFormFinding()">
      <i data-lucide="plus-circle"></i> Nieuwe bevinding toevoegen
    </button>

    <div class="ff-paste-zone" id="ffPasteZone">
      <i data-lucide="clipboard"></i>
      <span>Plak een screenshot (Ctrl+V) om direct een nieuwe bevinding te starten</span>
    </div>

    <div class="ff-footer">
      <div class="ff-footer-info">
        ${findings.length} bevinding${findings.length !== 1 ? 'en' : ''}${scoredCount > 0 ? ` · ${scoredCount} beoordeeld` : ''}
      </div>
      <button class="ff-scorecard-btn" onclick="showScorecard()" ${findings.length === 0 ? 'disabled' : ''}>
        <i data-lucide="bar-chart-3"></i> Resultaat bekijken
      </button>
    </div>
  `;

  if (typeof lucide !== 'undefined') lucide.createIcons();
}

function renderFindingCard(fId, finding, index) {
  const a = finding || {};
  const shots = a.screenshots || (a.screenshot ? [a.screenshot] : []);

  return `
    <div class="question-card ff-card ${a.score ? 'answered' : ''}" id="card-${fId}" onclick="setActiveQuestion('${fId}')" draggable="true" ondragstart="ffDragStart(event,'${fId}')" ondragover="ffDragOver(event)" ondrop="ffDrop(event,'${fId}')">

      <div class="ff-card-header">
        <span class="ff-card-number">${index + 1}</span>
        <div class="ff-card-spacer"></div>
        <button class="ff-delete-btn" onclick="event.stopPropagation(); deleteFinding('${fId}')" title="Verwijder bevinding">
          <i data-lucide="trash-2" style="width:14px;height:14px"></i>
        </button>
      </div>

      <textarea class="notes-input ff-notes-main" id="notes-${fId}"
        placeholder="Beschrijf je bevinding, probleem, of aanbeveling..."
        oninput="updateFindingNotes('${fId}', this.value)"
        onclick="event.stopPropagation()"
      >${a.notes || ''}</textarea>

      ${shots.length > 0 ? `
        <div class="ff-screenshots">
          ${shots.map((src, si) => `
            <div class="screenshot-thumb">
              <img class="screenshot-preview ff-screenshot-large" src="${src}" onclick="showLightbox('${fId}',${si})" title="Klik om te vergroten">
              <button class="screenshot-remove" onclick="event.stopPropagation(); removeScreenshot('${fId}',${si})" title="Verwijder">&times;</button>
            </div>
          `).join('')}
        </div>
      ` : ''}

      <div class="ff-bottom-row" onclick="event.stopPropagation()">
        <div class="ff-category-row">
          ${FF_CATEGORIES.map(c => {
            const cats = a.findingCategories || (a.findingCategory ? [a.findingCategory] : []);
            const isSel = cats.includes(c.id);
            return `
            <button class="ff-cat-tag ${isSel ? 'selected' : ''}"
              style="${isSel ? 'background:' + c.color + '22;border-color:' + c.color + '44;color:' + c.color : ''}"
              onclick="toggleFindingCategory('${fId}', '${c.id}')">
              <i data-lucide="${c.icon}" style="width:12px;height:12px"></i> ${c.label}
            </button>`;
          }).join('')}
        </div>

        <div class="screenshot-row">
          <button class="screenshot-btn capture-primary" id="capBtn-${fId}" onclick="capturePreviewScreenshot('${fId}')" title="Capture preview"><i data-lucide="camera"></i><span class="btn-label"> Capture</span></button>
          <button class="screenshot-btn" onclick="document.getElementById('file-${fId}').click()" title="Upload"><i data-lucide="upload"></i><span class="btn-label"> Upload</span></button>
          <span class="screenshot-hint"><i data-lucide="clipboard" style="width:11px;height:11px"></i> Ctrl+V</span>
          <input type="file" id="file-${fId}" accept="image/*" style="display:none" onchange="handleScreenshot('${fId}', this)">
        </div>

        <div class="score-row">
          <button class="score-btn score-bad ${a.score==='bad'?'selected':''}" onclick="setFfScore('${fId}','bad')"><i data-lucide="x"></i> Niet OK</button>
          <button class="score-btn score-ok ${a.score==='ok'?'selected':''}" onclick="setFfScore('${fId}','ok')">~ Matig</button>
          <button class="score-btn score-good ${a.score==='good'?'selected':''}" onclick="setFfScore('${fId}','good')"><i data-lucide="check"></i> Goed</button>
        </div>

        ${a.score === 'ok' || a.score === 'bad' ? `
          <div class="severity-row">
            ${a.score === 'ok' ? `
              <button class="sev-btn sev-quickwin ${a.severity==='high'?'selected':''}" onclick="setFfSeverity('${fId}','high')"><i data-lucide="zap"></i> Quick Win</button>
              <button class="sev-btn sev-filler ${a.severity!=='high'?'selected':''}" onclick="setFfSeverity('${fId}','low')"><i data-lucide="archive"></i> Opvuller</button>
            ` : `
              <button class="sev-btn sev-strategic ${a.severity==='high'?'selected':''}" onclick="setFfSeverity('${fId}','high')"><i data-lucide="target"></i> Strategisch</button>
              <button class="sev-btn sev-notnow ${a.severity!=='high'?'selected':''}" onclick="setFfSeverity('${fId}','low')"><i data-lucide="pause"></i> Niet Nu</button>
            `}
          </div>
        ` : ''}
      </div>
    </div>
  `;
}

// ── CRUD functies voor bevindingen ──

function addFreeFormFinding(initialScreenshot) {
  const project = getActiveProject();
  if (!project) return;
  if (!project.answers) project.answers = {};

  const fId = 'ff-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6);
  const existingCount = Object.keys(project.answers).filter(k => k.startsWith('ff-')).length;

  project.answers[fId] = {
    score: null,
    severity: null,
    notes: '',
    findingTitle: '',
    findingCategory: null,
    findingOrder: existingCount,
    screenshots: initialScreenshot ? [initialScreenshot] : []
  };

  saveState();
  saveCurrentAnswers();
  renderFreeFormReview(project);

  setTimeout(() => {
    const card = document.getElementById('card-' + fId);
    if (card) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    const notesInput = document.getElementById('notes-' + fId);
    if (notesInput) notesInput.focus();
  }, 100);
}

function deleteFinding(fId) {
  if (!confirm('Bevinding verwijderen?')) return;
  const project = getActiveProject();
  if (!project || !project.answers) return;
  delete project.answers[fId];
  const remaining = Object.keys(project.answers)
    .filter(k => k.startsWith('ff-'))
    .sort((a, b) => (project.answers[a].findingOrder || 0) - (project.answers[b].findingOrder || 0));
  remaining.forEach((k, i) => project.answers[k].findingOrder = i);
  saveState();
  saveCurrentAnswers();
  renderFreeFormReview(project);
}

function updateFindingTitle(fId, value) {
  const project = getActiveProject();
  if (!project?.answers?.[fId]) return;
  project.answers[fId].findingTitle = value;
  clearTimeout(window._ffSaveTimeout);
  window._ffSaveTimeout = setTimeout(() => { saveState(); saveCurrentAnswers(); }, 500);
}

function updateFindingNotes(fId, value) {
  const project = getActiveProject();
  if (!project?.answers?.[fId]) return;
  project.answers[fId].notes = value;
  lastActiveQId = fId;
  clearTimeout(window._ffSaveTimeout);
  window._ffSaveTimeout = setTimeout(() => { saveState(); saveCurrentAnswers(); }, 500);
}

function toggleFindingCategory(fId, catId) {
  const project = getActiveProject();
  if (!project?.answers?.[fId]) return;
  const a = project.answers[fId];
  // Migreer oud single-value naar array
  if (!a.findingCategories) {
    a.findingCategories = a.findingCategory ? [a.findingCategory] : [];
  }
  const idx = a.findingCategories.indexOf(catId);
  if (idx >= 0) {
    a.findingCategories.splice(idx, 1);
  } else {
    a.findingCategories.push(catId);
  }
  // Hou findingCategory in sync (eerste categorie, voor backward compat)
  a.findingCategory = a.findingCategories[0] || null;
  lastActiveQId = fId;
  saveState();
  saveCurrentAnswers();
  renderFreeFormReview(project);
}

function setFfScore(fId, score) {
  const project = getActiveProject();
  if (!project?.answers?.[fId]) return;
  if (project.answers[fId].score === score) {
    project.answers[fId].score = null;
    project.answers[fId].severity = null;
  } else {
    project.answers[fId].score = score;
    if (score === 'good') project.answers[fId].severity = null;
    if (score === 'bad') project.answers[fId].severity = 'high';
    if (score === 'ok') project.answers[fId].severity = 'low';
  }
  lastActiveQId = fId;
  saveState();
  saveCurrentAnswers();
  renderFreeFormReview(project);
}

function setFfSeverity(fId, severity) {
  const project = getActiveProject();
  if (!project?.answers?.[fId]) return;
  project.answers[fId].severity = severity;
  lastActiveQId = fId;
  saveState();
  saveCurrentAnswers();
  renderFreeFormReview(project);
}

// ── Drag & drop herordenen ──
let ffDraggedId = null;

function ffDragStart(e, fId) {
  ffDraggedId = fId;
  e.dataTransfer.effectAllowed = 'move';
  e.target.style.opacity = '0.5';
}

function ffDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
}

function ffDrop(e, targetId) {
  e.preventDefault();
  if (!ffDraggedId || ffDraggedId === targetId) return;

  const project = getActiveProject();
  if (!project?.answers) return;

  const allFindings = Object.keys(project.answers)
    .filter(k => k.startsWith('ff-'))
    .sort((a, b) => (project.answers[a].findingOrder || 0) - (project.answers[b].findingOrder || 0));

  const fromIdx = allFindings.indexOf(ffDraggedId);
  const toIdx = allFindings.indexOf(targetId);
  if (fromIdx === -1 || toIdx === -1) return;

  allFindings.splice(fromIdx, 1);
  allFindings.splice(toIdx, 0, ffDraggedId);
  allFindings.forEach((k, i) => project.answers[k].findingOrder = i);

  ffDraggedId = null;
  saveState();
  saveCurrentAnswers();
  renderFreeFormReview(project);
}

// ═══════════════ URL & DEVICE ═══════════════
function loadUrl() {
  const url = document.getElementById('urlInput').value.trim();
  if (!url) return;
  const frame = document.getElementById('previewFrame');
  const empty = document.getElementById('previewEmpty');
  frame.classList.remove('hidden');
  empty.classList.add('hidden');
  let finalUrl = url;
  if (!url.startsWith('http://') && !url.startsWith('https://')) finalUrl = 'https://' + url;
  const domain = finalUrl.replace('https://','').replace('http://','').split('/')[0];

  const wrapper = document.getElementById('previewWrapper');
  let blocked = false;
  let iframeConfirmed = false; // true if we positively confirmed iframe loaded

  // ── Pre-load thumbnail in background immediately ──
  const thumbUrl = `https://image.thum.io/get/width/1280/crop/900/${finalUrl}`;
  let thumbLoaded = false;
  let thumbDataUrl = null;
  const preloadImg = new Image();
  preloadImg.crossOrigin = 'anonymous';
  preloadImg.onload = () => { thumbLoaded = true; };
  preloadImg.src = thumbUrl;

  // ── Show static thumbnail preview ──
  function showBlocked() {
    if (blocked) return;
    blocked = true;

    // Remove help button if present
    const helpBtn = wrapper.querySelector('.iframe-help-btn');
    if (helpBtn) helpBtn.remove();

    frame.classList.add('hidden');
    empty.classList.remove('hidden');

    empty.innerHTML = `
      <div class="static-preview">
        <div class="static-preview-loading" id="thumbLoader" ${thumbLoaded ? 'style="display:none"' : ''}>
          <div class="static-preview-spinner"></div>
          <p style="font-size:12px">Statische preview laden van <strong>${domain}</strong>...</p>
        </div>
        <img class="static-preview-img" id="thumbImg" ${thumbLoaded ? '' : 'style="display:none"'}
          src="${thumbUrl}" alt="Preview van ${domain}">
        <div class="static-preview-error" id="thumbError" style="display:none">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:48px;height:48px;opacity:0.4">
            <rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>
          </svg>
          <p style="max-width:300px;line-height:1.6"><strong style="color:var(--accent)">${domain}</strong> blokkeert iframe-embedding.<br>Open de site naast deze tool om te reviewen.</p>
        </div>
        <div class="static-preview-badge">
          <span class="badge-label"><span class="dot"></span> Statische preview — iframe geblokkeerd</span>
          <div class="static-preview-actions">
            <a href="${finalUrl}" target="_blank" class="btn-open" onclick="enterReviewMode()">↗ Open in nieuw tabblad</a>
            <button onclick="refreshThumbnail('${finalUrl}')" class="btn-side">↻ Ververs</button>
          </div>
        </div>
      </div>`;

    // Handle thumbnail load/error for the visible image
    const visImg = document.getElementById('thumbImg');
    const loader = document.getElementById('thumbLoader');
    const errDiv = document.getElementById('thumbError');
    if (!thumbLoaded) {
      visImg.onload = () => { loader.style.display = 'none'; visImg.style.display = 'block'; };
      visImg.onerror = () => { loader.style.display = 'none'; errDiv.style.display = 'flex'; };
      setTimeout(() => {
        if (loader.style.display !== 'none') { loader.style.display = 'none'; errDiv.style.display = 'flex'; }
      }, 15000);
    }
  }

  // ── Load iframe ──
  frame.src = finalUrl;
  frame.onerror = showBlocked;

  frame.onload = () => {
    // Check 1: about:blank means blocked
    try {
      const loc = frame.contentWindow?.location?.href;
      if (loc === 'about:blank') { showBlocked(); return; }
      // If we can read the full URL without error → same-origin, iframe loaded fine
      iframeConfirmed = true;
    } catch(e) {
      // Cross-origin: can't determine if loaded or blocked
      // Check if we can access contentDocument (same-origin error pages)
      try {
        const doc = frame.contentDocument;
        if (doc && doc.body) {
          const text = (doc.body.innerText || '').toLowerCase();
          if (doc.body.innerHTML.trim() === '' ||
              text.includes('geweigerd') || text.includes('refused') ||
              text.includes('blocked') || text.includes('err_')) {
            showBlocked();
            return;
          }
          iframeConfirmed = true;
        }
      } catch(e2) { /* truly cross-origin */ }
    }
  };

  // ── Fallback: after 1.5s show floating help button for cross-origin iframes ──
  setTimeout(() => {
    if (blocked || iframeConfirmed) return;
    if (frame.classList.contains('hidden')) return;

    // We can't tell if the iframe loaded or is showing an error page
    // Show a help button with prominent "open in venster" option
    const existingBtn = wrapper.querySelector('.iframe-help-btn');
    if (existingBtn) return;

    const helpBtn = document.createElement('button');
    helpBtn.className = 'iframe-help-btn';
    helpBtn.innerHTML = '<i data-lucide="shield-alert" style="width:14px;height:14px"></i> Site niet zichtbaar? <span style="text-decoration:underline">Open in tabblad</span>';
    helpBtn.onclick = () => { showBlocked(); openSideBySide(finalUrl); };
    wrapper.appendChild(helpBtn);
    if (typeof lucide !== 'undefined') lucide.createIcons({nodes:[helpBtn]});
  }, 1500);
}

let siteWindow = null;

function toggleSiteWindow() {
  const main = document.querySelector('.main');
  const isReviewMode = main && main.classList.contains('review-mode');
  if (isReviewMode) {
    exitReviewMode();
  } else {
    const url = document.getElementById('urlInput').value.trim();
    if (!url) { alert('Voer eerst een URL in.'); return; }
    let finalUrl = url;
    if (!url.startsWith('http://') && !url.startsWith('https://')) finalUrl = 'https://' + url;
    openSideBySide(finalUrl);
  }
}

function openSideBySide(url) {
  // Open in a new tab — user can use Chrome's split view (right-click tab → gesplitste weergave)
  if (siteWindow && !siteWindow.closed) siteWindow.close();
  siteWindow = window.open(url, '_blank');
  enterReviewMode();
}

function enterReviewMode() {
  const main = document.querySelector('.main');
  if (main) main.classList.add('review-mode');
  // Hide preview panel
  const pp = document.querySelector('.preview-panel');
  if (pp) pp.style.display = 'none';
  const rp = document.querySelector('.review-panel');
  if (rp) { rp.style.width = '100%'; rp.style.maxWidth = '100%'; rp.style.minWidth = '100%'; rp.style.borderRight = 'none'; }
  // Hide URL toolbar (site opened in external window)
  const urlBar = document.getElementById('urlToolbar');
  if (urlBar) urlBar.style.display = 'none';
  // Adjust topbar sticky position
  const topbar = document.querySelector('.topbar');
  if (topbar) topbar.style.top = '0';
  // Adjust main height
  if (main) main.style.height = 'calc(100vh - 44px)';
  // Show review mode info in topbar subtitle
  const review = document.getElementById('deviceBarReview');
  if (review) review.style.display = 'inline-flex';
  // Show scan URL input (user can't change urlInput in review-mode)
  const scanInput = document.getElementById('scanUrlInput');
  if (scanInput) {
    scanInput.style.display = 'block';
    const project = getActiveProject();
    scanInput.value = project?.url || '';
  }
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

function exitReviewMode() {
  const main = document.querySelector('.main');
  if (main) main.classList.remove('review-mode');
  // Restore preview panel
  const pp = document.querySelector('.preview-panel');
  if (pp) pp.style.display = '';
  const rp = document.querySelector('.review-panel');
  if (rp) { rp.style.width = ''; rp.style.maxWidth = ''; rp.style.minWidth = ''; rp.style.borderRight = ''; }
  // Restore URL toolbar
  const urlBar = document.getElementById('urlToolbar');
  if (urlBar) urlBar.style.display = '';
  // Restore topbar sticky position
  const topbar = document.querySelector('.topbar');
  if (topbar) topbar.style.top = '';
  // Restore main height
  if (main) main.style.height = '';
  // Hide review mode info in topbar subtitle
  const review = document.getElementById('deviceBarReview');
  if (review) review.style.display = 'none';
  // Hide scan URL input
  const scanInput = document.getElementById('scanUrlInput');
  if (scanInput) scanInput.style.display = 'none';
  if (typeof lucide !== 'undefined') lucide.createIcons();
  // Close site window
  if (siteWindow && !siteWindow.closed) siteWindow.close();
  siteWindow = null;
}

// focusSiteWindow and captureExternalScreenshot removed — simplified to toggle + Ctrl+V paste

function refreshThumbnail(url) {
  const img = document.getElementById('thumbImg');
  const loader = document.getElementById('thumbLoader');
  const errDiv = document.getElementById('thumbError');
  if (!img || !loader) return;
  img.style.display = 'none';
  if (errDiv) errDiv.style.display = 'none';
  loader.style.display = 'flex';
  // Cache-bust with timestamp
  img.src = `https://image.thum.io/get/width/1280/crop/900/${url}?t=${Date.now()}`;
}

function switchDevice(device, btn) {
  document.querySelectorAll('.device-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('previewWrapper').className = 'preview-frame-wrapper ' + device;
}

// ═══════════════ STEP NAVIGATION ═══════════════
function buildStepper() { try {
  const answers = getAnswers();
  const stepper = document.getElementById('stepStepper');
  // Progress at top of stepper — only count answers matching current step questions
  const totalQ = reviewSteps.reduce((sum, s) => sum + s.questions.length, 0);
  const stepQIds = new Set(reviewSteps.flatMap(s => s.questions.map(q => q.id)));
  const answeredQ = Object.entries(answers).filter(([id, a]) => a.score && stepQIds.has(id)).length;
  const pct = totalQ > 0 ? Math.min(Math.round((answeredQ / totalQ) * 100), 100) : 0;
  const progressColor = pct === 100 ? 'var(--green)' : 'var(--accent)';

  stepper.innerHTML = `
    <div class="stepper-progress">
      <div class="stepper-progress-label">Voortgang</div>
      <div class="stepper-progress-row">
        <div class="stepper-progress-bar"><div class="stepper-progress-fill" style="width:${pct}%;background:${progressColor}"></div></div>
        <div class="stepper-progress-pct" id="progressPct" style="color:${progressColor}">${pct}%</div>
      </div>
    </div>` + (() => {
    let lastModuleId = null;
    return reviewSteps.map((step, i) => {
      const scored = step.questions.filter(q => answers[q.id]?.score && answers[q.id].score !== 'nvt');
      const total = step.questions.length;
      const isCompleted = step.questions.every(q => answers[q.id]?.score);
      const isLast = i === reviewSteps.length - 1;

      let avg = 0;
      let meta = '';

      if (scored.length > 0) {
        const ws = calcWeightedScore(step.questions, answers);
        avg = ws.score;
        meta = `<div class="stepper-meta">${avg.toFixed(1)} · ${scored.length}/${total} beoordeeld</div>`;
      }

      const isActive = i === currentStep;
      const status = isActive ? 'active' : isCompleted ? 'completed' : 'pending';
      const isFirst = i === 0;
      const chk = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';

      // Module header when module changes
      let moduleHeader = '';
      if (step.moduleId && step.moduleId !== lastModuleId) {
        lastModuleId = step.moduleId;
        moduleHeader = `<div class="stepper-module-header" style="border-left:3px solid ${step.moduleColor || 'var(--accent)'}"><span style="color:${step.moduleColor || 'var(--accent)'}">${step.moduleName || ''}</span></div>`;
      }

      return `${moduleHeader}
        <div class="stepper-item ${status}" onclick="goToStep(${i})" ${step.moduleColor ? `style="--mod-color:${step.moduleColor}"` : ''}>
          <div class="stepper-track">
            <div class="stepper-line line-top${isFirst?' line-hidden':''}"></div>
            <div class="stepper-circle">${isCompleted && !isActive ? chk : i + 1}</div>
            <div class="stepper-line line-btm${isLast?' line-hidden':''}"></div>
          </div>
          <div class="stepper-info">
            <div class="stepper-label">${step.shortTitle}</div>
            ${meta}
          </div>
        </div>`;
    }).join('');
  })();
  // Scroll active step into view
  setTimeout(() => {
    const active = stepper.querySelector('.stepper-item.active');
    if (active) active.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 50);
} catch(e) { console.error('[RenderError] buildStepper:', e); const el = document.getElementById('stepStepper'); if (el) el.innerHTML = `<div style="padding:24px;text-align:center;color:var(--red)"><p style="font-weight:600">Er ging iets mis bij het laden.</p><p style="font-size:12px;color:var(--text-muted);margin-top:8px">${esc(e.message)}</p><button class="btn btn-secondary" onclick="location.reload()" style="margin-top:12px">Herlaad pagina</button></div>`; } }

function goToStep(i) { saveCurrentAnswers(); currentStep = i; renderStep(i); buildStepper(); }

function nextStep() {
  saveCurrentAnswers();
  if (currentStep < reviewSteps.length - 1) { currentStep++; renderStep(currentStep); buildStepper(); }
  else showScorecard();
}

function prevStep() {
  saveCurrentAnswers();
  if (currentStep > 0) { currentStep--; renderStep(currentStep); buildStepper(); }
}

// ═══════════════ RENDER STEP ═══════════════
// ═══ FOCUS MODE: één vraag tegelijk ═══
let _focusQIndex = 0;

function updateFocusView(step) {
  if (!step) { step = reviewSteps[currentStep]; }
  if (!step) return;
  const questions = step.questions;
  const answers = getAnswers();

  // Alle kaarten verbergen, alleen actieve tonen
  questions.forEach((q, i) => {
    const card = document.getElementById('card-' + q.id);
    if (card) {
      card.classList.toggle('q-focus-active', i === _focusQIndex);
    }
  });

  // Dots updaten
  const dotsEl = document.getElementById('focusDots');
  if (dotsEl) {
    dotsEl.innerHTML = questions.map((q, i) => {
      const a = answers[q.id] || {};
      let cls = 'focus-dot';
      if (i === _focusQIndex) cls += ' dot-active';
      else if (a.score === 'nvt') cls += ' dot-nvt';
      else if (a.score) cls += ' dot-answered';
      return `<div class="${cls}" onclick="focusGoTo(${i})" title="Vraag ${i+1}"></div>`;
    }).join('');
  }

  // Knoppen disable
  const prevBtn = document.getElementById('focusPrevBtn');
  const nextBtn = document.getElementById('focusNextBtn');
  if (prevBtn) prevBtn.disabled = _focusQIndex <= 0;
  if (nextBtn) {
    if (_focusQIndex >= questions.length - 1) {
      const isLastStep = currentStep >= reviewSteps.length - 1;
      if (isLastStep) {
        nextBtn.innerHTML = '<i data-lucide="check-circle" style="width:14px;height:14px"></i> Voltooi Review';
        nextBtn.style.background = 'var(--green)'; nextBtn.style.borderColor = 'var(--green)'; nextBtn.style.color = '#fff';
      } else {
        nextBtn.innerHTML = 'Volgende stap <i data-lucide="chevrons-right" style="width:14px;height:14px"></i>';
        nextBtn.style.background = ''; nextBtn.style.borderColor = ''; nextBtn.style.color = '';
      }
      nextBtn.onclick = () => nextStep();
    } else {
      nextBtn.innerHTML = 'Volgende <i data-lucide="chevron-right" style="width:14px;height:14px"></i>';
      nextBtn.style.background = ''; nextBtn.style.borderColor = ''; nextBtn.style.color = '';
      nextBtn.onclick = () => focusNextQ();
    }
    nextBtn.disabled = false;
  }

  // Scroll naar boven
  const area = document.getElementById('questionsArea');
  if (area) area.scrollTop = 0;

  if (typeof lucide !== 'undefined') lucide.createIcons();
}

function focusNextQ() {
  const step = reviewSteps[currentStep];
  if (!step) return;
  if (_focusQIndex < step.questions.length - 1) {
    _focusQIndex++;
    updateFocusView(step);
  }
}

function focusPrevQ() {
  if (_focusQIndex > 0) {
    _focusQIndex--;
    updateFocusView(reviewSteps[currentStep]);
  }
}

function focusGoTo(index) {
  _focusQIndex = index;
  updateFocusView(reviewSteps[currentStep]);
}

function renderStep(stepIndex, resetScroll) { try {
  if (resetScroll === undefined) resetScroll = true;
  if (resetScroll) lastActiveQId = null; // reset paste target on step change
  const step = reviewSteps[stepIndex];
  if (!step) { console.warn('[renderStep] Geen step gevonden voor index', stepIndex); return; }
  const answers = getAnswers();
  const area = document.getElementById('questionsArea');
  const prevScrollTop = area.scrollTop;
  document.getElementById('stepIndicator').textContent = step.moduleName ? `${step.moduleName} · Stap ${stepIndex + 1} / ${reviewSteps.length}` : `Stap ${stepIndex + 1} / ${reviewSteps.length}`;

  const stepScored = step.questions.filter(q => answers[q.id]?.score && answers[q.id].score !== 'nvt');
  const stepNvt = step.questions.filter(q => answers[q.id]?.score === 'nvt').length;
  const stepEffective = step.questions.length - stepNvt;
  const stepAnswered = stepScored.length + stepNvt;
  // Weighted scoring per step
  const stepWs = calcWeightedScore(step.questions, answers);
  const avgScore = stepEffective > 0 ? stepWs.score : 0;
  const scoreClass = stepEffective === 0 ? 'neutral' : avgScore >= 8 ? 'good' : avgScore >= 5 ? 'ok' : 'bad';

  area.innerHTML = `
    ${step.moduleColor ? `<div class="module-badge" style="background:${step.moduleColor}22;border:1px solid ${step.moduleColor}44;color:${step.moduleColor}"><i data-lucide="${step.moduleIcon || 'box'}"></i> ${step.moduleName || ''}</div>` : ''}
    <div class="category-title">${step.title}</div>
    <div class="category-desc">${step.desc}</div>
    <div class="score-summary">
      <div class="score-circle ${scoreClass}">${stepEffective > 0 ? avgScore.toFixed(1) : '—'}</div>
      <div class="score-meta">
        <div class="label">Categorie Score</div>
        <div class="sublabel">${stepScored.length} / ${stepEffective} beoordeeld${stepNvt > 0 ? ` · ${stepNvt} n.v.t.` : ''}${stepScored.length < stepEffective ? ' · onbeantwoord = 0 punten' : ''}</div>
      </div>
    </div>
    ${step.questions.map((q, qi) => {
      const a = answers[q.id] || {};
      return `
        <div class="question-card ${a.score === 'nvt' ? 'answered-nvt' : a.score ? 'answered' : ''}" id="card-${q.id}" onclick="setActiveQuestion('${q.id}')">
          <div class="question-label"><span class="q-num">${qi + 1}.</span>${q.text}${a.autoScanned ? '<span class="auto-badge"><i data-lucide="zap"></i> auto</span>' : ''}${q.type === 'auto' ? '<span class="auto-badge" style="background:#3b82f622;color:#3b82f6;border-color:#3b82f644"><i data-lucide="cpu"></i> auto-check</span>' : ''}${q.severity === 'critical' ? '<span class="sev-badge sev-critical">kritiek</span>' : ''}</div>
          ${q.business_impact_nl && (a.score === 'bad' || a.score === 'ok') ? '<div class="check-impact"><i data-lucide="alert-triangle" style="width:12px;height:12px;flex-shrink:0"></i> ' + q.business_impact_nl + '</div>' : ''}
          ${q.fix_suggestion_nl && (a.score === 'bad' || a.score === 'ok') ? '<div class="check-fix"><i data-lucide="wrench" style="width:12px;height:12px;flex-shrink:0"></i> ' + q.fix_suggestion_nl + '</div>' : ''}
          <div class="score-row">
            <button class="score-btn score-bad ${a.score==='bad'?'selected':''}" onclick="setScore('${q.id}','bad')"><i data-lucide="x"></i> Niet OK</button>
            <button class="score-btn score-ok ${a.score==='ok'?'selected':''}" onclick="setScore('${q.id}','ok')">~ Matig</button>
            <button class="score-btn score-good ${a.score==='good'?'selected':''}" onclick="setScore('${q.id}','good')"><i data-lucide="check"></i> Goed</button>
            <button class="score-btn score-nvt ${a.score==='nvt'?'selected':''}" onclick="setScore('${q.id}','nvt')">N.v.t.</button>
          </div>
          ${a.score==='ok'||a.score==='bad' ? (()=>{ const sev = a.severity || step.impact || 'low'; const isHigh = sev==='high'; return a.score==='ok' ? `<div class="severity-row">
            <button class="sev-btn sev-quickwin ${isHigh?'selected':''}" onclick="setSeverity('${q.id}','high',this)"><i data-lucide="zap"></i> Quick Win</button>
            <button class="sev-btn sev-filler ${!isHigh?'selected':''}" onclick="setSeverity('${q.id}','low',this)"><i data-lucide="archive"></i> Opvuller</button>
          </div>` : `<div class="severity-row">
            <button class="sev-btn sev-strategic ${isHigh?'selected':''}" onclick="setSeverity('${q.id}','high',this)"><i data-lucide="target"></i> Strategisch</button>
            <button class="sev-btn sev-notnow ${!isHigh?'selected':''}" onclick="setSeverity('${q.id}','low',this)"><i data-lucide="pause"></i> Niet Nu</button>
          </div>`; })() : ''}
          <textarea class="notes-input" id="notes-${q.id}" placeholder="Notities, bevindingen, aanbevelingen...">${esc(a.notes||'')}</textarea>
          <div class="screenshot-row">
            ${getScreenshots(q.id).map((src, si) => `
              <div class="screenshot-thumb">
                <img class="screenshot-preview" src="${src}" onclick="showLightbox('${q.id}',${si})" title="Klik om te vergroten">
                <button class="screenshot-remove" onclick="removeScreenshot('${q.id}',${si})" title="Verwijder">×</button>
              </div>
            `).join('')}
            <button class="screenshot-btn capture-primary" id="capBtn-${q.id}" onclick="capturePreviewScreenshot('${q.id}')" title="Capture preview"><i data-lucide="camera"></i><span class="btn-label"> Capture</span></button>
            <button class="screenshot-btn" onclick="document.getElementById('file-${q.id}').click()" title="Upload"><i data-lucide="upload"></i><span class="btn-label"> Upload</span></button>
            <span class="screenshot-hint"><i data-lucide="clipboard" style="width:11px;height:11px"></i> Ctrl+V</span>
            <input type="file" id="file-${q.id}" accept="image/*" style="display:none" onchange="handleScreenshot('${q.id}', this)">
          </div>
          ${q.hasContrastChecker ? `
          <div class="inline-cc" style="margin-top:12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:16px">
            <div style="font-size:13px;font-weight:700;margin-bottom:12px;color:var(--text)"><i data-lucide="contrast"></i> Contrast Checker</div>
            <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">
              <div>
                <label style="font-size:10px;color:var(--text-muted);display:block;margin-bottom:3px">TEKST</label>
                <div class="cc-color-input"><input type="color" id="iccFg" value="#333333" oninput="syncColorText('iccFg','iccFgHex');updateInlineCC()"><input type="text" id="iccFgHex" value="#333333" oninput="syncColorPicker('iccFgHex','iccFg');updateInlineCC()" maxlength="7"></div>
              </div>
              <div>
                <label style="font-size:10px;color:var(--text-muted);display:block;margin-bottom:3px">ACHTERGROND</label>
                <div class="cc-color-input"><input type="color" id="iccBg" value="#FFFFFF" oninput="syncColorText('iccBg','iccBgHex');updateInlineCC()"><input type="text" id="iccBgHex" value="#FFFFFF" oninput="syncColorPicker('iccBgHex','iccBg');updateInlineCC()" maxlength="7"></div>
              </div>
              <button class="cc-swap" onclick="swapInlineCC()" style="margin-bottom:0">⇅</button>
            </div>
            <div style="display:flex;gap:12px;margin-top:12px;align-items:center">
              <div id="iccPreview" style="flex:1;padding:12px;border-radius:8px;background:#fff;color:#333;text-align:center;border:1px solid var(--border)">
                <div style="font-size:18px;font-weight:700">Aa Voorbeeld</div>
                <div style="font-size:12px">Leesbaarheid test</div>
              </div>
              <div style="text-align:center;min-width:80px">
                <div id="iccRatio" style="font-size:28px;font-weight:900">—</div>
                <div style="font-size:10px;color:var(--text-muted)">ratio</div>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;margin-top:10px">
              <div style="text-align:center;padding:6px;background:var(--surface);border-radius:6px">
                <div style="font-size:9px;color:var(--text-muted)">AA Norm</div>
                <div id="iccAAnorm" style="font-size:12px;font-weight:800">—</div>
              </div>
              <div style="text-align:center;padding:6px;background:var(--surface);border-radius:6px">
                <div style="font-size:9px;color:var(--text-muted)">AA Groot</div>
                <div id="iccAAlarge" style="font-size:12px;font-weight:800">—</div>
              </div>
              <div style="text-align:center;padding:6px;background:var(--surface);border-radius:6px">
                <div style="font-size:9px;color:var(--text-muted)">AAA Norm</div>
                <div id="iccAAAnorm" style="font-size:12px;font-weight:800">—</div>
              </div>
              <div style="text-align:center;padding:6px;background:var(--surface);border-radius:6px">
                <div style="font-size:9px;color:var(--text-muted)">AAA Groot</div>
                <div id="iccAAAlarge" style="font-size:12px;font-weight:800">—</div>
              </div>
            </div>
          </div>` : ''}
        </div>`;
    }).join('')}
    <div class="focus-nav" id="focusNav">
      <button class="focus-nav-btn" id="focusPrevBtn" onclick="focusPrevQ()"><i data-lucide="chevron-left" style="width:14px;height:14px"></i> Vorige</button>
      <div class="focus-nav-counter">
        <div class="focus-dots" id="focusDots"></div>
      </div>
      <button class="focus-nav-btn" id="focusNextBtn" onclick="focusNextQ()">Volgende <i data-lucide="chevron-right" style="width:14px;height:14px"></i></button>
    </div>`;

  // Focus mode: altijd actief, toon 1 vraag tegelijk
  area.classList.add('focus-mode');

  if (resetScroll) { area.scrollTop = 0; } else { area.scrollTop = prevScrollTop; }
  updateProgress();

  // Focus: bij nieuwe stap → eerste onbeantwoorde, bij re-render → behoud huidige index
  if (resetScroll) {
    const firstUnanswered = step.questions.findIndex(q => !answers[q.id]?.score);
    _focusQIndex = firstUnanswered >= 0 ? firstUnanswered : 0;
  }
  // Clamp index (veiligheid)
  if (_focusQIndex >= step.questions.length) _focusQIndex = step.questions.length - 1;
  if (_focusQIndex < 0) _focusQIndex = 0;
  updateFocusView(step);

  if (typeof lucide !== 'undefined') lucide.createIcons();
} catch(e) { console.error('[RenderError] renderStep:', e); const el = document.getElementById('questionsArea'); if (el) el.innerHTML = `<div style="padding:24px;text-align:center;color:var(--red)"><p style="font-weight:600">Er ging iets mis bij het laden.</p><p style="font-size:12px;color:var(--text-muted);margin-top:8px">${esc(e.message)}</p><button class="btn btn-secondary" onclick="location.reload()" style="margin-top:12px">Herlaad pagina</button></div>`; } }

// ═══════════════ SCORING ═══════════════
function setScore(qId, score) {
  const answers = getAnswers();
  if (!answers[qId]) answers[qId] = {};
  // Save ALL notes on current step before re-render
  const step = reviewSteps[currentStep];
  step.questions.forEach(q => {
    const ne = document.getElementById('notes-' + q.id);
    if (ne) {
      if (!answers[q.id]) answers[q.id] = {};
      answers[q.id].notes = ne.value;
    }
  });
  answers[qId].score = score;
  if (score === 'nvt' || score === 'good') { delete answers[qId].severity; }
  saveState();

  // Auto-advance: bij 'goed' of 'nvt' → spring naar volgende onbeantwoorde vraag
  if (score === 'good' || score === 'nvt') {
    const nextUnanswered = step.questions.findIndex((q, i) => i > _focusQIndex && !answers[q.id]?.score);
    if (nextUnanswered >= 0) {
      _focusQIndex = nextUnanswered;
    } else if (_focusQIndex < step.questions.length - 1) {
      _focusQIndex++;
    }
  }

  renderStep(currentStep, false);
  buildStepper();
}

function setSeverity(qId, severity, btn) {
  const answers = getAnswers();
  if (!answers[qId]) answers[qId] = {};
  answers[qId].severity = severity;
  const card = document.getElementById('card-' + qId);
  card.querySelectorAll('.sev-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  saveState();
}

function saveCurrentAnswers() {
  const project = getActiveProject();
  if (!project) return;

  // Free-form: notes worden al direct opgeslagen via updateFindingNotes
  if (project.reviewType === 'free-form') {
    saveState();
    return;
  }

  const step = reviewSteps[currentStep];
  if (!step) { saveState(); return; }
  step.questions.forEach(q => {
    const notesEl = document.getElementById('notes-' + q.id);
    if (notesEl) {
      if (!project.answers[q.id]) project.answers[q.id] = {};
      project.answers[q.id].notes = notesEl.value;
    }
  });
  saveState();
}

// ═══════════════ SCREENSHOTS ═══════════════
function handleScreenshot(qId, input) {
  if (!input.files || !input.files[0]) return;
  const file = input.files[0];
  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      const maxW = 800;
      const scale = Math.min(1, maxW / img.width);
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
      saveCurrentAnswers();
      addScreenshot(qId, dataUrl);
      const proj = getActiveProject();
      if (proj?.reviewType === 'free-form') {
        renderFreeFormReview(proj);
      } else {
        renderStep(currentStep, false);
      }
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// ── Multi-screenshot helpers ──
function getScreenshots(qId) {
  const a = getAnswers()[qId];
  if (!a) return [];
  if (a.screenshots && Array.isArray(a.screenshots)) return a.screenshots;
  if (a.screenshot) return [a.screenshot]; // backward compat
  return [];
}

function addScreenshot(qId, dataUrl) {
  const answers = getAnswers();
  if (!answers[qId]) answers[qId] = {};
  // Migrate old single screenshot to array
  if (answers[qId].screenshot && !answers[qId].screenshots) {
    answers[qId].screenshots = [answers[qId].screenshot];
    delete answers[qId].screenshot;
  }
  if (!answers[qId].screenshots) answers[qId].screenshots = [];
  answers[qId].screenshots.push(dataUrl);
  saveState();
  // Upload to Firebase
  const project = getActiveProject();
  const idx = answers[qId].screenshots.length - 1;
  if (project) uploadScreenshotToStorage(project.id, qId + '_' + idx, dataUrl);
}

function removeScreenshot(qId, idx) {
  const answers = getAnswers();
  if (!answers[qId]) return;
  // Migrate old format
  if (answers[qId].screenshot && !answers[qId].screenshots) {
    answers[qId].screenshots = [answers[qId].screenshot];
    delete answers[qId].screenshot;
  }
  if (answers[qId].screenshots) {
    answers[qId].screenshots.splice(idx, 1);
    if (answers[qId].screenshots.length === 0) delete answers[qId].screenshots;
  }
  delete answers[qId].screenshot; // clean up old field
  saveState();
  saveCurrentAnswers();
  const proj = getActiveProject();
  if (proj?.reviewType === 'free-form') {
    renderFreeFormReview(proj);
  } else {
    renderStep(currentStep, false);
  }
}

// ── Auto-paste screenshot on Ctrl+V ──
let lastActiveQId = null; // tracks which question user last interacted with

function setActiveQuestion(qId) {
  lastActiveQId = qId;
  // Visual indicator: highlight active question's screenshot row
  document.querySelectorAll('.screenshot-row').forEach(r => r.classList.remove('paste-target'));
  const row = document.querySelector(`#notes-${qId}`)?.closest('.question-card')?.querySelector('.screenshot-row');
  if (row) row.classList.add('paste-target');
}

function getActiveQuestionId() {
  // 1. If a notes textarea is focused, use that question
  const focused = document.activeElement;
  if (focused && focused.id && focused.id.startsWith('notes-')) {
    return focused.id.replace('notes-', '');
  }
  // 1b. If a title input is focused (free-form), use that finding
  if (focused && focused.id && focused.id.startsWith('title-')) {
    return focused.id.replace('title-', '');
  }
  // 2. Use last actively clicked/interacted question
  if (lastActiveQId) {
    // Free-form: ff- IDs zijn altijd geldig
    if (lastActiveQId.startsWith('ff-')) return lastActiveQId;
    // Verify it's still on the current step
    if (typeof reviewSteps !== 'undefined' && reviewSteps[currentStep]) {
      const onStep = reviewSteps[currentStep].questions.some(q => q.id === lastActiveQId);
      if (onStep) return lastActiveQId;
    }
  }
  // 3. Fallback: first question in current step without a screenshot
  if (typeof reviewSteps !== 'undefined' && typeof currentStep !== 'undefined' && reviewSteps[currentStep]) {
    const answers = getAnswers();
    for (const q of reviewSteps[currentStep].questions) {
      if (!answers[q.id]?.screenshot) return q.id;
    }
    return reviewSteps[currentStep].questions[0]?.id;
  }
  return null;
}

// Global paste listener — works automatically, no need to click "Plak" first
document.addEventListener('paste', function(e) {
  // Only on review screen
  const reviewScreen = document.getElementById('reviewScreen');
  if (!reviewScreen || reviewScreen.classList.contains('hidden')) return;
  // Don't intercept text pastes in text fields
  const focused = document.activeElement;
  const isTextInput = focused && (focused.tagName === 'INPUT' && focused.type !== 'file');

  // Check if clipboard contains an image
  const items = e.clipboardData?.items;
  if (!items) return;
  const hasImage = Array.from(items).some(item => item.type.startsWith('image/'));

  // If no image in clipboard, let text paste through normally
  if (!hasImage) return;
  // If typing in text input and no image, don't intercept
  if (isTextInput && !hasImage) return;
  for (const item of items) {
    if (item.type.startsWith('image/')) {
      e.preventDefault();
      const blob = item.getAsFile();
      const reader = new FileReader();
      reader.onload = function(ev) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const maxW = 800;
          const scale = Math.min(1, maxW / img.width);
          canvas.width = img.width * scale;
          canvas.height = img.height * scale;
          canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
          const dataUrl = canvas.toDataURL('image/jpeg', 0.7);

          // ── FREE-FORM: paste creëert nieuwe bevinding als geen active question ──
          const project = getActiveProject();
          if (project?.reviewType === 'free-form') {
            const targetQId = getActiveQuestionId();
            if (targetQId && targetQId.startsWith('ff-')) {
              addScreenshot(targetQId, dataUrl);
              renderFreeFormReview(project);
            } else {
              addFreeFormFinding(dataUrl);
            }
            return;
          }

          // ── BESTAAND: voeg toe aan actieve vraag ──
          const targetQId = getActiveQuestionId();
          if (!targetQId) return;
          saveCurrentAnswers();
          addScreenshot(targetQId, dataUrl);
          const card = document.getElementById('card-' + targetQId);
          if (card) { card.style.boxShadow = '0 0 0 2px var(--accent)'; setTimeout(() => card.style.boxShadow = '', 800); }
          renderStep(currentStep, false);
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(blob);
      return;
    }
  }
});

// ═══════════════ DIRECT PREVIEW CAPTURE (Screen Capture API) ═══════════════
async function capturePreviewScreenshot(qId) {
  const btn = document.getElementById('capBtn-' + qId);
  if (btn) { btn.disabled = true; btn.textContent = '⏳ Delen...'; }

  try {
    // Request screen capture — preferCurrentTab hints to share this tab
    const stream = await navigator.mediaDevices.getDisplayMedia({
      video: { displaySurface: 'browser' },
      preferCurrentTab: true
    });

    if (btn) { btn.innerHTML = '<i data-lucide="camera"></i> Vastleggen...'; lucide.createIcons({nodes:[btn]}); }

    const track = stream.getVideoTracks()[0];
    const video = document.createElement('video');
    video.srcObject = stream;
    video.muted = true;
    await video.play();

    // Wait for real video frames using requestVideoFrameCallback (reliable)
    // or a generous timeout as fallback
    await new Promise(resolve => {
      if ('requestVideoFrameCallback' in video) {
        video.requestVideoFrameCallback(() => {
          video.requestVideoFrameCallback(resolve); // wait 2 frames
        });
      } else {
        setTimeout(resolve, 1200);
      }
    });

    const vw = video.videoWidth;
    const vh = video.videoHeight;
    console.log('[Capture] Video dimensions:', vw, 'x', vh, '| Viewport:', window.innerWidth, 'x', window.innerHeight);

    if (vw === 0 || vh === 0) {
      throw new Error('Video dimensions are 0 — frame not ready');
    }

    // Grab full frame
    const fullCanvas = document.createElement('canvas');
    fullCanvas.width = vw;
    fullCanvas.height = vh;
    fullCanvas.getContext('2d').drawImage(video, 0, 0, vw, vh);

    // Stop stream
    stream.getTracks().forEach(t => t.stop());
    video.srcObject = null;

    // Get preview area bounds (viewport-relative)
    const previewEl = document.getElementById('previewWrapper');
    const rect = previewEl.getBoundingClientRect();

    // Detect if this is a tab capture (dimensions roughly match viewport * DPR)
    // or a full screen capture (dimensions much larger)
    const dpr = window.devicePixelRatio || 1;
    const expectedTabW = window.innerWidth * dpr;
    const expectedTabH = window.innerHeight * dpr;
    const isTabCapture = Math.abs(vw - expectedTabW) < 200 && Math.abs(vh - expectedTabH) < 200;
    console.log('[Capture] DPR:', dpr, '| Expected tab:', expectedTabW, 'x', expectedTabH, '| isTabCapture:', isTabCapture);

    let canvas = null;

    if (isTabCapture && rect.width > 0 && rect.height > 0) {
      // Tab capture: coordinates map directly (scaled by DPR)
      const scaleX = vw / window.innerWidth;
      const scaleY = vh / window.innerHeight;

      let cropX = Math.round(rect.left * scaleX);
      let cropY = Math.round(rect.top * scaleY);
      let cropW = Math.round(rect.width * scaleX);
      let cropH = Math.round(rect.height * scaleY);

      // Clamp to valid bounds
      cropX = Math.max(0, Math.min(cropX, vw - 1));
      cropY = Math.max(0, Math.min(cropY, vh - 1));
      cropW = Math.min(cropW, vw - cropX);
      cropH = Math.min(cropH, vh - cropY);

      console.log('[Capture] Crop:', cropX, cropY, cropW, cropH);

      if (cropW > 50 && cropH > 50) {
        const maxW = 800;
        const ratio = Math.min(1, maxW / cropW);
        canvas = document.createElement('canvas');
        canvas.width = Math.round(cropW * ratio);
        canvas.height = Math.round(cropH * ratio);
        canvas.getContext('2d').drawImage(fullCanvas, cropX, cropY, cropW, cropH, 0, 0, canvas.width, canvas.height);
      }
    }

    // Fallback: use full capture (uncropped) if crop failed or not tab capture
    if (!canvas || canvas.width < 10) {
      console.log('[Capture] Using full frame (no crop)');
      const maxW = 800;
      const ratio = Math.min(1, maxW / vw);
      canvas = document.createElement('canvas');
      canvas.width = Math.round(vw * ratio);
      canvas.height = Math.round(vh * ratio);
      canvas.getContext('2d').drawImage(fullCanvas, 0, 0, canvas.width, canvas.height);
    }

    // Validate: check canvas has actual pixels (not blank)
    const testData = canvas.getContext('2d').getImageData(
      Math.floor(canvas.width / 2), Math.floor(canvas.height / 2), 1, 1
    ).data;
    if (testData[0] === 0 && testData[1] === 0 && testData[2] === 0 && testData[3] === 0) {
      console.warn('[Capture] Center pixel is transparent, using full frame fallback');
      const maxW = 800;
      const ratio = Math.min(1, maxW / vw);
      canvas = document.createElement('canvas');
      canvas.width = Math.round(vw * ratio);
      canvas.height = Math.round(vh * ratio);
      canvas.getContext('2d').drawImage(fullCanvas, 0, 0, canvas.width, canvas.height);
    }

    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);

    // Validate data URL
    if (!dataUrl || dataUrl === 'data:,' || dataUrl.length < 200) {
      throw new Error('Generated empty image data (length: ' + (dataUrl?.length || 0) + ')');
    }

    console.log('[Capture] Success! Image size:', Math.round(dataUrl.length / 1024), 'KB');

    // Flash effect on preview
    const flash = document.createElement('div');
    flash.className = 'capture-flash';
    flash.innerHTML = '<i data-lucide="camera"></i>'; lucide.createIcons({nodes:[flash]});
    flash.style.fontSize = '48px';
    previewEl.style.position = 'relative';
    previewEl.appendChild(flash);
    setTimeout(() => flash.remove(), 600);

    // Store screenshot
    saveCurrentAnswers();
    addScreenshot(qId, dataUrl);
    const proj = getActiveProject();
    if (proj?.reviewType === 'free-form') {
      renderFreeFormReview(proj);
    } else {
      renderStep(currentStep, false);
    }

  } catch (e) {
    if (e.name === 'NotAllowedError') {
      if (btn) { btn.disabled = false; btn.innerHTML = '<i data-lucide="camera"></i> Capture preview'; lucide.createIcons({nodes:[btn]}); }
      return;
    }
    console.error('[Capture] Failed:', e);
    if (btn) { btn.disabled = false; btn.innerHTML = '<i data-lucide="camera"></i> Capture preview'; lucide.createIcons({nodes:[btn]}); }
  }
}

function showLightbox(qId, idx) {
  const shots = getScreenshots(qId);
  if (!shots.length) return;
  const src = idx !== undefined ? shots[idx] : shots[0];
  if (!src) return;
  const lb = document.createElement('div');
  lb.className = 'screenshot-lightbox';
  lb.onclick = () => lb.remove();
  lb.innerHTML = `<img src="${src}">`;
  document.body.appendChild(lb);
}

function updateProgress() {
  const answers = getAnswers();
  const total = reviewSteps.reduce((sum, s) => sum + s.questions.length, 0);
  const stepQIds = new Set(reviewSteps.flatMap(s => s.questions.map(q => q.id)));
  const answered = Object.entries(answers).filter(([id, a]) => a.score && stepQIds.has(id)).length;
  const pct = total > 0 ? Math.min(Math.round((answered / total) * 100), 100) : 0;
  const progressColor = pct === 100 ? 'var(--green)' : 'var(--accent)';
  const pctEl = document.getElementById('progressPct');
  if (pctEl) { pctEl.textContent = pct + '%'; pctEl.style.color = progressColor; }
  const fill = document.querySelector('.stepper-progress-fill');
  if (fill) { fill.style.width = pct + '%'; fill.style.background = progressColor; }
}

// ═══════════════ AUTO-SCAN (PageSpeed Insights) ═══════════════
const DEFAULT_PSI_KEY = 'AIzaSyALFIQC3M_3aS7xtPDCXqWEB6dDXVPGS-c';

function getApiKey() {
  try { return localStorage.getItem('bold700_psi_key') || DEFAULT_PSI_KEY; } catch(e) { return DEFAULT_PSI_KEY; }
}

function setApiKey(key) {
  try { localStorage.setItem('bold700_psi_key', key); } catch(e) {}
}

function promptApiKey() {
  const current = getApiKey();
  const key = prompt('Voer je Google PageSpeed Insights API key in.\n\nGratis aanmaken op: https://developers.google.com/speed/docs/insights/v5/get-started#key\n\nHuidige key:', current || '');
  if (key !== null) { setApiKey(key.trim()); return key.trim(); }
  return current;
}

// ── Scan toast banner helpers ──
let scanToastEl = null;
let scanToastTimer = null;
function showScanToast(type, title, sub, autoHide) {
  if (scanToastEl) scanToastEl.remove();
  if (scanToastTimer) { clearTimeout(scanToastTimer); scanToastTimer = null; }
  const icon = type === 'scanning' ? '<i data-lucide="loader" class="toast-spinner" style="width:16px;height:16px"></i>'
    : type === 'success' ? '<i data-lucide="check-circle" style="width:16px;height:16px"></i>'
    : '<i data-lucide="alert-circle" style="width:16px;height:16px"></i>';
  const el = document.createElement('div');
  el.className = `scan-toast ${type}`;
  el.innerHTML = `<span class="toast-icon">${icon}</span><div class="toast-text"><div>${title}</div>${sub ? '<div class="toast-sub">' + sub + '</div>' : ''}</div>`;
  document.body.appendChild(el);
  if (typeof lucide !== 'undefined') lucide.createIcons({nodes:[el]});
  scanToastEl = el;
  if (autoHide) {
    scanToastTimer = setTimeout(() => {
      el.style.animation = 'toastFade 0.3s ease forwards';
      setTimeout(() => { el.remove(); scanToastEl = null; }, 300);
    }, autoHide);
  }
}
function hideScanToast() {
  if (scanToastEl) {
    scanToastEl.style.animation = 'toastFade 0.3s ease forwards';
    setTimeout(() => { if (scanToastEl) { scanToastEl.remove(); scanToastEl = null; } }, 300);
  }
  if (scanToastTimer) { clearTimeout(scanToastTimer); scanToastTimer = null; }
}

async function runAutoScan() {
  const project = getActiveProject();
  if (!project) return;

  // ── Figma projects → run Figma design checks instead ──
  if (project.sourceType === 'figma') {
    const btn = document.getElementById('btnAutoScan');
    btn.classList.add('scanning');
    btn.style.pointerEvents = 'none';
    btn.style.opacity = '0.6';
    try {
      const autoFill = (qId, score, note) => {
        const mappedId = (typeof LEGACY_ID_MAP !== 'undefined' && LEGACY_ID_MAP[qId]) ? LEGACY_ID_MAP[qId] : qId;
        if (!project.answers[mappedId]) project.answers[mappedId] = {};
        if (project.answers[mappedId].score && !project.answers[mappedId].autoScanned) return;
        project.answers[mappedId].score = score;
        project.answers[mappedId].notes = (project.answers[mappedId].notes ? project.answers[mappedId].notes + '\n' : '') + '[Auto-scan] ' + note;
        project.answers[mappedId].autoScanned = true;
      };
      showScanToast('scanning', 'Figma design analyse…', 'Frames worden geanalyseerd');
      const filled = await runFigmaDesignChecks(project, autoFill);
      saveState();
      renderStep(currentStep);
      showScanToast('success', `Figma scan voltooid`, `${filled} checks automatisch ingevuld`, 4000);
    } catch(e) {
      console.error('[AutoScan] Figma error:', e);
      showScanToast('error', 'Figma scan mislukt', e.message || 'Onbekende fout', 5000);
    }
    btn.classList.remove('scanning');
    btn.style.pointerEvents = '';
    btn.style.opacity = '';
    return;
  }

  // Use the current preview URL (what the user is actually looking at), fallback to project URL
  // Priority: scanUrlInput (review-mode) > urlInput (iframe-mode) > project.url
  const scanUrlInput = document.getElementById('scanUrlInput');
  const urlInput = document.getElementById('urlInput');
  let url = (scanUrlInput && scanUrlInput.style.display !== 'none' && scanUrlInput.value.trim())
    || (urlInput && urlInput.value.trim())
    || project.url;
  if (!url) { alert('Voer eerst een URL in'); return; }
  if (!url.startsWith('http')) url = 'https://' + url;

  const btn = document.getElementById('btnAutoScan');
  // Keep button stable — just show spinner icon
  btn.classList.add('scanning');
  btn.style.pointerEvents = 'none';
  btn.style.opacity = '0.6';

  const answers = project.answers;

  // Helper: auto-fill a question (skip if already manually answered)
  function autoFill(qId, score, note) {
    const mappedId = (typeof LEGACY_ID_MAP !== 'undefined' && LEGACY_ID_MAP[qId]) ? LEGACY_ID_MAP[qId] : qId;
    if (!answers[mappedId]) answers[mappedId] = {};
    if (answers[mappedId].score && !answers[mappedId].autoScanned) return;
    answers[mappedId].score = score;
    answers[mappedId].notes = (answers[mappedId].notes ? answers[mappedId].notes + '\n' : '') + '[Auto-scan] ' + note;
    answers[mappedId].autoScanned = true;
  }

  let domFilled = 0;
  let psiFilled = 0;

  // ── Phase 1: DOM-based checks (fast, works always) ──
  showScanToast('scanning', 'DOM analyse uitvoeren…', 'Pagina wordt geanalyseerd');
  try {
    const pageData = await getPageDocument(url);
    if (pageData) {
      console.log('[AutoScan] Pagina opgehaald via:', pageData.source, '— start DOM checks');
      domFilled = await runDomChecks(pageData, answers, autoFill);
      console.log('[AutoScan] DOM checks klaar:', domFilled, 'velden ingevuld');
      // Run non-technical checks (storytelling, content, persuasion, IA, E-E-A-T)
      try {
        const nonTechFilled = await runNonTechAutoChecks(pageData.doc, pageData.css, autoFill, project.selectedTemplate);
        domFilled += nonTechFilled;
        console.log('[AutoScan] Non-tech checks klaar:', nonTechFilled, 'velden ingevuld');
      } catch(e) { console.warn('[NonTechScan]', e); }
    } else {
      console.warn('[AutoScan] Geen pagina data — DOM checks overgeslagen!');
    }
  } catch(e) { console.warn('DOM checks error:', e); }

  saveState();
  renderStep(currentStep, false);
  buildStepper();

  // ── Phase 2: PageSpeed Insights API (all users, gratis API) ──
  {
    let apiKey = getApiKey();
    try {
      showScanToast('scanning', 'PageSpeed Insights laden…', 'Dit duurt 10-30 seconden');
      const apiUrl = `https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=${encodeURIComponent(url)}&category=performance&category=seo&category=accessibility&strategy=mobile&key=${encodeURIComponent(apiKey)}`;
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 60000);
      const resp = await fetch(apiUrl, { signal: controller.signal });
      clearTimeout(timeout);
      if (!resp.ok) {
        const errData = await resp.json().catch(() => ({}));
        throw new Error(errData.error?.message || `API fout (${resp.status})`);
      }
      const data = await resp.json();
      const audits = data.lighthouseResult?.audits || {};
      const cats = data.lighthouseResult?.categories || {};

      const perfScore = (cats.performance?.score || 0) * 100;
      const lcp = audits['largest-contentful-paint']?.numericValue;
      const cls = audits['cumulative-layout-shift']?.numericValue;
      const inp = audits['interaction-to-next-paint']?.numericValue;
      const fcp = audits['first-contentful-paint']?.numericValue;
      const speed = audits['speed-index']?.numericValue;

      if (speed !== undefined) {
        const speedSec = speed / 1000;
        const score = speedSec < 2 ? 'good' : speedSec < 3 ? 'ok' : 'bad';
        autoFill('cvq6', score, `Speed Index: ${speedSec.toFixed(1)}s. FCP: ${(fcp/1000).toFixed(1)}s. Performance score: ${perfScore.toFixed(0)}/100`);
        psiFilled++;
      }

      if (lcp !== undefined) {
        const lcpOk = lcp < 2500;
        const clsOk = cls !== undefined ? cls < 0.1 : true;
        const inpOk = inp !== undefined ? inp < 200 : true;
        const allGood = lcpOk && clsOk && inpOk;
        const anyBad = (!lcpOk && lcp > 4000) || (cls > 0.25) || (inp > 500);
        const score = allGood ? 'good' : anyBad ? 'bad' : 'ok';
        let note = `LCP: ${(lcp/1000).toFixed(1)}s`;
        if (cls !== undefined) note += ` · CLS: ${cls.toFixed(3)}`;
        if (inp !== undefined) note += ` · INP: ${inp.toFixed(0)}ms`;
        autoFill('cvq7', score, note);
        psiFilled++;
      }

      const tapAudit = audits['tap-targets'];
      if (tapAudit) {
        const failCount = tapAudit.details?.items?.length || 0;
        autoFill('mbq2', tapAudit.score === 1 ? 'good' : failCount > 5 ? 'bad' : 'ok',
          tapAudit.score === 1 ? 'Touch targets zijn groot genoeg' : `${failCount} element(en) te klein voor touch`);
        psiFilled++;
      }

      const fontAudit = audits['font-size'];
      if (fontAudit) {
        autoFill('mbq3', fontAudit.score === 1 ? 'good' : 'ok', fontAudit.score === 1 ? 'Lettergrootte is leesbaar op mobiel' : 'Sommige tekst te klein op mobiel');
        psiFilled++;
      }

      const a11yScore = (cats.accessibility?.score || 0) * 100;
      if (a11yScore > 0) {
        autoFill('hcq5', a11yScore >= 90 ? 'good' : a11yScore >= 50 ? 'ok' : 'bad', `Lighthouse Accessibility: ${a11yScore.toFixed(0)}/100`);
        psiFilled++;
      }

      // ══════ PERFORMANCE PSI CHECKS (perf-*) ══════

      // perf-003: LCP
      if (lcp !== undefined) {
        const lcpSec = lcp / 1000;
        autoFill('perf-003', lcpSec < 2.5 ? 'good' : lcpSec < 4 ? 'ok' : 'bad',
          `LCP: ${lcpSec.toFixed(1)}s ${lcpSec >= 2.5 ? '(moet <2.5s)' : '(goed)'}`);
        psiFilled++;
      }
      // perf-004: CLS
      if (cls !== undefined) {
        autoFill('perf-004', cls < 0.1 ? 'good' : cls < 0.25 ? 'ok' : 'bad',
          `CLS: ${cls.toFixed(3)} ${cls >= 0.1 ? '(moet <0.1)' : '(goed)'}`);
        psiFilled++;
      }
      // perf-005: INP/TBT
      const tbt = audits['total-blocking-time']?.numericValue;
      if (tbt !== undefined) {
        autoFill('perf-005', tbt < 200 ? 'good' : tbt < 600 ? 'ok' : 'bad',
          `Total Blocking Time: ${tbt.toFixed(0)}ms ${tbt >= 200 ? '(moet <200ms)' : '(goed)'}`);
        psiFilled++;
      }
      // perf-006: FCP
      if (fcp !== undefined) {
        const fcpSec = fcp / 1000;
        autoFill('perf-006', fcpSec < 1.8 ? 'good' : fcpSec < 3 ? 'ok' : 'bad',
          `FCP: ${fcpSec.toFixed(1)}s ${fcpSec >= 1.8 ? '(moet <1.8s)' : '(goed)'}`);
        psiFilled++;
      }
      // perf-007: TTFB
      const ttfb = audits['server-response-time']?.numericValue;
      if (ttfb !== undefined) {
        autoFill('perf-007', ttfb < 600 ? 'good' : ttfb < 1500 ? 'ok' : 'bad',
          `TTFB: ${ttfb.toFixed(0)}ms ${ttfb >= 600 ? '(moet <600ms)' : '(goed)'}`);
        psiFilled++;
      }
      // perf-008: Speed Index
      if (speed !== undefined) {
        const si = speed / 1000;
        autoFill('perf-008', si < 3.4 ? 'good' : si < 5.8 ? 'ok' : 'bad',
          `Speed Index: ${si.toFixed(1)}s ${si >= 3.4 ? '(moet <3.4s)' : '(goed)'}`);
        psiFilled++;
      }

      // perf-011: Render-blocking resources
      const rbo = audits['render-blocking-resources'];
      if (rbo) {
        const items = rbo.details?.items?.length || 0;
        autoFill('perf-011', rbo.score === 1 ? 'good' : items > 5 ? 'bad' : 'ok',
          rbo.score === 1 ? 'Geen render-blocking resources' : `${items} render-blocking resources (${(rbo.numericValue/1000).toFixed(1)}s vertraging)`);
        psiFilled++;
      }
      // perf-012: Unused CSS
      const unusedCSS = audits['unused-css-rules'];
      if (unusedCSS) {
        autoFill('perf-012', unusedCSS.score === 1 ? 'good' : 'ok',
          unusedCSS.score === 1 ? 'Geen significante ongebruikte CSS' : `Ongebruikte CSS: ${((unusedCSS.numericValue || 0)/1024).toFixed(0)}KB te besparen`);
        psiFilled++;
      }
      // perf-013: Unused JavaScript
      const unusedJS = audits['unused-javascript'];
      if (unusedJS) {
        autoFill('perf-013', unusedJS.score === 1 ? 'good' : 'ok',
          unusedJS.score === 1 ? 'Geen significante ongebruikte JS' : `Ongebruikte JS: ${((unusedJS.numericValue || 0)/1024).toFixed(0)}KB te besparen`);
        psiFilled++;
      }
      // perf-014: JS execution time
      const bootup = audits['bootup-time'];
      if (bootup) {
        autoFill('perf-014', bootup.score === 1 ? 'good' : bootup.numericValue > 3500 ? 'bad' : 'ok',
          `JS uitvoeringstijd: ${(bootup.numericValue/1000).toFixed(1)}s`);
        psiFilled++;
      }
      // perf-015: Main thread work
      const mainThread = audits['mainthread-work-breakdown'];
      if (mainThread) {
        autoFill('perf-015', mainThread.score === 1 ? 'good' : mainThread.numericValue > 4000 ? 'bad' : 'ok',
          `Main thread werk: ${(mainThread.numericValue/1000).toFixed(1)}s`);
        psiFilled++;
      }
      // perf-016: DOM size (PSI version)
      const domSize = audits['dom-size'];
      if (domSize) {
        const count = domSize.numericValue || 0;
        autoFill('perf-016', count < 1500 ? 'good' : count < 3000 ? 'ok' : 'bad',
          `DOM grootte: ${count} elementen (Lighthouse) ${count >= 1500 ? '— te groot' : ''}`);
        psiFilled++;
      }
      // perf-017: Critical request chains
      const crc = audits['critical-request-chains'];
      if (crc) {
        autoFill('perf-017', crc.score === 1 ? 'good' : 'ok',
          crc.displayValue || 'Critical request chains geanalyseerd');
        psiFilled++;
      }
      // perf-019: Images optimized
      const imgOpt = audits['uses-optimized-images'];
      if (imgOpt) {
        autoFill('perf-019', imgOpt.score === 1 ? 'good' : 'ok',
          imgOpt.score === 1 ? 'Afbeeldingen zijn geoptimaliseerd' : `Afbeeldingen optimaliseren: ${((imgOpt.numericValue || 0)/1024).toFixed(0)}KB te besparen`);
        psiFilled++;
      }
      // perf-020: Modern image formats
      const modernImg = audits['modern-image-formats'];
      if (modernImg) {
        autoFill('perf-020', modernImg.score === 1 ? 'good' : 'bad',
          modernImg.score === 1 ? 'Moderne afbeeldingsformaten gebruikt' : `Gebruik WebP/AVIF: ${((modernImg.numericValue || 0)/1024).toFixed(0)}KB te besparen`);
        psiFilled++;
      }
      // perf-021: Responsive images
      const respImg = audits['uses-responsive-images'];
      if (respImg) {
        autoFill('perf-021', respImg.score === 1 ? 'good' : 'ok',
          respImg.score === 1 ? 'Responsive images correct' : `Afbeeldingen niet responsive: ${((respImg.numericValue || 0)/1024).toFixed(0)}KB te besparen`);
        psiFilled++;
      }
      // perf-022: Text compression
      const textComp = audits['uses-text-compression'];
      if (textComp) {
        autoFill('perf-022', textComp.score === 1 ? 'good' : 'bad',
          textComp.score === 1 ? 'Tekstcompressie (gzip/brotli) actief' : `Geen tekstcompressie: ${((textComp.numericValue || 0)/1024).toFixed(0)}KB te besparen`);
        psiFilled++;
      }
      // perf-023: CSS minified
      const cssMin = audits['unminified-css'];
      if (cssMin) {
        autoFill('perf-023', cssMin.score === 1 ? 'good' : 'ok',
          cssMin.score === 1 ? 'CSS is geminified' : `CSS niet geminified: ${((cssMin.numericValue || 0)/1024).toFixed(0)}KB te besparen`);
        psiFilled++;
      }
      // perf-024: JS minified
      const jsMin = audits['unminified-javascript'];
      if (jsMin) {
        autoFill('perf-024', jsMin.score === 1 ? 'good' : 'ok',
          jsMin.score === 1 ? 'JavaScript is geminified' : `JS niet geminified: ${((jsMin.numericValue || 0)/1024).toFixed(0)}KB te besparen`);
        psiFilled++;
      }
      // perf-025: Font display
      const fontDisplay = audits['font-display'];
      if (fontDisplay) {
        autoFill('perf-025', fontDisplay.score === 1 ? 'good' : 'ok',
          fontDisplay.score === 1 ? 'font-display correct geconfigureerd' : 'Font-display niet optimaal — voeg display=swap toe');
        psiFilled++;
      }
      // perf-026: Preload
      const preload = audits['uses-rel-preload'];
      if (preload) {
        autoFill('perf-026', preload.score === 1 ? 'good' : 'ok',
          preload.score === 1 ? 'Kritieke resources correct gepreload' : 'Preload hints ontbreken voor kritieke resources');
        psiFilled++;
      }
      // perf-027: Preconnect
      const preconnect = audits['uses-rel-preconnect'];
      if (preconnect) {
        autoFill('perf-027', preconnect.score === 1 ? 'good' : 'ok',
          preconnect.score === 1 ? 'Preconnect correct geconfigureerd' : 'Preconnect ontbreekt voor externe origins');
        psiFilled++;
      }
      // perf-028: Offscreen images
      const offscreen = audits['offscreen-images'];
      if (offscreen) {
        autoFill('perf-028', offscreen.score === 1 ? 'good' : 'ok',
          offscreen.score === 1 ? 'Offscreen images worden lazy geladen' : `Offscreen images: ${((offscreen.numericValue || 0)/1024).toFixed(0)}KB te besparen met lazy loading`);
        psiFilled++;
      }
      // perf-029: Browser caching
      const caching = audits['uses-long-cache-ttl'];
      if (caching) {
        autoFill('perf-029', caching.score === 1 ? 'good' : caching.score >= 0.5 ? 'ok' : 'bad',
          caching.score === 1 ? 'Browser caching correct geconfigureerd' : `Caching optimaliseren: ${caching.details?.items?.length || 0} resources zonder goede cache-headers`);
        psiFilled++;
      }
      // perf-030: HTTP/2
      const http2 = audits['uses-http2'];
      if (http2) {
        autoFill('perf-030', http2.score === 1 ? 'good' : 'ok',
          http2.score === 1 ? 'HTTP/2 wordt gebruikt' : 'Niet alle resources via HTTP/2 — upgrade aanbevolen');
        psiFilled++;
      }
      // perf-035: Third-party impact
      const thirdParty = audits['third-party-summary'];
      if (thirdParty) {
        const items = thirdParty.details?.items?.length || 0;
        autoFill('perf-035', items <= 3 ? 'good' : items <= 8 ? 'ok' : 'bad',
          `${items} third-party scripts gedetecteerd ${items > 8 ? '— te veel impact' : ''}`);
        psiFilled++;
      }
      // perf-036: Third-party facades
      const facades = audits['third-party-facades'];
      if (facades) {
        autoFill('perf-036', facades.score === 1 ? 'good' : 'ok',
          facades.score === 1 ? 'Third-party facades correct geïmplementeerd' : 'Overweeg facades voor zware third-party embeds');
        psiFilled++;
      }

      // ══════ MOBILE PSI CHECKS (mob-*) ══════
      // mob-002: Tap targets (already done above)
      // mob-006: Content width
      const contentWidth = audits['content-width'];
      if (contentWidth) {
        autoFill('mob-006', contentWidth.score === 1 ? 'good' : 'bad',
          contentWidth.score === 1 ? 'Content past correct in viewport' : 'Content breder dan viewport — scrollt horizontaal');
        psiFilled++;
      }
      // mob-011: Tap target spacing
      if (tapAudit) {
        autoFill('mob-011', tapAudit.score === 1 ? 'good' : 'ok',
          tapAudit.score === 1 ? 'Voldoende ruimte tussen touch targets' : 'Touch targets staan te dicht bij elkaar');
        psiFilled++;
      }
      // mob-019: Mobile speed score
      autoFill('mob-019', perfScore >= 90 ? 'good' : perfScore >= 50 ? 'ok' : 'bad',
        `Mobiele performance score: ${perfScore.toFixed(0)}/100`);
      psiFilled++;
      // mob-020: Mobile LCP
      if (lcp !== undefined) {
        autoFill('mob-020', lcp < 2500 ? 'good' : lcp < 4000 ? 'ok' : 'bad',
          `Mobiele LCP: ${(lcp/1000).toFixed(1)}s ${lcp >= 2500 ? '(moet <2.5s)' : '(goed)'}`);
        psiFilled++;
      }

      // ══════ SECURITY PSI CHECKS ══════
      const vulnLibs = audits['no-vulnerable-libraries'];
      if (vulnLibs) {
        autoFill('sec-014', vulnLibs.score === 1 ? 'good' : 'bad',
          vulnLibs.score === 1 ? 'Geen kwetsbare JS bibliotheken (Lighthouse)' :
          `${vulnLibs.details?.items?.length || 0} kwetsbare bibliotheken gevonden!`);
        psiFilled++;
      }

      saveState();
      renderStep(currentStep, false);
      buildStepper();

    } catch(err) {
      const msg = err.name === 'AbortError' ? 'Timeout — probeer opnieuw' : (err.message || 'Onbekende fout');
      const isQuota = msg.toLowerCase().includes('quota') || msg.toLowerCase().includes('rate');
      if (isQuota) {
        const newKey = promptApiKey();
        if (newKey && newKey !== apiKey) {
          btn.classList.remove('scanning');
          btn.style.pointerEvents = '';
          btn.style.opacity = '';
          hideScanToast();
          runAutoScan();
          return;
        }
      }
      if (domFilled > 0) {
        console.warn('PSI failed but DOM checks succeeded:', msg);
      } else {
        showScanToast('error', 'Scan mislukt', msg.substring(0, 60), 5000);
        btn.classList.remove('scanning');
        btn.style.pointerEvents = '';
        btn.style.opacity = '';
        console.error('Auto-scan error:', err);
        return;
      }
    }
  }

  // ── Show results in toast ──
  // For quick-scan: only count auto-filled answers matching current reviewSteps questions
  const stepQIds = new Set(reviewSteps.flatMap(s => s.questions.map(q => q.id)));
  const totalFilled = Object.entries(answers).filter(([id, a]) => a.autoScanned && stepQIds.has(id)).length;
  const totalFilledAll = Object.values(answers).filter(a => a.autoScanned).length;
  showScanToast('success',
    `${totalFilled} vragen automatisch ingevuld`,
    `${totalFilledAll > totalFilled ? totalFilled + ' relevant voor deze scan · ' : ''}${domFilled} via DOM analyse${psiFilled > 0 ? ` · ${psiFilled} via PageSpeed` : ''}`,
    4000
  );

  // Reset button
  btn.classList.remove('scanning');
  btn.style.pointerEvents = '';
  btn.style.opacity = '';
}

// ═══════════════ DOM-BASED AUTO-CHECKS ═══════════════
async function getPageDocument(url) {
  // Try 1: iframe DOM (same-origin)
  try {
    const frame = document.getElementById('previewFrame');
    if (frame && frame.contentDocument && frame.contentDocument.body) {
      const test = frame.contentDocument.title; // throws if cross-origin
      console.log('[AutoScan] Bron: iframe (same-origin)');
      return { doc: frame.contentDocument, source: 'iframe', css: true };
    }
  } catch(e) { console.log('[AutoScan] iframe cross-origin, probeer fetch…'); }

  // Try 2: fetch + DOMParser (cross-origin fallback)
  try {
    const resp = await fetch(url, { mode: 'cors', redirect: 'follow' });
    if (!resp.ok) throw new Error(resp.status);
    const html = await resp.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    console.log('[AutoScan] Bron: directe fetch (' + html.length + ' bytes)');
    return { doc, source: 'fetch', css: false };
  } catch(e) { console.log('[AutoScan] Directe fetch faalde: ' + e.message + ', probeer worker proxy…'); }

  // Try 3: Cloudflare Worker proxy (works from file:// and any origin)
  try {
    const workerProxy = getAiProxyUrl();
    if (workerProxy) {
      const proxyBase = workerProxy.replace(/\/$/, '');
      const resp = await fetch(`${proxyBase}/fetch?url=${encodeURIComponent(url)}`);
      if (!resp.ok) throw new Error(resp.status);
      const html = await resp.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      console.log('[AutoScan] Bron: worker proxy (' + html.length + ' bytes)');
      return { doc, source: 'worker-proxy', css: false };
    } else {
      console.log('[AutoScan] Geen worker proxy URL geconfigureerd');
    }
  } catch(e) { console.warn('[AutoScan] Worker proxy faalde:', e.message); }

  // Try 4: allorigins fallback
  try {
    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
    const resp = await fetch(proxyUrl);
    if (!resp.ok) throw new Error(resp.status);
    const html = await resp.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    console.log('[AutoScan] Bron: allorigins proxy (' + html.length + ' bytes)');
    return { doc, source: 'proxy', css: false };
  } catch(e) { console.warn('[AutoScan] Allorigins proxy faalde:', e.message); }

  console.error('[AutoScan] GEEN bron beschikbaar — pagina kon niet opgehaald worden voor URL:', url);
  return null;
}

async function runDomChecks(pageData, answers, autoFill) {
  if (!pageData || !pageData.doc) return 0;
  const doc = pageData.doc;
  const canCSS = pageData.css; // only true for same-origin iframe
  let filled = 0;

  // ── sm1: Heading hierarchy (h1 → h2 → h3, no skipping) ──
  try {
    const headings = Array.from(doc.querySelectorAll('h1,h2,h3,h4,h5,h6'));
    if (headings.length > 0) {
      const levels = headings.map(h => parseInt(h.tagName[1]));
      const h1Count = levels.filter(l => l === 1).length;
      let skipped = false;
      for (let i = 1; i < levels.length; i++) {
        if (levels[i] - levels[i-1] > 1) { skipped = true; break; }
      }
      const hasH1 = h1Count >= 1;
      const multiH1 = h1Count > 1;
      const structure = levels.slice(0, 10).map(l => 'h' + l).join(' → ');
      if (hasH1 && !skipped && !multiH1) {
        autoFill('sm1', 'good', `Heading hiërarchie correct: ${structure}${levels.length > 10 ? '…' : ''}`);
      } else {
        const issues = [];
        if (!hasH1) issues.push('geen h1 gevonden');
        if (multiH1) issues.push(h1Count + ' h1-tags (verwacht: 1)');
        if (skipped) issues.push('niveaus overgeslagen');
        autoFill('sm1', multiH1 || !hasH1 ? 'bad' : 'ok', `Headings: ${issues.join(', ')}. Structuur: ${structure}${levels.length > 10 ? '…' : ''}`);
      }
      filled++;
    }
  } catch(e) {}

  // ── kb4 + seq1: Title tag ──
  try {
    const title = doc.querySelector('title');
    const titleText = title ? title.textContent.trim() : '';
    if (titleText.length > 0) {
      const isGood = titleText.length >= 10 && titleText.length <= 70;
      const score = isGood ? 'good' : 'ok';
      const note = `Title: "${titleText.substring(0, 60)}${titleText.length > 60 ? '…' : ''}" (${titleText.length} tekens)`;
      autoFill('kb4', score, note);
      autoFill('seq1', score, note);
      filled += 2;
    } else {
      autoFill('kb4', 'bad', 'Geen title tag gevonden of leeg');
      autoFill('seq1', 'bad', 'Geen title tag gevonden of leeg');
      filled += 2;
    }
  } catch(e) {}

  // ── seq2: Meta description ──
  try {
    const meta = doc.querySelector('meta[name="description"]');
    const desc = meta ? meta.getAttribute('content')?.trim() : '';
    if (desc && desc.length > 0) {
      const isGood = desc.length >= 50 && desc.length <= 160;
      autoFill('seq2', isGood ? 'good' : 'ok', `Meta description: "${desc.substring(0, 80)}${desc.length > 80 ? '…' : ''}" (${desc.length} tekens)`);
    } else {
      autoFill('seq2', 'bad', 'Meta description ontbreekt');
    }
    filled++;
  } catch(e) {}

  // ── seq4: Alt-teksten op afbeeldingen ──
  try {
    const imgs = Array.from(doc.querySelectorAll('img'));
    if (imgs.length > 0) {
      const missingAlt = imgs.filter(img => !img.hasAttribute('alt') || img.getAttribute('alt').trim() === '');
      // Exclude decorative / tiny images
      const significant = missingAlt.filter(img => {
        const w = img.getAttribute('width');
        const h = img.getAttribute('height');
        if (w && h && parseInt(w) < 5 && parseInt(h) < 5) return false;
        if (img.getAttribute('role') === 'presentation') return false;
        return true;
      });
      if (significant.length === 0) {
        autoFill('seq4', 'good', `Alle ${imgs.length} afbeeldingen hebben alt-teksten`);
      } else {
        autoFill('seq4', significant.length > 3 ? 'bad' : 'ok', `${significant.length} van ${imgs.length} afbeeldingen missen alt-teksten`);
      }
      filled++;
    }
  } catch(e) {}

  // ── seq3: Heading tags correct (duplicate of sm1 but for SEO step) ──
  try {
    const headings = Array.from(doc.querySelectorAll('h1,h2,h3,h4,h5,h6'));
    if (headings.length > 0) {
      const levels = headings.map(h => parseInt(h.tagName[1]));
      const h1s = levels.filter(l => l === 1).length;
      let skipFound = false;
      for (let i = 1; i < levels.length; i++) { if (levels[i] - levels[i-1] > 1) { skipFound = true; break; } }
      if (h1s === 1 && !skipFound) {
        autoFill('seq3', 'good', `${headings.length} headings, hiërarchie correct`);
      } else {
        const issues = [];
        if (h1s !== 1) issues.push(h1s + ' h1-tags');
        if (skipFound) issues.push('niveaus overgeslagen');
        autoFill('seq3', 'ok', `${headings.length} headings — ${issues.join(', ')}`);
      }
      filled++;
    }
  } catch(e) {}

  // ── kb3: Skip-to-content link ──
  try {
    const links = Array.from(doc.querySelectorAll('a[href^="#"]'));
    const skipLink = links.find(a => {
      const text = (a.textContent || '').toLowerCase();
      const href = (a.getAttribute('href') || '').toLowerCase();
      return text.includes('skip') || text.includes('direct naar') || text.includes('naar content') ||
             text.includes('ga naar inhoud') || href.includes('main') || href.includes('content');
    });
    if (skipLink) {
      autoFill('kb3', 'good', `Skip-link gevonden: "${skipLink.textContent.trim().substring(0, 40)}"`);
    } else {
      autoFill('kb3', 'bad', 'Geen "skip to content" link gevonden');
    }
    filled++;
  } catch(e) {}

  // ── fm5: lang attribute on <html> ──
  try {
    const htmlEl = doc.querySelector('html');
    const lang = htmlEl ? htmlEl.getAttribute('lang') : null;
    if (lang && lang.trim().length >= 2) {
      autoFill('fm5', 'good', `lang="${lang}" correct ingesteld op html-element`);
    } else {
      autoFill('fm5', 'bad', 'Geen lang-attribuut op html-element gevonden');
    }
    filled++;
  } catch(e) {}

  // ── fm1: Form fields with <label> ──
  try {
    const inputs = Array.from(doc.querySelectorAll('input:not([type="hidden"]):not([type="submit"]):not([type="button"]):not([type="reset"]), select, textarea'));
    if (inputs.length > 0) {
      const noLabel = inputs.filter(inp => {
        const id = inp.getAttribute('id');
        if (id && doc.querySelector(`label[for="${id}"]`)) return false;
        if (inp.closest('label')) return false;
        if (inp.getAttribute('aria-label') || inp.getAttribute('aria-labelledby')) return false;
        if (inp.getAttribute('title')) return false;
        return true;
      });
      if (noLabel.length === 0) {
        autoFill('fm1', 'good', `Alle ${inputs.length} formuliervelden hebben een label`);
      } else {
        autoFill('fm1', noLabel.length > 2 ? 'bad' : 'ok', `${noLabel.length} van ${inputs.length} velden missen een gekoppeld label`);
      }
      filled++;
    }
  } catch(e) {}

  // ── fm7: Required fields marked ──
  try {
    const inputs = Array.from(doc.querySelectorAll('input[required], select[required], textarea[required], input[aria-required="true"], select[aria-required="true"], textarea[aria-required="true"]'));
    const allInputs = Array.from(doc.querySelectorAll('input:not([type="hidden"]):not([type="submit"]):not([type="button"]):not([type="reset"]), select, textarea'));
    if (allInputs.length > 0) {
      if (inputs.length > 0) {
        autoFill('fm7', 'good', `${inputs.length} van ${allInputs.length} velden gemarkeerd als verplicht (required/aria-required)`);
      } else {
        autoFill('fm7', 'ok', `${allInputs.length} formuliervelden gevonden, maar geen "required" of "aria-required" attributen`);
      }
      filled++;
    }
  } catch(e) {}

  // ── sm7: Autocomplete attributes on personal data fields ──
  try {
    const personalFields = Array.from(doc.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], input[name*="name"], input[name*="email"], input[name*="phone"], input[name*="address"], input[name*="city"], input[name*="zip"], input[name*="postal"]'));
    if (personalFields.length > 0) {
      const hasAutocomplete = personalFields.filter(f => f.getAttribute('autocomplete'));
      if (hasAutocomplete.length === personalFields.length) {
        autoFill('sm7', 'good', `Alle ${personalFields.length} relevante velden hebben autocomplete-attributen`);
      } else if (hasAutocomplete.length > 0) {
        autoFill('sm7', 'ok', `${hasAutocomplete.length} van ${personalFields.length} relevante velden hebben autocomplete-attributen`);
      } else {
        autoFill('sm7', 'bad', `${personalFields.length} persoonlijke-data velden zonder autocomplete-attributen`);
      }
      filled++;
    }
  } catch(e) {}

  // ── sm2: Interactive elements with accessible name ──
  try {
    const interactive = Array.from(doc.querySelectorAll('button, a[href], input:not([type="hidden"]), select, textarea, [role="button"], [role="link"], [role="tab"]'));
    if (interactive.length > 0) {
      const noName = interactive.filter(el => {
        const text = (el.textContent || '').trim();
        const ariaLabel = el.getAttribute('aria-label');
        const ariaLabelledBy = el.getAttribute('aria-labelledby');
        const title = el.getAttribute('title');
        const alt = el.querySelector('img[alt]')?.getAttribute('alt');
        const value = el.getAttribute('value');
        return !text && !ariaLabel && !ariaLabelledBy && !title && !alt && !value;
      });
      if (noName.length === 0) {
        autoFill('sm2', 'good', `Alle ${interactive.length} interactieve elementen hebben een toegankelijke naam`);
      } else {
        autoFill('sm2', noName.length > 5 ? 'bad' : 'ok', `${noName.length} van ${interactive.length} interactieve elementen missen een toegankelijke naam`);
      }
      filled++;
    }
  } catch(e) {}

  // ── sm3: ARIA roles (divs/spans acting as buttons without role) ──
  try {
    const clickable = Array.from(doc.querySelectorAll('[onclick], [tabindex]'));
    const badRole = clickable.filter(el => {
      const tag = el.tagName.toLowerCase();
      if (['button','a','input','select','textarea','summary','details'].includes(tag)) return false;
      if (el.getAttribute('role')) return false;
      return true;
    });
    if (clickable.length > 0) {
      if (badRole.length === 0) {
        autoFill('sm3', 'good', 'Alle klikbare elementen hebben correcte ARIA-rollen of zijn native HTML-elementen');
      } else {
        autoFill('sm3', badRole.length > 3 ? 'bad' : 'ok', `${badRole.length} klikbare elementen zonder juiste role-attribuut`);
      }
      filled++;
    }
  } catch(e) {}

  // ── mbq1: Viewport meta tag (responsive) ──
  try {
    const viewport = doc.querySelector('meta[name="viewport"]');
    if (viewport) {
      const content = viewport.getAttribute('content') || '';
      const hasWidth = content.includes('width=device-width');
      autoFill('mbq1', hasWidth ? 'good' : 'ok', `Viewport meta: "${content.substring(0, 60)}"`);
    } else {
      autoFill('mbq1', 'bad', 'Geen viewport meta tag gevonden — site is niet responsive');
    }
    filled++;
  } catch(e) {}

  // ── a11q7: Text min 16px and line-height min 1.5 (CSS check — only iframe) ──
  if (canCSS) {
    try {
      const body = doc.body;
      const cs = doc.defaultView.getComputedStyle(body);
      const fontSize = parseFloat(cs.fontSize);
      const lineHeight = parseFloat(cs.lineHeight);
      const lhRatio = lineHeight / fontSize;
      const sizeOk = fontSize >= 16;
      const lhOk = lhRatio >= 1.4;
      if (sizeOk && lhOk) {
        autoFill('a11q7', 'good', `Body font-size: ${fontSize}px, line-height: ${lhRatio.toFixed(2)} — beide voldoende`);
      } else {
        const issues = [];
        if (!sizeOk) issues.push(`font-size ${fontSize}px (min 16px)`);
        if (!lhOk) issues.push(`line-height ${lhRatio.toFixed(2)} (min 1.5)`);
        autoFill('a11q7', 'ok', `Body tekst: ${issues.join(', ')}`);
      }
      filled++;
    } catch(e) {}
  }

  // ── hcq5: Basic accessibility check via tag count (aria, roles, alt) ──
  try {
    const ariaCount = doc.querySelectorAll('[aria-label],[aria-labelledby],[aria-describedby],[role]').length;
    const altCount = doc.querySelectorAll('img[alt]').length;
    const imgTotal = doc.querySelectorAll('img').length;
    const labelCount = doc.querySelectorAll('label').length;
    const total = ariaCount + altCount + labelCount;
    if (total > 20) {
      autoFill('hcq5', 'good', `Goede a11y basis: ${ariaCount} ARIA attrs, ${altCount}/${imgTotal} img met alt, ${labelCount} labels`);
    } else if (total > 5) {
      autoFill('hcq5', 'ok', `Basis a11y aanwezig: ${ariaCount} ARIA attrs, ${altCount}/${imgTotal} img met alt, ${labelCount} labels`);
    } else {
      autoFill('hcq5', 'bad', `Minimale a11y: ${ariaCount} ARIA attrs, ${altCount}/${imgTotal} img met alt, ${labelCount} labels`);
    }
    filled++;
  } catch(e) {}

  // ── md5: Auto-playing audio/video ──
  try {
    const autoplayMedia = doc.querySelectorAll('audio[autoplay], video[autoplay]');
    const allMedia = doc.querySelectorAll('audio, video');
    if (allMedia.length > 0) {
      if (autoplayMedia.length === 0) {
        autoFill('md5', 'good', `${allMedia.length} media-element(en) gevonden, geen autoplay`);
      } else {
        autoFill('md5', 'ok', `${autoplayMedia.length} media-element(en) met autoplay gevonden`);
      }
      filled++;
    }
  } catch(e) {}

  // ── seq5: Clean URL (is-crawlable via robots meta) ──
  try {
    const robotsMeta = doc.querySelector('meta[name="robots"]');
    const content = robotsMeta ? (robotsMeta.getAttribute('content') || '').toLowerCase() : '';
    if (content.includes('noindex')) {
      autoFill('seq5', 'bad', `Pagina is noindex: robots meta = "${content}"`);
      filled++;
    } else if (robotsMeta) {
      autoFill('seq5', 'good', `Pagina is indexeerbaar: robots meta = "${content || 'geen restrictie'}"`);
      filled++;
    }
  } catch(e) {}

  // ── h6q6 + h7q3 + kb6: Zoekfunctie aanwezig ──
  try {
    const searchInput = doc.querySelector('input[type="search"], [role="search"], input[name*="search"], input[name*="zoek"], input[placeholder*="zoek" i], input[placeholder*="search" i]');
    const sitemapLink = doc.querySelector('a[href*="sitemap"], a[href*="site-map"]');
    const navEl = doc.querySelector('nav, [role="navigation"]');
    const found = [];
    if (navEl) found.push('navigatie');
    if (searchInput) found.push('zoekfunctie');
    if (sitemapLink) found.push('sitemap');
    if (searchInput) {
      autoFill('h6q6', 'good', `Zoekfunctie gevonden op de pagina`);
      autoFill('h7q3', 'good', `Zoekfunctie aanwezig naast navigatie`);
      filled += 2;
    } else {
      autoFill('h6q6', 'bad', 'Geen zoekfunctie gevonden (geen input[type="search"] of [role="search"])');
      autoFill('h7q3', 'bad', 'Geen zoekfunctie gevonden');
      filled += 2;
    }
    // kb6: multiple ways to find pages
    if (found.length >= 2) {
      autoFill('kb6', 'good', `${found.length} manieren gevonden: ${found.join(', ')}`);
    } else if (found.length === 1) {
      autoFill('kb6', 'ok', `Slechts 1 manier gevonden: ${found[0]}. Voeg zoekfunctie of sitemap toe.`);
    } else {
      autoFill('kb6', 'bad', 'Geen navigatie, zoekfunctie of sitemap gevonden');
    }
    filled++;
  } catch(e) {}

  // ── h10q3: Contactinformatie makkelijk te vinden ──
  try {
    const telLink = doc.querySelector('a[href^="tel:"]');
    const mailLink = doc.querySelector('a[href^="mailto:"]');
    const contactLink = doc.querySelector('a[href*="contact"], a[href*="kontakt"]');
    const found = [];
    if (telLink) found.push('telefoonnummer');
    if (mailLink) found.push('e-mailadres');
    if (contactLink) found.push('contactpagina');
    if (found.length >= 2) {
      autoFill('h10q3', 'good', `Contactinfo gevonden: ${found.join(', ')}`);
    } else if (found.length === 1) {
      autoFill('h10q3', 'ok', `Contactinfo deels aanwezig: ${found[0]}`);
    } else {
      autoFill('h10q3', 'bad', 'Geen telefoonnummer, e-mail of contactpagina-link gevonden');
    }
    filled++;
  } catch(e) {}

  // ── h10q5: Chatfunctie / direct contactkanaal ──
  try {
    const chatIndicators = doc.querySelectorAll(
      '[id*="intercom"], [class*="intercom"], [id*="drift"], [class*="drift"], ' +
      '[id*="tawk"], [class*="tawk"], [id*="zendesk"], [class*="zendesk"], ' +
      '[id*="crisp"], [class*="crisp"], [id*="livechat"], [class*="livechat"], ' +
      '[id*="hubspot"], [class*="hubspot-messages"], [id*="tidio"], [class*="tidio"], ' +
      '[id*="chat-widget"], [class*="chat-widget"], [id*="chatbot"], [class*="chatbot"], ' +
      'iframe[src*="tawk.to"], iframe[src*="intercom"], iframe[src*="drift"]'
    );
    if (chatIndicators.length > 0) {
      autoFill('h10q5', 'good', `Chatwidget gedetecteerd (${chatIndicators.length} indicator(en))`);
    } else {
      autoFill('h10q5', 'ok', 'Geen bekende chatwidget gedetecteerd (Intercom, Drift, Tawk, Zendesk, Crisp, Tidio, HubSpot)');
    }
    filled++;
  } catch(e) {}

  // ── md2: Video's met ondertiteling (captions) ──
  try {
    const videos = Array.from(doc.querySelectorAll('video'));
    if (videos.length > 0) {
      const withTrack = videos.filter(v => v.querySelector('track[kind="captions"], track[kind="subtitles"]'));
      if (withTrack.length === videos.length) {
        autoFill('md2', 'good', `Alle ${videos.length} video('s) hebben ondertiteling (track-element)`);
      } else if (withTrack.length > 0) {
        autoFill('md2', 'ok', `${withTrack.length} van ${videos.length} video('s) hebben ondertiteling`);
      } else {
        autoFill('md2', 'bad', `${videos.length} video('s) zonder ondertiteling (geen track-element gevonden)`);
      }
      filled++;
    }
  } catch(e) {}

  // ── md7: Bewegende/auto-scrollende content ──
  try {
    const marquee = doc.querySelectorAll('marquee');
    const blink = doc.querySelectorAll('blink');
    const autoScroll = marquee.length + blink.length;
    if (autoScroll > 0) {
      autoFill('md7', 'bad', `${autoScroll} verouderde bewegende elementen gevonden (marquee/blink)`);
      filled++;
    }
  } catch(e) {}

  // ── mbq4: Mobiel formulier keyboard types ──
  try {
    const emailInputs = doc.querySelectorAll('input[type="email"], input[inputmode="email"]');
    const telInputs = doc.querySelectorAll('input[type="tel"], input[inputmode="tel"]');
    const urlInputs = doc.querySelectorAll('input[type="url"], input[inputmode="url"]');
    const numInputs = doc.querySelectorAll('input[type="number"], input[inputmode="numeric"], input[inputmode="decimal"]');
    const allInputs = doc.querySelectorAll('input:not([type="hidden"]):not([type="submit"]):not([type="button"]):not([type="reset"]):not([type="checkbox"]):not([type="radio"])');
    if (allInputs.length > 0) {
      const typed = emailInputs.length + telInputs.length + urlInputs.length + numInputs.length;
      const details = [];
      if (emailInputs.length) details.push(`${emailInputs.length}× email`);
      if (telInputs.length) details.push(`${telInputs.length}× tel`);
      if (urlInputs.length) details.push(`${urlInputs.length}× url`);
      if (numInputs.length) details.push(`${numInputs.length}× number`);
      if (typed > 0) {
        autoFill('mbq4', typed >= allInputs.length * 0.3 ? 'good' : 'ok', `Mobiel keyboard types: ${details.join(', ')} van ${allInputs.length} velden`);
      } else {
        autoFill('mbq4', 'ok', `${allInputs.length} invoervelden zonder specifiek inputmode/type — standaard toetsenbord wordt gebruikt`);
      }
      filled++;
    }
  } catch(e) {}

  // ── kb5: Tab-volgorde (positive tabindex = anti-pattern) ──
  try {
    const positiveTabindex = Array.from(doc.querySelectorAll('[tabindex]')).filter(el => {
      const val = parseInt(el.getAttribute('tabindex'));
      return val > 0;
    });
    if (positiveTabindex.length > 0) {
      autoFill('kb5', 'ok', `${positiveTabindex.length} elementen met positieve tabindex (anti-pattern — verstoort natuurlijke tab-volgorde)`);
      filled++;
    } else {
      const tabindexEls = doc.querySelectorAll('[tabindex]').length;
      if (tabindexEls > 0) {
        autoFill('kb5', 'good', `${tabindexEls} elementen met tabindex, geen positieve waarden (correcte aanpak)`);
        filled++;
      }
    }
  } catch(e) {}

  // ── h1q1: Breadcrumbs / actieve menu-items ──
  try {
    const breadcrumb = doc.querySelector('[aria-label*="breadcrumb" i], .breadcrumb, .breadcrumbs, nav.breadcrumb, [role="navigation"][aria-label*="broodkruimel" i], ol.breadcrumb');
    const ariaCurrent = doc.querySelector('[aria-current="page"], [aria-current="step"], .active[role="menuitem"], nav .active, nav .current');
    const found = [];
    if (breadcrumb) found.push('breadcrumbs');
    if (ariaCurrent) found.push('actief menu-item (aria-current/active)');
    if (found.length >= 2) {
      autoFill('h1q1', 'good', `Navigatie-indicatoren: ${found.join(' + ')}`);
    } else if (found.length === 1) {
      autoFill('h1q1', 'ok', `Deels: ${found[0]} gevonden, maar ${!breadcrumb ? 'geen breadcrumbs' : 'geen actief menu-item'}`);
    } else {
      autoFill('h1q1', 'bad', 'Geen breadcrumbs of aria-current/active menu-indicatie gevonden');
    }
    filled++;
  } catch(e) {}

  // ── h6q3: Sticky/fixed navigatie ──
  if (canCSS) {
    try {
      const navEls = doc.querySelectorAll('nav, header, [role="navigation"]');
      let hasSticky = false;
      navEls.forEach(el => {
        const cs = doc.defaultView.getComputedStyle(el);
        if (cs.position === 'sticky' || cs.position === 'fixed') hasSticky = true;
      });
      if (hasSticky) {
        autoFill('h6q3', 'good', 'Navigatie is sticky/fixed — altijd bereikbaar');
      } else if (navEls.length > 0) {
        autoFill('h6q3', 'ok', `Navigatie gevonden maar niet sticky/fixed — verdwijnt bij scrollen`);
      } else {
        autoFill('h6q3', 'bad', 'Geen nav of header element gevonden');
      }
      filled++;
    } catch(e) {}
  }

  // ── cvq3 + cvq5: Vertrouwenssignalen / social proof ──
  try {
    const trustIndicators = [];
    // Reviews / ratings
    if (doc.querySelector('[class*="review"], [class*="rating"], [class*="testimonial"], [class*="getuigenis"], [itemtype*="Review"], [class*="trustpilot"]')) trustIndicators.push('reviews/ratings');
    // Trust badges / keurmerken
    if (doc.querySelector('[class*="trust"], [class*="keurmerk"], [class*="badge"], [alt*="keurmerk" i], [alt*="trusted" i], [alt*="ssl" i], [alt*="secure" i]')) trustIndicators.push('vertrouwensbadges');
    // Client logos
    if (doc.querySelector('[class*="client"], [class*="partner"], [class*="logo-grid"], [class*="klant"], [alt*="klant" i], [alt*="partner" i]')) trustIndicators.push('klant/partner logo\'s');
    // Star ratings
    if (doc.querySelector('[class*="star"], [class*="ster"], .fa-star, [aria-label*="star" i]')) trustIndicators.push('sterren-rating');

    if (trustIndicators.length >= 2) {
      autoFill('cvq3', 'good', `Vertrouwenssignalen: ${trustIndicators.join(', ')}`);
      autoFill('cvq5', 'good', `Social proof aanwezig: ${trustIndicators.join(', ')}`);
    } else if (trustIndicators.length === 1) {
      autoFill('cvq3', 'ok', `1 type vertrouwenssignaal: ${trustIndicators[0]}`);
      autoFill('cvq5', 'ok', `Beperkte social proof: ${trustIndicators[0]}`);
    } else {
      autoFill('cvq3', 'bad', 'Geen vertrouwenssignalen gevonden (reviews, badges, klantenlogo\'s)');
      autoFill('cvq5', 'bad', 'Geen social proof elementen gevonden');
    }
    filled += 2;
  } catch(e) {}

  // ── sm4: Semantische structuur (header/main/footer/nav) ──
  try {
    const semantic = [];
    if (doc.querySelector('header')) semantic.push('header');
    if (doc.querySelector('nav, [role="navigation"]')) semantic.push('nav');
    if (doc.querySelector('main, [role="main"]')) semantic.push('main');
    if (doc.querySelector('footer')) semantic.push('footer');
    if (doc.querySelector('aside, [role="complementary"]')) semantic.push('aside');
    if (doc.querySelector('article')) semantic.push('article');
    if (doc.querySelector('section')) semantic.push('section');
    if (semantic.length >= 4) {
      autoFill('sm4', 'good', `Goede semantische structuur: ${semantic.join(', ')}`);
    } else if (semantic.length >= 2) {
      autoFill('sm4', 'ok', `Basis semantiek: ${semantic.join(', ')} — voeg meer landmarks toe`);
    } else {
      autoFill('sm4', 'bad', `Minimale semantiek: ${semantic.length > 0 ? semantic.join(', ') : 'geen landmarks'}. Gebruik header, nav, main, footer.`);
    }
    filled++;
  } catch(e) {}

  // ── cvq4: Contactformulier kort genoeg ──
  try {
    const forms = Array.from(doc.querySelectorAll('form'));
    if (forms.length > 0) {
      const shortestForm = forms.reduce((min, form) => {
        const fields = form.querySelectorAll('input:not([type="hidden"]):not([type="submit"]):not([type="button"]), select, textarea').length;
        return fields < min.fields ? { form, fields } : min;
      }, { form: null, fields: 999 });
      if (shortestForm.fields <= 4) {
        autoFill('cvq4', 'good', `Kortste formulier: ${shortestForm.fields} velden — beknopt`);
      } else if (shortestForm.fields <= 7) {
        autoFill('cvq4', 'ok', `Kortste formulier: ${shortestForm.fields} velden — overweeg reductie`);
      } else {
        autoFill('cvq4', 'bad', `Kortste formulier: ${shortestForm.fields} velden — te lang, verhoogt uitval`);
      }
      filled++;
    }
  } catch(e) {}

  // ── h4q3: Webconventies (logo links = home) ──
  try {
    const logoLink = doc.querySelector('header a[href="/"], header a[href="./"], a.logo[href], .logo a[href], a[class*="logo"][href], header a:first-child[href]');
    if (logoLink) {
      const href = logoLink.getAttribute('href') || '';
      const isHome = href === '/' || href === './' || href === '#' || href.endsWith('/') && href.split('/').filter(Boolean).length <= 1;
      if (isHome) {
        autoFill('h4q3', 'good', 'Logo linkt naar homepage — volgt webconventies');
      } else {
        autoFill('h4q3', 'ok', `Logo linkt naar "${href}" — niet direct naar homepage`);
      }
    } else {
      autoFill('h4q3', 'ok', 'Geen duidelijke logo-link in header gevonden');
    }
    filled++;
  } catch(e) {}

  // ── h1q6: Winkelwagen status zichtbaar (e-commerce) ──
  try {
    const cartIndicators = doc.querySelector('[class*="cart"], [class*="basket"], [class*="wagen"], [class*="winkelwagen"], [id*="cart"], [aria-label*="cart" i], [aria-label*="winkelwagen" i], a[href*="cart"], a[href*="winkelwagen"]');
    if (cartIndicators) {
      autoFill('h1q6', 'good', 'Winkelwagen-element gevonden in de pagina');
      filled++;
    }
    // Only fill if we find e-commerce indicators, otherwise skip (n.v.t.)
  } catch(e) {}

  // ── h10q1: FAQ sectie ──
  try {
    const faqLink = doc.querySelector('a[href*="faq" i], a[href*="veelgestelde" i]');
    const faqSection = doc.querySelector('[id*="faq" i], [class*="faq" i], details, [itemtype*="FAQPage"]');
    const accordion = doc.querySelectorAll('details, [class*="accordion"]');
    if (faqSection || accordion.length >= 3) {
      autoFill('h10q1', 'good', `FAQ/accordion gevonden${accordion.length > 0 ? ` (${accordion.length} items)` : ''}`);
    } else if (faqLink) {
      autoFill('h10q1', 'ok', 'Link naar FAQ-pagina gevonden, maar geen inline FAQ op deze pagina');
    } else {
      autoFill('h10q1', 'bad', 'Geen FAQ-sectie of veelgestelde-vragen link gevonden');
    }
    filled++;
  } catch(e) {}

  // ── Open Graph & structured data (bonus info in notes) ──
  try {
    const ogTitle = doc.querySelector('meta[property="og:title"]');
    const ogDesc = doc.querySelector('meta[property="og:description"]');
    const ogImg = doc.querySelector('meta[property="og:image"]');
    const schema = doc.querySelector('script[type="application/ld+json"]');
    const ogParts = [];
    if (ogTitle) ogParts.push('og:title');
    if (ogDesc) ogParts.push('og:description');
    if (ogImg) ogParts.push('og:image');
    if (schema) ogParts.push('structured data (JSON-LD)');
    // No direct question for this, but enrich seq2 notes if possible
  } catch(e) {}

  // ── sec-001: HTTPS enforced (check if URL uses HTTPS) ──
  try {
    const pageUrl = doc.querySelector('link[rel="canonical"]')?.getAttribute('href') || doc.baseURI || '';
    const isHttps = pageUrl.startsWith('https://') || url.startsWith('https://');
    const hsts = doc.querySelector('meta[http-equiv="Strict-Transport-Security"]');
    if (isHttps) {
      autoFill('sec-001', 'good', `Site draait op HTTPS${hsts ? ' + HSTS header gevonden' : ''}`);
    } else {
      autoFill('sec-001', 'bad', 'Site draait niet op HTTPS — onversleutelde verbinding');
    }
    filled++;
  } catch(e) {}

  // ── sec-002: SSL certificate valid (if HTTPS loads = cert is valid) ──
  try {
    if (pageData.source === 'fetch' || pageData.source === 'worker-proxy' || pageData.source === 'iframe') {
      const isHttps = url.startsWith('https://');
      if (isHttps) {
        autoFill('sec-002', 'good', 'SSL certificaat is geldig (pagina laadt succesvol via HTTPS)');
      } else {
        autoFill('sec-002', 'ok', 'Kon SSL certificaat niet controleren — site gebruikt geen HTTPS');
      }
      filled++;
    }
  } catch(e) {}

  // ── sec-003: TLS version (inferred — if modern HTTPS works, TLS 1.2+ is used) ──
  try {
    const isHttps = url.startsWith('https://');
    if (isHttps && (pageData.source === 'fetch' || pageData.source === 'worker-proxy')) {
      autoFill('sec-003', 'good', 'TLS 1.2+ wordt gebruikt (moderne HTTPS verbinding succesvol)');
      filled++;
    }
  } catch(e) {}

  // ── sec-004: Mixed content (HTTP resources on HTTPS page) ──
  try {
    const isHttps = url.startsWith('https://');
    if (isHttps) {
      const httpResources = [];
      doc.querySelectorAll('script[src^="http://"], link[href^="http://"], img[src^="http://"], iframe[src^="http://"]').forEach(el => {
        const src = el.getAttribute('src') || el.getAttribute('href') || '';
        if (src.startsWith('http://')) httpResources.push(src.substring(0, 60));
      });
      if (httpResources.length === 0) {
        autoFill('sec-004', 'good', 'Geen mixed content gevonden — alle resources laden via HTTPS');
      } else {
        autoFill('sec-004', 'bad', `${httpResources.length} resource(s) laden via HTTP: ${httpResources.slice(0, 3).join(', ')}${httpResources.length > 3 ? '…' : ''}`);
      }
      filled++;
    }
  } catch(e) {}

  // ── sec-005: Security headers (Content-Security-Policy via meta tag) ──
  try {
    const csp = doc.querySelector('meta[http-equiv="Content-Security-Policy"]');
    const xfo = doc.querySelector('meta[http-equiv="X-Frame-Options"]');
    const headers = [];
    if (csp) headers.push('CSP');
    if (xfo) headers.push('X-Frame-Options');
    if (headers.length > 0) {
      autoFill('sec-005', 'good', `Security headers via meta tags: ${headers.join(', ')}`);
    } else {
      autoFill('sec-005', 'ok', 'Geen security headers in meta tags (kan via server headers ingesteld zijn)');
    }
    filled++;
  } catch(e) {}

  // ── sec-006: X-Content-Type-Options / MIME sniffing (meta check) ──
  try {
    const xContent = doc.querySelector('meta[http-equiv="X-Content-Type-Options"]');
    if (xContent) {
      autoFill('sec-006', 'good', 'X-Content-Type-Options meta tag aanwezig');
      filled++;
    }
  } catch(e) {}

  // ── sec-009: Subresource Integrity (SRI) on external scripts ──
  try {
    const externalScripts = Array.from(doc.querySelectorAll('script[src]')).filter(s => {
      const src = s.getAttribute('src') || '';
      return src.startsWith('http') && !src.includes(new URL(url).hostname);
    });
    if (externalScripts.length > 0) {
      const withSri = externalScripts.filter(s => s.getAttribute('integrity'));
      if (withSri.length === externalScripts.length) {
        autoFill('sec-009', 'good', `Alle ${externalScripts.length} externe scripts hebben SRI (integrity)`);
      } else if (withSri.length > 0) {
        autoFill('sec-009', 'ok', `${withSri.length} van ${externalScripts.length} externe scripts hebben SRI`);
      } else {
        autoFill('sec-009', 'bad', `${externalScripts.length} externe scripts zonder SRI (integrity attribuut)`);
      }
      filled++;
    }
  } catch(e) {}

  // ══════════════════════════════════════════════════════════════
  // TECHNICAL SEO (tseo-*) — DOM-based checks
  // ══════════════════════════════════════════════════════════════

  // ── tseo-019 + tseo-020: Meta robots tags ──
  try {
    const robotsMeta = doc.querySelector('meta[name="robots"]');
    const content = robotsMeta ? (robotsMeta.getAttribute('content') || '').toLowerCase() : '';
    if (robotsMeta) {
      const hasNoindex = content.includes('noindex');
      const hasNofollow = content.includes('nofollow');
      autoFill('tseo-019', !hasNoindex && !hasNofollow ? 'good' : 'ok',
        `Meta robots: "${content}" ${hasNoindex ? '⚠ noindex actief' : ''}${hasNofollow ? '⚠ nofollow actief' : ''}`);
      autoFill('tseo-020', hasNoindex ? 'bad' : 'good',
        hasNoindex ? 'Pagina is noindex — wordt niet geïndexeerd!' : 'Geen accidentele noindex gevonden');
      filled += 2;
    } else {
      autoFill('tseo-019', 'good', 'Geen restrictieve meta robots tag — standaard index,follow');
      autoFill('tseo-020', 'good', 'Geen noindex gevonden');
      filled += 2;
    }
  } catch(e) {}

  // ── tseo-021/022/023: Canonical tags ──
  try {
    const canonicals = Array.from(doc.querySelectorAll('link[rel="canonical"]'));
    if (canonicals.length === 1) {
      const href = canonicals[0].getAttribute('href') || '';
      const isSelf = href === url || href === url.replace(/\/$/, '') || url.startsWith(href);
      autoFill('tseo-021', 'good', `Canonical tag aanwezig: ${href.substring(0, 80)}`);
      autoFill('tseo-022', isSelf ? 'good' : 'ok',
        isSelf ? 'Canonical is self-referencing (correct)' : `Canonical wijst naar andere URL: ${href.substring(0, 60)}`);
      autoFill('tseo-023', 'good', 'Geen conflicterende canonical tags (1 gevonden)');
      filled += 3;
    } else if (canonicals.length > 1) {
      autoFill('tseo-021', 'ok', `${canonicals.length} canonical tags gevonden — er mag er maar 1 zijn`);
      autoFill('tseo-022', 'ok', 'Meerdere canonicals — kan niet bepalen of self-referencing');
      autoFill('tseo-023', 'bad', `${canonicals.length} conflicterende canonical tags!`);
      filled += 3;
    } else {
      autoFill('tseo-021', 'bad', 'Geen canonical tag gevonden');
      autoFill('tseo-022', 'bad', 'Geen canonical tag aanwezig');
      autoFill('tseo-023', 'good', 'Geen conflict (geen canonical)');
      filled += 3;
    }
  } catch(e) {}

  // ── tseo-024: X-Robots-Tag (meta http-equiv check) ──
  try {
    const xRobots = doc.querySelector('meta[http-equiv="X-Robots-Tag"]');
    if (xRobots) {
      const val = xRobots.getAttribute('content') || '';
      autoFill('tseo-024', val.includes('noindex') ? 'bad' : 'good', `X-Robots-Tag meta: "${val}"`);
    } else {
      autoFill('tseo-024', 'good', 'Geen restrictieve X-Robots-Tag meta gevonden');
    }
    filled++;
  } catch(e) {}

  // ── tseo-035-044: URL structure checks ──
  try {
    const pageUrl = url;
    const urlPath = new URL(pageUrl).pathname;
    // tseo-035: Clean URLs
    const isClean = !/[?&].*=/.test(urlPath) && !urlPath.includes('index.php') && !urlPath.includes('index.html');
    autoFill('tseo-035', isClean ? 'good' : 'ok', isClean ? 'URL is schoon en leesbaar' : 'URL bevat query parameters of index-bestanden');
    filled++;
    // tseo-036: No uppercase
    const hasUpper = /[A-Z]/.test(urlPath);
    autoFill('tseo-036', hasUpper ? 'ok' : 'good', hasUpper ? 'URL bevat hoofdletters — gebruik alleen kleine letters' : 'URL gebruikt alleen kleine letters');
    filled++;
    // tseo-037: No special characters
    const hasSpecial = /[^a-zA-Z0-9\-_\/\.]/.test(urlPath);
    autoFill('tseo-037', hasSpecial ? 'ok' : 'good', hasSpecial ? 'URL bevat speciale tekens' : 'URL bevat geen speciale tekens');
    filled++;
    // tseo-038: URL length
    autoFill('tseo-038', pageUrl.length < 100 ? 'good' : pageUrl.length < 150 ? 'ok' : 'bad',
      `URL lengte: ${pageUrl.length} tekens ${pageUrl.length >= 100 ? '(beter < 100)' : '(goed)'}`);
    filled++;
    // tseo-039: Trailing slash consistency
    const hasTrailing = urlPath.endsWith('/') && urlPath !== '/';
    autoFill('tseo-039', 'ok', `URL ${hasTrailing ? 'heeft' : 'heeft geen'} trailing slash — zorg voor consistentie`);
    filled++;
    // tseo-040: No session IDs in URL
    const hasSession = /[?&](session|sid|phpsessid|jsessionid)=/i.test(pageUrl);
    autoFill('tseo-040', hasSession ? 'bad' : 'good',
      hasSession ? 'Session ID in URL gedetecteerd — slecht voor SEO' : 'Geen session IDs in URL');
    filled++;
    // tseo-041: HTTPS
    autoFill('tseo-041', pageUrl.startsWith('https://') ? 'good' : 'bad',
      pageUrl.startsWith('https://') ? 'URL gebruikt HTTPS' : 'URL gebruikt geen HTTPS!');
    filled++;
  } catch(e) {}

  // ── tseo-054: Descriptive anchor text ──
  try {
    const links = Array.from(doc.querySelectorAll('a[href]'));
    if (links.length > 0) {
      const genericText = ['klik hier', 'lees meer', 'hier', 'click here', 'read more', 'more', 'link', 'meer'];
      const generic = links.filter(a => {
        const text = (a.textContent || '').trim().toLowerCase();
        return genericText.includes(text);
      });
      if (generic.length === 0) {
        autoFill('tseo-054', 'good', `Alle ${links.length} links hebben beschrijvende anchortekst`);
      } else {
        autoFill('tseo-054', generic.length > 5 ? 'bad' : 'ok',
          `${generic.length} van ${links.length} links hebben generieke tekst (bijv. "klik hier", "lees meer")`);
      }
      filled++;
    }
  } catch(e) {}

  // ── tseo-055: External links have rel=noopener ──
  try {
    const hostname = new URL(url).hostname;
    const extLinks = Array.from(doc.querySelectorAll('a[href^="http"]')).filter(a => {
      try { return new URL(a.getAttribute('href')).hostname !== hostname; } catch(e) { return false; }
    });
    if (extLinks.length > 0) {
      const withNoopener = extLinks.filter(a => {
        const rel = (a.getAttribute('rel') || '').toLowerCase();
        return rel.includes('noopener') || rel.includes('noreferrer');
      });
      if (withNoopener.length === extLinks.length) {
        autoFill('tseo-055', 'good', `Alle ${extLinks.length} externe links hebben rel="noopener"`);
      } else {
        autoFill('tseo-055', 'ok', `${withNoopener.length} van ${extLinks.length} externe links hebben rel="noopener"`);
      }
      filled++;
    }
  } catch(e) {}

  // ── tseo-056: Link count per page ──
  try {
    const allLinks = doc.querySelectorAll('a[href]').length;
    autoFill('tseo-056', allLinks < 100 ? 'good' : allLinks < 200 ? 'ok' : 'bad',
      `${allLinks} links op pagina ${allLinks >= 200 ? '— te veel, beperk tot <100' : allLinks >= 100 ? '— veel, overweeg reductie' : '— goed aantal'}`);
    filled++;
  } catch(e) {}

  // ── tseo-067-071: Structured data / JSON-LD ──
  try {
    const jsonLdScripts = Array.from(doc.querySelectorAll('script[type="application/ld+json"]'));
    if (jsonLdScripts.length > 0) {
      autoFill('tseo-067', 'good', `${jsonLdScripts.length} JSON-LD blok(ken) gevonden`);
      filled++;
      // tseo-068: Valid JSON-LD
      let validCount = 0;
      let schemas = [];
      jsonLdScripts.forEach(s => {
        try {
          const data = JSON.parse(s.textContent);
          validCount++;
          const type = data['@type'] || (Array.isArray(data['@graph']) ? 'Graph' : 'onbekend');
          schemas.push(type);
        } catch(e) {}
      });
      autoFill('tseo-068', validCount === jsonLdScripts.length ? 'good' : 'bad',
        validCount === jsonLdScripts.length
          ? `Alle JSON-LD is valide syntax. Types: ${schemas.join(', ')}`
          : `${jsonLdScripts.length - validCount} JSON-LD blokken hebben ongeldige syntax`);
      filled++;
      // tseo-069: Organization schema
      const hasOrg = schemas.some(s => s === 'Organization' || s === 'LocalBusiness' || s === 'Corporation');
      autoFill('tseo-069', hasOrg ? 'good' : 'ok',
        hasOrg ? 'Organization/LocalBusiness schema aanwezig' : 'Geen Organization schema — overweeg toe te voegen');
      filled++;
      // tseo-070: Breadcrumb schema
      const hasBreadcrumb = schemas.some(s => s === 'BreadcrumbList');
      autoFill('tseo-070', hasBreadcrumb ? 'good' : 'ok',
        hasBreadcrumb ? 'BreadcrumbList schema aanwezig' : 'Geen Breadcrumb schema gevonden');
      filled++;
      // tseo-071: Rich results eligible
      const richTypes = ['Product', 'Article', 'FAQPage', 'HowTo', 'Recipe', 'Event', 'JobPosting', 'Review'];
      const hasRich = schemas.some(s => richTypes.includes(s));
      autoFill('tseo-071', hasRich ? 'good' : 'ok',
        hasRich ? `Rich result eligible: ${schemas.filter(s => richTypes.includes(s)).join(', ')}` : 'Geen rich-result eligible schema gevonden');
      filled++;
    } else {
      autoFill('tseo-067', 'bad', 'Geen JSON-LD structured data gevonden');
      autoFill('tseo-068', 'bad', 'Geen JSON-LD aanwezig om te valideren');
      autoFill('tseo-069', 'bad', 'Geen Organization schema');
      autoFill('tseo-070', 'bad', 'Geen Breadcrumb schema');
      autoFill('tseo-071', 'bad', 'Geen structured data voor rich results');
      filled += 5;
    }
  } catch(e) {}

  // ── tseo-082-086: hreflang tags ──
  try {
    const hreflangs = Array.from(doc.querySelectorAll('link[rel="alternate"][hreflang]'));
    if (hreflangs.length > 0) {
      const langs = hreflangs.map(h => h.getAttribute('hreflang'));
      autoFill('tseo-082', 'good', `${hreflangs.length} hreflang tags: ${langs.join(', ')}`);
      filled++;
      // tseo-083: Return links
      autoFill('tseo-083', 'ok', `${hreflangs.length} hreflang tags gevonden — controleer return links handmatig`);
      filled++;
      // tseo-084: Valid language codes
      const validPattern = /^[a-z]{2}(-[A-Z]{2})?$|^x-default$/;
      const invalid = langs.filter(l => !validPattern.test(l));
      autoFill('tseo-084', invalid.length === 0 ? 'good' : 'bad',
        invalid.length === 0 ? 'Alle hreflang taalcodes zijn geldig' : `Ongeldige taalcodes: ${invalid.join(', ')}`);
      filled++;
      // tseo-085: x-default
      const hasXDefault = langs.includes('x-default');
      autoFill('tseo-085', hasXDefault ? 'good' : 'ok',
        hasXDefault ? 'x-default hreflang aanwezig' : 'Geen x-default hreflang — voeg toe als fallback');
      filled++;
      // tseo-086: hreflang/canonical conflict
      const canonical = doc.querySelector('link[rel="canonical"]');
      autoFill('tseo-086', canonical ? 'ok' : 'good',
        canonical ? 'Canonical en hreflang beide aanwezig — controleer dat ze niet conflicteren' : 'Geen canonical/hreflang conflict');
      filled++;
    } else {
      // Only fill if page seems multilingual
      const htmlLang = doc.querySelector('html')?.getAttribute('lang') || '';
      autoFill('tseo-082', 'ok', `Geen hreflang tags — ${htmlLang ? 'pagina taal: ' + htmlLang : 'n.v.t. als single-language site'}`);
      autoFill('tseo-083', 'ok', 'N.v.t. — geen hreflang tags');
      autoFill('tseo-084', 'ok', 'N.v.t. — geen hreflang tags');
      autoFill('tseo-085', 'ok', 'N.v.t. — geen hreflang tags');
      autoFill('tseo-086', 'good', 'Geen hreflang/canonical conflict');
      filled += 5;
    }
  } catch(e) {}

  // ══════════════════════════════════════════════════════════════
  // ON-PAGE SEO (opseo-*) — extra checks
  // ══════════════════════════════════════════════════════════════

  // ── opseo-006: Title length 50-60 chars ──
  try {
    const title = doc.querySelector('title');
    const titleText = title ? title.textContent.trim() : '';
    if (titleText) {
      autoFill('opseo-006', titleText.length >= 50 && titleText.length <= 60 ? 'good' :
        titleText.length >= 30 && titleText.length <= 70 ? 'ok' : 'bad',
        `Title lengte: ${titleText.length} tekens ${titleText.length < 50 ? '(te kort, min 50)' : titleText.length > 60 ? '(te lang, max 60)' : '(ideaal)'}`);
    } else {
      autoFill('opseo-006', 'bad', 'Geen title tag gevonden');
    }
    filled++;
  } catch(e) {}

  // ── opseo-007: Meta description length 150-160 chars ──
  try {
    const meta = doc.querySelector('meta[name="description"]');
    const desc = meta ? (meta.getAttribute('content') || '').trim() : '';
    if (desc) {
      autoFill('opseo-007', desc.length >= 150 && desc.length <= 160 ? 'good' :
        desc.length >= 120 && desc.length <= 170 ? 'ok' : 'bad',
        `Meta description lengte: ${desc.length} tekens ${desc.length < 150 ? '(te kort)' : desc.length > 160 ? '(te lang)' : '(ideaal)'}`);
    } else {
      autoFill('opseo-007', 'bad', 'Geen meta description gevonden');
    }
    filled++;
  } catch(e) {}

  // ── opseo-011: Only one H1 ──
  try {
    const h1s = doc.querySelectorAll('h1');
    autoFill('opseo-011', h1s.length === 1 ? 'good' : h1s.length === 0 ? 'bad' : 'ok',
      h1s.length === 1 ? 'Precies één H1 tag op de pagina' :
      h1s.length === 0 ? 'Geen H1 tag gevonden!' : `${h1s.length} H1 tags — er mag er maar 1 zijn`);
    filled++;
  } catch(e) {}

  // ── opseo-012: Heading hierarchy correct ──
  try {
    const headings = Array.from(doc.querySelectorAll('h1,h2,h3,h4,h5,h6'));
    if (headings.length > 0) {
      const levels = headings.map(h => parseInt(h.tagName[1]));
      let skipFound = false;
      for (let i = 1; i < levels.length; i++) { if (levels[i] - levels[i-1] > 1) { skipFound = true; break; } }
      autoFill('opseo-012', !skipFound ? 'good' : 'ok',
        !skipFound ? `Heading hiërarchie correct (${headings.length} headings)` : 'Heading niveaus worden overgeslagen');
      filled++;
    }
  } catch(e) {}

  // ── opseo-013: H1 present on page ──
  try {
    const h1 = doc.querySelector('h1');
    const h1Text = h1 ? h1.textContent.trim() : '';
    autoFill('opseo-013', h1 ? 'good' : 'bad',
      h1 ? `H1 aanwezig: "${h1Text.substring(0, 60)}${h1Text.length > 60 ? '…' : ''}"` : 'Geen H1 tag gevonden op de pagina!');
    filled++;
  } catch(e) {}

  // ── opseo-018: Word count 300+ ──
  try {
    const bodyText = (doc.body?.innerText || doc.body?.textContent || '').trim();
    const wordCount = bodyText.split(/\s+/).filter(w => w.length > 0).length;
    autoFill('opseo-018', wordCount >= 300 ? 'good' : wordCount >= 150 ? 'ok' : 'bad',
      `Woordenaantal: ${wordCount} ${wordCount < 300 ? '(minimum 300 aanbevolen)' : '(voldoende)'}`);
    filled++;
  } catch(e) {}

  // ── opseo-028/029/030/031: Open Graph + Twitter Card ──
  try {
    const ogTitle = doc.querySelector('meta[property="og:title"]');
    const ogDesc = doc.querySelector('meta[property="og:description"]');
    const ogImg = doc.querySelector('meta[property="og:image"]');
    const twCard = doc.querySelector('meta[name="twitter:card"]');
    autoFill('opseo-028', ogTitle ? 'good' : 'bad',
      ogTitle ? `OG title: "${(ogTitle.getAttribute('content') || '').substring(0, 50)}"` : 'Geen og:title meta tag');
    autoFill('opseo-029', ogDesc ? 'good' : 'bad',
      ogDesc ? `OG description aanwezig (${(ogDesc.getAttribute('content') || '').length} tekens)` : 'Geen og:description meta tag');
    autoFill('opseo-030', ogImg ? 'good' : 'bad',
      ogImg ? `OG image: ${(ogImg.getAttribute('content') || '').substring(0, 60)}` : 'Geen og:image meta tag');
    autoFill('opseo-031', twCard ? 'good' : 'ok',
      twCard ? `Twitter Card: ${twCard.getAttribute('content')}` : 'Geen Twitter Card meta tags');
    filled += 4;
  } catch(e) {}

  // ── opseo-034: Descriptive image filenames ──
  try {
    const imgs = Array.from(doc.querySelectorAll('img[src]'));
    if (imgs.length > 0) {
      const badNames = imgs.filter(img => {
        const src = img.getAttribute('src') || '';
        const filename = src.split('/').pop().split('?')[0].toLowerCase();
        return /^(img|image|photo|pic|screenshot|untitled|dsc|img_?\d+|\d+)\.(jpg|jpeg|png|gif|webp|avif|svg)$/i.test(filename);
      });
      autoFill('opseo-034', badNames.length === 0 ? 'good' : badNames.length > 3 ? 'bad' : 'ok',
        badNames.length === 0 ? `Alle ${imgs.length} afbeeldingen hebben beschrijvende bestandsnamen` :
        `${badNames.length} afbeeldingen met generieke bestandsnamen (bijv. img001.jpg)`);
      filled++;
    }
  } catch(e) {}

  // ── opseo-035: Images have width/height attributes ──
  try {
    const imgs = Array.from(doc.querySelectorAll('img'));
    if (imgs.length > 0) {
      const withDims = imgs.filter(img => img.getAttribute('width') && img.getAttribute('height'));
      autoFill('opseo-035', withDims.length === imgs.length ? 'good' : withDims.length > 0 ? 'ok' : 'bad',
        `${withDims.length} van ${imgs.length} afbeeldingen hebben width/height attributen ${withDims.length < imgs.length ? '— voorkomt CLS' : ''}`);
      filled++;
    }
  } catch(e) {}

  // ── opseo-019: Target keyword in first paragraph ──
  try {
    const firstPara = doc.querySelector('main p, article p, .content p, p');
    if (firstPara) {
      const text = firstPara.textContent.trim();
      autoFill('opseo-019', text.length > 30 ? 'ok' : 'bad',
        text.length > 30 ? `Eerste alinea: "${text.substring(0, 80)}…" — controleer of doelsleutelwoord aanwezig is` :
        'Eerste alinea te kort of leeg');
    } else {
      autoFill('opseo-019', 'bad', 'Geen eerste alinea gevonden');
    }
    filled++;
  } catch(e) {}

  // ── opseo-038: Viewport meta tag ──
  try {
    const viewport = doc.querySelector('meta[name="viewport"]');
    if (viewport) {
      const content = viewport.getAttribute('content') || '';
      autoFill('opseo-038', content.includes('width=device-width') ? 'good' : 'ok',
        `Viewport meta: "${content.substring(0, 60)}"`);
    } else {
      autoFill('opseo-038', 'bad', 'Geen viewport meta tag — niet mobielvriendelijk');
    }
    filled++;
  } catch(e) {}

  // ══════════════════════════════════════════════════════════════
  // ACCESSIBILITY (a11y-*) — extra checks
  // ══════════════════════════════════════════════════════════════

  // ── a11y-001: Contrast ratio (CSS only) ──
  if (canCSS) {
    try {
      const body = doc.body;
      const cs = doc.defaultView.getComputedStyle(body);
      const color = cs.color;
      const bg = cs.backgroundColor;
      autoFill('a11y-001', 'ok', `Body tekstkleur: ${color}, achtergrond: ${bg} — controleer contrast handmatig of via DevTools`);
      filled++;
    } catch(e) {}
  }

  // ── a11y-046: All images have alt text ──
  try {
    const imgs = Array.from(doc.querySelectorAll('img'));
    if (imgs.length > 0) {
      const missingAlt = imgs.filter(img => {
        if (img.getAttribute('role') === 'presentation' || img.getAttribute('aria-hidden') === 'true') return false;
        return !img.hasAttribute('alt');
      });
      autoFill('a11y-046', missingAlt.length === 0 ? 'good' : missingAlt.length > 3 ? 'bad' : 'ok',
        missingAlt.length === 0 ? `Alle ${imgs.length} afbeeldingen hebben alt-tekst` :
        `${missingAlt.length} van ${imgs.length} afbeeldingen missen alt-tekst`);
      filled++;
    }
  } catch(e) {}

  // ── a11y-047: Links have descriptive text ──
  try {
    const links = Array.from(doc.querySelectorAll('a[href]'));
    if (links.length > 0) {
      const noText = links.filter(a => {
        const text = (a.textContent || '').trim();
        const ariaLabel = a.getAttribute('aria-label');
        const title = a.getAttribute('title');
        const img = a.querySelector('img[alt]');
        return !text && !ariaLabel && !title && !img;
      });
      autoFill('a11y-047', noText.length === 0 ? 'good' : noText.length > 3 ? 'bad' : 'ok',
        noText.length === 0 ? `Alle ${links.length} links hebben beschrijvende tekst` :
        `${noText.length} links zonder toegankelijke tekst`);
      filled++;
    }
  } catch(e) {}

  // ── a11y-048: Correct tabindex usage ──
  try {
    const posTabindex = Array.from(doc.querySelectorAll('[tabindex]')).filter(el => parseInt(el.getAttribute('tabindex')) > 0);
    autoFill('a11y-048', posTabindex.length === 0 ? 'good' : 'bad',
      posTabindex.length === 0 ? 'Correct tabindex gebruik (geen positieve waarden)' :
      `${posTabindex.length} elementen met positieve tabindex — verstoort tab-volgorde`);
    filled++;
  } catch(e) {}

  // ── a11y-049: Unique accesskeys ──
  try {
    const accesskeys = Array.from(doc.querySelectorAll('[accesskey]')).map(el => el.getAttribute('accesskey'));
    if (accesskeys.length > 0) {
      const unique = new Set(accesskeys);
      autoFill('a11y-049', unique.size === accesskeys.length ? 'good' : 'bad',
        unique.size === accesskeys.length ? `${accesskeys.length} unieke accesskeys` :
        `Dubbele accesskeys gevonden! ${accesskeys.length} totaal, ${unique.size} uniek`);
    } else {
      autoFill('a11y-049', 'ok', 'Geen accesskeys gedefinieerd');
    }
    filled++;
  } catch(e) {}

  // ── a11y-053: Videos have captions ──
  try {
    const videos = Array.from(doc.querySelectorAll('video'));
    if (videos.length > 0) {
      const withCaptions = videos.filter(v => v.querySelector('track[kind="captions"], track[kind="subtitles"]'));
      autoFill('a11y-053', withCaptions.length === videos.length ? 'good' : withCaptions.length > 0 ? 'ok' : 'bad',
        `${withCaptions.length} van ${videos.length} video's hebben ondertiteling`);
      filled++;
    }
  } catch(e) {}

  // ── a11y-054: Audio elements have captions ──
  try {
    const audios = Array.from(doc.querySelectorAll('audio'));
    if (audios.length > 0) {
      const withTrack = audios.filter(a => a.querySelector('track'));
      autoFill('a11y-054', withTrack.length === audios.length ? 'good' : 'bad',
        `${withTrack.length} van ${audios.length} audio-elementen hebben een transcript/track`);
      filled++;
    }
  } catch(e) {}

  // ── a11y-057: Form fields have name attributes ──
  try {
    const formFields = Array.from(doc.querySelectorAll('input:not([type="hidden"]):not([type="submit"]):not([type="button"]), select, textarea'));
    if (formFields.length > 0) {
      const noName = formFields.filter(f => !f.getAttribute('name') && !f.getAttribute('id'));
      autoFill('a11y-057', noName.length === 0 ? 'good' : 'bad',
        noName.length === 0 ? `Alle ${formFields.length} formuliervelden hebben name/id` :
        `${noName.length} velden zonder name of id attribuut`);
      filled++;
    }
  } catch(e) {}

  // ── a11y-058: Valid lang attribute ──
  try {
    const htmlEl = doc.querySelector('html');
    const lang = htmlEl ? htmlEl.getAttribute('lang') : null;
    if (lang) {
      const validLang = /^[a-z]{2,3}(-[A-Za-z]{2,4})?$/.test(lang);
      autoFill('a11y-058', validLang ? 'good' : 'bad',
        validLang ? `Geldig lang-attribuut: "${lang}"` : `Ongeldig lang-attribuut: "${lang}"`);
    } else {
      autoFill('a11y-058', 'bad', 'Geen lang-attribuut op html-element');
    }
    filled++;
  } catch(e) {}

  // ── a11y-062: Page has main landmark ──
  try {
    const mainEl = doc.querySelector('main, [role="main"]');
    autoFill('a11y-062', mainEl ? 'good' : 'bad',
      mainEl ? 'Main landmark aanwezig' : 'Geen <main> of role="main" gevonden');
    filled++;
  } catch(e) {}

  // ── a11y-063: Content regions marked with landmarks ──
  try {
    const landmarks = doc.querySelectorAll('header, nav, main, aside, footer, [role="banner"], [role="navigation"], [role="main"], [role="complementary"], [role="contentinfo"]');
    autoFill('a11y-063', landmarks.length >= 3 ? 'good' : landmarks.length >= 1 ? 'ok' : 'bad',
      `${landmarks.length} landmark regio's gevonden ${landmarks.length < 3 ? '— voeg meer toe (header, nav, main, footer)' : ''}`);
    filled++;
  } catch(e) {}

  // ── a11y-064: Lists semantically marked ──
  try {
    const lists = doc.querySelectorAll('ul, ol, dl');
    if (lists.length > 0) {
      autoFill('a11y-064', 'good', `${lists.length} semantische lijsten gevonden (ul/ol/dl)`);
    } else {
      autoFill('a11y-064', 'ok', 'Geen semantische lijsten gevonden — controleer of lijstachtige content correct gemarkeerd is');
    }
    filled++;
  } catch(e) {}

  // ── a11y-065: List items only inside lists ──
  try {
    const orphanLi = Array.from(doc.querySelectorAll('li')).filter(li => {
      const parent = li.parentElement;
      return parent && !['UL', 'OL', 'MENU'].includes(parent.tagName);
    });
    autoFill('a11y-065', orphanLi.length === 0 ? 'good' : 'bad',
      orphanLi.length === 0 ? 'Alle list items staan correct in ul/ol' :
      `${orphanLi.length} li-elementen buiten een ul/ol — ongeldige structuur`);
    filled++;
  } catch(e) {}

  // ── a11y-066: Iframes have titles ──
  try {
    const iframes = Array.from(doc.querySelectorAll('iframe'));
    if (iframes.length > 0) {
      const noTitle = iframes.filter(f => !f.getAttribute('title') && !f.getAttribute('aria-label'));
      autoFill('a11y-066', noTitle.length === 0 ? 'good' : 'bad',
        noTitle.length === 0 ? `Alle ${iframes.length} iframes hebben een title` :
        `${noTitle.length} van ${iframes.length} iframes missen een title attribuut`);
      filled++;
    }
  } catch(e) {}

  // ── a11y-067: No duplicate IDs ──
  try {
    const allIds = Array.from(doc.querySelectorAll('[id]')).map(el => el.id).filter(id => id);
    const seen = new Set();
    const dupes = [];
    allIds.forEach(id => { if (seen.has(id)) dupes.push(id); seen.add(id); });
    if (allIds.length > 0) {
      autoFill('a11y-067', dupes.length === 0 ? 'good' : 'bad',
        dupes.length === 0 ? `Alle ${allIds.length} IDs zijn uniek` :
        `${dupes.length} dubbele IDs gevonden: ${dupes.slice(0, 5).join(', ')}${dupes.length > 5 ? '…' : ''}`);
      filled++;
    }
  } catch(e) {}

  // ══════════════════════════════════════════════════════════════
  // ANALYTICS (anl-*)
  // ══════════════════════════════════════════════════════════════

  // ── anl-001/002: Google Analytics 4 ──
  try {
    const gaScripts = Array.from(doc.querySelectorAll('script[src*="googletagmanager.com/gtag"], script[src*="google-analytics.com"], script[src*="gtag/js"]'));
    const inlineGA = Array.from(doc.querySelectorAll('script')).filter(s => (s.textContent || '').includes('gtag('));
    const gaFound = gaScripts.length > 0 || inlineGA.length > 0;
    autoFill('anl-001', gaFound ? 'good' : 'bad',
      gaFound ? 'Google Analytics (GA4/gtag) gedetecteerd' : 'Geen Google Analytics gevonden');
    filled++;
    // anl-002: GA4 ID valid format
    if (gaFound) {
      const allScriptContent = [...gaScripts.map(s => s.getAttribute('src') || ''), ...inlineGA.map(s => s.textContent || '')].join(' ');
      const ga4Match = allScriptContent.match(/G-[A-Z0-9]{6,}/);
      const uaMatch = allScriptContent.match(/UA-\d+-\d+/);
      if (ga4Match) {
        autoFill('anl-002', 'good', `GA4 Measurement ID: ${ga4Match[0]}`);
      } else if (uaMatch) {
        autoFill('anl-002', 'ok', `Oude Universal Analytics ID: ${uaMatch[0]} — migreer naar GA4`);
      } else {
        autoFill('anl-002', 'ok', 'Analytics script gevonden maar geen GA4 ID (G-XXXXXX) herkend');
      }
      filled++;
    } else {
      autoFill('anl-002', 'bad', 'Geen GA4 ID — analytics niet geïnstalleerd');
      filled++;
    }
  } catch(e) {}

  // ── anl-007/008: Google Tag Manager ──
  try {
    const gtmScripts = Array.from(doc.querySelectorAll('script[src*="googletagmanager.com/gtm"]'));
    const gtmNoscript = doc.querySelector('noscript iframe[src*="googletagmanager.com"]');
    const inlineGTM = Array.from(doc.querySelectorAll('script')).filter(s => (s.textContent || '').includes('GTM-'));
    const gtmFound = gtmScripts.length > 0 || gtmNoscript || inlineGTM.length > 0;
    autoFill('anl-007', gtmFound ? 'good' : 'ok',
      gtmFound ? 'Google Tag Manager gedetecteerd' : 'Geen Google Tag Manager gevonden');
    filled++;
    if (gtmFound) {
      const allContent = [...gtmScripts.map(s => s.getAttribute('src') || ''), ...inlineGTM.map(s => s.textContent || '')].join(' ');
      const gtmMatch = allContent.match(/GTM-[A-Z0-9]+/);
      autoFill('anl-008', gtmMatch ? 'good' : 'ok',
        gtmMatch ? `GTM Container ID: ${gtmMatch[0]}` : 'GTM gevonden maar geen container ID herkend');
    } else {
      autoFill('anl-008', 'ok', 'N.v.t. — geen GTM');
    }
    filled++;
  } catch(e) {}

  // ── anl-012: Consent Mode v2 ──
  try {
    const scripts = Array.from(doc.querySelectorAll('script')).map(s => s.textContent || '').join(' ');
    const hasConsentMode = scripts.includes('consent') && (scripts.includes('granted') || scripts.includes('denied'));
    const hasGtagConsent = scripts.includes('gtag') && scripts.includes('consent');
    autoFill('anl-012', hasConsentMode || hasGtagConsent ? 'good' : 'ok',
      hasConsentMode || hasGtagConsent ? 'Consent Mode configuratie gedetecteerd' :
      'Geen Consent Mode v2 gevonden — vereist voor EU compliance');
    filled++;
  } catch(e) {}

  // ══════════════════════════════════════════════════════════════
  // LEGAL / PRIVACY (legal-*)
  // ══════════════════════════════════════════════════════════════

  // ── legal-001/002: Privacy policy ──
  try {
    const privacyLink = doc.querySelector('a[href*="privacy"], a[href*="privacybeleid"], a[href*="privacyverklaring"]');
    const footerPrivacy = doc.querySelector('footer a[href*="privacy"], footer a[href*="privacybeleid"]');
    autoFill('legal-001', privacyLink ? 'good' : 'bad',
      privacyLink ? `Privacybeleid link gevonden: ${(privacyLink.getAttribute('href') || '').substring(0, 60)}` :
      'Geen link naar privacybeleid gevonden');
    autoFill('legal-002', footerPrivacy ? 'good' : privacyLink ? 'ok' : 'bad',
      footerPrivacy ? 'Privacybeleid gelinkt in footer' :
      privacyLink ? 'Privacybeleid gevonden maar niet in footer' : 'Geen privacybeleid link in footer');
    filled += 2;
  } catch(e) {}

  // ── legal-008/009: Cookie banner ──
  try {
    const cookieBanner = doc.querySelector(
      '[id*="cookie" i], [class*="cookie-banner" i], [class*="cookie-consent" i], [class*="cookie-notice" i], ' +
      '[id*="consent" i][class*="banner" i], [class*="cc-banner"], [class*="gdpr" i], ' +
      '[id*="cookieConsent" i], [class*="cookieConsent" i], [id*="CookieConsent" i], ' +
      '[class*="onetrust" i], [id*="onetrust" i], [class*="cookiebot" i], [id*="CybotCookiebotDialog"]'
    );
    autoFill('legal-008', cookieBanner ? 'good' : 'bad',
      cookieBanner ? 'Cookie banner/consent gedetecteerd' : 'Geen cookie banner gevonden — vereist voor GDPR');
    filled++;
    if (cookieBanner) {
      const rejectBtn = cookieBanner.querySelector(
        'button[class*="reject" i], button[class*="decline" i], button[class*="weiger" i], ' +
        'a[class*="reject" i], [class*="deny" i], button[class*="refuse" i]'
      );
      const allBtns = cookieBanner.querySelectorAll('button, a[role="button"]');
      const hasReject = rejectBtn || Array.from(allBtns).some(b => {
        const text = (b.textContent || '').toLowerCase();
        return text.includes('weiger') || text.includes('reject') || text.includes('decline') || text.includes('alleen noodzakelijk');
      });
      autoFill('legal-009', hasReject ? 'good' : 'bad',
        hasReject ? 'Cookie banner heeft een weiger/reject optie' :
        'Geen weiger-optie gevonden in cookie banner — vereist voor GDPR');
      filled++;
    } else {
      autoFill('legal-009', 'bad', 'N.v.t. — geen cookie banner');
      filled++;
    }
  } catch(e) {}

  // ── legal-010: No cookies before consent (limited DOM check) ──
  try {
    const scripts = Array.from(doc.querySelectorAll('script')).map(s => s.textContent || '').join(' ');
    const setsDocCookie = scripts.includes('document.cookie');
    const hasConsentCheck = scripts.includes('consent') || scripts.includes('cookie_consent') || scripts.includes('cookieConsent');
    autoFill('legal-010', !setsDocCookie ? 'good' : hasConsentCheck ? 'ok' : 'bad',
      !setsDocCookie ? 'Geen directe cookie-setting in inline scripts gevonden' :
      hasConsentCheck ? 'Cookie-setting met consent check gedetecteerd' :
      'Scripts zetten cookies zonder duidelijke consent check');
    filled++;
  } catch(e) {}

  // ── legal-015: HTTPS on form pages ──
  try {
    const forms = doc.querySelectorAll('form[action]');
    if (forms.length > 0) {
      const httpForms = Array.from(forms).filter(f => {
        const action = f.getAttribute('action') || '';
        return action.startsWith('http://');
      });
      autoFill('legal-015', httpForms.length === 0 ? 'good' : 'bad',
        httpForms.length === 0 ? `Alle ${forms.length} formulieren gebruiken HTTPS` :
        `${httpForms.length} formulieren sturen data via HTTP — onveilig!`);
    } else {
      autoFill('legal-015', 'ok', 'Geen formulieren met action attribuut gevonden');
    }
    filled++;
  } catch(e) {}

  // ── legal-026/027: Terms & conditions ──
  try {
    const termsLink = doc.querySelector('a[href*="terms"], a[href*="voorwaarden"], a[href*="algemene-voorwaarden"], a[href*="conditions"]');
    const footerTerms = doc.querySelector('footer a[href*="terms"], footer a[href*="voorwaarden"], footer a[href*="conditions"]');
    autoFill('legal-026', termsLink ? 'good' : 'ok',
      termsLink ? `Algemene voorwaarden link gevonden` : 'Geen link naar algemene voorwaarden gevonden');
    autoFill('legal-027', footerTerms ? 'good' : termsLink ? 'ok' : 'ok',
      footerTerms ? 'Voorwaarden gelinkt in footer' :
      termsLink ? 'Voorwaarden gevonden maar niet in footer' : 'Geen voorwaarden link in footer');
    filled += 2;
  } catch(e) {}

  // ══════════════════════════════════════════════════════════════
  // TRUST & CREDIBILITY (trust-*)
  // ══════════════════════════════════════════════════════════════

  // ── trust-008: Contact page exists & linked ──
  try {
    const contactLink = doc.querySelector('a[href*="contact"], a[href*="kontakt"]');
    autoFill('trust-008', contactLink ? 'good' : 'bad',
      contactLink ? 'Contactpagina link gevonden' : 'Geen link naar contactpagina gevonden');
    filled++;
  } catch(e) {}

  // ── trust-009: Phone number clickable (tel link) ──
  try {
    const telLink = doc.querySelector('a[href^="tel:"]');
    autoFill('trust-009', telLink ? 'good' : 'ok',
      telLink ? `Klikbaar telefoonnummer: ${telLink.getAttribute('href')}` : 'Geen klikbaar telefoonnummer (tel: link) gevonden');
    filled++;
  } catch(e) {}

  // ── trust-010: Email address present ──
  try {
    const mailLink = doc.querySelector('a[href^="mailto:"]');
    const bodyText = (doc.body?.textContent || '');
    const emailInText = bodyText.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/);
    autoFill('trust-010', mailLink ? 'good' : emailInText ? 'ok' : 'bad',
      mailLink ? `E-mailadres gevonden: ${mailLink.getAttribute('href').replace('mailto:', '')}` :
      emailInText ? `E-mailadres in tekst: ${emailInText[0]} (maak een mailto: link)` :
      'Geen e-mailadres gevonden op de pagina');
    filled++;
  } catch(e) {}

  // ══════════════════════════════════════════════════════════════
  // CONTENT QUALITY (cont-*)
  // ══════════════════════════════════════════════════════════════

  // ── cont-001/002/003: Readability metrics ──
  try {
    const bodyText = (doc.body?.innerText || doc.body?.textContent || '').trim();
    const sentences = bodyText.split(/[.!?]+/).filter(s => s.trim().length > 10);
    const words = bodyText.split(/\s+/).filter(w => w.length > 0);
    const paragraphs = Array.from(doc.querySelectorAll('p')).filter(p => p.textContent.trim().length > 20);

    if (sentences.length > 3 && words.length > 50) {
      // cont-001: Readability (simplified Flesch-Kincaid estimate)
      const avgWordsPerSentence = words.length / sentences.length;
      const avgSyllables = words.reduce((sum, w) => sum + Math.max(1, w.replace(/[^aeiouyAEIOUY]/g, '').length), 0) / words.length;
      const fkScore = 206.835 - (1.015 * avgWordsPerSentence) - (84.6 * avgSyllables);
      autoFill('cont-001', fkScore >= 60 ? 'good' : fkScore >= 30 ? 'ok' : 'bad',
        `Leesbaarheid (Flesch): ~${Math.round(fkScore)}/100 (${fkScore >= 60 ? 'goed leesbaar' : fkScore >= 30 ? 'matig' : 'moeilijk'}) — gem. ${avgWordsPerSentence.toFixed(1)} woorden/zin`);
      filled++;

      // cont-002: Average sentence length
      autoFill('cont-002', avgWordsPerSentence <= 20 ? 'good' : avgWordsPerSentence <= 25 ? 'ok' : 'bad',
        `Gemiddelde zinslengte: ${avgWordsPerSentence.toFixed(1)} woorden ${avgWordsPerSentence > 20 ? '(streef naar <20)' : '(goed)'}`);
      filled++;

      // cont-003: Paragraph length
      if (paragraphs.length > 0) {
        const avgParaWords = paragraphs.reduce((sum, p) => sum + p.textContent.split(/\s+/).length, 0) / paragraphs.length;
        autoFill('cont-003', avgParaWords <= 80 ? 'good' : avgParaWords <= 150 ? 'ok' : 'bad',
          `Gemiddelde alinea: ~${Math.round(avgParaWords)} woorden (${paragraphs.length} alinea's) ${avgParaWords > 80 ? '— korter is beter voor online' : ''}`);
        filled++;
      }
    }
  } catch(e) {}

  // ── cont-009: Word count meets requirements ──
  try {
    const bodyText = (doc.body?.innerText || doc.body?.textContent || '').trim();
    const wordCount = bodyText.split(/\s+/).filter(w => w.length > 0).length;
    autoFill('cont-009', wordCount >= 300 ? 'good' : wordCount >= 150 ? 'ok' : 'bad',
      `Woordenaantal: ${wordCount} ${wordCount < 300 ? '(aanbevolen min. 300 voor SEO)' : '(voldoende)'}`);
    filled++;
  } catch(e) {}

  // ── cont-024: Last modified date ──
  try {
    const lastMod = doc.querySelector('meta[name="last-modified"], meta[http-equiv="last-modified"], time[datetime]');
    if (lastMod) {
      const date = lastMod.getAttribute('content') || lastMod.getAttribute('datetime') || '';
      autoFill('cont-024', 'ok', `Laatst bijgewerkt: ${date}`);
    } else {
      autoFill('cont-024', 'ok', 'Geen last-modified meta tag of time element gevonden');
    }
    filled++;
  } catch(e) {}

  // ── cont-030: Proper heading structure for content ──
  try {
    const headings = doc.querySelectorAll('h1,h2,h3,h4,h5,h6');
    const paragraphs = doc.querySelectorAll('p');
    if (paragraphs.length > 3) {
      const ratio = headings.length / paragraphs.length;
      autoFill('cont-030', headings.length >= 3 && ratio >= 0.1 ? 'good' :
        headings.length >= 1 ? 'ok' : 'bad',
        `${headings.length} headings voor ${paragraphs.length} alinea's ${ratio < 0.1 ? '— meer subkoppen toevoegen' : '— goed gestructureerd'}`);
      filled++;
    }
  } catch(e) {}

  // ══════════════════════════════════════════════════════════════
  // BRAND (brand-*)
  // ══════════════════════════════════════════════════════════════

  // ── brand-001: Logo present ──
  try {
    const logo = doc.querySelector(
      'img[class*="logo" i], img[id*="logo" i], img[alt*="logo" i], ' +
      'a[class*="logo" i] img, .logo img, #logo img, ' +
      'svg[class*="logo" i], header img:first-of-type, ' +
      '[class*="brand" i] img, a[aria-label*="logo" i]'
    );
    autoFill('brand-001', logo ? 'good' : 'ok',
      logo ? 'Logo gedetecteerd op de pagina' : 'Geen duidelijk logo-element gevonden (controleer handmatig)');
    filled++;
  } catch(e) {}

  // ── brand-009: Max 3 font families ──
  if (canCSS) {
    try {
      const allElements = doc.querySelectorAll('body, body *');
      const fonts = new Set();
      allElements.forEach(el => {
        try {
          const ff = doc.defaultView.getComputedStyle(el).fontFamily;
          if (ff) {
            const primary = ff.split(',')[0].trim().replace(/['"]/g, '');
            if (primary && !['inherit', 'initial', 'unset'].includes(primary)) fonts.add(primary);
          }
        } catch(e) {}
      });
      autoFill('brand-009', fonts.size <= 3 ? 'good' : fonts.size <= 5 ? 'ok' : 'bad',
        `${fonts.size} font families: ${Array.from(fonts).slice(0, 5).join(', ')}${fonts.size > 5 ? '…' : ''} ${fonts.size > 3 ? '(max 3 aanbevolen)' : ''}`);
      filled++;
    } catch(e) {}
  }

  // ══════════════════════════════════════════════════════════════
  // SECURITY extras (sec-*)
  // ══════════════════════════════════════════════════════════════

  // ── sec-007: X-Frame-Options ──
  try {
    const xfo = doc.querySelector('meta[http-equiv="X-Frame-Options"]');
    autoFill('sec-007', xfo ? 'good' : 'ok',
      xfo ? `X-Frame-Options via meta: ${xfo.getAttribute('content')}` :
      'Geen X-Frame-Options meta tag (kan via server headers ingesteld zijn)');
    filled++;
  } catch(e) {}

  // ── sec-008: X-Content-Type-Options ──
  try {
    const xcto = doc.querySelector('meta[http-equiv="X-Content-Type-Options"]');
    autoFill('sec-008', xcto ? 'good' : 'ok',
      xcto ? `X-Content-Type-Options: ${xcto.getAttribute('content')}` :
      'Geen X-Content-Type-Options meta (kan via server headers)');
    filled++;
  } catch(e) {}

  // ── sec-010: Permissions-Policy ──
  try {
    const pp = doc.querySelector('meta[http-equiv="Permissions-Policy"], meta[http-equiv="Feature-Policy"]');
    autoFill('sec-010', pp ? 'good' : 'ok',
      pp ? 'Permissions-Policy meta tag aanwezig' :
      'Geen Permissions-Policy meta tag (kan via server headers)');
    filled++;
  } catch(e) {}

  // ── sec-011: HSTS header ──
  try {
    const hsts = doc.querySelector('meta[http-equiv="Strict-Transport-Security"]');
    autoFill('sec-011', hsts ? 'good' : 'ok',
      hsts ? `HSTS via meta: ${hsts.getAttribute('content')}` :
      'Geen HSTS meta tag (wordt normaal via server header ingesteld)');
    filled++;
  } catch(e) {}

  // ── sec-012: X-XSS-Protection ──
  try {
    const xxss = doc.querySelector('meta[http-equiv="X-XSS-Protection"]');
    autoFill('sec-012', xxss ? 'good' : 'ok',
      xxss ? `X-XSS-Protection: ${xxss.getAttribute('content')}` :
      'Geen X-XSS-Protection meta (verouderd, CSP is beter)');
    filled++;
  } catch(e) {}

  // ── sec-014: Vulnerable JS libraries (check known old versions) ──
  try {
    const scripts = Array.from(doc.querySelectorAll('script[src]'));
    const vulnPatterns = [
      { pattern: /jquery[.-]1\./i, lib: 'jQuery 1.x' },
      { pattern: /jquery[.-]2\./i, lib: 'jQuery 2.x' },
      { pattern: /angular[.-]1\.[0-5]/i, lib: 'AngularJS 1.x (oud)' },
      { pattern: /bootstrap[.-][23]\./i, lib: 'Bootstrap 2/3 (oud)' },
      { pattern: /moment[.-]2\.[0-9]\./i, lib: 'Moment.js (oud)' },
    ];
    const found = [];
    scripts.forEach(s => {
      const src = s.getAttribute('src') || '';
      vulnPatterns.forEach(v => { if (v.pattern.test(src)) found.push(v.lib); });
    });
    autoFill('sec-014', found.length === 0 ? 'good' : 'bad',
      found.length === 0 ? 'Geen bekende verouderde JS bibliotheken gedetecteerd' :
      `Verouderde bibliotheken: ${found.join(', ')} — update naar nieuwste versie`);
    filled++;
  } catch(e) {}

  // ── sec-015: Google Safe Browsing (can only infer) ──
  try {
    autoFill('sec-015', 'ok', 'Google Safe Browsing status kan niet automatisch gecontroleerd worden — check via Google Search Console');
    filled++;
  } catch(e) {}

  // ══════════════════════════════════════════════════════════════
  // PERFORMANCE DOM checks (perf-*)
  // ══════════════════════════════════════════════════════════════

  // ── perf-016: DOM size ──
  try {
    const allElements = doc.querySelectorAll('*').length;
    autoFill('perf-016', allElements < 1500 ? 'good' : allElements < 3000 ? 'ok' : 'bad',
      `DOM grootte: ${allElements} elementen ${allElements >= 1500 ? '(streef naar <1500)' : '(goed)'}`);
    filled++;
  } catch(e) {}

  // ── perf-019/020: Image optimization + modern formats ──
  try {
    const imgs = Array.from(doc.querySelectorAll('img[src]'));
    if (imgs.length > 0) {
      const formats = {};
      imgs.forEach(img => {
        const src = (img.getAttribute('src') || '').toLowerCase();
        const ext = src.split('.').pop().split('?')[0];
        formats[ext] = (formats[ext] || 0) + 1;
      });
      const modernCount = (formats['webp'] || 0) + (formats['avif'] || 0);
      const oldCount = (formats['jpg'] || 0) + (formats['jpeg'] || 0) + (formats['png'] || 0) + (formats['gif'] || 0);
      const formatList = Object.entries(formats).map(([k,v]) => `${v}× .${k}`).join(', ');
      autoFill('perf-019', oldCount === 0 || modernCount > 0 ? 'good' : 'ok',
        `Afbeeldingsformaten: ${formatList} ${oldCount > 0 && modernCount === 0 ? '— gebruik WebP/AVIF' : ''}`);
      autoFill('perf-020', modernCount > 0 ? 'good' : 'bad',
        modernCount > 0 ? `${modernCount} afbeeldingen in modern formaat (WebP/AVIF)` :
        'Geen moderne afbeeldingsformaten (WebP/AVIF) — comprimeer 25-50% beter');
      filled += 2;
    }
  } catch(e) {}

  // ── perf-025: Font display strategy ──
  try {
    const fontFaces = Array.from(doc.querySelectorAll('style')).map(s => s.textContent || '').join(' ');
    const linkFonts = Array.from(doc.querySelectorAll('link[href*="fonts"]'));
    const hasFontDisplay = fontFaces.includes('font-display');
    const hasSwap = fontFaces.includes('font-display: swap') || fontFaces.includes('font-display:swap');
    const googleFonts = linkFonts.filter(l => (l.getAttribute('href') || '').includes('fonts.googleapis.com'));
    const gfWithDisplay = googleFonts.filter(l => (l.getAttribute('href') || '').includes('display=swap'));
    if (googleFonts.length > 0 || hasFontDisplay) {
      autoFill('perf-025', (hasSwap || gfWithDisplay.length === googleFonts.length) ? 'good' : 'ok',
        (hasSwap || gfWithDisplay.length > 0) ? 'font-display: swap geconfigureerd' :
        'Font-display strategie niet optimaal — voeg display=swap toe');
      filled++;
    }
  } catch(e) {}

  // ── perf-026: Preload hints ──
  try {
    const preloads = doc.querySelectorAll('link[rel="preload"]');
    autoFill('perf-026', preloads.length > 0 ? 'good' : 'ok',
      preloads.length > 0 ? `${preloads.length} preload hints gevonden (kritieke resources)` :
      'Geen preload hints — overweeg kritieke fonts/scripts te preloaden');
    filled++;
  } catch(e) {}

  // ── perf-027: Preconnect hints ──
  try {
    const preconnects = doc.querySelectorAll('link[rel="preconnect"], link[rel="dns-prefetch"]');
    autoFill('perf-027', preconnects.length > 0 ? 'good' : 'ok',
      preconnects.length > 0 ? `${preconnects.length} preconnect/dns-prefetch hints` :
      'Geen preconnect hints — voeg toe voor externe domeinen');
    filled++;
  } catch(e) {}

  // ── perf-028: Lazy loading on images ──
  try {
    const imgs = Array.from(doc.querySelectorAll('img'));
    if (imgs.length > 3) {
      const lazyImgs = imgs.filter(img => img.getAttribute('loading') === 'lazy' || img.getAttribute('data-src') || img.classList.contains('lazyload'));
      autoFill('perf-028', lazyImgs.length > 0 ? 'good' : 'bad',
        lazyImgs.length > 0 ? `${lazyImgs.length} van ${imgs.length} afbeeldingen hebben lazy loading` :
        `${imgs.length} afbeeldingen zonder lazy loading — voeg loading="lazy" toe`);
      filled++;
    }
  } catch(e) {}

  // ── perf-011: Render-blocking resources ──
  try {
    const blockingCSS = Array.from(doc.querySelectorAll('link[rel="stylesheet"]')).filter(l => !l.getAttribute('media') || l.getAttribute('media') === 'all');
    const blockingJS = Array.from(doc.querySelectorAll('script[src]')).filter(s => !s.hasAttribute('async') && !s.hasAttribute('defer') && !s.getAttribute('type')?.includes('module'));
    const headBlockingJS = blockingJS.filter(s => s.closest('head'));
    autoFill('perf-011', headBlockingJS.length === 0 ? 'good' : headBlockingJS.length <= 3 ? 'ok' : 'bad',
      `${blockingCSS.length} CSS + ${headBlockingJS.length} render-blocking JS in <head> ${headBlockingJS.length > 0 ? '— voeg async/defer toe' : ''}`);
    filled++;
  } catch(e) {}

  // ── perf-023: CSS minified (check inline styles size) ──
  try {
    const styles = Array.from(doc.querySelectorAll('style'));
    if (styles.length > 0) {
      const totalCSS = styles.reduce((sum, s) => sum + (s.textContent || '').length, 0);
      const hasNewlines = styles.some(s => (s.textContent || '').split('\n').length > 10);
      autoFill('perf-023', !hasNewlines ? 'good' : 'ok',
        !hasNewlines ? `Inline CSS lijkt geminified (${(totalCSS/1024).toFixed(1)}KB)` :
        `Inline CSS niet geminified (${(totalCSS/1024).toFixed(1)}KB, ${styles.length} blokken)`);
      filled++;
    }
  } catch(e) {}

  // ── perf-024: JavaScript minified ──
  try {
    const inlineScripts = Array.from(doc.querySelectorAll('script:not([src])')).filter(s => (s.textContent || '').length > 200);
    if (inlineScripts.length > 0) {
      const totalJS = inlineScripts.reduce((sum, s) => sum + (s.textContent || '').length, 0);
      const hasComments = inlineScripts.some(s => (s.textContent || '').includes('//') || (s.textContent || '').includes('/*'));
      autoFill('perf-024', !hasComments ? 'good' : 'ok',
        !hasComments ? `Inline JS lijkt geminified (${(totalJS/1024).toFixed(1)}KB)` :
        `Inline JS bevat comments — niet volledig geminified (${(totalJS/1024).toFixed(1)}KB)`);
      filled++;
    }
  } catch(e) {}

  // ══════════════════════════════════════════════════════════════
  // MOBILE extras (mob-*)
  // ══════════════════════════════════════════════════════════════

  // ── mob-006: Content properly sized to viewport ──
  try {
    const viewport = doc.querySelector('meta[name="viewport"]');
    if (viewport) {
      const content = viewport.getAttribute('content') || '';
      const hasWidth = content.includes('width=device-width');
      const hasInitScale = content.includes('initial-scale=1');
      autoFill('mob-006', hasWidth && hasInitScale ? 'good' : hasWidth ? 'ok' : 'bad',
        `Viewport: ${content.substring(0, 60)} ${!hasWidth ? '— width=device-width ontbreekt' : ''}`);
    } else {
      autoFill('mob-006', 'bad', 'Geen viewport meta — content past zich niet aan schermgrootte aan');
    }
    filled++;
  } catch(e) {}

  // ── mob-007: No horizontal scrolling (check for fixed-width elements) ──
  try {
    const fixedWidth = doc.querySelectorAll('[style*="width:"][style*="px"]');
    const tables = doc.querySelectorAll('table:not([class*="responsive"])');
    const issues = [];
    if (fixedWidth.length > 3) issues.push(`${fixedWidth.length} elementen met vaste pixel-breedte`);
    if (tables.length > 0) issues.push(`${tables.length} tabellen (mogelijk niet responsive)`);
    autoFill('mob-007', issues.length === 0 ? 'good' : 'ok',
      issues.length === 0 ? 'Geen duidelijke oorzaken voor horizontaal scrollen' :
      `Mogelijke problemen: ${issues.join(', ')}`);
    filled++;
  } catch(e) {}

  // ── mob-011: Touch target spacing (limited DOM check) ──
  try {
    const clickables = doc.querySelectorAll('a, button, input, select, textarea, [role="button"]');
    autoFill('mob-011', 'ok', `${clickables.length} interactieve elementen — controleer spacing visueel (min. 8px tussen targets)`);
    filled++;
  } catch(e) {}

  // ── mob-021: Critical CSS inlined ──
  try {
    const inlineStyles = doc.querySelectorAll('head style');
    const externalCSS = doc.querySelectorAll('link[rel="stylesheet"]');
    autoFill('mob-021', inlineStyles.length > 0 ? 'good' : externalCSS.length <= 2 ? 'ok' : 'bad',
      inlineStyles.length > 0 ? `${inlineStyles.length} inline style blokken (critical CSS)` :
      `${externalCSS.length} externe stylesheets zonder inline critical CSS`);
    filled++;
  } catch(e) {}

  // ══════════════════════════════════════════════════════════════
  // TSEO crawlability checks (tseo-001 through tseo-011) — fetch-based
  // These need separate fetches for robots.txt and sitemap
  // ══════════════════════════════════════════════════════════════
  try {
    const origin = new URL(url).origin;

    // tseo-001/002/005: robots.txt
    try {
      const workerProxy = typeof getAiProxyUrl === 'function' ? getAiProxyUrl() : '';
      let robotsTxt = '';
      if (workerProxy) {
        const proxyBase = workerProxy.replace(/\/$/, '');
        const rResp = await fetch(`${proxyBase}/fetch?url=${encodeURIComponent(origin + '/robots.txt')}`);
        if (rResp.ok) robotsTxt = await rResp.text();
      }
      if (robotsTxt && robotsTxt.toLowerCase().includes('user-agent')) {
        autoFill('tseo-001', 'good', 'robots.txt gevonden en toegankelijk');
        filled++;
        const blocksImportant = robotsTxt.toLowerCase().includes('disallow: /');
        autoFill('tseo-002', !blocksImportant ? 'good' : 'ok',
          !blocksImportant ? 'robots.txt blokkeert geen belangrijke paden' :
          'robots.txt bevat Disallow regels — controleer dat belangrijke pagina\'s niet geblokkeerd worden');
        filled++;
        const hasSitemap = robotsTxt.toLowerCase().includes('sitemap:');
        autoFill('tseo-005', hasSitemap ? 'good' : 'bad',
          hasSitemap ? 'Sitemap vermeldt in robots.txt' : 'Geen sitemap referentie in robots.txt');
        filled++;
      } else {
        autoFill('tseo-001', 'bad', 'Geen robots.txt gevonden of niet toegankelijk');
        autoFill('tseo-002', 'ok', 'Kan niet controleren — geen robots.txt');
        autoFill('tseo-005', 'bad', 'Geen robots.txt met sitemap referentie');
        filled += 3;
      }
    } catch(e) {
      autoFill('tseo-001', 'ok', 'robots.txt kon niet gecontroleerd worden');
      autoFill('tseo-002', 'ok', 'robots.txt kon niet gecontroleerd worden');
      autoFill('tseo-005', 'ok', 'robots.txt kon niet gecontroleerd worden');
      filled += 3;
    }

    // tseo-003/004: XML sitemap
    try {
      const workerProxy = typeof getAiProxyUrl === 'function' ? getAiProxyUrl() : '';
      let sitemapContent = '';
      if (workerProxy) {
        const proxyBase = workerProxy.replace(/\/$/, '');
        const sResp = await fetch(`${proxyBase}/fetch?url=${encodeURIComponent(origin + '/sitemap.xml')}`);
        if (sResp.ok) sitemapContent = await sResp.text();
      }
      if (sitemapContent && (sitemapContent.includes('<urlset') || sitemapContent.includes('<sitemapindex'))) {
        autoFill('tseo-003', 'good', 'XML sitemap gevonden');
        filled++;
        const urlCount = (sitemapContent.match(/<loc>/g) || []).length;
        autoFill('tseo-004', urlCount > 0 ? 'good' : 'ok',
          `Sitemap bevat ${urlCount} URLs ${urlCount === 0 ? '— lijkt leeg' : ''}`);
        filled++;
        // tseo-006: Coverage
        autoFill('tseo-006', urlCount >= 5 ? 'good' : 'ok',
          `Sitemap heeft ${urlCount} URLs — controleer of alle belangrijke pagina's zijn opgenomen`);
        filled++;
      } else {
        autoFill('tseo-003', 'bad', 'Geen XML sitemap gevonden op /sitemap.xml');
        autoFill('tseo-004', 'bad', 'Geen sitemap om te valideren');
        autoFill('tseo-006', 'bad', 'Geen sitemap');
        filled += 3;
      }
    } catch(e) {
      autoFill('tseo-003', 'ok', 'Sitemap kon niet gecontroleerd worden');
      autoFill('tseo-004', 'ok', 'Sitemap kon niet gecontroleerd worden');
      autoFill('tseo-006', 'ok', 'Sitemap kon niet gecontroleerd worden');
      filled += 3;
    }
  } catch(e) {}

  // ── tseo-007: No 5xx server errors (if page loaded, no 5xx) ──
  try {
    autoFill('tseo-007', 'good', 'Pagina laadde succesvol — geen server errors');
    filled++;
  } catch(e) {}

  // ── tseo-008: Page renders without JS errors (limited check) ──
  try {
    const noscript = doc.querySelectorAll('noscript');
    autoFill('tseo-008', 'ok', `Pagina geladen ${noscript.length > 0 ? '— bevat noscript fallback' : '— JS errors niet detecteerbaar via DOM scan'}`);
    filled++;
  } catch(e) {}

  // ── tseo-009: Crawl depth (infer from breadcrumbs) ──
  try {
    const breadcrumbs = doc.querySelectorAll('[class*="breadcrumb"] li, [class*="breadcrumb"] a, nav[aria-label*="breadcrumb" i] a');
    if (breadcrumbs.length > 0) {
      autoFill('tseo-009', breadcrumbs.length <= 4 ? 'good' : 'ok',
        `Kruimelpad diepte: ${breadcrumbs.length} niveaus ${breadcrumbs.length > 4 ? '(streef naar max 3 klikken)' : ''}`);
    } else {
      autoFill('tseo-009', 'ok', 'Geen breadcrumbs — crawl depth niet te bepalen');
    }
    filled++;
  } catch(e) {}

  // ── tseo-010: Orphan pages (limited check) ──
  try {
    const internalLinks = Array.from(doc.querySelectorAll('a[href]')).filter(a => {
      const href = a.getAttribute('href') || '';
      return href.startsWith('/') || href.startsWith(new URL(url).origin);
    });
    autoFill('tseo-010', internalLinks.length >= 5 ? 'good' : internalLinks.length >= 1 ? 'ok' : 'bad',
      `${internalLinks.length} interne links — ${internalLinks.length < 5 ? 'weinig interne links, risico op orphan pages' : 'goed verbonden'}`);
    filled++;
  } catch(e) {}

  // ── tseo-011: Server response (if loaded = acceptable) ──
  try {
    autoFill('tseo-011', 'ok', 'Server response tijd niet meetbaar via DOM scan — gebruik Chrome DevTools of PSI');
    filled++;
  } catch(e) {}

  // ── tseo-025/026/027: Duplicate content checks (single page) ──
  try {
    autoFill('tseo-025', 'ok', 'Duplicate content kan alleen over meerdere pagina\'s gecontroleerd worden');
    autoFill('tseo-026', 'ok', 'Duplicate titles vereist crawl van meerdere pagina\'s');
    autoFill('tseo-027', 'ok', 'Duplicate descriptions vereist crawl van meerdere pagina\'s');
    filled += 3;
  } catch(e) {}

  // ── tseo-042/043/044: Redirects (can't fully check from DOM) ──
  try {
    autoFill('tseo-042', 'ok', 'Redirect chains niet detecteerbaar via DOM scan — controleer via server logs');
    autoFill('tseo-043', 'ok', 'Redirect loops niet detecteerbaar via DOM scan');
    autoFill('tseo-044', 'ok', '301 redirects niet detecteerbaar via DOM scan');
    filled += 3;
  } catch(e) {}

  // ── tseo-049/050/051/053: Links checks ──
  try {
    const links = Array.from(doc.querySelectorAll('a[href]'));
    const emptyLinks = links.filter(a => {
      const href = (a.getAttribute('href') || '').trim();
      return href === '' || href === '#' || href === 'javascript:void(0)' || href === 'javascript:;';
    });
    if (links.length > 0) {
      autoFill('tseo-049', emptyLinks.length === 0 ? 'good' : 'ok',
        emptyLinks.length === 0 ? `${links.length} interne links, geen lege hrefs` :
        `${emptyLinks.length} links met lege/placeholder hrefs — potentieel broken`);
      filled++;
    }
    // tseo-050: Broken external links (needs crawl, DOM limited)
    const hostname = new URL(url).hostname;
    const extLinks = links.filter(a => { try { return new URL(a.getAttribute('href') || '', url).hostname !== hostname; } catch(e) { return false; } });
    autoFill('tseo-050', 'ok', `${extLinks.length} externe links gevonden — broken link check vereist crawl, controleer handmatig of via tool`);
    filled++;
    // tseo-051: Broken image links
    const imgSrcs = Array.from(doc.querySelectorAll('img[src]'));
    const emptyImgs = imgSrcs.filter(img => { const s = (img.getAttribute('src') || '').trim(); return !s || s === '#'; });
    autoFill('tseo-051', emptyImgs.length === 0 ? 'good' : 'bad',
      emptyImgs.length === 0 ? `${imgSrcs.length} afbeeldingen met geldige src` :
      `${emptyImgs.length} afbeeldingen met lege/ongeldige src`);
    filled++;
    // tseo-053: Links to redirected pages (can't detect from DOM)
    autoFill('tseo-053', 'ok', 'Redirect-links niet detecteerbaar via DOM scan — gebruik redirectchecker.com of Screaming Frog');
    filled++;
  } catch(e) {}

  // ── tseo-052: Link consistency ──
  try {
    const links = Array.from(doc.querySelectorAll('a[href]'));
    const absolute = links.filter(a => (a.getAttribute('href') || '').startsWith('http')).length;
    const relative = links.filter(a => (a.getAttribute('href') || '').startsWith('/')).length;
    if (links.length > 0) {
      autoFill('tseo-052', 'ok',
        `${absolute} absolute links, ${relative} relatieve links — ${Math.abs(absolute - relative) > links.length * 0.5 ? 'overwegend consistent' : 'mix van stijlen'}`);
      filled++;
    }
  } catch(e) {}

  // ═══════════════ QUICK-SCAN TEMPLATE AUTO-CHECKS ═══════════════
  const project = getActiveProject ? getActiveProject() : null;
  const tpl = project?.selectedTemplate;
  if (tpl) {
    try { filled += runQuickScanAutoChecks(doc, tpl, autoFill); } catch(e) { console.warn('[QS AutoCheck]', e); }
  }

  return filled;
}

// ═══════════════ NON-TECH AUTO-SCAN (Storytelling, Content, Persuasion, IA, E-E-A-T) ═══════════════

// ── Helper: syllable counter (vereenvoudigd, werkt voor NL en EN) ──
function countSyllables(word) {
  word = word.toLowerCase().replace(/[^a-zàáâãäåèéêëìíîïòóôõöùúûüý]/g, '');
  if (word.length <= 3) return 1;
  word = word.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/, '');
  word = word.replace(/^y/, '');
  const matches = word.match(/[aeiouy]{1,2}/g);
  return matches ? Math.max(matches.length, 1) : 1;
}

async function runNonTechAutoChecks(doc, canCSS, autoFill, template) {
  let filled = 0;

  // Haal alle zichtbare tekst op
  const bodyText = (doc.body?.innerText || '').trim();
  const allText = bodyText;
  const words = allText.split(/\s+/).filter(w => w.length > 0);
  const sentences = allText.split(/[.!?]+/).filter(s => s.trim().length > 5);
  const paragraphs = Array.from(doc.querySelectorAll('p')).map(p => p.innerText.trim()).filter(t => t.length > 10);

  // ═══════════════════════════════════════════
  // STORYTELLING CHECKS (auto)
  // ═══════════════════════════════════════════
  if (['qs-storytelling', 'qs-content', null].includes(template)) {

    // st-you-vs-we: Ratio jij/je/u vs wij/ons
    try {
      const youWords = (allText.match(/\b(jij|je|jouw|u|uw|you|your|yours)\b/gi) || []).length;
      const weWords = (allText.match(/\b(wij|we|ons|onze|our|us)\b/gi) || []).length;
      const ratio = weWords > 0 ? (youWords / weWords).toFixed(1) : youWords > 0 ? '∞' : '0';
      autoFill('st-you-vs-we',
        youWords >= weWords * 2 ? 'good' : youWords >= weWords ? 'ok' : 'bad',
        `"Jij/je/u": ${youWords}x | "Wij/ons": ${weWords}x | Ratio: ${ratio}:1. ${youWords < weWords ? 'De pagina praat meer over zichzelf dan over de bezoeker.' : ''}`
      ); filled++;
    } catch(e) {}

    // st-headline-length: H1 lengte 5-12 woorden
    try {
      const h1 = doc.querySelector('h1');
      if (h1) {
        const h1Words = h1.innerText.trim().split(/\s+/).length;
        autoFill('st-headline-length',
          h1Words >= 5 && h1Words <= 12 ? 'good' : h1Words >= 3 && h1Words <= 15 ? 'ok' : 'bad',
          `H1: "${h1.innerText.trim().substring(0, 80)}" — ${h1Words} woorden. ${h1Words < 5 ? 'Te kort, mist context.' : h1Words > 12 ? 'Te lang, moeilijk scanbaar.' : 'Goede lengte.'}`
        ); filled++;
      }
    } catch(e) {}

    // st-single-cta: Tel prominente CTA's in eerste viewport
    try {
      const allBtns = Array.from(doc.querySelectorAll('a, button, [role="button"], input[type="submit"]'));
      const ctaBtns = allBtns.filter(el => {
        const text = (el.innerText || el.value || '').toLowerCase().trim();
        const isProminent = el.tagName === 'BUTTON' || el.classList.toString().includes('btn') || el.classList.toString().includes('cta') || el.getAttribute('role') === 'button';
        const isCtaText = text.length > 2 && text.length < 40 && !['menu', 'zoeken', 'search', 'logo', 'home'].some(w => text.includes(w));
        return isProminent && isCtaText;
      });
      const aboveFold = ctaBtns.filter(el => {
        const rect = el.getBoundingClientRect ? el.getBoundingClientRect() : null;
        return rect ? rect.top < 800 : true;
      });
      autoFill('st-single-cta',
        aboveFold.length === 1 ? 'good' : aboveFold.length === 2 ? 'ok' : 'bad',
        `${aboveFold.length} prominente CTA('s) boven de fold gevonden. ${aboveFold.length > 2 ? 'Te veel concurrerende acties — kies 1 primaire CTA.' : aboveFold.length === 0 ? 'Geen CTA boven de fold!' : ''}`
      ); filled++;
    } catch(e) {}

    // st-heading-hierarchy: H1 > H2 > H3 grootte
    if (canCSS) {
      try {
        const h1 = doc.querySelector('h1');
        const h2 = doc.querySelector('h2');
        const h3 = doc.querySelector('h3');
        if (h1 && h2) {
          const h1Size = parseFloat(doc.defaultView.getComputedStyle(h1).fontSize);
          const h2Size = parseFloat(doc.defaultView.getComputedStyle(h2).fontSize);
          const h3Size = h3 ? parseFloat(doc.defaultView.getComputedStyle(h3).fontSize) : 0;
          const h1Bigger = h1Size > h2Size * 1.15;
          const h2Bigger = h3Size === 0 || h2Size > h3Size * 1.1;
          autoFill('st-heading-hierarchy',
            h1Bigger && h2Bigger ? 'good' : h1Bigger || h2Bigger ? 'ok' : 'bad',
            `H1: ${h1Size}px, H2: ${h2Size}px${h3 ? ', H3: ' + h3Size + 'px' : ''}. ${!h1Bigger ? 'H1 is niet duidelijk groter dan H2.' : ''}`
          ); filled++;
        }
      } catch(e) {}
    }
  }

  // ═══════════════════════════════════════════
  // CONTENT QUALITY CHECKS (auto)
  // ═══════════════════════════════════════════
  if (['qs-content', 'qs-storytelling', null].includes(template)) {

    // cq-readability: Flesch Reading Ease (vereenvoudigd)
    try {
      if (words.length > 50) {
        const avgSentLen = words.length / Math.max(sentences.length, 1);
        const syllables = words.reduce((sum, w) => sum + countSyllables(w), 0);
        const avgSylPerWord = syllables / words.length;
        const flesch = 206.835 - (1.015 * avgSentLen) - (84.6 * avgSylPerWord);
        const fleschRound = Math.round(flesch);
        autoFill('cq-readability',
          fleschRound >= 60 ? 'good' : fleschRound >= 40 ? 'ok' : 'bad',
          `Flesch Reading Ease: ${fleschRound}/100. ${fleschRound >= 60 ? 'Goed leesbaar.' : fleschRound >= 40 ? 'Redelijk, maar kan eenvoudiger.' : 'Te moeilijk — vereenvoudig zinnen en woordkeuze.'} (${words.length} woorden, ${sentences.length} zinnen)`
        ); filled++;
      }
    } catch(e) {}

    // cq-sentence-length
    try {
      if (sentences.length > 5) {
        const avgLen = Math.round(words.length / sentences.length);
        autoFill('cq-sentence-length',
          avgLen <= 15 ? 'good' : avgLen <= 20 ? 'ok' : 'bad',
          `Gemiddelde zinslengte: ${avgLen} woorden. ${avgLen > 20 ? 'Te lang — splits zinnen op. Optimaal is 10-15 woorden.' : 'Prima.'}`
        ); filled++;
      }
    } catch(e) {}

    // cq-paragraph-length
    try {
      if (paragraphs.length > 3) {
        const longParas = paragraphs.filter(p => p.split(/\s+/).length > 100);
        autoFill('cq-paragraph-length',
          longParas.length === 0 ? 'good' : longParas.length <= 2 ? 'ok' : 'bad',
          `${longParas.length} van ${paragraphs.length} paragrafen zijn langer dan 100 woorden. ${longParas.length > 0 ? 'Splits ze op voor betere scanbaarheid.' : 'Alle paragrafen zijn lekker kort.'}`
        ); filled++;
      }
    } catch(e) {}

    // cq-text-walls: Subheading elke 300 woorden
    try {
      const headings = Array.from(doc.querySelectorAll('h1,h2,h3,h4,h5,h6'));
      if (words.length > 300 && headings.length > 0) {
        const ratio = Math.round(words.length / headings.length);
        autoFill('cq-text-walls',
          ratio <= 300 ? 'good' : ratio <= 500 ? 'ok' : 'bad',
          `${headings.length} headings voor ${words.length} woorden (1 heading per ~${ratio} woorden). ${ratio > 300 ? 'Voeg meer subheadings toe — maximaal 300 woorden per sectie.' : ''}`
        ); filled++;
      }
    } catch(e) {}

    // cq-passive-voice (vereenvoudigd NL)
    try {
      if (sentences.length > 5) {
        const passivePatterns = /\b(wordt|worden|werd|werden|is|was|zijn|waren)\s+\w*(ge\w+d|ge\w+en|ge\w+t)\b/gi;
        const passiveCount = (allText.match(passivePatterns) || []).length;
        const passivePct = Math.round((passiveCount / sentences.length) * 100);
        autoFill('cq-passive-voice',
          passivePct <= 10 ? 'good' : passivePct <= 20 ? 'ok' : 'bad',
          `~${passivePct}% passieve constructies (${passiveCount} van ${sentences.length} zinnen). ${passivePct > 15 ? 'Herschrijf passieve zinnen naar actief voor directere tekst.' : ''}`
        ); filled++;
      }
    } catch(e) {}

    // cq-cta-labels: Check op generieke button tekst
    try {
      const btns = Array.from(doc.querySelectorAll('button, input[type="submit"], [role="button"]'));
      const genericLabels = ['submit', 'verstuur', 'verzend', 'klik hier', 'click here', 'ok', 'go', 'send'];
      const genericBtns = btns.filter(b => {
        const text = (b.innerText || b.value || '').toLowerCase().trim();
        return genericLabels.some(g => text === g);
      });
      if (btns.length > 0) {
        autoFill('cq-cta-labels',
          genericBtns.length === 0 ? 'good' : genericBtns.length <= 1 ? 'ok' : 'bad',
          genericBtns.length === 0
            ? `Alle ${btns.length} knoppen hebben beschrijvende labels.`
            : `${genericBtns.length} knop(pen) met generieke labels: ${genericBtns.map(b => '"' + (b.innerText || b.value).trim() + '"').join(', ')}. Gebruik actie + waarde.`
        ); filled++;
      }
    } catch(e) {}

    // cq-generic-links: Check op "Klik hier", "Lees meer" links
    try {
      const links = Array.from(doc.querySelectorAll('a'));
      const genericTexts = ['klik hier', 'click here', 'lees meer', 'read more', 'meer info', 'learn more', 'hier'];
      const genericLinks = links.filter(a => {
        const text = (a.innerText || '').toLowerCase().trim();
        return genericTexts.includes(text);
      });
      if (links.length > 0) {
        autoFill('cq-generic-links',
          genericLinks.length === 0 ? 'good' : genericLinks.length <= 2 ? 'ok' : 'bad',
          genericLinks.length === 0
            ? 'Geen generieke linktekst gevonden.'
            : `${genericLinks.length} link(s) met generieke tekst: ${genericLinks.slice(0, 3).map(a => '"' + a.innerText.trim() + '"').join(', ')}. Gebruik beschrijvende link-tekst.`
        ); filled++;
      }
    } catch(e) {}
  }

  // ═══════════════════════════════════════════
  // PERSUASION & TRUST CHECKS (auto)
  // ═══════════════════════════════════════════
  if (['qs-persuasion', null].includes(template)) {

    // ps-social-proof: Zoek testimonials, reviews, logo's
    try {
      const testimonials = doc.querySelectorAll('[class*="testimonial"], [class*="review"], [class*="quote"], blockquote, [class*="klant"], [class*="customer"]');
      const logoBar = doc.querySelectorAll('[class*="logo"], [class*="client"], [class*="partner"], [class*="trusted"]');
      const ratings = doc.querySelectorAll('[class*="rating"], [class*="star"], [itemprop="reviewCount"], [itemprop="ratingValue"]');
      const types = [];
      if (testimonials.length > 0) types.push('testimonials');
      if (logoBar.length >= 3) types.push("logo's");
      if (ratings.length > 0) types.push('ratings/reviews');
      autoFill('ps-social-proof',
        types.length >= 2 ? 'good' : types.length === 1 ? 'ok' : 'bad',
        types.length >= 2
          ? `${types.length} soorten social proof gevonden: ${types.join(', ')}.`
          : types.length === 1
            ? `Slechts 1 type social proof: ${types[0]}. Voeg minimaal 1 extra type toe.`
            : "Geen social proof gevonden. Dit is kritiek — voeg testimonials, logo's, of reviews toe."
      ); filled++;
    } catch(e) {}

    // ps-trust-badges
    try {
      const badges = doc.querySelectorAll('[class*="trust"], [class*="secure"], [class*="badge"], [class*="seal"], [class*="keurmerk"], [class*="certificate"], [alt*="secure" i], [alt*="trust" i], [alt*="ssl" i], [alt*="norton" i]');
      autoFill('ps-trust-badges',
        badges.length >= 2 ? 'good' : badges.length === 1 ? 'ok' : 'bad',
        badges.length > 0
          ? `${badges.length} vertrouwenssignaal/signalen gevonden.`
          : 'Geen trust badges gevonden. Voeg beveiligings- of kwaliteitskeurmerken toe, vooral bij formulieren.'
      ); filled++;
    } catch(e) {}

    // ps-contact-findable
    try {
      const tel = doc.querySelector('a[href^="tel:"]');
      const mail = doc.querySelector('a[href^="mailto:"]');
      const contactLink = doc.querySelector('a[href*="contact"], a[href*="kontakt"]');
      const found = [tel && 'telefoon', mail && 'email', contactLink && 'contactpagina'].filter(Boolean);
      autoFill('ps-contact-findable',
        found.length >= 2 ? 'good' : found.length === 1 ? 'ok' : 'bad',
        found.length > 0
          ? `Contactmethodes gevonden: ${found.join(', ')}.`
          : 'Geen direct bereikbare contactinfo gevonden. Voeg telefoon, email, of contactpagina link toe.'
      ); filled++;
    } catch(e) {}
  }

  // ═══════════════════════════════════════════
  // INFORMATIE-ARCHITECTUUR CHECKS (auto)
  // ═══════════════════════════════════════════
  if (['qs-ia', null].includes(template)) {

    // ia-nav-items
    try {
      const nav = doc.querySelector('nav, [role="navigation"]');
      if (nav) {
        const topLinks = Array.from(nav.querySelectorAll(':scope > ul > li > a, :scope > a, :scope > ul > li')).length;
        const items = topLinks || Array.from(nav.querySelectorAll('a')).length;
        autoFill('ia-nav-items',
          items <= 7 ? 'good' : items <= 9 ? 'ok' : 'bad',
          `${items} navigatie-items gevonden. ${items > 7 ? "Meer dan 7 items verhoogt de cognitieve belasting (Hick's Law)." : 'Goed aantal.'}`
        ); filled++;
      }
    } catch(e) {}

    // ia-logo-home
    try {
      const logoLink = doc.querySelector('a[href="/"] img, a[href="/"] svg, header a:first-child img, [class*="logo"] a, a[class*="logo"]');
      const logoLinksHome = logoLink?.closest('a')?.getAttribute('href');
      autoFill('ia-logo-home',
        logoLinksHome === '/' || logoLinksHome === '/index.html' || logoLinksHome === '' ? 'good' : logoLink ? 'ok' : 'bad',
        logoLink
          ? `Logo gevonden, linkt naar "${logoLinksHome || '(geen href)'}". ${logoLinksHome !== '/' ? 'Zorg dat het logo linkt naar de homepage (/).' : ''}`
          : 'Geen klikbaar logo gevonden in de header.'
      ); filled++;
    } catch(e) {}

    // ia-breadcrumbs
    try {
      const breadcrumb = doc.querySelector('[class*="breadcrumb"], nav[aria-label*="breadcrumb" i], [itemtype*="BreadcrumbList"], ol[class*="bread"]');
      autoFill('ia-breadcrumbs',
        breadcrumb ? 'good' : 'bad',
        breadcrumb ? 'Breadcrumbs aanwezig.' : "Geen breadcrumbs gevonden. Voeg ze toe op pagina's dieper dan niveau 1."
      ); filled++;
    } catch(e) {}

    // ia-search
    try {
      const search = doc.querySelector('input[type="search"], [role="search"], input[name*="search"], input[name*="zoek"], input[placeholder*="zoek" i], input[placeholder*="search" i]');
      autoFill('ia-search',
        search ? 'good' : 'bad',
        search ? 'Zoekfunctie gevonden.' : 'Geen zoekfunctie gevonden. Zoek-gebruikers converteren 1.8x vaker.'
      ); filled++;
    } catch(e) {}
  }

  // ═══════════════════════════════════════════
  // E-E-A-T CHECKS (auto)
  // ═══════════════════════════════════════════
  if (['qs-eeat', null].includes(template)) {

    // ee-about-page
    try {
      const aboutLink = doc.querySelector('a[href*="about"], a[href*="over-ons"], a[href*="about-us"], a[href*="over"]');
      autoFill('ee-about-page',
        aboutLink ? 'good' : 'bad',
        aboutLink ? `Over ons-pagina gelinkt: "${aboutLink.getAttribute('href')}".` : 'Geen link naar een Over ons/About-pagina gevonden.'
      ); filled++;
    } catch(e) {}

    // ee-privacy-terms
    try {
      const privacy = doc.querySelector('a[href*="privacy"], a[href*="privacybeleid"]');
      const terms = doc.querySelector('a[href*="terms"], a[href*="voorwaarden"], a[href*="disclaimer"]');
      autoFill('ee-privacy-terms',
        privacy && terms ? 'good' : privacy || terms ? 'ok' : 'bad',
        [privacy && 'privacy policy', terms && 'algemene voorwaarden'].filter(Boolean).join(' + ') || 'Geen privacy policy of voorwaarden gevonden in de footer.'
      ); filled++;
    } catch(e) {}

    // ee-author-attribution
    try {
      const author = doc.querySelector('[class*="author"], [rel="author"], [itemprop="author"], [class*="auteur"], .byline, [class*="writer"]');
      autoFill('ee-author-attribution',
        author ? 'good' : 'bad',
        author ? 'Auteur-attributie gevonden.' : 'Geen auteur-attributie gevonden op de pagina.'
      ); filled++;
    } catch(e) {}
  }

  return filled;
}

// ═══════════════ MULTI-SIGNAL DETECTION HELPERS ═══════════════
function findAddToCart(doc) {
  const byClass = doc.querySelector('[class*="add-to-cart"], [class*="addtocart"], [class*="add_to_cart"], [class*="add-to-bag"]');
  if (byClass) return byClass;
  const byAria = doc.querySelector('[aria-label*="cart" i], [aria-label*="winkelwagen" i], [aria-label*="toevoegen" i], [aria-label*="add to" i]');
  if (byAria) return byAria;
  const buttons = Array.from(doc.querySelectorAll('button, [role="button"], input[type="submit"]'));
  const cartBtn = buttons.find(b => {
    const t = (b.textContent || b.value || '').toLowerCase().trim();
    return t.includes('in winkelmand') || t.includes('toevoegen') || t.includes('add to cart') || t.includes('add to bag') || t.includes('buy now') || t.includes('koop') || t.includes('bestel');
  });
  if (cartBtn) return cartBtn;
  const byForm = doc.querySelector('form[action*="cart"], form[action*="add"], form[action*="basket"]');
  return byForm ? (byForm.querySelector('button, input[type="submit"]') || byForm) : null;
}

function findNavigation(doc) {
  return doc.querySelector('nav, [role="navigation"], .navbar, .main-nav, .site-nav, header nav, .nav-menu, [class*="navigation"], [class*="main-menu"]');
}

function findSocialProof(doc) {
  const selectors = [
    '[class*="testimonial"]', '[class*="review"]', '[class*="rating"]',
    '[class*="klant"]', '[class*="customer"]', '[class*="trust"]',
    '[class*="social-proof"]', '[class*="client-logo"]', '[class*="partner"]',
    '[itemprop="reviewCount"]', '[class*="star-rating"]', '[class*="stars"]',
    'figure blockquote', '.testimonials', '#testimonials'
  ];
  return doc.querySelector(selectors.join(', '));
}

function findPricingTable(doc) {
  const selectors = [
    '[class*="pricing"]', '[class*="price-table"]', '[class*="plans"]',
    '[class*="tier"]', '[class*="package"]', '[class*="subscription"]',
    'table[class*="price"]', '.pricing-grid', '#pricing'
  ];
  return doc.querySelector(selectors.join(', '));
}

function findContactInfo(doc) {
  const tel = doc.querySelector('a[href^="tel:"], [itemprop="telephone"], [class*="phone-number"]');
  const email = doc.querySelector('a[href^="mailto:"], [itemprop="email"], [class*="email-address"]');
  const form = doc.querySelector('form[action*="contact"], form[class*="contact"], .contact-form, #contact-form');
  return { tel, email, form, count: (tel ? 1 : 0) + (email ? 1 : 0) + (form ? 1 : 0) };
}

function findReviews(doc) {
  const selectors = [
    '[class*="review"]', '[itemprop="reviewCount"]', '[itemprop="ratingValue"]',
    '[class*="star-rating"]', '[class*="stars"]', '[class*="rating"]',
    '.reviews', '#reviews', '[class*="testimonial"]'
  ];
  return doc.querySelector(selectors.join(', '));
}

function runQuickScanAutoChecks(doc, template, autoFill) {
  let f = 0;
  const allLinks = Array.from(doc.querySelectorAll('a'));
  const allBtns = Array.from(doc.querySelectorAll('button, [role="button"], input[type="submit"]'));
  const allForms = Array.from(doc.querySelectorAll('form'));
  const allImgs = Array.from(doc.querySelectorAll('img'));
  const allInputs = Array.from(doc.querySelectorAll('input, textarea, select'));
  const headings = Array.from(doc.querySelectorAll('h1,h2,h3,h4,h5,h6'));

  // ── LANDING PAGE auto-checks ──
  if (template === 'qs-landing') {
    // qs-lp-002: Single CTA focus
    const ctaBtns = allBtns.filter(b => {
      const t = (b.textContent || '').toLowerCase();
      return t.includes('start') || t.includes('probeer') || t.includes('aanmeld') || t.includes('sign up') || t.includes('get') || t.includes('download') || t.includes('try');
    });
    const outLinks = allLinks.filter(a => a.hostname && a.hostname !== location.hostname).length;
    if (ctaBtns.length === 1 && outLinks <= 2) {
      autoFill('qs-lp-002', 'good', `1 primaire CTA gevonden, ${outLinks} externe links`); f++;
    } else if (ctaBtns.length > 1) {
      autoFill('qs-lp-002', 'bad', `${ctaBtns.length} CTA-knoppen gevonden — focus op 1 primaire actie`); f++;
    }

    // qs-lp-003: Navigation removal (multi-signal detection)
    const nav = findNavigation(doc);
    const navLinks = nav ? nav.querySelectorAll('a').length : 0;
    if (!nav || navLinks <= 2) {
      autoFill('qs-lp-003', 'good', nav ? `Minimale navigatie (${navLinks} links)` : 'Geen navigatiemenu gevonden'); f++;
    } else {
      autoFill('qs-lp-003', 'bad', `Navigatiemenu aanwezig met ${navLinks} links — verwijderen kan conversie verdubbelen`); f++;
    }

    // qs-lp-009: Form field count
    const forms = allForms.filter(f => f.querySelectorAll('input:not([type="hidden"]):not([type="submit"])').length > 0);
    if (forms.length > 0) {
      const fields = forms[0].querySelectorAll('input:not([type="hidden"]):not([type="submit"]), textarea, select').length;
      autoFill('qs-lp-009', fields <= 4 ? 'good' : fields <= 6 ? 'ok' : 'bad',
        `${fields} formuliervelden gevonden (optimaal: ≤4 voor lead gen)`); f++;
    }

    // qs-lp-010: Social proof
    const socialProof = doc.querySelector('[class*="testimonial"], [class*="review"], [class*="trust"], [class*="logo-bar"], [class*="client"], [class*="partner"]');
    if (socialProof) {
      autoFill('qs-lp-010', 'good', 'Social proof elementen gevonden op pagina'); f++;
    } else {
      autoFill('qs-lp-010', 'bad', 'Geen social proof gevonden — toevoegen verhoogt conversie met 34%'); f++;
    }

    // qs-lp-018: Contact info
    const hasPhone = !!doc.querySelector('a[href^="tel:"]');
    const hasEmail = !!doc.querySelector('a[href^="mailto:"]');
    if (hasPhone || hasEmail) {
      autoFill('qs-lp-018', 'good', `Contactinfo aanwezig: ${hasPhone ? 'telefoon' : ''} ${hasEmail ? 'e-mail' : ''}`); f++;
    } else {
      autoFill('qs-lp-018', 'ok', 'Geen contactinfo zichtbaar — toevoegen verhoogt signups met 14.8%'); f++;
    }
  }

  // ── PRODUCT PAGE auto-checks ──
  if (template === 'qs-product') {
    // qs-pp-001: Add-to-cart button (multi-signal detection)
    const atc = findAddToCart(doc);
    if (atc) {
      autoFill('qs-pp-001', 'good', `Add-to-cart knop gevonden: "${(atc.textContent||'').trim().substring(0,30)}"`); f++;
    } else {
      autoFill('qs-pp-001', 'bad', 'Geen add-to-cart knop gevonden'); f++;
    }

    // qs-pp-002: Product images
    const productImgs = allImgs.filter(img => {
      const src = (img.src || img.dataset.src || '').toLowerCase();
      const cls = (img.className || '').toLowerCase();
      return cls.includes('product') || cls.includes('gallery') || src.includes('product') || img.closest('[class*="gallery"], [class*="product-image"]');
    });
    const imgCount = productImgs.length || allImgs.filter(i => i.width > 200).length;
    autoFill('qs-pp-002', imgCount >= 4 ? 'good' : imgCount >= 2 ? 'ok' : 'bad',
      `${imgCount} productafbeeldingen gevonden (aanbevolen: ≥4)`); f++;

    // qs-pp-004: Price visibility
    const price = doc.querySelector('[class*="price"], [itemprop="price"], [data-price]');
    if (price) {
      autoFill('qs-pp-004', 'good', `Prijs element gevonden: "${(price.textContent||'').trim().substring(0,30)}"`); f++;
    } else {
      autoFill('qs-pp-004', 'bad', 'Geen prijs element gevonden op pagina'); f++;
    }

    // qs-pp-006: Horizontal tabs detection
    const tabs = doc.querySelector('[role="tablist"], .tabs, .nav-tabs, .product-tabs');
    if (tabs) {
      autoFill('qs-pp-006', 'bad', 'Horizontale tabs gedetecteerd — 27% van gebruikers mist getabde content (Baymard)'); f++;
    } else {
      autoFill('qs-pp-006', 'good', 'Geen horizontale tabs — goede keuze voor productinfo zichtbaarheid'); f++;
    }

    // qs-pp-007: Customer reviews
    const reviews = doc.querySelector('[class*="review"], [class*="rating"], [itemprop="aggregateRating"], [class*="star"]');
    if (reviews) {
      autoFill('qs-pp-007', 'good', 'Reviews/ratings sectie gevonden'); f++;
    } else {
      autoFill('qs-pp-007', 'bad', 'Geen reviews/ratings gevonden — 65% van sites heeft dit incorrect'); f++;
    }

    // qs-pp-015: Breadcrumbs
    const breadcrumb = doc.querySelector('[class*="breadcrumb"], nav[aria-label*="breadcrumb"], [itemtype*="BreadcrumbList"]');
    if (breadcrumb) {
      autoFill('qs-pp-015', 'good', 'Breadcrumb navigatie aanwezig'); f++;
    } else {
      autoFill('qs-pp-015', 'bad', 'Geen breadcrumb navigatie gevonden'); f++;
    }

    // qs-pp-016: Product video
    const video = doc.querySelector('video, iframe[src*="youtube"], iframe[src*="vimeo"], [class*="video"]');
    if (video) {
      autoFill('qs-pp-016', 'good', 'Productvideo aanwezig — verhoogt conversie tot 86%'); f++;
    } else {
      autoFill('qs-pp-016', 'ok', 'Geen productvideo gevonden — toevoegen kan conversie met 80-86% verhogen'); f++;
    }
  }

  // ── CHECKOUT auto-checks ──
  if (template === 'qs-checkout') {
    // qs-co-003: Form field count
    const visibleFields = allInputs.filter(i => i.type !== 'hidden' && i.type !== 'submit' && i.type !== 'button').length;
    autoFill('qs-co-003', visibleFields <= 8 ? 'good' : visibleFields <= 12 ? 'ok' : 'bad',
      `${visibleFields} zichtbare formuliervelden (optimaal: ≤8, gemiddeld: 11.3)`); f++;

    // qs-co-004: Express checkout
    const expressPayments = doc.querySelectorAll('[class*="apple-pay"], [class*="google-pay"], [class*="paypal"], [class*="ideal"], [class*="express"], [class*="wallet"]');
    autoFill('qs-co-004', expressPayments.length >= 2 ? 'good' : expressPayments.length === 1 ? 'ok' : 'bad',
      `${expressPayments.length} express checkout optie(s) gevonden (aanbevolen: ≥2)`); f++;

    // qs-co-005: Security indicators
    const securitySignals = doc.querySelectorAll('[class*="secure"], [class*="ssl"], [class*="trust"], [class*="lock"], [class*="badge"]');
    autoFill('qs-co-005', securitySignals.length >= 2 ? 'good' : securitySignals.length === 1 ? 'ok' : 'bad',
      `${securitySignals.length} security indicator(s) gevonden — 25% verlaat bij ontbreken`); f++;

    // qs-co-011: Progress indicator
    const progress = doc.querySelector('[class*="step"], [class*="progress"], [class*="breadcrumb"], [role="progressbar"]');
    if (progress) {
      autoFill('qs-co-011', 'good', 'Voortgangsindicator gevonden in checkout flow'); f++;
    } else {
      autoFill('qs-co-011', 'ok', 'Geen voortgangsindicator gevonden — aanbevolen bij multi-step checkout'); f++;
    }

    // qs-co-014: Promo code field
    const promoField = doc.querySelector('input[name*="promo"], input[name*="coupon"], input[name*="discount"], input[placeholder*="code"]');
    const promoVisible = promoField && promoField.offsetParent !== null;
    if (promoField && !promoVisible) {
      autoFill('qs-co-014', 'good', 'Promo-codeveld verborgen achter link — correcte implementatie'); f++;
    } else if (promoField) {
      autoFill('qs-co-014', 'bad', 'Promo-codeveld is direct zichtbaar — 35% van gebruikers verlaat checkout om code te zoeken'); f++;
    }
  }

  // ── HOMEPAGE auto-checks ──
  if (template === 'qs-homepage') {
    // qs-hp-003: Navigation clarity
    const navEl = doc.querySelector('nav, [role="navigation"]');
    if (navEl) {
      const navItems = navEl.querySelectorAll('a').length;
      autoFill('qs-hp-003', navItems <= 7 ? 'good' : navItems <= 10 ? 'ok' : 'bad',
        `${navItems} navigatie-items (optimaal: ≤7 top-level)`); f++;
    }

    // qs-hp-005: Logo top-left
    const logo = doc.querySelector('header .logo, header [class*="logo"], .site-header img:first-child, header a:first-child img');
    if (logo) {
      autoFill('qs-hp-005', 'good', 'Logo gevonden in header'); f++;
    }

    // qs-hp-009: Search functionality
    const search = doc.querySelector('input[type="search"], [role="search"], input[name="q"], input[name="search"], [class*="search-input"]');
    if (search) {
      autoFill('qs-hp-009', 'good', 'Zoekfunctie aanwezig op homepage'); f++;
    } else {
      autoFill('qs-hp-009', 'ok', 'Geen zoekfunctie gevonden — aanbevolen voor content-rijke sites'); f++;
    }

    // qs-hp-012: Footer essentials
    const footer = doc.querySelector('footer');
    if (footer) {
      const footerLinks = Array.from(footer.querySelectorAll('a')).map(a => (a.textContent||'').toLowerCase());
      const hasContact = footerLinks.some(t => t.includes('contact'));
      const hasPrivacy = footerLinks.some(t => t.includes('privacy'));
      const hasAbout = footerLinks.some(t => t.includes('about') || t.includes('over'));
      const count = [hasContact, hasPrivacy, hasAbout].filter(Boolean).length;
      autoFill('qs-hp-012', count >= 3 ? 'good' : count >= 2 ? 'ok' : 'bad',
        `Footer links: ${hasContact?'✓':'✗'} Contact, ${hasPrivacy?'✓':'✗'} Privacy, ${hasAbout?'✓':'✗'} Over ons`); f++;
    }

    // qs-hp-008: Trust indicators
    const trustSignals = doc.querySelectorAll('[class*="trust"], [class*="client"], [class*="partner"], [class*="testimonial"], [class*="review"], [class*="badge"]');
    autoFill('qs-hp-008', trustSignals.length >= 2 ? 'good' : trustSignals.length === 1 ? 'ok' : 'bad',
      `${trustSignals.length} trust indicator(s) gevonden op homepage`); f++;
  }

  // ── CONTACT PAGE auto-checks ──
  if (template === 'qs-contact') {
    // qs-ct-001: Page findability (check nav + footer)
    const navContact = doc.querySelector('nav a[href*="contact"], [role="navigation"] a[href*="contact"]');
    const footerContact = doc.querySelector('footer a[href*="contact"]');
    autoFill('qs-ct-001', navContact && footerContact ? 'good' : navContact || footerContact ? 'ok' : 'bad',
      `Contact link: ${navContact?'✓':'✗'} navigatie, ${footerContact?'✓':'✗'} footer`); f++;

    // qs-ct-002: Phone number
    const phone = doc.querySelector('a[href^="tel:"]');
    if (phone) {
      autoFill('qs-ct-002', 'good', `Telefoonnummer gevonden: ${(phone.textContent||'').trim().substring(0,20)}`); f++;
    } else {
      autoFill('qs-ct-002', 'bad', 'Geen telefoonnummer zichtbaar — "implies the org doesn\'t want to be bothered" (NNGroup)'); f++;
    }

    // qs-ct-003: Multiple contact methods
    const hasPhoneLink = !!doc.querySelector('a[href^="tel:"]');
    const hasEmailLink = !!doc.querySelector('a[href^="mailto:"]');
    const hasForm = allForms.length > 0;
    const hasChat = !!doc.querySelector('[class*="chat"], [class*="messenger"], [id*="chat"]');
    const methods = [hasPhoneLink, hasEmailLink, hasForm, hasChat].filter(Boolean).length;
    autoFill('qs-ct-003', methods >= 3 ? 'good' : methods >= 2 ? 'ok' : 'bad',
      `${methods} contactmethode(n): ${hasPhoneLink?'telefoon ':''}${hasEmailLink?'email ':''}${hasForm?'formulier ':''}${hasChat?'chat ':''}`); f++;

    // qs-ct-004: Form simplicity
    if (allForms.length > 0) {
      const reqFields = allForms[0].querySelectorAll('input[required]:not([type="hidden"]), textarea[required], select[required]').length;
      autoFill('qs-ct-004', reqFields <= 5 ? 'good' : reqFields <= 7 ? 'ok' : 'bad',
        `${reqFields} verplichte velden (optimaal: ≤5)`); f++;
    }

    // qs-ct-005: Mobile tap-to-call
    const telLinks = doc.querySelectorAll('a[href^="tel:"]');
    const mailtoLinks = doc.querySelectorAll('a[href^="mailto:"]');
    autoFill('qs-ct-005', telLinks.length > 0 && mailtoLinks.length > 0 ? 'good' : telLinks.length > 0 || mailtoLinks.length > 0 ? 'ok' : 'bad',
      `tel: links: ${telLinks.length}, mailto: links: ${mailtoLinks.length}`); f++;

    // qs-ct-006: Physical address
    const address = doc.querySelector('address, [itemprop="address"], [class*="address"]');
    const map = doc.querySelector('iframe[src*="maps"], [class*="map"]');
    if (address || map) {
      autoFill('qs-ct-006', 'good', `${address?'Adres':''}${address&&map?' + ':''}${map?'Kaart':''} gevonden`); f++;
    }

    // qs-ct-009: FAQ/self-service
    const faq = doc.querySelector('[class*="faq"], [class*="help"], a[href*="faq"], a[href*="help"]');
    if (faq) {
      autoFill('qs-ct-009', 'good', 'FAQ/help sectie of link gevonden'); f++;
    }

    // qs-ct-010: CTA button text
    const submitBtns = allBtns.filter(b => b.type === 'submit' || b.closest('form'));
    submitBtns.forEach(btn => {
      const txt = (btn.textContent || btn.value || '').toLowerCase().trim();
      if (txt === 'submit' || txt === 'verzenden') {
        autoFill('qs-ct-010', 'ok', `Knoptekst "${txt}" — "Stuur Bericht" converteert ~3% beter`); f++;
      } else if (txt.length > 0) {
        autoFill('qs-ct-010', 'good', `Specifieke knoptekst: "${(btn.textContent||btn.value||'').trim().substring(0,30)}"`); f++;
      }
    });
  }

  // ── BLOG auto-checks ──
  if (template === 'qs-blog') {
    // qs-bl-001: Heading structure
    const h1s = headings.filter(h => h.tagName === 'H1');
    const levels = headings.map(h => parseInt(h.tagName[1]));
    let skipped = false;
    for (let i = 1; i < levels.length; i++) { if (levels[i] - levels[i-1] > 1) { skipped = true; break; } }
    autoFill('qs-bl-001', h1s.length === 1 && !skipped ? 'good' : h1s.length === 1 ? 'ok' : 'bad',
      `${h1s.length} H1(s), ${headings.length} totaal headings${skipped ? ', niveaus overgeslagen' : ''}`); f++;

    // qs-bl-006: Image optimization
    const imgsWithAlt = allImgs.filter(i => i.alt && i.alt.trim().length > 0).length;
    const imgsTotal = allImgs.length;
    autoFill('qs-bl-006', imgsTotal > 0 && imgsWithAlt === imgsTotal ? 'good' : imgsWithAlt > imgsTotal * 0.7 ? 'ok' : 'bad',
      `${imgsWithAlt}/${imgsTotal} afbeeldingen hebben alt-tekst`); f++;

    // qs-bl-007: Internal linking
    const internalLinks = allLinks.filter(a => {
      try { return a.hostname === location.hostname || !a.hostname; } catch(e) { return false; }
    }).length;
    autoFill('qs-bl-007', internalLinks >= 3 ? 'good' : internalLinks >= 1 ? 'ok' : 'bad',
      `${internalLinks} interne links in content (aanbevolen: ≥3 voor posts >1000 woorden)`); f++;

    // qs-bl-008: Author credibility
    const author = doc.querySelector('[class*="author"], [rel="author"], [itemprop="author"], .byline');
    if (author) {
      autoFill('qs-bl-008', 'good', `Auteur informatie gevonden: "${(author.textContent||'').trim().substring(0,40)}"`); f++;
    } else {
      autoFill('qs-bl-008', 'bad', 'Geen auteur informatie — E-E-A-T is ranking factor (137× genoemd in Google Quality Raters)'); f++;
    }

    // qs-bl-009: Content freshness
    const dateEl = doc.querySelector('time[datetime], [class*="date"], [class*="published"], [itemprop="datePublished"]');
    if (dateEl) {
      autoFill('qs-bl-009', 'good', `Publicatiedatum gevonden: "${(dateEl.textContent||dateEl.getAttribute('datetime')||'').trim().substring(0,30)}"`); f++;
    } else {
      autoFill('qs-bl-009', 'bad', 'Geen publicatie- of updatedatum gevonden — essentieel voor E-E-A-T'); f++;
    }

    // qs-bl-011: Related posts
    const related = doc.querySelector('[class*="related"], [class*="more-posts"], [class*="suggested"], [class*="also-like"]');
    if (related) {
      autoFill('qs-bl-011', 'good', 'Gerelateerde artikelen sectie aanwezig'); f++;
    } else {
      autoFill('qs-bl-011', 'ok', 'Geen gerelateerde artikelen sectie gevonden'); f++;
    }

    // qs-bl-012: Table of contents
    const toc = doc.querySelector('[class*="toc"], [class*="table-of-contents"], [id*="toc"]');
    const wordCount = (doc.body?.textContent || '').split(/\s+/).length;
    if (toc) {
      autoFill('qs-bl-012', 'good', 'Inhoudsopgave aanwezig'); f++;
    } else if (wordCount > 1500) {
      autoFill('qs-bl-012', 'ok', `Geen inhoudsopgave bij ~${wordCount} woorden — aanbevolen boven 1500`); f++;
    }

    // qs-bl-013: Social share buttons
    const shareButtons = doc.querySelectorAll('[class*="share"], [class*="social-share"], a[href*="twitter.com/intent"], a[href*="facebook.com/sharer"], a[href*="linkedin.com/share"]');
    autoFill('qs-bl-013', shareButtons.length >= 3 ? 'good' : shareButtons.length >= 1 ? 'ok' : 'bad',
      `${shareButtons.length} social share knoppen gevonden (aanbevolen: ≥3)`); f++;
  }

  // ── PRICING PAGE auto-checks ──
  if (template === 'qs-pricing') {
    // qs-pr-001: Plan comparison clarity
    const planCards = doc.querySelectorAll('[class*="plan"], [class*="tier"], [class*="pricing-card"], [class*="package"]');
    autoFill('qs-pr-001', planCards.length >= 3 && planCards.length <= 4 ? 'good' : planCards.length >= 2 ? 'ok' : 'bad',
      `${planCards.length} prijsplannen gevonden (optimaal: 3-4)`); f++;

    // qs-pr-003: CTA per plan
    const planCTAs = doc.querySelectorAll('[class*="plan"] button, [class*="tier"] button, [class*="pricing-card"] button, [class*="pricing"] a[class*="btn"]');
    autoFill('qs-pr-003', planCTAs.length >= planCards.length ? 'good' : planCTAs.length > 0 ? 'ok' : 'bad',
      `${planCTAs.length} CTA-knoppen bij ${planCards.length} plannen`); f++;

    // qs-pr-005: Feature comparison table
    const featureTable = doc.querySelector('table, [class*="feature-comparison"], [class*="comparison"]');
    if (featureTable) {
      autoFill('qs-pr-005', 'good', 'Feature vergelijkingstabel aanwezig'); f++;
    } else {
      autoFill('qs-pr-005', 'ok', 'Geen feature vergelijkingstabel gevonden — vermindert support verzoeken met 31%'); f++;
    }

    // qs-pr-006: Annual/monthly toggle
    const toggle = doc.querySelector('[class*="toggle"], [class*="switch"], [class*="billing"], input[type="checkbox"][class*="plan"]');
    if (toggle) {
      autoFill('qs-pr-006', 'good', 'Jaarlijks/maandelijks toggle aanwezig — verhoogt jaarlijkse adoptie met 19%'); f++;
    } else {
      autoFill('qs-pr-006', 'ok', 'Geen billing toggle gevonden'); f++;
    }

    // qs-pr-007: FAQ section
    const faq = doc.querySelector('[class*="faq"], details, [class*="accordion"]');
    if (faq) {
      const faqItems = doc.querySelectorAll('[class*="faq"] dt, [class*="faq"] h3, details summary, [class*="accordion-item"]');
      autoFill('qs-pr-007', faqItems.length >= 5 ? 'good' : faqItems.length >= 3 ? 'ok' : 'bad',
        `${faqItems.length} FAQ items (aanbevolen: ≥5 — 67% verlaat bij vermoeden verborgen kosten)`); f++;
    } else {
      autoFill('qs-pr-007', 'bad', 'Geen FAQ sectie — 67% van pricing abandonment door vermoeden verborgen kosten'); f++;
    }

    // qs-pr-009: Enterprise option
    const enterprise = doc.querySelector('[class*="enterprise"], a[href*="contact"], a[href*="sales"]');
    if (enterprise) {
      autoFill('qs-pr-009', 'good', 'Enterprise / Contact Sales optie aanwezig'); f++;
    }

    // qs-pr-011: Social proof
    const socialProof = doc.querySelectorAll('[class*="testimonial"], [class*="client-logo"], [class*="trust"], [class*="badge"]');
    autoFill('qs-pr-011', socialProof.length >= 2 ? 'good' : socialProof.length === 1 ? 'ok' : 'bad',
      `${socialProof.length} social proof element(en) — verhoogt conversie 15-25%`); f++;
  }

  // ── ABOUT PAGE auto-checks ──
  if (template === 'qs-about') {
    // qs-ab-005: Credibility signals
    const creds = doc.querySelectorAll('[class*="award"], [class*="cert"], [class*="partner"], [class*="press"], [class*="badge"]');
    autoFill('qs-ab-005', creds.length >= 2 ? 'good' : creds.length === 1 ? 'ok' : 'bad',
      `${creds.length} geloofwaardigheidssignalen (awards, certificeringen, pers)`); f++;

    // qs-ab-006: Scannable content
    const paragraphs = Array.from(doc.querySelectorAll('main p, article p, .content p, .about p'));
    const longParas = paragraphs.filter(p => p.textContent.split('\n').length > 4 || p.textContent.length > 400).length;
    autoFill('qs-ab-006', longParas === 0 ? 'good' : longParas <= 2 ? 'ok' : 'bad',
      `${longParas} te lange paragrafen (max 4 regels per paragraaf)`); f++;

    // qs-ab-007: Contact pathway CTA
    const contactCTA = doc.querySelector('a[href*="contact"], button[onclick*="contact"], [class*="cta"]');
    if (contactCTA) {
      autoFill('qs-ab-007', 'good', 'Contact CTA aanwezig — geen dead-end pagina'); f++;
    } else {
      autoFill('qs-ab-007', 'bad', 'Geen contact CTA — Over Ons is een dead-end zonder volgende stap'); f++;
    }

    // qs-ab-009: Careers links
    const careersLink = doc.querySelector('a[href*="career"], a[href*="jobs"], a[href*="vacature"], a[href*="werken-bij"]');
    if (careersLink) {
      autoFill('qs-ab-009', 'good', 'Vacature/careers link aanwezig'); f++;
    }

    // qs-ab-011: Third-party validation
    const externalLinks = allLinks.filter(a => {
      const href = (a.href||'').toLowerCase();
      return href.includes('trustpilot') || href.includes('glassdoor') || href.includes('linkedin') || href.includes('g2.com') || href.includes('capterra');
    });
    if (externalLinks.length > 0) {
      autoFill('qs-ab-011', 'good', `${externalLinks.length} link(s) naar externe reviews/validatie`); f++;
    }
  }

  // ── OPT-IN auto-checks ──
  if (template === 'qs-optin') {
    // qs-oi-002: Form fields
    const forms = allForms.filter(f => f.querySelector('input[type="email"]'));
    if (forms.length > 0) {
      const fields = forms[0].querySelectorAll('input:not([type="hidden"]):not([type="submit"]), textarea').length;
      autoFill('qs-oi-002', fields <= 2 ? 'good' : fields <= 4 ? 'ok' : 'bad',
        `${fields} velden in opt-in formulier (optimaal: 1-2 voor TOFU, 3-4 MOFU)`); f++;
    }

    // qs-oi-005: Privacy assurance
    const privacyLink = doc.querySelector('a[href*="privacy"], [class*="privacy"]');
    if (privacyLink) {
      autoFill('qs-oi-005', 'good', 'Privacy link nabij formulier gevonden'); f++;
    } else {
      autoFill('qs-oi-005', 'bad', 'Geen privacy link bij formulier — essentieel voor GDPR en vertrouwen'); f++;
    }

    // qs-oi-007: Social proof near CTA
    const sp = doc.querySelector('[class*="testimonial"], [class*="subscriber"], [class*="trust"]');
    if (sp) {
      autoFill('qs-oi-007', 'good', 'Social proof bij CTA — verhoogt conversie met 34%'); f++;
    } else {
      autoFill('qs-oi-007', 'bad', 'Geen social proof bij opt-in CTA'); f++;
    }

    // qs-oi-010: Distraction removal
    const hasNav = !!doc.querySelector('nav, [role="navigation"]');
    const hasSidebar = !!doc.querySelector('aside, [class*="sidebar"]');
    if (!hasNav && !hasSidebar) {
      autoFill('qs-oi-010', 'good', 'Geen navigatie of sidebar — minimale afleiding'); f++;
    } else {
      autoFill('qs-oi-010', 'bad', `${hasNav?'Navigatie':''}${hasNav&&hasSidebar?' + ':''}${hasSidebar?'Sidebar':''} aanwezig — verwijderen verhoogt conversie 266%`); f++;
    }
  }

  // ── LAUNCH PAGE auto-checks ──
  if (template === 'qs-launch') {
    // qs-la-001: Email capture
    const emailInput = doc.querySelector('input[type="email"]');
    const totalFields = emailInput ? emailInput.closest('form')?.querySelectorAll('input:not([type="hidden"]):not([type="submit"])').length : 0;
    if (emailInput) {
      autoFill('qs-la-001', totalFields <= 2 ? 'good' : 'ok',
        `Email capture gevonden met ${totalFields} veld(en) (optimaal: max 2)`); f++;
    } else {
      autoFill('qs-la-001', 'bad', 'Geen email capture formulier gevonden'); f++;
    }

    // qs-la-005: Countdown timer
    const countdown = doc.querySelector('[class*="countdown"], [class*="timer"], [class*="launch-date"]');
    if (countdown) {
      autoFill('qs-la-005', 'good', 'Countdown timer of lanceringsdatum gevonden — verhoogt conversie ~9%'); f++;
    }
  }

  // ── ONBOARDING auto-checks ──
  if (template === 'qs-onboarding') {
    // qs-ob-002: Signup friction
    const signupForm = allForms.find(f => f.querySelector('input[type="email"]') || f.querySelector('input[type="password"]'));
    if (signupForm) {
      const fields = signupForm.querySelectorAll('input:not([type="hidden"]):not([type="submit"]):not([type="button"])').length;
      const socialLogin = doc.querySelector('[class*="google"], [class*="github"], [class*="social-login"], [class*="oauth"]');
      autoFill('qs-ob-002', fields <= 3 && socialLogin ? 'good' : fields <= 3 ? 'ok' : 'bad',
        `${fields} signup velden${socialLogin ? ' + social login' : ''} (optimaal: ≤3 + social login)`); f++;
    }

    // qs-ob-009: Contextual help
    const helpWidgets = doc.querySelectorAll('[class*="help"], [class*="chat"], [class*="support"], [class*="resource"], a[href*="help"], a[href*="docs"]');
    autoFill('qs-ob-009', helpWidgets.length >= 2 ? 'good' : helpWidgets.length === 1 ? 'ok' : 'bad',
      `${helpWidgets.length} help/support element(en) (aanbevolen: ≥2)`); f++;

    // qs-ob-014: Mobile responsiveness
    const viewport = doc.querySelector('meta[name="viewport"]');
    if (viewport) {
      autoFill('qs-ob-014', 'good', 'Viewport meta tag aanwezig voor mobiele ondersteuning'); f++;
    } else {
      autoFill('qs-ob-014', 'bad', 'Geen viewport meta tag — onboarding werkt niet goed op mobiel'); f++;
    }
  }

  return f;
}

// ═══════════════ SCORECARD ═══════════════
function showScorecard() { try {
  saveCurrentAnswers();
  const project = getActiveProject();
  const answers = project ? project.answers : {};
  const container = document.getElementById('scorecardContent');

  // ── Free-form: genereer reviewSteps uit bevindingen per categorie ──
  if (project?.reviewType === 'free-form') {
    const findings = Object.keys(answers)
      .filter(k => k.startsWith('ff-'))
      .sort((a, b) => (answers[a].findingOrder || 0) - (answers[b].findingOrder || 0));
    const catMap = {};
    const addedToStep = new Set(); // track welke findings al in minstens 1 categorie zitten
    findings.forEach(fId => {
      const cats = answers[fId].findingCategories || (answers[fId].findingCategory ? [answers[fId].findingCategory] : ['other']);
      if (cats.length === 0) cats.push('other');
      cats.forEach(cat => {
        if (!catMap[cat]) catMap[cat] = [];
        catMap[cat].push(fId);
        addedToStep.add(fId);
      });
    });
    reviewSteps = Object.entries(catMap).map(([catId, fIds]) => ({
      id: 'ff-cat-' + catId,
      title: (typeof FF_CAT_LABELS !== 'undefined' && FF_CAT_LABELS[catId]) || catId,
      shortTitle: (typeof FF_CAT_LABELS !== 'undefined' && FF_CAT_LABELS[catId]) || catId,
      impact: 'high',
      desc: '',
      questions: fIds.map(fId => ({
        id: fId,
        text: answers[fId].findingTitle || (answers[fId].notes || '').split('\n')[0].substring(0, 80) || 'Bevinding',
        type: 'manual'
      }))
    }));
  }

  const totalQ = reviewSteps.reduce((s, st) => s + st.questions.length, 0);
  // Only count answers matching current reviewSteps questions (prevent quick-scan counting all regular auto-checks)
  const stepQIds = new Set(reviewSteps.flatMap(s => s.questions.map(q => q.id)));
  const allNvt = Object.entries(answers).filter(([id, a]) => stepQIds.has(id) && a.score === 'nvt').length;
  const allScored = Object.entries(answers).filter(([id, a]) => stepQIds.has(id) && a.score && a.score !== 'nvt').map(([, a]) => a);
  const overallEffective = totalQ - allNvt;
  // Weighted scoring: critical=3x, high=2x, medium/low=1x
  const allQ = reviewSteps.flatMap(s => s.questions);
  const overallWs = calcWeightedScore(allQ, answers);
  const overallAvg = overallWs.score;
  const overallClass = overallAvg >= 7.5 ? 'sc-good' : overallAvg >= 5 ? 'sc-ok' : 'sc-bad';
  const overallVerdict = overallAvg >= 8 ? 'Uitstekend' : overallAvg >= 7 ? 'Goed' : overallAvg >= 5 ? 'Voldoende — ruimte voor verbetering' : overallAvg >= 3 ? 'Onvoldoende — actie nodig' : 'Kritiek — directe actie vereist';

  const catScores = reviewSteps.map(step => {
    const nvt = step.questions.filter(q => answers[q.id]?.score === 'nvt').length;
    const effective = step.questions.length - nvt;
    // Weighted scoring per category
    const ws = calcWeightedScore(step.questions, answers);
    const avg = effective > 0 ? ws.score : -1;
    const cls = effective === 0 ? 'sc-na' : avg >= 7.5 ? 'sc-good' : avg >= 5 ? 'sc-ok' : 'sc-bad';
    const status = effective === 0 ? 'Alles n.v.t.' : avg >= 7.5 ? 'Goed' : avg >= 5 ? 'Aandacht nodig' : 'Kritiek';
    const stCls = effective === 0 ? 'st-na' : avg >= 7.5 ? 'st-good' : avg >= 5 ? 'st-ok' : 'st-bad';
    return { ...step, avg, cls, status, stCls, effective, nvt };
  });

  // Group catScores by module
  const moduleGroups = {};
  const moduleOrder = [];
  catScores.forEach(c => {
    const mId = c.moduleId || 'other';
    if (!moduleGroups[mId]) {
      moduleGroups[mId] = {
        id: mId,
        name: c.moduleName || c.title,
        color: c.moduleColor || 'var(--accent)',
        icon: c.moduleIcon || 'box',
        steps: [],
        totalEffective: 0,
        totalScoreSum: 0
      };
      moduleOrder.push(mId);
    }
    moduleGroups[mId].steps.push(c);
    if (c.effective > 0) {
      moduleGroups[mId].totalEffective += c.effective;
      moduleGroups[mId].totalScoreSum += c.avg >= 0 ? c.avg * c.effective : 0;
    }
  });
  // Calculate module-level averages
  moduleOrder.forEach(mId => {
    const mg = moduleGroups[mId];
    mg.avg = mg.totalEffective > 0 ? mg.totalScoreSum / mg.totalEffective : -1;
    mg.cls = mg.totalEffective === 0 ? 'sc-na' : mg.avg >= 7.5 ? 'sc-good' : mg.avg >= 5 ? 'sc-ok' : 'sc-bad';
    mg.status = mg.totalEffective === 0 ? 'Alles n.v.t.' : mg.avg >= 7.5 ? 'Goed' : mg.avg >= 5 ? 'Aandacht nodig' : 'Kritiek';
    mg.stCls = mg.totalEffective === 0 ? 'st-na' : mg.avg >= 7.5 ? 'st-good' : mg.avg >= 5 ? 'st-ok' : 'st-bad';
  });

  const allIssues = [];
  reviewSteps.forEach(step => {
    step.questions.forEach(q => {
      const a = answers[q.id];
      if (a && (a.score==='bad'||a.score==='ok')) {
        const shots = getScreenshots(q.id);
        const issueText = q.id.startsWith('ff-') ? (a.findingTitle || (a.notes || '').split('\n')[0].substring(0, 80) || q.text) : q.text;
        const ffCats = q.id.startsWith('ff-') ? (a.findingCategories || (a.findingCategory ? [a.findingCategory] : [])) : [];
        const issueCat = q.id.startsWith('ff-')
          ? (ffCats.length > 0 ? ffCats.map(c => FF_CAT_LABELS[c] || c).join(', ') : step.shortTitle)
          : step.shortTitle;
        // Dedup: skip als dit ff- ID al in allIssues zit
        if (q.id.startsWith('ff-') && allIssues.some(i => i.id === q.id)) { return; }
        allIssues.push({ id: q.id, text: issueText, tip: questionTips[q.id]||'', score: a.score, impact: a.severity||step.impact||'low', notes: a.notes||'', category: issueCat, screenshots: shots, screenshot: shots[0]||'' });
      }
    });
  });
  allIssues.sort((a, b) => ({ high:0, low:1 }[a.impact]||1) - ({ high:0, low:1 }[b.impact]||1));

  const quickWins = allIssues.filter(i => i.impact==='high' && i.score==='ok');
  const strategic = allIssues.filter(i => i.impact==='high' && i.score==='bad');
  const fillers = allIssues.filter(i => i.impact==='low' && i.score==='ok');
  const notNow = allIssues.filter(i => i.impact==='low' && i.score==='bad');

  // Lead gate no longer needed — email is captured at the landing page
  // Free-form = altijd expert modus, nooit self-service lock
  const isSelfService = project && project.mode === 'self-service' && project.reviewType !== 'free-form';
  const hasProvidedEmail = project && project.leadEmail;
  const showLeadGate = false; // Email already captured at landing

  // ── Helper: render een issue card voor free-form scorecard ──
  function renderFfIssueCard(issue, answers) {
    const a = answers[issue.id] || {};
    const scoreColor = issue.score === 'bad' ? 'var(--red)' : 'var(--yellow)';
    const scoreLabel = issue.score === 'bad' ? 'Niet OK' : 'Matig';
    const impactLabel = issue.impact === 'high' ? 'Hoge impact' : 'Lage impact';
    const shots = issue.screenshots || [];
    const cats = a.findingCategories || (a.findingCategory ? [a.findingCategory] : []);
    const catLabels = cats.map(c => FF_CAT_LABELS[c] || c).filter(Boolean);

    return `<div class="ff-issue-card" style="border-left-color:${scoreColor}">
      <div class="ff-issue-card-top">
        <span class="ff-issue-badge" style="background:${scoreColor}15;color:${scoreColor}">${scoreLabel}</span>
        <span class="ff-issue-impact" style="color:${issue.impact === 'high' ? 'var(--red)' : 'var(--text-muted)'}">${impactLabel}</span>
      </div>
      <div class="ff-issue-card-text">${esc(issue.text)}</div>
      ${a.notes ? `<div class="ff-issue-card-notes">${esc(a.notes).substring(0, 300).replace(/\n/g, '<br>')}</div>` : ''}
      ${catLabels.length > 0 ? `<div class="ff-issue-cats">${catLabels.map(l => '<span class="ff-issue-cat-tag">' + esc(l) + '</span>').join('')}</div>` : ''}
      ${shots.length > 0 ? `<div class="ff-issue-shots">${shots.slice(0, 2).map((s, idx) => '<img class="ff-issue-shot" src="' + s + '" onclick="showLightbox(\'' + issue.id + '\',' + idx + ')" title="Screenshot">').join('')}${shots.length > 2 ? '<span style="font-size:11px;color:var(--text-muted)">+' + (shots.length - 2) + ' meer</span>' : ''}</div>` : ''}
    </div>`;
  }

  // ── FREE-FORM: aparte scorecard zonder cijfer ──
  if (project?.reviewType === 'free-form') {
    const ffFindings = Object.keys(answers).filter(k => k.startsWith('ff-'))
      .sort((a, b) => (answers[a].findingOrder || 0) - (answers[b].findingOrder || 0));
    const ffBad = ffFindings.filter(f => answers[f]?.score === 'bad');
    const ffOk = ffFindings.filter(f => answers[f]?.score === 'ok');
    const ffGood = ffFindings.filter(f => answers[f]?.score === 'good');
    const ffUnscored = ffFindings.filter(f => !answers[f]?.score);

    // Topbar
    document.getElementById('scorecardTopbar').innerHTML = `
      <div class="dash-topbar">
        <div class="dash-topbar-left">
          <button class="back-btn" onclick="backToDashboardFromScorecard()" title="Dashboard"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1.5" y="1.5" width="5" height="5.5" rx="1"/><rect x="9.5" y="1.5" width="5" height="3.5" rx="1"/><rect x="1.5" y="9.5" width="5" height="3.5" rx="1"/><rect x="9.5" y="7.5" width="5" height="5.5" rx="1"/></svg></button>
          <span class="logo">${brandLogo('18px', true)}</span>
          <div class="dash-topbar-title">${esc(project?.name || 'Vrije Review')}${project?.client ? ' — ' + esc(project.client) : ''}</div>
        </div>
        <div class="dash-topbar-right">
          <div class="dash-topbar-meta">${new Date().toLocaleDateString('nl-NL')} · ${ffFindings.length} bevindingen</div>
          <button class="btn-icon" onclick="closeScorecard()"><i data-lucide="chevron-left" style="width:14px;height:14px"></i> Terug</button>
          <button class="btn-icon" onclick="exportResults()" style="border-color:var(--accent);color:var(--accent)"><i data-lucide="download" style="width:14px;height:14px"></i> Exporteer</button>
        </div>
      </div>`;

    // Groepeer per categorie voor overzicht
    const ffCatSummary = {};
    ffFindings.forEach(fId => {
      const a = answers[fId];
      const cats = a.findingCategories || (a.findingCategory ? [a.findingCategory] : []);
      if (cats.length === 0) cats.push('other');
      cats.forEach(cat => {
        if (!ffCatSummary[cat]) ffCatSummary[cat] = { bad: 0, ok: 0, good: 0 };
        if (a.score === 'bad') ffCatSummary[cat].bad++;
        else if (a.score === 'ok') ffCatSummary[cat].ok++;
        else if (a.score === 'good') ffCatSummary[cat].good++;
      });
    });

    container.innerHTML = `
      <div class="kpi-strip">
        <div class="kpi-card">
          <div class="kpi-label">Bevindingen</div>
          <div class="kpi-value">${ffFindings.length}</div>
          <div class="kpi-sub">totaal genoteerd</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Niet OK</div>
          <div class="kpi-value" style="color:var(--red)">${ffBad.length}</div>
          <div class="kpi-sub">${strategic.length} strategisch · ${notNow.length} niet nu</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Matig</div>
          <div class="kpi-value" style="color:var(--yellow)">${ffOk.length}</div>
          <div class="kpi-sub">${quickWins.length} quick win${quickWins.length !== 1 ? 's' : ''}</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Goed</div>
          <div class="kpi-value" style="color:var(--green)">${ffGood.length}</div>
          <div class="kpi-sub">positieve punten</div>
        </div>
      </div>

      ${Object.keys(ffCatSummary).length > 0 ? `
      <div style="margin-bottom:24px">
        <h3 style="font-size:14px;margin-bottom:12px;color:var(--text-muted)">Per categorie</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));gap:8px">
          ${Object.entries(ffCatSummary).map(([catId, counts]) => {
            const catInfo = FF_CATEGORIES.find(c => c.id === catId) || { label: catId, color: '#6b7280', icon: 'more-horizontal' };
            const total = counts.bad + counts.ok + counts.good;
            return `<div style="padding:12px 16px;border:1px solid var(--border);border-radius:var(--radius);display:flex;align-items:center;gap:10px">
              <i data-lucide="${catInfo.icon}" style="width:16px;height:16px;color:${catInfo.color};flex-shrink:0"></i>
              <div style="flex:1;min-width:0">
                <div style="font-size:13px;font-weight:600">${catInfo.label}</div>
                <div style="font-size:11px;color:var(--text-muted)">${counts.bad > 0 ? '<span style="color:var(--red)">' + counts.bad + ' niet ok</span> · ' : ''}${counts.ok > 0 ? '<span style="color:var(--yellow)">' + counts.ok + ' matig</span> · ' : ''}${counts.good > 0 ? '<span style="color:var(--green)">' + counts.good + ' goed</span>' : ''}</div>
              </div>
              <div style="font-size:18px;font-weight:700;color:var(--text-muted)">${total}</div>
            </div>`;
          }).join('')}
        </div>
      </div>` : ''}

      <div class="dash-grid">
        <div class="ai-plan-section" id="aiPlanSection">
          <div class="ai-plan-header">
            <h3><i data-lucide="sparkles"></i> AI Actieplan</h3>
            <div style="display:flex;gap:8px;align-items:center">
              ${isSelfService ? `
                <span style="font-size:12px;color:var(--text-muted)"><i data-lucide="lock" style="width:13px;height:13px"></i> Professional</span>
              ` : `
                <button class="ai-plan-generate" onclick="generateAiPlan()" id="btnAiPlan"><i data-lucide="sparkles"></i> ${project?.aiPlan ? 'Opnieuw' : 'Genereer'}</button>
              `}
            </div>
          </div>
          <div class="ai-plan-body" id="aiPlanBody">
            ${isSelfService ? '<div class="ai-plan-empty"><i data-lucide="lock" style="width:32px;height:32px;opacity:0.3;margin-bottom:12px;display:block;margin-inline:auto"></i><strong>AI Actieplan — Professional Feature</strong></div>' : '<div class="ai-plan-empty"><i data-lucide="sparkles" style="width:32px;height:32px;opacity:0.3;margin-bottom:12px;display:block;margin-inline:auto"></i>Klik op Genereer om een actieplan te maken op basis van je bevindingen.</div>'}
          </div>
        </div>

        ${allIssues.length > 0 ? `
        <div class="issues-section">
          <h3 style="margin-bottom:12px"><i data-lucide="alert-triangle" style="color:var(--yellow)"></i> Verbeterpunten (${allIssues.length})</h3>

          ${strategic.length > 0 ? `
          <div class="issue-group">
            <div class="issue-group-title"><i data-lucide="target" style="color:var(--red)"></i> Strategisch (${strategic.length})</div>
            ${strategic.map(i => renderFfIssueCard(i, answers)).join('')}
          </div>` : ''}

          ${quickWins.length > 0 ? `
          <div class="issue-group">
            <div class="issue-group-title"><i data-lucide="zap" style="color:var(--green)"></i> Quick Wins (${quickWins.length})</div>
            ${quickWins.map(i => renderFfIssueCard(i, answers)).join('')}
          </div>` : ''}

          ${notNow.length > 0 ? `
          <div class="issue-group">
            <div class="issue-group-title"><i data-lucide="pause" style="color:var(--text-muted)"></i> Niet Nu (${notNow.length})</div>
            ${notNow.map(i => renderFfIssueCard(i, answers)).join('')}
          </div>` : ''}

          ${fillers.length > 0 ? `
          <div class="issue-group">
            <div class="issue-group-title"><i data-lucide="archive" style="color:var(--text-muted)"></i> Opvuller (${fillers.length})</div>
            ${fillers.map(i => renderFfIssueCard(i, answers)).join('')}
          </div>` : ''}
        </div>` : ''}

        ${ffGood.length > 0 ? `
        <div class="issues-section" style="margin-top:16px">
          <h3 style="margin-bottom:12px"><i data-lucide="check-circle" style="color:var(--green)"></i> Sterke punten (${ffGood.length})</h3>
          ${ffGood.map(fId => {
            const a = answers[fId];
            const label = a.findingTitle || (a.notes || '').split('\\n')[0].substring(0, 80) || 'Bevinding';
            return '<div class="issue-card" style="border-left-color:var(--green)"><div class="issue-card-text">' + esc(label) + '</div>' + (a.notes ? '<div class="issue-card-notes">' + esc(a.notes).substring(0, 200) + '</div>' : '') + '</div>';
          }).join('')}
        </div>` : ''}
      </div>
    `;

    // Show scorecard screen
    document.getElementById('reviewScreen').classList.add('hidden');
    document.getElementById('scorecardScreen').classList.remove('hidden');
    if (typeof lucide !== 'undefined') lucide.createIcons();
    return;
  }

  // Render full-width topbar separately
  document.getElementById('scorecardTopbar').innerHTML = `
    <div class="dash-topbar">
      <div class="dash-topbar-left">
        <button class="back-btn" onclick="backToDashboardFromScorecard()" title="Dashboard"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1.5" y="1.5" width="5" height="5.5" rx="1"/><rect x="9.5" y="1.5" width="5" height="3.5" rx="1"/><rect x="1.5" y="9.5" width="5" height="3.5" rx="1"/><rect x="9.5" y="7.5" width="5" height="5.5" rx="1"/></svg></button>
        <span class="logo">${brandLogo('18px', true)}</span>
        <div class="dash-topbar-title">${esc(project?.name || 'UX Review')}${project?.client ? ' — ' + esc(project.client) : ''}</div>
      </div>
      <div class="dash-topbar-right">
        <div class="dash-topbar-meta">${new Date().toLocaleDateString('nl-NL')} · ${allScored.length}/${overallEffective} beoordeeld${allNvt > 0 ? ` · ${allNvt} n.v.t.` : ''}</div>
        <button class="btn-icon" onclick="closeScorecard()"><i data-lucide="chevron-left" style="width:14px;height:14px"></i> Terug</button>
        <button class="btn-icon" onclick="exportResults()" style="border-color:var(--accent);color:var(--accent)"><i data-lucide="download" style="width:14px;height:14px"></i> Exporteer</button>
      </div>
    </div>`;

  container.innerHTML = `
    <div class="kpi-strip">
      <div class="kpi-card kpi-accent">
        <div class="kpi-label">Totaalscore</div>
        <div class="kpi-value ${overallClass}">${overallAvg.toFixed(1)}</div>
        <div class="kpi-sub">${overallVerdict}</div>
        <div class="kpi-bar"><div class="kpi-bar-fill" style="width:${overallAvg * 10}%;background:${overallClass === 'sc-good' ? 'var(--green)' : overallClass === 'sc-ok' ? 'var(--yellow)' : 'var(--red)'}"></div></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Beoordeeld</div>
        <div class="kpi-value">${allScored.length}<span style="font-size:16px;font-weight:400;color:var(--text-muted)">/${overallEffective}</span></div>
        <div class="kpi-sub">${overallEffective > 0 ? Math.min(Math.round(allScored.length / overallEffective * 100), 100) : 0}% voltooid</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Verbeterpunten</div>
        <div class="kpi-value" style="color:${allIssues.length > 0 ? 'var(--yellow)' : 'var(--green)'}">${allIssues.length}</div>
        <div class="kpi-sub">${allIssues.filter(i => i.impact === 'high').length} hoge impact</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Quick Wins</div>
        <div class="kpi-value" style="color:var(--green)">${quickWins.length}</div>
        <div class="kpi-sub">Direct oppakken</div>
      </div>
    </div>

    ${isSelfService && overallAvg > 0 && overallAvg < 7 ? `
    <div class="upsell-card" style="margin-bottom:16px">
      <div class="upsell-tag">Hulp nodig?</div>
      <h2>Wij helpen je van een ${overallAvg.toFixed(1)} naar een 8+</h2>
      <p>Ons team van UX experts maakt een volledig rapport met wireframes en een implementatieplan. Inclusief een strategie call.</p>
      <div class="upsell-benefits">
        <span>Expert analyse</span>
        <span>Concreet actieplan</span>
        <span>Gratis intake call</span>
      </div>
    </div>` : ''}

    <div class="dash-grid">
      <div class="ai-plan-section" id="aiPlanSection">
        <div class="ai-plan-header">
          <h3><i data-lucide="sparkles"></i> AI Actieplan</h3>
          <div style="display:flex;gap:8px;align-items:center">
            ${isSelfService ? `
              <span style="font-size:12px;color:var(--text-muted)"><i data-lucide="lock" style="width:13px;height:13px"></i> Professional</span>
            ` : `
              <button class="ai-plan-generate" onclick="generateAiPlan()" id="btnAiPlan"><i data-lucide="sparkles"></i> ${project?.aiPlan ? 'Opnieuw' : 'Genereer'}</button>
            `}
          </div>
        </div>
        <div class="ai-plan-body" id="aiPlanBody">
          ${isSelfService ? `
          <div class="ai-plan-empty">
            <i data-lucide="lock" style="width:32px;height:32px;opacity:0.3;margin-bottom:12px;display:block;margin-inline:auto"></i>
            <strong style="font-size:15px;color:var(--text);display:block;margin-bottom:8px">AI Actieplan — Professional Feature</strong>
            De AI maakt een kant-en-klaar actieplan voor je klant:<br>
            concrete actiepunten, business impact, en prioriteiten — geen technisch jargon.<br><br>
            <button class="ai-plan-generate" onclick="upgradeForAi()" style="margin-top:4px"><i data-lucide="sparkles"></i> Upgrade naar Professional</button>
          </div>
          ` : project?.aiPlan ? `<div class="ai-plan-content">${markdownToHtml(project.aiPlan)}</div>` : `
          <div class="ai-plan-empty">
            <i data-lucide="sparkles" style="width:32px;height:32px;opacity:0.3;margin-bottom:8px;display:block;margin-inline:auto"></i>
            Genereer een klantgericht actieplan op basis van de review resultaten.
          </div>`}
        </div>
        ${!isSelfService && project?.aiPlan ? `<div class="ai-plan-actions">
          <button class="btn btn-secondary" onclick="copyAiPlan()"><i data-lucide="copy" style="width:12px;height:12px"></i> Kopieer</button>
          <span style="font-size:10px;color:var(--text-muted)">Gegenereerd: ${project.aiPlanDate ? new Date(project.aiPlanDate).toLocaleDateString('nl-NL') : ''}</span>
        </div>` : ''}
      </div>

      <div class="dash-card">
        <div class="dash-card-head">
          <h3><i data-lucide="zap" style="width:14px;height:14px;color:var(--green)"></i> Quick Wins & Strategisch</h3>
          <span style="font-size:11px;color:var(--text-muted)">${quickWins.length + strategic.length} items</span>
        </div>
        <div class="dash-card-body compact" style="max-height:400px;overflow-y:auto">
          ${quickWins.length > 0 ? quickWins.map(i => `
            <div class="action-item">
              <div class="action-dot green"></div>
              <div class="action-text">${i.tip || i.text}</div>
              ${i.screenshot ? `<img class="action-screenshot" src="${i.screenshot}" onclick="showLightbox('${i.id}',0)" title="Screenshot">` : ''}
            </div>`).join('') : ''}
          ${strategic.length > 0 ? strategic.map(i => `
            <div class="action-item">
              <div class="action-dot blue"></div>
              <div class="action-text">${i.tip || i.text}</div>
              ${i.screenshot ? `<img class="action-screenshot" src="${i.screenshot}" onclick="showLightbox('${i.id}',0)" title="Screenshot">` : ''}
            </div>`).join('') : ''}
          ${quickWins.length === 0 && strategic.length === 0 ? '<div class="action-empty">Geen hoge-impact items gevonden</div>' : ''}
        </div>
      </div>
    </div>

    <div class="dash-grid">
      <div class="dash-card">
        <div class="dash-card-head">
          <h3><i data-lucide="bar-chart-3" style="width:14px;height:14px;color:var(--accent)"></i> Module Scores</h3>
          <span style="font-size:11px;color:var(--text-muted)">${moduleOrder.length} modules · ${catScores.filter(c => c.effective > 0).length} categorieën</span>
        </div>
        <div class="dash-card-body compact" style="max-height:600px;overflow-y:auto">
          ${moduleOrder.map(mId => {
            const mg = moduleGroups[mId];
            const barColor = mg.cls === 'sc-good' ? 'var(--green)' : mg.cls === 'sc-ok' ? 'var(--yellow)' : mg.cls === 'sc-bad' ? 'var(--red)' : 'var(--border)';
            return `
            <div class="mod-group" data-module="${mId}">
              <div class="mod-group-header" onclick="this.parentElement.classList.toggle('collapsed')" style="--mg-color:${mg.color}">
                <div class="mod-group-left">
                  <i data-lucide="${mg.icon}" style="width:14px;height:14px;color:${mg.color}"></i>
                  <span class="mod-group-name">${mg.name}</span>
                  <span class="mod-group-count">${mg.steps.length} checks</span>
                </div>
                <div class="mod-group-right">
                  <div class="mod-group-bar"><div class="mod-group-bar-fill" style="width:${mg.avg >= 0 ? mg.avg * 10 : 0}%;background:${mg.color}"></div></div>
                  <div class="mod-group-score ${mg.cls}">${mg.avg >= 0 ? mg.avg.toFixed(1) : '—'}</div>
                  <div class="mod-group-status ${mg.stCls}">${mg.status}</div>
                  <i data-lucide="chevron-down" class="mod-group-chevron" style="width:12px;height:12px;color:var(--text-muted)"></i>
                </div>
              </div>
              <div class="mod-group-body">
                ${mg.steps.map(c => `
                <div class="cat-row cat-row-sub">
                  <div class="cat-row-score ${c.cls}">${c.avg >= 0 ? c.avg.toFixed(1) : '—'}</div>
                  <div class="cat-row-name">${c.title}</div>
                  <div class="cat-row-bar"><div class="cat-row-fill" style="width:${c.avg >= 0 ? c.avg * 10 : 0}%;background:${c.cls === 'sc-good' ? 'var(--green)' : c.cls === 'sc-ok' ? 'var(--yellow)' : c.cls === 'sc-bad' ? 'var(--red)' : 'var(--border)'}"></div></div>
                  <div class="cat-row-status ${c.stCls}">${c.status}</div>
                </div>`).join('')}
              </div>
            </div>`;
          }).join('')}
        </div>
      </div>

      <div class="dash-card">
        <div class="dash-card-head">
          <h3><i data-lucide="grid-2x2" style="width:14px;height:14px;color:var(--blue)"></i> Prioriteitenmatrix</h3>
        </div>
        <div class="dash-card-body">
          <div class="matrix-compact">
            <div class="mc qw">
              <h4><i data-lucide="zap" style="width:10px;height:10px"></i> Quick Wins</h4>
              <div class="mc-count" style="color:var(--green)">${quickWins.length}</div>
            </div>
            <div class="mc sp">
              <h4><i data-lucide="target" style="width:10px;height:10px"></i> Strategisch</h4>
              <div class="mc-count" style="color:var(--blue)">${strategic.length}</div>
            </div>
            <div class="mc fi">
              <h4><i data-lucide="archive" style="width:10px;height:10px"></i> Opvullers</h4>
              <div class="mc-count" style="color:var(--yellow)">${fillers.length}</div>
            </div>
            <div class="mc nn">
              <h4><i data-lucide="pause" style="width:10px;height:10px"></i> Niet Nu</h4>
              <div class="mc-count" style="color:var(--text-muted)">${notNow.length}</div>
            </div>
          </div>
          <div style="margin-top:12px;font-size:10px;color:var(--text-muted);line-height:1.6">
            <strong style="color:var(--green)">Quick Wins</strong> = Matig + hoge impact ·
            <strong style="color:var(--blue)">Strategisch</strong> = Niet OK + hoge impact<br>
            <strong style="color:var(--yellow)">Opvullers</strong> = Matig + lage impact ·
            <span>Niet Nu</span> = Niet OK + lage impact
          </div>
        </div>
      </div>
    </div>

    <div id="siteInsightsContainer"></div>

    ${allIssues.length > 0 ? `
    <button class="findings-toggle" onclick="toggleFindings()" id="findingsToggle">
      <span><i data-lucide="list" style="width:14px;height:14px"></i> Alle Bevindingen (${allIssues.length})</span>
      <span class="ft-arrow">▼</span>
    </button>
    <div class="findings-body" id="findingsBody">
      ${allIssues.map(i => `
        <div class="issue-row">
          <span class="issue-badge ib-${i.impact}">${i.impact}</span>
          <div style="flex:1;min-width:0">
            <div class="issue-text">${i.text}</div>
            ${i.tip ? `<div class="issue-note" style="color:var(--accent);font-weight:600"><i data-lucide="lightbulb" style="width:14px;height:14px"></i> ${i.tip}</div>` : ''}
            ${i.notes ? `<div class="issue-note">${i.notes}</div>` : ''}
            <div class="issue-note" style="font-style:italic">Categorie: ${i.category}</div>
            ${(i.screenshots||[]).length ? `<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">${i.screenshots.map((s,si) => `<img class="issue-screenshot" src="${s}" onclick="showLightbox('${i.id}',${si})" title="Klik om te vergroten">`).join('')}</div>` : ''}
          </div>
        </div>`).join('')}
    </div>` : ''}
  `;

  document.getElementById('scorecardScreen').classList.remove('hidden');
  if (typeof lucide !== 'undefined') lucide.createIcons();

  // Render Site Insights (premium feature)
  const insightsContainer = document.getElementById('siteInsightsContainer');
  if (insightsContainer) renderSiteInsights(project, overallAvg, insightsContainer);
} catch(e) { console.error('[RenderError] showScorecard:', e); const el = document.getElementById('scorecardContent'); if (el) el.innerHTML = `<div style="padding:24px;text-align:center;color:var(--red)"><p style="font-weight:600">Er ging iets mis bij het laden.</p><p style="font-size:12px;color:var(--text-muted);margin-top:8px">${esc(e.message)}</p><button class="btn btn-secondary" onclick="location.reload()" style="margin-top:12px">Herlaad pagina</button></div>`; } }

// ═══════════════ SITE INSIGHTS (Premium) ═══════════════

function normalizeUrl(url) {
  if (!url) return '';
  try {
    let u = url.trim().toLowerCase();
    if (!/^https?:\/\//i.test(u)) u = 'https://' + u;
    const parsed = new URL(u);
    // Normalize to hostname only (strip www, path, query, hash)
    return parsed.hostname.replace(/^www\./, '');
  } catch(e) { return url.trim().toLowerCase().replace(/^(https?:\/\/)?(www\.)?/, '').split('/')[0]; }
}

function getSameUrlReviews(currentProject) {
  if (!currentProject || !currentProject.url) return [];
  const normUrl = normalizeUrl(currentProject.url);
  return projects
    .filter(p => p.id !== currentProject.id && normalizeUrl(p.url) === normUrl && p.answers && Object.keys(p.answers).length > 0)
    .sort((a, b) => (a.createdAt || '').localeCompare(b.createdAt || ''));
}

function calcProjectScoreSimple(proj) {
  // Simple score calc for site insights — counts all answered questions regardless of module config
  if (!proj || !proj.answers) return null;
  const ans = proj.answers;
  const allQIds = Object.keys(ans);
  const nvt = allQIds.filter(k => ans[k].score === 'nvt').length;
  const scored = allQIds.filter(k => ans[k].score && ans[k].score !== 'nvt');
  const effective = allQIds.length - nvt;
  if (effective === 0) return null;
  const sum = scored.reduce((s, k) => s + (ans[k].score === 'good' ? 10 : ans[k].score === 'ok' ? 6 : 3), 0);
  return { avg: sum / effective, scored: scored.length, effective, date: proj.createdAt || proj.updatedAt || '' };
}

// ── Site Benchmark: write anonymized score to Firestore ──
async function writeSiteBenchmark(project, score) {
  if (!currentUser || !project || !project.url || score == null) return;
  const domain = normalizeUrl(project.url);
  if (!domain) return;
  try {
    const benchRef = db.collection('site_benchmarks').doc(domain);
    const benchDoc = await benchRef.get();
    const now = new Date().toISOString();
    if (benchDoc.exists) {
      const data = benchDoc.data();
      // Update running average
      const entries = data.entries || [];
      // Check if this user already has an entry — update it
      const existingIdx = entries.findIndex(e => e.uid === currentUser.uid && e.projectId === project.id);
      if (existingIdx >= 0) {
        entries[existingIdx] = { uid: currentUser.uid, projectId: project.id, score, date: now };
      } else {
        entries.push({ uid: currentUser.uid, projectId: project.id, score, date: now });
      }
      const avgScore = entries.reduce((s, e) => s + e.score, 0) / entries.length;
      await benchRef.set({ domain, avgScore, reviewCount: entries.length, lastUpdated: now, entries }, { merge: true });
    } else {
      await benchRef.set({
        domain, avgScore: score, reviewCount: 1, lastUpdated: now,
        entries: [{ uid: currentUser.uid, projectId: project.id, score, date: now }]
      });
    }
  } catch(e) { console.warn('[Benchmark] Write failed:', e.message); }
}

// ── Read site benchmark for a domain ──
async function readSiteBenchmark(url) {
  const domain = normalizeUrl(url);
  if (!domain) return null;
  try {
    const benchDoc = await db.collection('site_benchmarks').doc(domain).get();
    if (benchDoc.exists) return benchDoc.data();
  } catch(e) { console.warn('[Benchmark] Read failed:', e.message); }
  return null;
}

// ── SVG sparkline generator ──
function buildSparkline(dataPoints, width, height, color) {
  if (!dataPoints || dataPoints.length < 2) return '';
  const min = Math.min(...dataPoints) - 0.5;
  const max = Math.max(...dataPoints) + 0.5;
  const range = max - min || 1;
  const step = width / (dataPoints.length - 1);
  const points = dataPoints.map((v, i) => `${(i * step).toFixed(1)},${(height - ((v - min) / range) * height).toFixed(1)}`).join(' ');
  const lastY = height - ((dataPoints[dataPoints.length - 1] - min) / range) * height;
  return `<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" style="overflow:visible">
    <polyline points="${points}" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <circle cx="${width}" cy="${lastY.toFixed(1)}" r="3" fill="${color}"/>
  </svg>`;
}

// ── Render Site Insights section ──
function renderSiteInsights(project, currentScore, container) {
  const isPremium = isAdmin || (userProfile && userProfile.plan === 'pro');
  const sameUrlReviews = getSameUrlReviews(project);
  const hasHistory = sameUrlReviews.length > 0;
  const domain = normalizeUrl(project.url);

  // Build score history (past reviews + current)
  const history = sameUrlReviews.map(p => calcProjectScoreSimple(p)).filter(Boolean);
  if (currentScore > 0) history.push({ avg: currentScore, date: project.createdAt || new Date().toISOString() });

  // Calculate delta
  const delta = history.length >= 2 ? history[history.length - 1].avg - history[history.length - 2].avg : null;
  const deltaClass = delta > 0 ? 'delta-up' : delta < 0 ? 'delta-down' : 'delta-flat';
  const deltaIcon = delta > 0 ? 'trending-up' : delta < 0 ? 'trending-down' : 'minus';
  const deltaText = delta !== null ? (delta > 0 ? '+' : '') + delta.toFixed(1) : '—';

  // Sparkline data
  const sparkData = history.map(h => h.avg);

  if (!isPremium) {
    // Show locked premium teaser
    container.innerHTML = `
      <div class="dash-card site-insights-card">
        <div class="dash-card-head">
          <h3><i data-lucide="line-chart" style="width:14px;height:14px;color:var(--accent)"></i> Site Insights</h3>
          <span class="premium-badge"><i data-lucide="crown" style="width:10px;height:10px"></i> Premium</span>
        </div>
        <div class="dash-card-body" style="position:relative;overflow:hidden">
          <div class="insights-locked-overlay">
            <div class="insights-locked-content">
              <i data-lucide="lock" style="width:28px;height:28px;opacity:0.4;margin-bottom:8px"></i>
              <strong>Review Geschiedenis & Benchmarks</strong>
              <p>Zie hoe je scores verbeteren over tijd, vergelijk met andere reviewers, en track je voortgang per module.</p>
              <button class="btn btn-primary btn-sm" onclick="upgradeForAi()" style="margin-top:8px"><i data-lucide="crown" style="width:12px;height:12px"></i> Upgrade naar Pro</button>
            </div>
          </div>
          <div class="insights-preview-blur">
            <div class="insights-grid">
              <div class="insight-stat">
                <div class="insight-stat-label">Reviews dit domein</div>
                <div class="insight-stat-value">${hasHistory ? history.length : '—'}</div>
              </div>
              <div class="insight-stat">
                <div class="insight-stat-label">Score trend</div>
                <div class="insight-stat-value">—</div>
              </div>
              <div class="insight-stat">
                <div class="insight-stat-label">Community gemiddelde</div>
                <div class="insight-stat-value">—</div>
              </div>
            </div>
          </div>
        </div>
      </div>`;
  } else {
    // Full premium view
    // Async: fetch community benchmark
    const benchmarkPlaceholder = 'si-benchmark-' + Date.now();
    container.innerHTML = `
      <div class="dash-card site-insights-card">
        <div class="dash-card-head">
          <h3><i data-lucide="line-chart" style="width:14px;height:14px;color:var(--accent)"></i> Site Insights</h3>
          <span class="premium-badge active"><i data-lucide="crown" style="width:10px;height:10px"></i> Pro</span>
        </div>
        <div class="dash-card-body">
          <div class="insights-domain"><i data-lucide="globe" style="width:12px;height:12px"></i> ${domain || project.url}</div>
          <div class="insights-grid">
            <div class="insight-stat">
              <div class="insight-stat-label">Reviews</div>
              <div class="insight-stat-value">${history.length}</div>
              <div class="insight-stat-sub">${hasHistory ? 'van dit domein' : 'eerste review'}</div>
            </div>
            <div class="insight-stat">
              <div class="insight-stat-label">Trend</div>
              <div class="insight-stat-value ${deltaClass}">${delta !== null ? `<i data-lucide="${deltaIcon}" style="width:16px;height:16px"></i> ${deltaText}` : '—'}</div>
              <div class="insight-stat-sub">${delta !== null ? (delta > 0 ? 'verbeterd' : delta < 0 ? 'verslechterd' : 'stabiel') + ' t.o.v. vorige' : 'geen vorige review'}</div>
            </div>
            <div class="insight-stat" id="${benchmarkPlaceholder}">
              <div class="insight-stat-label">Community</div>
              <div class="insight-stat-value">
                <span class="insight-loading"><i data-lucide="loader" style="width:14px;height:14px;animation:spin 1s linear infinite"></i></span>
              </div>
              <div class="insight-stat-sub">laden...</div>
            </div>
          </div>
          ${sparkData.length >= 2 ? `
          <div class="insights-chart">
            <div class="insights-chart-label">Score verloop</div>
            <div class="insights-chart-body">
              ${buildSparkline(sparkData, 280, 50, currentScore >= 7.5 ? '#22c55e' : currentScore >= 5 ? '#eab308' : '#ef4444')}
              <div class="insights-chart-points">
                ${history.map((h, i) => `<span class="insights-point">${h.avg.toFixed(1)}${h.date ? '<br><small>' + new Date(h.date).toLocaleDateString('nl-NL', {day:'numeric',month:'short'}) + '</small>' : ''}</span>`).join('')}
              </div>
            </div>
          </div>` : `
          <div class="insights-empty-chart">
            <i data-lucide="trending-up" style="width:20px;height:20px;opacity:0.2"></i>
            <span>Doe nog een review van ${domain || 'dit domein'} om je voortgang te zien</span>
          </div>`}
          ${hasHistory ? `
          <div class="insights-history">
            <div class="insights-history-label">Eerdere reviews</div>
            ${sameUrlReviews.map(p => {
              const s = calcProjectScoreSimple(p);
              const sClass = !s ? 'sc-na' : s.avg >= 7.5 ? 'sc-good' : s.avg >= 5 ? 'sc-ok' : 'sc-bad';
              return `<div class="insights-history-row">
                <span class="insights-h-score ${sClass}">${s ? s.avg.toFixed(1) : '—'}</span>
                <span class="insights-h-name">${p.name}</span>
                <span class="insights-h-date">${p.createdAt ? new Date(p.createdAt).toLocaleDateString('nl-NL') : '—'}</span>
              </div>`;
            }).join('')}
          </div>` : ''}
        </div>
      </div>`;

    // Async: load community benchmark
    readSiteBenchmark(project.url).then(bench => {
      const el = document.getElementById(benchmarkPlaceholder);
      if (!el) return;
      if (bench && bench.reviewCount > 0) {
        const otherCount = bench.entries ? bench.entries.filter(e => e.uid !== (currentUser?.uid || '')).length : 0;
        const benchClass = bench.avgScore >= 7.5 ? 'sc-good' : bench.avgScore >= 5 ? 'sc-ok' : 'sc-bad';
        const diff = currentScore - bench.avgScore;
        const diffText = diff > 0 ? '+' + diff.toFixed(1) + ' boven' : diff < 0 ? diff.toFixed(1) + ' onder' : 'gelijk aan';
        el.innerHTML = `
          <div class="insight-stat-label">Community</div>
          <div class="insight-stat-value ${benchClass}">${bench.avgScore.toFixed(1)}</div>
          <div class="insight-stat-sub">${bench.reviewCount} review${bench.reviewCount !== 1 ? 's' : ''}${otherCount > 0 ? ' · ' + diffText + ' gem.' : ''}</div>`;
      } else {
        el.innerHTML = `
          <div class="insight-stat-label">Community</div>
          <div class="insight-stat-value" style="color:var(--text-muted)">—</div>
          <div class="insight-stat-sub">nog geen data</div>`;
      }
      if (typeof lucide !== 'undefined') lucide.createIcons();
    });

    // Write current score to benchmark
    if (currentScore > 0) writeSiteBenchmark(project, currentScore);
  }

  if (typeof lucide !== 'undefined') lucide.createIcons();
}

function submitLeadGate() {
  const email = document.getElementById('upsellEmail').value.trim();
  if (!email || !email.includes('@')) { alert('Vul een geldig e-mailadres in.'); return; }
  const project = getActiveProject();
  if (project) { project.leadEmail = email; project.leadDate = new Date().toISOString(); saveState(); }
  // Unlock the scorecard
  const details = document.getElementById('scorecardDetails');
  if (details) details.classList.remove('lead-gated');
  document.getElementById('upsellForm').classList.add('hidden');
  document.getElementById('upsellSuccess').classList.remove('hidden');
  // Update dashboard stats
  setTimeout(() => { renderDashboard(); }, 500);
}

function closeScorecard() { document.getElementById('scorecardScreen').classList.add('hidden'); }

function toggleFindings() {
  const toggle = document.getElementById('findingsToggle');
  const body = document.getElementById('findingsBody');
  if (!toggle || !body) return;
  const isOpen = toggle.classList.toggle('open');
  body.classList.toggle('open', isOpen);
}

function backToDashboardFromScorecard() {
  document.getElementById('scorecardScreen').classList.add('hidden');
  document.getElementById('reviewScreen').classList.add('hidden');
  clearUrlParam('p');
  showDashboard();
}

// ═══════════════ EXPORT ═══════════════
function exportResults() {
  saveCurrentAnswers();
  const project = getActiveProject();
  const answers = project ? project.answers : {};
  const isQuickScan = !!project?.selectedTemplate;
  const tplBundle = isQuickScan && typeof MODULE_REGISTRY !== 'undefined' ? MODULE_REGISTRY.bundles[project.selectedTemplate] : null;
  const lines = [];

  if (isQuickScan && tplBundle) {
    // ── QUICK SCAN: kort, gericht rapport ──
    const typeName = tplBundle.name_nl.replace(' Quick Scan', '');
    lines.push('══════════════════════════════════════════');
    lines.push(`  ${typeName} QUICK SCAN`);
    lines.push('══════════════════════════════════════════');
    lines.push('');
    lines.push(`Project:  ${project?.name||'—'}`);
    lines.push(`URL:      ${project?.url||'—'}`);
    lines.push(`Datum:    ${new Date().toLocaleDateString('nl-NL')}`);
    lines.push('');

    const expScore = calcProjectScore(project || { answers: {} });
    lines.push(`SCORE: ${expScore.avg.toFixed(1)} / 10`);
    lines.push('');

    // Collect issues sorted by severity
    const issues = [];
    const good = [];
    reviewSteps.forEach(step => {
      step.questions.forEach(q => {
        const a = answers[q.id]; if (!a?.score || a.score === 'nvt') return;
        const sev = q.severity || q.priority || 'medium';
        if (a.score === 'bad' || a.score === 'ok') {
          issues.push({ q, a, sev, score: a.score });
        } else {
          good.push({ q, a });
        }
      });
    });

    // Sort: critical first, then high, then medium
    const sevOrder = { critical: 0, high: 1, medium: 2, low: 3 };
    issues.sort((a, b) => (sevOrder[a.sev]||3) - (sevOrder[b.sev]||3));

    if (issues.length > 0) {
      lines.push('🔴 FIX NU — Kritieke problemen');
      lines.push('─────────────────────────────');
      const critical = issues.filter(i => i.sev === 'critical' || i.score === 'bad');
      critical.forEach(i => {
        lines.push(`• ${i.q.text}`);
        if (i.q.business_impact_nl) lines.push(`  Impact: ${i.q.business_impact_nl}`);
        if (i.q.fix_suggestion_nl) lines.push(`  Fix: ${i.q.fix_suggestion_nl}`);
        if (i.a.notes) lines.push(`  Notitie: ${i.a.notes.replace(/\[Auto-scan\]\s*/g, '').trim()}`);
        lines.push('');
      });

      const plan = issues.filter(i => i.sev !== 'critical' && i.score !== 'bad');
      if (plan.length > 0) {
        lines.push('🟡 PLAN IN — Verbeterpunten');
        lines.push('─────────────────────────────');
        plan.forEach(i => {
          lines.push(`• ${i.q.text}`);
          if (i.q.fix_suggestion_nl) lines.push(`  Fix: ${i.q.fix_suggestion_nl}`);
          lines.push('');
        });
      }
    }

    if (good.length > 0) {
      lines.push(`🟢 GOED — ${good.length} punten scoren goed`);
      lines.push('');
    }

    // Top 3 priorities
    lines.push('── TOP 3 PRIORITEITEN ──');
    lines.push('');
    issues.slice(0, 3).forEach((i, idx) => {
      lines.push(`${idx+1}. ${i.q.text}`);
      if (i.q.fix_suggestion_nl) lines.push(`   → ${i.q.fix_suggestion_nl}`);
      lines.push('');
    });

  } else {
    // ── VOLLEDIGE AUDIT: uitgebreid format ──
    lines.push('══════════════════════════════════════════');
    lines.push('  BOLD700 UX REVIEW RESULTATEN');
    lines.push('══════════════════════════════════════════');
    lines.push('');
    lines.push(`Project:     ${project?.name||'—'}`);
    lines.push(`Klant:       ${project?.client||'—'}`);
    lines.push(`URL:         ${project?.url||'—'}`);
    lines.push(`Datum:       ${new Date().toLocaleDateString('nl-NL')}`);
    lines.push('');

    const expScore = calcProjectScore(project || { answers: {} });
    lines.push(`TOTAALSCORE: ${expScore.avg.toFixed(1)} / 10 (gewogen)`);
    lines.push(`(${expScore.answered} beoordeeld, ${expScore.nvt||0} n.v.t., ${expScore.effectiveTotal - expScore.answered} onbeantwoord = 0 punten)`);
    lines.push('');
    lines.push('── SCORES PER CATEGORIE ──');
    lines.push('');

    reviewSteps.forEach(step => {
      const ws = calcWeightedScore(step.questions, answers);
      const stepNvt = step.questions.filter(q => answers[q.id]?.score === 'nvt').length;
      const effective = step.questions.length - stepNvt;
      const status = effective === 0 ? 'Alles n.v.t.' : ws.score >= 8 ? 'Goed' : ws.score >= 5 ? 'Aandacht nodig' : 'Kritiek';
      lines.push(`${step.title.padEnd(40)} ${effective>0?ws.score.toFixed(1):'—'}/10  [${status}]${stepNvt > 0 ? ` (${stepNvt} n.v.t.)` : ''}`);
    });

    lines.push('');
    lines.push('── BEVINDINGEN ──');
    lines.push('');
    let n = 1;
    reviewSteps.forEach(step => {
      step.questions.forEach(q => {
        const a = answers[q.id]; if (!a?.score) return;
        if (a.score === 'nvt') { lines.push(`  #${n++} ${q.text}`); lines.push('     ○ N.v.t.'); lines.push(''); return; }
        const lbl = a.score==='good'?'✓ Goed':a.score==='ok'?'~ Matig':'✗ Niet OK';
        lines.push(`  #${n++} ${q.text}`);
        lines.push(`     ${lbl}${q.severity?' ['+q.severity.toUpperCase()+']':''}`);
        if (a.notes) lines.push(`     ${a.notes}`);
        lines.push('');
      });
    });
  }

  lines.push('══════════════════════════════════════════');
  lines.push('  Gegenereerd door BOLD700 UX Review Tool');
  lines.push('══════════════════════════════════════════');

  document.getElementById('exportContent').textContent = lines.join('\n');
  document.getElementById('exportModal').classList.remove('hidden');
}

function copyExport() {
  navigator.clipboard.writeText(document.getElementById('exportContent').textContent).then(() => {
    const btn = event.target;
    btn.innerHTML = '<i data-lucide="check" style="width:14px;height:14px"></i> Gekopieerd!'; lucide.createIcons({nodes:[btn]});
    setTimeout(() => btn.textContent = 'Kopieer naar Klembord', 2000);
  });
}

function closeExport() { document.getElementById('exportModal').classList.add('hidden'); }

// ═══════════════ AI ACTIEPLAN (Cloudflare Worker Proxy) ═══════════════
// Proxy URL is loaded from Firestore (admin-configured). API key stays on the server, never in the browser.
let _aiProxyUrl = null;

async function loadAiConfig() {
  try {
    const doc = await db.collection('config').doc('ai').get();
    if (doc.exists && doc.data().proxyUrl) {
      _aiProxyUrl = doc.data().proxyUrl;
    }
  } catch(e) {
    console.warn('[AI] Could not load AI config:', e.message);
  }
}

async function saveAiConfig(proxyUrl) {
  if (!isAdmin) return;
  try {
    await db.collection('config').doc('ai').set({ proxyUrl: proxyUrl, updatedAt: new Date().toISOString() });
    _aiProxyUrl = proxyUrl;
    showScanToast('success', 'Proxy URL opgeslagen', 'AI Actieplan is nu beschikbaar.', 3000);
    renderAdminConfig();
  } catch(e) {
    showScanToast('error', 'Opslaan mislukt', e.message, 4000);
  }
}

function getAiProxyUrl() { return _aiProxyUrl || ''; }

function isAiAvailable() {
  const project = getActiveProject();
  return project && project.mode === 'professional' && !!getAiProxyUrl();
}

function upgradeForAi() {
  const project = getActiveProject();
  if (!project) return;
  const upgrade = confirm('Upgrade naar Professional om het AI Actieplan te gebruiken.\n\nProfessional bevat:\n• AI Actieplan — klantgerichte actiepunten\n• Auto-Scan — automatische website analyse\n• Prioriteitenmatrix\n• Volledige exportopties\n\nWil je upgraden?');
  if (upgrade) {
    project.mode = 'professional';
    saveState();
    showScorecard(); // Re-render with AI enabled
  }
}

function buildAiPromptData() {
  const project = getActiveProject();
  if (!project) return null;
  const answers = project.answers || {};

  const issues = [];
  const strengths = [];

  // ── FREE-FORM: lees direct uit answers in plaats van reviewSteps ──
  if (project.reviewType === 'free-form') {
    Object.keys(answers).filter(k => k.startsWith('ff-')).forEach(fId => {
      const a = answers[fId];
      if (!a || !a.score) return;
      const cats = a.findingCategories || (a.findingCategory ? [a.findingCategory] : []);
      const catLabel = cats.map(c => FF_CAT_LABELS[c] || c).join(', ') || 'Overig';
      const label = a.findingTitle || (a.notes || '').split('\n')[0].substring(0, 80) || 'Bevinding';
      const item = {
        category: catLabel,
        question: label,
        score: a.score,
        impact: a.severity || 'low',
        notes: (a.notes || '').trim(),
        tip: ''
      };
      if (a.score === 'bad' || a.score === 'ok') issues.push(item);
      else strengths.push(item);
    });
  } else {
    reviewSteps.forEach(step => {
      step.questions.forEach(q => {
        const a = answers[q.id];
        if (!a || !a.score || a.score === 'nvt') return;
        const item = {
          category: step.shortTitle,
          question: q.text,
          score: a.score,
          impact: a.severity || step.impact || 'low',
          notes: (a.notes || '').replace(/\[Auto-scan\]\s*/g, '').trim(),
          tip: questionTips[q.id] || ''
        };
        if (a.score === 'bad' || a.score === 'ok') issues.push(item);
        else strengths.push(item);
      });
    });
  }

  // Sort: high impact first
  issues.sort((a, b) => (a.impact === 'high' ? 0 : 1) - (b.impact === 'high' ? 0 : 1));

  const totalQ = project.reviewType === 'free-form'
    ? Object.keys(answers).filter(k => k.startsWith('ff-')).length
    : reviewSteps.reduce((s, st) => s + st.questions.length, 0);

  return {
    project: { name: project.name, client: project.client, url: project.url },
    issues,
    strengths: strengths.length,
    totalQuestions: totalQ
  };
}

async function generateAiPlan() {
  const project = getActiveProject();
  if (!project || (project.mode === 'self-service' && project.reviewType !== 'free-form')) { upgradeForAi(); return; }

  const proxyUrl = getAiProxyUrl();
  if (!proxyUrl) { alert('AI Actieplan is momenteel niet beschikbaar. Neem contact op met BOLD700.'); return; }

  const data = buildAiPromptData();
  if (!data || data.issues.length === 0) {
    document.getElementById('aiPlanBody').innerHTML = '<div class="ai-plan-empty">Geen verbeterpunten gevonden — alles is goed beoordeeld!</div>';
    return;
  }

  const btn = document.getElementById('btnAiPlan');
  if (btn) { btn.disabled = true; btn.innerHTML = '<i data-lucide="loader"></i> Genereren…'; lucide.createIcons({nodes:[btn]}); }

  const body = document.getElementById('aiPlanBody');
  body.innerHTML = '<div class="ai-plan-empty ai-loading"><i data-lucide="sparkles" style="width:32px;height:32px;opacity:0.5;margin-bottom:8px;display:block;margin-inline:auto"></i>AI analyseert de review resultaten…</div>';
  if (typeof lucide !== 'undefined') lucide.createIcons({nodes:[body]});

  const issuesSummary = data.issues.map(i => {
    const scoreLabel = i.score === 'bad' ? 'Niet OK' : 'Matig';
    const impactLabel = i.impact === 'high' ? 'Hoog' : 'Laag';
    let line = `- [${scoreLabel}] [Impact: ${impactLabel}] ${i.question}`;
    if (i.notes) line += ` | Notitie reviewer: "${i.notes}"`;
    if (i.tip) line += ` | Suggestie: ${i.tip}`;
    line += ` (${i.category})`;
    return line;
  }).join('\n');

  const systemPrompt = `Je bent een senior UX consultant van BOLD700, een bureau dat bedrijven helpt met UX design en development. Je schrijft in het Nederlands, direct en to-the-point. Geen vakjargon — schrijf alsof je tegen een ondernemer of marketing manager praat.

Je doel: maak een kort, helder actieplan dat de klant overtuigt om te investeren in verbeteringen. Focus op RESULTAAT en BUSINESS IMPACT, niet op technische details.`;

  const isFreeForm = project?.reviewType === 'free-form';
  const userPrompt = `Hier zijn de resultaten van een ${isFreeForm ? 'vrije expert review' : 'UX review'} van ${data.project.url || 'een website'}${data.project.name ? ' ('+data.project.name+')' : ''}${data.project.client ? ' voor '+data.project.client : ''}.

${isFreeForm
  ? `De reviewer heeft ${data.totalQuestions} bevindingen genoteerd: ${data.issues.length} verbeterpunten en ${data.strengths} sterke punten. Dit is een vrije review — de bevindingen zijn door de expert zelf gekozen, niet uit een checklist.`
  : `Van de ${data.totalQuestions} beoordeelde punten zijn er ${data.issues.length} verbeterpunten gevonden en ${data.strengths} punten goed beoordeeld.`}

VERBETERPUNTEN:
${issuesSummary}

Maak een klantgericht actieplan met deze structuur:

## Samenvatting
Een korte samenvatting (2-3 zinnen) over de staat van de website. Begin positief (wat gaat goed), dan wat er beter kan.

## Top Prioriteiten
De 3-5 belangrijkste acties. Per actie:
### [Korte titel]
**Wat:** Wat moet er gebeuren (1 zin, simpel)
**Waarom:** Wat levert het op voor de business (meer leads, minder uitval, betere vindbaarheid, etc.)
**Impact:** Hoog/Midden/Laag
**Effort:** Klein/Middel/Groot

## Quick Wins
Punten die snel gefixt kunnen worden met groot effect. Kort en bondig, max 5 items als bullet points.

## Overige Aanbevelingen
De rest van de verbeterpunten, gegroepeerd en kort samengevat. Niet elk punt apart — groepeer gerelateerde items.

Regels:
- Schrijf in het Nederlands
- Gebruik GEEN technische termen (geen WCAG codes, geen HTML-termen, geen developer jargon)
- Focus op wat het de klant OPLEVERT (meer klanten, minder uitval, betere Google positie, professionelere uitstraling)
- Wees concreet maar kort
- Gebruik Markdown formatting`;

  // Rate limiting check
  if (!canCallAI()) {
    body.innerHTML = '<div class="ai-plan-empty" style="color:var(--orange)"><i data-lucide="alert-triangle" style="width:32px;height:32px;opacity:0.7;margin-bottom:8px;display:block;margin-inline:auto"></i>Je hebt het maximum van ' + AI_RATE_LIMIT.maxPerHour + ' AI-verzoeken per uur bereikt. Probeer het later opnieuw.</div>';
    if (typeof lucide !== 'undefined') lucide.createIcons({nodes:[body]});
    if (btn) { btn.disabled = false; btn.innerHTML = '<i data-lucide="sparkles"></i> Genereer AI Actieplan'; lucide.createIcons({nodes:[btn]}); }
    return;
  }
  trackAICall();

  try {
    const resp = await fetch(proxyUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 2000,
        system: systemPrompt,
        messages: [{ role: 'user', content: userPrompt }]
      })
    });

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      throw new Error(err.error?.message || `API fout (${resp.status})`);
    }

    const result = await resp.json();
    const text = result.content?.[0]?.text || 'Geen resultaat ontvangen';

    // Simple Markdown → HTML conversion
    const html = markdownToHtml(text);

    body.innerHTML = `<div class="ai-plan-content">${html}</div>`;
    // Add action bar
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'ai-plan-actions';
    actionsDiv.innerHTML = `
      <button class="btn btn-secondary" onclick="copyAiPlan()"><i data-lucide="copy" style="width:12px;height:12px"></i> Kopieer</button>
      <button class="btn btn-secondary" onclick="generateAiPlan()"><i data-lucide="refresh-cw" style="width:12px;height:12px"></i> Opnieuw</button>
    `;
    body.parentElement.appendChild(actionsDiv);

    // Store in project
    if (project) { project.aiPlan = text; project.aiPlanDate = new Date().toISOString(); saveState(); }

  } catch(err) {
    const msg = err.message || 'Onbekende fout';
    body.innerHTML = `<div class="ai-plan-empty" style="color:var(--red)">
      <i data-lucide="alert-circle" style="width:32px;height:32px;opacity:0.5;margin-bottom:8px;display:block;margin-inline:auto"></i>
      ${msg.includes('401') || msg.includes('auth') ? 'AI service configuratiefout. Neem contact op met BOLD700.' :
        msg.includes('429') ? 'De AI is even druk bezet. Probeer het over een minuut opnieuw.' :
        msg.includes('fetch') || msg.includes('network') || msg.includes('Failed') ? 'Geen verbinding met de AI service. Controleer je internetverbinding en probeer opnieuw.' :
        'Er ging iets mis: ' + msg.substring(0, 60) + '. Probeer het opnieuw.'}
    </div>`;
    if (typeof lucide !== 'undefined') lucide.createIcons({nodes:[body]});
  }

  if (btn) { btn.disabled = false; btn.innerHTML = '<i data-lucide="sparkles"></i> Genereer Actieplan'; lucide.createIcons({nodes:[btn]}); }
}

function markdownToHtml(md) {
  let html = md
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    // Headers
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^# (.+)$/gm, '<h2>$1</h2>')
    // Bold + italic
    .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    // Blockquote
    .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
    // Lists
    .replace(/^- (.+)$/gm, '<li>$1</li>')
    .replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>');

  // Wrap consecutive <li> in <ul>
  html = html.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
  // Paragraphs (lines not already wrapped)
  html = html.split('\n').map(line => {
    const trimmed = line.trim();
    if (!trimmed) return '';
    if (trimmed.startsWith('<h') || trimmed.startsWith('<ul') || trimmed.startsWith('<li') ||
        trimmed.startsWith('<blockquote') || trimmed.startsWith('</')) return line;
    return `<p>${line}</p>`;
  }).join('\n');

  return html;
}

function copyAiPlan() {
  const project = getActiveProject();
  if (project?.aiPlan) {
    navigator.clipboard.writeText(project.aiPlan).then(() => {
      const btns = document.querySelectorAll('.ai-plan-actions button');
      if (btns[0]) { btns[0].innerHTML = '<i data-lucide="check" style="width:12px;height:12px"></i> Gekopieerd!'; lucide.createIcons({nodes:[btns[0]]}); setTimeout(() => { btns[0].innerHTML = '<i data-lucide="copy" style="width:12px;height:12px"></i> Kopieer'; lucide.createIcons({nodes:[btns[0]]}); }, 2000); }
    });
  }
}

// ═══════════════ CONTRAST CHECKER ═══════════════

function toggleContrastChecker() {
  document.getElementById('contrastPanel').classList.toggle('open');
  updateContrast();
}

// WCAG relative luminance calculation
function getLuminance(hex) {
  const r = parseInt(hex.slice(1,3), 16) / 255;
  const g = parseInt(hex.slice(3,5), 16) / 255;
  const b = parseInt(hex.slice(5,7), 16) / 255;
  const toLinear = c => c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
  return 0.2126 * toLinear(r) + 0.7152 * toLinear(g) + 0.0722 * toLinear(b);
}

function getContrastRatio(hex1, hex2) {
  const l1 = getLuminance(hex1);
  const l2 = getLuminance(hex2);
  const lighter = Math.max(l1, l2);
  const darker = Math.min(l1, l2);
  return (lighter + 0.05) / (darker + 0.05);
}

function updateContrast() {
  const fg = document.getElementById('ccFg').value;
  const bg = document.getElementById('ccBg').value;
  const ratio = getContrastRatio(fg, bg);

  // Preview
  const preview = document.getElementById('ccPreview');
  preview.style.color = fg;
  preview.style.background = bg;

  // Ratio display
  const ratioEl = document.getElementById('ccRatio');
  ratioEl.textContent = ratio.toFixed(2) + ':1';
  ratioEl.style.color = ratio >= 4.5 ? 'var(--green)' : ratio >= 3 ? 'var(--yellow)' : 'var(--red)';

  // WCAG results
  const check = (el, threshold) => {
    const pass = ratio >= threshold;
    el.innerHTML = pass ? '<i data-lucide="check" style="width:12px;height:12px"></i> Slaagt' : '<i data-lucide="x" style="width:12px;height:12px"></i> Faalt'; lucide.createIcons({nodes:[el]});
    el.className = 'cc-status ' + (pass ? 'pass' : 'fail');
  };
  check(document.getElementById('ccAAnorm'), 4.5);
  check(document.getElementById('ccAAlarge'), 3);
  check(document.getElementById('ccAAAnorm'), 7);
  check(document.getElementById('ccAAAlarge'), 4.5);
}

function syncColorText(colorId, textId) {
  document.getElementById(textId).value = document.getElementById(colorId).value.toUpperCase();
}

function syncColorPicker(textId, colorId) {
  let val = document.getElementById(textId).value;
  if (!val.startsWith('#')) val = '#' + val;
  if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
    document.getElementById(colorId).value = val;
  }
}

function swapColors() {
  const fg = document.getElementById('ccFg').value;
  const bg = document.getElementById('ccBg').value;
  document.getElementById('ccFg').value = bg;
  document.getElementById('ccBg').value = fg;
  document.getElementById('ccFgHex').value = bg.toUpperCase();
  document.getElementById('ccBgHex').value = fg.toUpperCase();
  updateContrast();
}

// ── Inline contrast checker (embedded in step) ──
function updateInlineCC() {
  const fgEl = document.getElementById('iccFg');
  const bgEl = document.getElementById('iccBg');
  if (!fgEl || !bgEl) return;
  const fg = fgEl.value;
  const bg = bgEl.value;
  const ratio = getContrastRatio(fg, bg);

  const preview = document.getElementById('iccPreview');
  if (preview) { preview.style.color = fg; preview.style.background = bg; }

  const ratioEl = document.getElementById('iccRatio');
  if (ratioEl) {
    ratioEl.textContent = ratio.toFixed(2) + ':1';
    ratioEl.style.color = ratio >= 4.5 ? 'var(--green)' : ratio >= 3 ? 'var(--yellow)' : 'var(--red)';
  }

  const check = (id, threshold) => {
    const el = document.getElementById(id);
    if (!el) return;
    const pass = ratio >= threshold;
    el.textContent = pass ? '✓' : '✗';
    el.style.color = pass ? 'var(--green)' : 'var(--red)';
  };
  check('iccAAnorm', 4.5);
  check('iccAAlarge', 3);
  check('iccAAAnorm', 7);
  check('iccAAAlarge', 4.5);
}

function swapInlineCC() {
  const fgEl = document.getElementById('iccFg');
  const bgEl = document.getElementById('iccBg');
  if (!fgEl || !bgEl) return;
  const fg = fgEl.value;
  const bg = bgEl.value;
  fgEl.value = bg; bgEl.value = fg;
  document.getElementById('iccFgHex').value = bg.toUpperCase();
  document.getElementById('iccBgHex').value = fg.toUpperCase();
  updateInlineCC();
}

function setContrastColors(fg, bg) {
  document.getElementById('ccFg').value = fg;
  document.getElementById('ccBg').value = bg;
  document.getElementById('ccFgHex').value = fg.toUpperCase();
  document.getElementById('ccBgHex').value = bg.toUpperCase();
  updateContrast();
}

// ═══════════════ INIT ═══════════════
function initLogos() {
  const logoMap = { dashLogo: '28px', npLogo: '36px', reviewLogo: '24px', landingLogo: '28px', authLogo: '36px' };
  for (const [id, size] of Object.entries(logoMap)) {
    const el = document.getElementById(id);
    if (el) el.innerHTML = brandLogo(size, id === 'authLogo' || id === 'dashLogo');
  }
}

// ═══════════════ PREVIEW / LEAD GENERATION MODE ═══════════════

async function loadPreview(projectId) {
  try {
    const doc = await db.collection('projects').doc(projectId).get();
    if (!doc.exists) { showPreviewError('Project niet gevonden'); return; }
    const project = { ...doc.data(), id: doc.id };
    if (!project.previewMode || !project.previewConfig?.enabled) {
      showPreviewError('Deze preview is niet meer beschikbaar');
      return;
    }
    renderPreview(project);
  } catch(e) {
    console.error('[Preview]', e);
    showPreviewError('Kon preview niet laden');
  }
}

function renderPreview(project) {
  document.querySelectorAll('#authScreen, #dashboardScreen, #newProjectScreen, #reviewScreen, #scorecardScreen')
    .forEach(el => el.classList.add('hidden'));
  const screen = document.getElementById('previewScreen');
  screen.classList.remove('hidden');
  const config = project.previewConfig;
  const answers = project.answers || {};

  // Build review steps for this project
  let steps;
  if (typeof buildReviewSteps === 'function') {
    steps = buildReviewSteps(project.moduleConfig || (typeof getDefaultModuleConfig === 'function' ? getDefaultModuleConfig() : null));
  } else {
    steps = typeof reviewSteps !== 'undefined' ? reviewSteps : [];
  }

  // Collect ALL findings that have a score
  const allFindings = [];
  steps.forEach((step, stepIndex) => {
    step.questions.forEach(q => {
      const a = answers[q.id];
      if (!a?.score || a.score === 'nvt') return;
      allFindings.push({
        question: q, answer: a, step: step, stepIndex: stepIndex,
        severity: q.severity || q.priority || step.impact || 'medium',
        isNegative: a.score === 'bad' || a.score === 'ok'
      });
    });
  });

  // Sort: bad first, then ok, then good. Within each group: critical > high > medium
  const sevOrder = { critical: 0, high: 1, medium: 2, low: 3 };
  const scoreOrder = { bad: 0, ok: 1, good: 2 };
  allFindings.sort((a, b) => {
    const scoreDiff = (scoreOrder[a.answer.score] || 2) - (scoreOrder[b.answer.score] || 2);
    if (scoreDiff !== 0) return scoreDiff;
    return (sevOrder[a.severity] || 2) - (sevOrder[b.severity] || 2);
  });

  const maxVisible = config.visibleFindings || 5;
  const negativeFindings = allFindings.filter(f => f.isNegative);
  const visibleFindings = negativeFindings.slice(0, maxVisible);
  const lockedCount = negativeFindings.length - visibleFindings.length;
  const goodCount = allFindings.filter(f => f.answer.score === 'good').length;

  // Total score
  const scored = allFindings.filter(f => f.answer.score !== 'nvt');
  const totalScore = scored.length > 0
    ? scored.reduce((sum, f) => sum + (f.answer.score === 'good' ? 10 : f.answer.score === 'ok' ? 5 : 0), 0) / scored.length
    : 0;
  const scoreColor = totalScore >= 8 ? 'var(--green)' : totalScore >= 5 ? 'var(--yellow)' : 'var(--red)';

  // Template label
  let scanLabel = 'Volledige UX Audit';
  if (project.selectedTemplate && typeof MODULE_REGISTRY !== 'undefined') {
    const bundle = MODULE_REGISTRY.bundles[project.selectedTemplate];
    if (bundle) scanLabel = bundle.name_nl.replace(' Quick Scan', '') + ' Quick Scan';
  }

  // Domain
  let domain = project.url || '';
  try { domain = new URL(domain.startsWith('http') ? domain : 'https://' + domain).hostname; } catch(e) {}

  const badCount = allFindings.filter(f => f.answer.score === 'bad').length;
  const okCount = allFindings.filter(f => f.answer.score === 'ok').length;

  screen.innerHTML = `
    <div class="preview-container">
      <div class="preview-header">
        <div class="preview-logo">
          ${typeof brandLogo === 'function' ? brandLogo('28px', false) : '<strong>BOLD700</strong>'}
          <span class="preview-logo-text">UX Review Platform</span>
        </div>
      </div>

      <div class="preview-hero">
        ${config.customMessage ? `<div class="preview-custom-msg">${esc(config.customMessage)}</div>` : ''}
        <div class="preview-score-row">
          <div class="preview-score-circle" style="border-color:${scoreColor}">
            <div class="preview-score-num" style="color:${scoreColor}">${totalScore.toFixed(1)}</div>
            <div class="preview-score-label">/ 10</div>
          </div>
          <div class="preview-meta">
            <h1 class="preview-title">UX Review voor <span style="color:var(--accent)">${esc(domain)}</span></h1>
            <div class="preview-meta-row">
              <span>${esc(scanLabel)}</span>
              <span>·</span>
              <span>${scored.length} checks uitgevoerd</span>
              <span>·</span>
              <span>${new Date(project.createdAt || Date.now()).toLocaleDateString('nl-NL', { day: 'numeric', month: 'long', year: 'numeric' })}</span>
            </div>
            <div class="preview-summary">
              <span class="preview-tag bad">${badCount} kritiek</span>
              <span class="preview-tag ok">${okCount} verbeterpunten</span>
              <span class="preview-tag good">${goodCount} goed</span>
            </div>
          </div>
        </div>
      </div>

      <div class="preview-findings">
        <h2>Bevindingen</h2>
        ${visibleFindings.map(f => `
          <div class="preview-finding ${f.answer.score}">
            <div class="preview-finding-header">
              <span class="preview-finding-badge ${f.answer.score}">${f.answer.score === 'bad' ? '✗ Kritiek' : '~ Verbeterpunt'}</span>
              ${f.severity === 'critical' || f.severity === 'high' ? '<span class="preview-finding-sev">Hoge impact</span>' : ''}
            </div>
            <div class="preview-finding-text">${esc(f.question.text)}</div>
            ${f.answer.notes ? `<div class="preview-finding-notes">${esc(f.answer.notes).substring(0, 200)}${f.answer.notes.length > 200 ? '…' : ''}</div>` : ''}
            ${f.question.business_impact_nl ? `<div class="preview-finding-impact"><strong>Impact:</strong> ${esc(f.question.business_impact_nl)}</div>` : ''}
            ${f.question.fix_suggestion_nl ? `<div class="preview-finding-fix"><strong>Aanbeveling:</strong> ${esc(f.question.fix_suggestion_nl)}</div>` : ''}
          </div>
        `).join('')}

        ${lockedCount > 0 ? `
        <div class="preview-locked-section">
          <div class="preview-locked-overlay">
            <div class="preview-locked-icon">🔒</div>
            <div class="preview-locked-title">Nog ${lockedCount} bevindingen beschikbaar</div>
            <div class="preview-locked-desc">Unlock de volledige scan voor alle bevindingen, een concreet actieplan, en prioritering op business impact.</div>
          </div>
          <div class="preview-locked-blur">
            ${Array(Math.min(lockedCount, 3)).fill('').map(() => `
              <div class="preview-finding-fake">
                <div class="fake-badge"></div>
                <div class="fake-line long"></div>
                <div class="fake-line medium"></div>
                <div class="fake-line short"></div>
              </div>
            `).join('')}
          </div>
        </div>` : ''}
      </div>

      <div class="preview-cta-section">
        <h2>Volgende stap</h2>
        <div class="preview-cta-grid">
          ${config.ctaType !== 'pay' ? `
          <div class="preview-cta-card contact">
            <div class="preview-cta-icon">💬</div>
            <h3>Gratis adviesgesprek</h3>
            <p>Bespreek de bevindingen en krijg advies over prioriteiten en aanpak. Vrijblijvend.</p>
            <a href="mailto:${esc(config.contactEmail || 'info@bold700.nl')}?subject=${encodeURIComponent('UX Review ' + domain)}&body=${encodeURIComponent('Hoi, ik heb de preview van mijn UX review bekeken en wil graag de bevindingen bespreken.')}" class="preview-cta-btn contact">
              Neem contact op →
            </a>
            ${config.contactPhone ? `<div class="preview-cta-phone">Of bel: <a href="tel:${esc(config.contactPhone)}">${esc(config.contactPhone)}</a></div>` : ''}
          </div>` : ''}

          ${config.ctaType !== 'contact' ? `
          <div class="preview-cta-card unlock">
            <div class="preview-cta-icon">🔓</div>
            <h3>Volledige scan unlocken</h3>
            <p>Alle ${allFindings.length} bevindingen, gedetailleerd actieplan, en concrete fix-suggesties per item.</p>
            <a href="mailto:${esc(config.contactEmail || 'info@bold700.nl')}?subject=${encodeURIComponent('Unlock UX Review ' + domain)}&body=${encodeURIComponent('Hoi, ik wil graag de volledige UX review unlocken voor ' + domain + '.')}" class="preview-cta-btn unlock">
              Unlock volledige scan →
            </a>
          </div>` : ''}
        </div>
      </div>

      <div class="preview-footer">
        <div class="preview-footer-logo">
          ${typeof brandLogo === 'function' ? brandLogo('20px', false) : '<strong>BOLD700</strong>'}
          <span>BOLD700 · UX Review Expert</span>
        </div>
        <div class="preview-footer-text">Deze review is uitgevoerd met het BOLD700 UX Review Platform</div>
      </div>
    </div>`;
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

function showPreviewError(msg) {
  document.querySelectorAll('#authScreen, #dashboardScreen, #newProjectScreen, #reviewScreen, #scorecardScreen')
    .forEach(el => el.classList.add('hidden'));
  const screen = document.getElementById('previewScreen');
  screen.classList.remove('hidden');
  screen.innerHTML = `
    <div class="preview-container" style="text-align:center;padding:80px 24px">
      <div style="font-size:48px;margin-bottom:16px">🔍</div>
      <h1 style="font-size:24px;font-weight:800;margin-bottom:8px">${esc(msg)}</h1>
      <p style="color:var(--text-muted);margin-bottom:24px">Deze preview link is mogelijk verlopen of ongeldig.</p>
      <a href="${window.location.pathname}" style="color:var(--accent);font-weight:600;text-decoration:none">Naar BOLD700 →</a>
    </div>`;
}

// ── Preview config modal (for admin/auditor) ──
function showPreviewModal(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;
  const existing = project.previewConfig;
  const previewUrl = window.location.origin + window.location.pathname + '?preview=' + projectId;

  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };

  overlay.innerHTML = `
    <div class="modal-box" style="max-width:500px">
      <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border)">
        <h3 style="margin:0;font-size:16px;font-weight:700">Preview Link voor Lead</h3>
        <button onclick="this.closest('.modal-overlay').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:20px">×</button>
      </div>
      <div style="padding:20px">
        <p style="font-size:13px;color:var(--text-muted);margin-bottom:16px">
          Genereer een publieke link die je prospect kan bekijken. Ze zien een deel van de bevindingen — de rest is gelocked.
        </p>

        <div class="form-group" style="margin-bottom:12px">
          <label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px">Zichtbare bevindingen</label>
          <select id="pvVisibleCount" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;background:var(--surface);color:var(--text)">
            <option value="3" ${(existing?.visibleFindings || 5) === 3 ? 'selected' : ''}>3 bevindingen (meer urgentie)</option>
            <option value="5" ${(existing?.visibleFindings || 5) === 5 ? 'selected' : ''}>5 bevindingen (goede balans)</option>
            <option value="8" ${(existing?.visibleFindings || 5) === 8 ? 'selected' : ''}>8 bevindingen (meer waarde vooraf)</option>
          </select>
        </div>

        <div class="form-group" style="margin-bottom:12px">
          <label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px">Persoonlijk bericht (optioneel)</label>
          <textarea id="pvMessage" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;background:var(--surface);color:var(--text);resize:vertical" rows="3" placeholder="bijv. Hoi! Ik heb je website bekeken en een paar dingen gevonden die je conversie kunnen verbeteren...">${existing?.customMessage || ''}</textarea>
        </div>

        <div class="form-group" style="margin-bottom:12px">
          <label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px">Contact e-mail</label>
          <input type="email" id="pvEmail" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;background:var(--surface);color:var(--text)" value="${existing?.contactEmail || currentUser?.email || 'info@bold700.nl'}">
        </div>

        <div class="form-group" style="margin-bottom:12px">
          <label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px">Telefoonnummer (optioneel)</label>
          <input type="tel" id="pvPhone" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;background:var(--surface);color:var(--text)" value="${existing?.contactPhone || ''}" placeholder="+31 6 12345678">
        </div>

        <div class="form-group" style="margin-bottom:12px">
          <label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px">CTA opties</label>
          <select id="pvCtaType" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;background:var(--surface);color:var(--text)">
            <option value="both" ${(existing?.ctaType || 'both') === 'both' ? 'selected' : ''}>Contact + Betalen (beide)</option>
            <option value="contact" ${existing?.ctaType === 'contact' ? 'selected' : ''}>Alleen contact</option>
            <option value="pay" ${existing?.ctaType === 'pay' ? 'selected' : ''}>Alleen betalen</option>
          </select>
        </div>

        ${existing?.enabled ? `
        <div style="margin-top:16px;padding:12px;background:var(--surface2);border-radius:8px">
          <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:6px">PREVIEW LINK</label>
          <div style="display:flex;gap:8px">
            <input type="text" id="pvLinkField" value="${previewUrl}" readonly style="flex:1;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:8px 10px;font-size:11px;color:var(--text);font-family:monospace">
            <button class="btn btn-secondary" style="font-size:11px;padding:6px 12px;white-space:nowrap" onclick="navigator.clipboard.writeText(document.getElementById('pvLinkField').value);this.textContent='✓ Gekopieerd';setTimeout(()=>this.textContent='Kopieer',2000)">Kopieer</button>
          </div>
        </div>` : ''}

        <div style="display:flex;gap:8px;margin-top:20px">
          <button class="btn btn-primary" style="flex:1" onclick="savePreviewConfig('${projectId}')">
            ${existing?.enabled ? 'Bijwerken' : 'Preview link genereren'}
          </button>
          ${existing?.enabled ? `<button class="btn btn-secondary" onclick="disablePreview('${projectId}')">Uitschakelen</button>` : ''}
        </div>
      </div>
    </div>`;

  document.body.appendChild(overlay);
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

async function savePreviewConfig(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  project.previewMode = true;
  project.previewConfig = {
    enabled: true,
    createdAt: project.previewConfig?.createdAt || new Date().toISOString(),
    visibleFindings: parseInt(document.getElementById('pvVisibleCount').value),
    showOverallScore: true,
    showCategoryScores: false,
    ctaType: document.getElementById('pvCtaType').value,
    contactEmail: document.getElementById('pvEmail').value.trim(),
    contactPhone: document.getElementById('pvPhone').value.trim(),
    customMessage: document.getElementById('pvMessage').value.trim(),
    showBranding: true
  };

  await syncProjectToFirestore(project);

  const previewUrl = window.location.origin + window.location.pathname + '?preview=' + projectId;
  try { await navigator.clipboard.writeText(previewUrl); } catch(e) {}

  document.querySelector('.modal-overlay')?.remove();
  showScanToast('success', 'Preview link actief!', 'Link is gekopieerd naar je klembord', 4000);
  renderDashboard();
}

async function disablePreview(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;
  project.previewMode = false;
  if (project.previewConfig) project.previewConfig.enabled = false;
  await syncProjectToFirestore(project);
  document.querySelector('.modal-overlay')?.remove();
  showScanToast('info', 'Preview uitgeschakeld', 'De link werkt niet meer', 3000);
  renderDashboard();
}

// Main auth state listener — drives the entire app
auth.onAuthStateChanged(async (user) => {
  initLogos();
  if (typeof lucide !== 'undefined') lucide.createIcons();

  // Preview mode: skip auth flow entirely
  if (urlPreviewId) {
    loadPreview(urlPreviewId);
    return;
  }

  if (!user) {
    // Not logged in → show auth screen
    currentUser = null;
    userProfile = null;
    isAdmin = false;
    isAuditor = false;
    projects = [];
    auditRequests = [];
    showAuthScreen();
    return;
  }

  // User is logged in
  currentUser = user;
  document.body.style.cursor = 'wait';

  // Load user profile from Firestore
  try {
    const userDoc = await db.collection('users').doc(user.uid).get();
    if (userDoc.exists) {
      userProfile = userDoc.data();
      isAdmin = userProfile.role === 'admin';
      isAuditor = userProfile.role === 'auditor';
    } else {
      // Profile doesn't exist yet — create it
      userProfile = { email: user.email, role: 'user', plan: 'free', createdAt: new Date().toISOString() };
      try {
        await db.collection('users').doc(user.uid).set(userProfile);
        console.log('[Firebase] Profile created for', user.email);
      } catch(writeErr) {
        console.error('[Firebase] Could not create profile — check Firestore Security Rules!', writeErr.message);
        console.error('[Firebase] Go to Firebase Console → Firestore → Rules and ensure users can create their own profile.');
      }
    }
  } catch(e) {
    console.warn('[Firebase] Could not load user profile:', e.message);
    if (e.message && (e.message.includes('permission') || e.message.includes('Missing'))) {
      console.error('[Firebase] ⚠ Firestore Security Rules blokkeren toegang! Update je rules in Firebase Console.');
    }
    userProfile = { email: user.email, role: 'user', plan: 'free' };
  }

  await loadState();
  await loadAiConfig(); // Load AI API key from Firestore (not in source code)
  document.body.style.cursor = '';

  // Hide auth screen
  document.getElementById('authScreen').classList.add('hidden');

  // Load audit requests for admin/auditor
  if (isAdmin || isAuditor) {
    await loadAuditRequests();
  }

  // Load auditor application data
  if (isAdmin) {
    await loadAuditorApplications();
  } else if (!isAuditor) {
    await checkAuditorApplication();
  }

  // URL routing
  if (urlProjectId && projects.find(p => p.id === urlProjectId)) {
    openProject(urlProjectId);
    return;
  }

  // Route based on role
  if (isAdmin) {
    console.log('[Admin] Alle', projects.length, 'projecten zichtbaar.');
    showDashboard();
  } else if (isAuditor) {
    console.log('[Auditor]', auditRequests.length, 'audit requests geladen.');
    showAuditorDashboard();
  } else {
    showDashboard();
  }
});
</script>
</body>
</html>
