<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BOLD700 — UX Review Platform</title>
<style>
  :root {
    --bg: #0a0a0a;
    --surface: #141414;
    --surface2: #1e1e1e;
    --surface3: #282828;
    --border: #333;
    --text: #f0f0f0;
    --text-muted: #888;
    --accent: #ff5003;
    --accent-hover: #ff7233;
    --accent-glow: rgba(255,80,3,0.15);
    --brand-blue: #1728c8;
    --green: #22c55e;
    --yellow: #eab308;
    --red: #ef4444;
    --blue: #3b82f6;
    --purple: #a855f7;
    --radius: 12px;
    --radius-sm: 8px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
  }

  .hidden { display: none !important; }

  /* ─── SHARED ─── */
  .logo { font-weight: 800; letter-spacing: -0.5px; color: var(--accent); display: inline-flex; align-items: center; }
  .logo svg.brand-b { height: 1em; width: auto; display: inline-block; vertical-align: middle; }
  .logo svg.brand-b path { fill: var(--accent); }
  /* Logo draw animation */
  @keyframes logoDrawIn {
    0% { stroke-dashoffset: 1200; fill-opacity: 0; }
    70% { fill-opacity: 0; }
    100% { stroke-dashoffset: 0; fill-opacity: 1; }
  }
  .logo svg.brand-b.animate path {
    stroke: var(--accent); stroke-width: 3; fill: var(--accent); fill-opacity: 0;
    stroke-dasharray: 1200; stroke-dashoffset: 1200;
    animation: logoDrawIn 1.8s ease-out forwards;
  }
  .btn {
    padding: 10px 20px; border-radius: var(--radius); font-size: 13px; font-weight: 600;
    cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; border: none;
  }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: var(--accent-hover); }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: #555; }
  .btn-success { background: var(--green); color: #fff; }
  .btn-success:hover { background: #16a34a; }
  .btn-lg { padding: 14px 28px; font-size: 15px; }

  /* ═══ SCREEN 1: DASHBOARD ═══ */
  .dashboard {
    height: 100vh;
    overflow-y: auto;
    background: var(--bg);
  }

  .dash-topbar {
    height: 56px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 24px;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .dash-topbar .logo { font-size: 18px; }

  .dash-topbar-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  /* ─── AUTH SCREEN ─── */
  .auth-screen {
    display: flex; align-items: center; justify-content: center;
    min-height: 100vh; background: var(--bg); padding: 24px;
  }
  .auth-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 24px;
    padding: 48px; width: 440px; max-width: 100%; text-align: center;
  }
  .auth-card .logo { font-size: 32px; display: flex; justify-content: center; margin-bottom: 8px; }
  .auth-card h1 { font-size: 24px; font-weight: 800; color: #fff; margin-bottom: 6px; }
  .auth-card h1 span { color: var(--accent); }
  .auth-card .auth-sub { color: var(--text-muted); font-size: 14px; margin-bottom: 28px; line-height: 1.6; }
  .auth-card .form-group { text-align: left; }
  .auth-cta {
    width: 100%; padding: 14px; font-size: 15px; font-weight: 700;
    background: var(--accent); color: #fff; border: none; border-radius: var(--radius);
    cursor: pointer; transition: all 0.2s; margin-top: 8px;
  }
  .auth-cta:hover { background: var(--accent-hover); transform: translateY(-1px); }
  .auth-cta:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .auth-toggle { margin-top: 20px; font-size: 13px; color: var(--text-muted); }
  .auth-toggle a { color: var(--accent); cursor: pointer; text-decoration: none; font-weight: 600; }
  .auth-toggle a:hover { text-decoration: underline; }
  .auth-error {
    background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: var(--radius-sm);
    padding: 10px 14px; font-size: 13px; color: var(--red); text-align: left; margin-top: 12px;
  }
  .auth-steps {
    display: flex; gap: 12px; margin-top: 28px; padding-top: 24px; border-top: 1px solid var(--border);
  }
  .auth-step {
    flex: 1; text-align: center; font-size: 11px; color: var(--text-muted); line-height: 1.5;
  }
  .auth-step .step-num {
    width: 24px; height: 24px; border-radius: 50%; background: var(--surface3);
    color: var(--accent); font-weight: 700; font-size: 12px;
    display: inline-flex; align-items: center; justify-content: center; margin-bottom: 6px;
  }
  .auth-forgot { font-size: 12px; text-align: right; margin-top: 4px; }
  .auth-forgot a { color: var(--text-muted); cursor: pointer; text-decoration: none; }
  .auth-forgot a:hover { color: var(--accent); }

  /* ─── VISITOR LANDING PAGE (now = user dashboard after login) ─── */
  .landing-screen {
    display: flex; align-items: center; justify-content: center;
    min-height: 100vh; background: var(--bg); padding: 24px;
  }
  .landing-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 24px;
    padding: 48px; width: 560px; max-width: 100%; text-align: center;
  }
  .landing-card .logo { font-size: 28px; display: flex; justify-content: center; margin-bottom: 8px; }
  .landing-card h1, .landing-card h2 { font-weight: 800; color: #fff; margin-bottom: 6px; }
  .landing-card h1 { font-size: 26px; }
  .landing-card h1 span { color: var(--accent); }
  .landing-card .landing-sub {
    color: var(--text-muted); font-size: 14px; margin-bottom: 32px; line-height: 1.6;
  }
  .landing-card .form-group { text-align: left; }
  .landing-card .landing-cta {
    width: 100%; padding: 14px; font-size: 15px; font-weight: 700;
    background: var(--accent); color: #fff; border: none; border-radius: var(--radius);
    cursor: pointer; transition: all 0.2s; margin-top: 8px;
  }
  .landing-card .landing-cta:hover { background: var(--accent-hover); transform: translateY(-1px); }
  /* Visitor mini-dashboard (returning users) */
  .visitor-projects { text-align: left; margin-top: 16px; }
  .visitor-projects h3 { font-size: 14px; font-weight: 700; margin-bottom: 10px; color: var(--text); }
  .visitor-project-card {
    background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm);
    padding: 14px 16px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;
    display: flex; justify-content: space-between; align-items: center;
  }
  .visitor-project-card:hover { border-color: var(--accent); background: var(--surface3); }
  .visitor-project-card .vp-info { flex: 1; }
  .visitor-project-card .vp-name { font-weight: 700; font-size: 14px; }
  .visitor-project-card .vp-date { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
  .visitor-project-card .vp-score { font-weight: 800; font-size: 18px; min-width: 40px; text-align: right; }
  .visitor-project-card .vp-score.good { color: var(--green); }
  .visitor-project-card .vp-score.ok { color: var(--yellow); }
  .visitor-project-card .vp-score.bad { color: var(--red); }
  .visitor-project-card .vp-score.none { color: var(--text-muted); font-size: 13px; }
  .vp-actions { display: flex; gap: 4px; margin-left: 8px; }
  .vp-delete { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 16px; padding: 4px 8px; border-radius: 6px; }
  .vp-delete:hover { color: var(--red); background: rgba(239,68,68,0.1); }
  .landing-divider { display: flex; align-items: center; gap: 12px; margin: 20px 0; color: var(--text-muted); font-size: 12px; }
  .landing-divider::before, .landing-divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
  .free-counter { font-size: 12px; color: var(--text-muted); margin-top: 10px; }
  .free-counter strong { color: var(--accent); }
  .upgrade-card {
    background: linear-gradient(135deg, var(--surface2), var(--surface3)); border: 1px solid var(--accent);
    border-radius: var(--radius); padding: 24px; text-align: center; margin-top: 16px;
  }
  .upgrade-card h3 { font-size: 16px; font-weight: 800; color: var(--accent); margin-bottom: 8px; }
  .upgrade-card p { font-size: 13px; color: var(--text-muted); line-height: 1.5; margin-bottom: 16px; }
  .user-topbar {
    display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; width: 100%;
  }
  .user-email-badge { font-size: 12px; color: var(--text-muted); }
  .user-logout { height: 36px; padding: 0 14px; background: var(--surface2); color: var(--text-muted); border: 1px solid var(--border); border-radius: var(--radius); font-size: 13px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
  .user-logout:hover { border-color: var(--red); color: var(--red); }
  .role-badge { font-size: 11px; font-weight: 700; padding: 3px 10px; border-radius: 12px; letter-spacing: 0.03em; }
  .role-badge.role-admin { background: var(--accent); color: #fff; }
  .role-badge.role-pro { background: var(--brand-blue); color: #fff; }
  .role-badge.role-free { background: var(--surface3); color: var(--text-muted); border: 1px solid var(--border); }

  .dash-content {
    max-width: 1100px;
    margin: 0 auto;
    padding: 40px 32px;
  }

  .dash-hero {
    text-align: center;
    margin-bottom: 48px;
  }

  .dash-hero h1 {
    font-size: 36px;
    font-weight: 800;
    margin-bottom: 8px;
    color: #fff;
  }
  .dash-hero h1 span { color: var(--accent); }

  .dash-hero p { color: var(--text-muted); font-size: 16px; letter-spacing: 0.02em; }

  .dash-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 32px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    text-align: center;
  }

  .stat-card .stat-num { font-size: 28px; font-weight: 800; margin-bottom: 4px; }
  .stat-card .stat-num.accent { color: var(--accent); }
  .stat-card .stat-num.green { color: var(--green); }
  .stat-card .stat-num.yellow { color: var(--yellow); }
  .stat-card .stat-num.red { color: var(--red); }
  .stat-card .stat-label { font-size: 12px; color: var(--text-muted); }

  .dash-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .dash-section-header h2 { font-size: 18px; font-weight: 700; }

  .projects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
  }

  .project-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }

  .project-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 32px rgba(0,0,0,0.3); }

  .project-card.new-project {
    border-style: dashed;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 200px;
    gap: 12px;
    color: var(--text-muted);
  }

  .project-card.new-project:hover { color: var(--accent); border-color: var(--accent); }

  .project-card.new-project svg { width: 40px; height: 40px; opacity: 0.5; }
  .project-card.new-project span { font-size: 14px; font-weight: 600; }

  .pc-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 12px; }
  .pc-name { font-size: 16px; font-weight: 700; }
  .pc-client { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

  .pc-badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    flex-shrink: 0;
  }

  .pc-badge.in-progress { background: rgba(59,130,246,0.15); color: var(--blue); }
  .pc-badge.completed { background: rgba(34,197,94,0.15); color: var(--green); }
  .pc-badge.not-started { background: var(--surface2); color: var(--text-muted); }

  .pc-url { font-size: 12px; color: var(--text-muted); margin-bottom: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  .pc-score-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }

  .pc-score-bar .bar-track {
    flex: 1;
    height: 6px;
    background: var(--surface2);
    border-radius: 3px;
    overflow: hidden;
  }

  .pc-score-bar .bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s; }
  .pc-score-bar .bar-fill.good { background: var(--green); }
  .pc-score-bar .bar-fill.ok { background: var(--yellow); }
  .pc-score-bar .bar-fill.bad { background: var(--red); }

  .pc-score-num { font-size: 14px; font-weight: 800; min-width: 36px; text-align: right; }
  .pc-score-num.good { color: var(--green); }
  .pc-score-num.ok { color: var(--yellow); }
  .pc-score-num.bad { color: var(--red); }
  .pc-score-num.na { color: var(--text-muted); }

  .pc-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 11px;
    color: var(--text-muted);
  }

  .pc-package {
    padding: 2px 8px;
    background: var(--surface2);
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
  }

  .pc-delete {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: none;
    background: var(--surface2);
    color: var(--text-muted);
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.2s;
  }

  .project-card:hover .pc-delete { display: flex; }
  .pc-delete:hover { background: rgba(239,68,68,0.2); color: var(--red); }

  /* ═══ SCREEN 2: NEW PROJECT ═══ */
  .new-project-screen {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100vh;
    background: var(--bg);
    overflow-y: auto;
  }

  .np-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 48px;
    width: 560px;
    max-height: 90vh;
    overflow-y: auto;
  }

  .np-card .logo { font-size: 28px; text-align: center; display: block; margin-bottom: 4px; }
  .np-subtitle { color: var(--text-muted); font-size: 14px; text-align: center; margin-bottom: 32px; }

  .np-card h2 { font-size: 22px; font-weight: 700; text-align: center; margin-bottom: 24px; }

  .form-group { text-align: left; margin-bottom: 16px; }
  .form-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--text-muted); }

  .form-input, .form-select {
    width: 100%; padding: 12px 16px; background: var(--surface2); border: 1px solid var(--border);
    border-radius: var(--radius); color: var(--text); font-size: 14px; outline: none; transition: border-color 0.2s;
  }

  .form-input:focus, .form-select:focus { border-color: var(--accent); }
  .form-input::placeholder { color: #555; }

  .form-select {
    appearance: none; cursor: pointer;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23888' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 14px center;
  }

  .mode-choice {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
  }

  .mode-option {
    padding: 20px 16px;
    background: var(--surface2);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }

  .mode-option:hover { border-color: #555; }

  .mode-option.selected {
    border-color: var(--accent);
    background: var(--accent-glow);
  }

  .mode-option .mode-icon { font-size: 24px; margin-bottom: 8px; }
  .mode-option .mode-name { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
  .mode-option .mode-desc { font-size: 11px; color: var(--text-muted); line-height: 1.4; }

  .np-actions {
    display: flex;
    gap: 12px;
    margin-top: 8px;
  }

  .np-actions .btn { flex: 1; justify-content: center; }

  /* ═══ SCREEN 3: REVIEW INTERFACE ═══ */

  /* URL toolbar (full-width, very top) */
  .url-toolbar {
    display: flex; align-items: center; gap: 8px; padding: 6px 16px;
    background: var(--surface); border-bottom: 1px solid var(--border);
    position: sticky; top: 0; z-index: 101;
  }
  .url-bar {
    display: flex; align-items: center; background: var(--surface2); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 0 10px; height: 32px; flex: 1; min-width: 100px; gap: 6px;
  }
  .url-bar svg { flex-shrink: 0; color: var(--text-muted); }
  .url-bar input { flex: 1; background: none; border: none; color: var(--text); font-size: 13px; outline: none; }
  .url-bar input::placeholder { color: var(--text-muted); }

  .btn-go {
    height: 32px; padding: 0 14px; background: var(--accent); color: #fff; border: none;
    border-radius: var(--radius); font-weight: 600; font-size: 12px; cursor: pointer; transition: background 0.2s;
    flex-shrink: 0;
  }
  .btn-go:hover { background: var(--accent-hover); }
  .btn-open-ext { background: var(--surface2); color: var(--text-muted); border: 1px solid var(--border); padding: 0 14px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 5px; }
  .btn-open-ext:hover { background: var(--accent); color: #fff; border-color: var(--accent); }
  .btn-open-ext.active { background: var(--accent); color: #fff; border-color: var(--accent); }

  .back-btn {
    width: 28px; height: 28px; border-radius: var(--radius-sm); border: 1px solid var(--border);
    background: var(--surface2); color: var(--text-muted); cursor: pointer; display: flex;
    align-items: center; justify-content: center; transition: all 0.2s; font-size: 14px; flex-shrink: 0;
  }
  .back-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* Navigation topbar (below URL bar) */
  .topbar {
    background: var(--surface); border-bottom: 1px solid var(--border);
    position: sticky; top: 44px; z-index: 100;
  }
  .topbar-row {
    display: flex; align-items: center; justify-content: space-between; padding: 6px 16px;
  }
  .topbar-center {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    flex: 1; min-width: 0;
  }
  .topbar-title { font-size: 14px; font-weight: 700; color: var(--text); line-height: 1.2; }
  .topbar-subtitle {
    display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-muted);
  }
  .topbar-sep { opacity: 0.3; }

  .topbar-left { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
  .topbar-right { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }

  .lucide, i[data-lucide] { width: 1em; height: 1em; display: inline-block; vertical-align: -0.125em; stroke-width: 2; }
  .icon-inline { display: inline-flex; align-items: center; gap: 4px; }

  /* Nav buttons (in topbar) */
  .btn-nav {
    padding: 6px 16px; border-radius: var(--radius); font-size: 13px; font-weight: 600;
    cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;
  }
  .btn-prev { background: var(--surface2); border: 1px solid var(--border); color: var(--text); }
  .btn-prev:hover { border-color: #555; }
  .btn-next { background: var(--accent); border: 1px solid var(--accent); color: #fff; }
  .btn-next:hover { background: var(--accent-hover); }

  /* Tool icon buttons (topbar) */
  .btn-icon {
    width: 28px; height: 28px; background: var(--surface2); color: var(--text);
    border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 12px;
    cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; padding: 0;
  }
  .btn-icon:hover { border-color: var(--accent); color: var(--accent); }

  /* Device bar (above preview frame) */
  .preview-device-bar {
    display: flex; align-items: center; justify-content: center; gap: 2px;
    padding: 6px 0; width: 100%;
  }
  #deviceBarReview { display: none; align-items: center; gap: 6px; }

  .device-btn {
    padding: 4px 12px; background: none;
    border: 1px solid transparent; border-radius: var(--radius-sm); color: var(--text-muted);
    font-size: 11px; cursor: pointer; transition: all 0.2s;
  }
  .device-btn:hover { color: var(--text); background: var(--surface2); }
  .device-btn.active { color: var(--accent); background: rgba(255,107,0,0.1); border-color: rgba(255,107,0,0.3); }

  /* Main layout */
  .main { display: flex; height: calc(100vh - 88px); }

  /* ─ Review Modus (site in apart venster) ─ */
  .main.review-mode .preview-panel { display: none !important; }
  .main.review-mode .review-panel { width: 100% !important; max-width: 100% !important; min-width: 100% !important; border-right: none; }
  .main.review-mode .review-body { max-width: 100%; }
  .main.review-mode .questions-area { max-width: 100%; }
  .main.review-mode .step-stepper { width: 200px; }

  .review-mode-info { display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-muted); }
  .dot-live { width: 6px; height: 6px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; display: inline-block; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
  .main.review-mode .screenshot-btn.capture-primary { display: none !important; }

  /* Preview panel */
  .preview-panel {
    flex: 1; display: flex; flex-direction: column; align-items: center;
    background: #0d0d0d; overflow: auto; position: relative;
  }

  .preview-frame-wrapper {
    background: #fff; border-radius: var(--radius); overflow: hidden;
    box-shadow: 0 0 60px rgba(0,0,0,0.5); transition: width 0.4s ease, height 0.3s ease;
    position: relative; margin: 0 24px 24px;
  }

  .preview-frame-wrapper.desktop { width: calc(100% - 48px); max-width: 1440px; height: calc(100vh - 160px); }
  .preview-frame-wrapper.tablet { width: 768px; height: calc(100vh - 160px); }
  .preview-frame-wrapper.mobile { width: 375px; height: calc(100vh - 160px); border-radius: 32px; }

  .preview-frame-wrapper.mobile::before {
    content: ''; position: absolute; top: 8px; left: 50%; transform: translateX(-50%);
    width: 80px; height: 4px; background: #333; border-radius: 4px; z-index: 10;
  }

  .preview-frame-wrapper iframe { width: 100%; height: 100%; border: none; display: block; }

  .preview-empty {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    height: 100%; width: 100%; color: var(--text-muted); text-align: center; gap: 16px;
  }
  .preview-empty svg { width: 64px; height: 64px; opacity: 0.3; }
  .preview-empty p { font-size: 14px; max-width: 300px; line-height: 1.6; }

  /* Static thumbnail preview (when iframe is blocked) */
  .static-preview {
    position: relative; width: 100%; height: 100%; display: flex; flex-direction: column;
  }
  .static-preview-img {
    width: 100%; flex: 1; object-fit: cover; object-position: top; display: block;
    border-radius: var(--radius) var(--radius) 0 0;
  }
  .static-preview-loading {
    flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 12px; color: var(--text-muted);
  }
  .static-preview-spinner {
    width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent);
    border-radius: 50%; animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .static-preview-badge {
    position: absolute; bottom: 0; left: 0; right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.85));
    padding: 24px 16px 14px; display: flex; align-items: center; justify-content: space-between;
    gap: 8px; flex-wrap: wrap;
  }
  .static-preview-badge .badge-label {
    font-size: 11px; color: rgba(255,255,255,0.8); font-weight: 600;
    display: flex; align-items: center; gap: 6px;
  }
  .static-preview-badge .badge-label .dot {
    width: 6px; height: 6px; background: var(--amber); border-radius: 50%; display: inline-block;
  }
  .static-preview-actions { display: flex; gap: 6px; }
  .static-preview-actions a, .static-preview-actions button {
    padding: 7px 14px; border-radius: var(--radius-sm); font-size: 11px; font-weight: 600;
    cursor: pointer; text-decoration: none; border: none; transition: all 0.2s;
  }
  .static-preview-actions .btn-open {
    background: var(--accent); color: #fff;
  }
  .static-preview-actions .btn-open:hover { background: var(--accent-hover); }
  .static-preview-actions .btn-side {
    background: rgba(255,255,255,0.15); color: #fff; border: 1px solid rgba(255,255,255,0.25);
  }
  .static-preview-actions .btn-side:hover { background: rgba(255,255,255,0.25); }
  .static-preview-error {
    flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 12px; color: var(--text-muted); padding: 24px;
  }

  /* Floating "site niet zichtbaar?" helper */
  .iframe-help-btn {
    position: absolute; bottom: 16px; right: 16px; z-index: 20;
    background: rgba(0,0,0,0.85); color: #fff; border: 1px solid rgba(255,255,255,0.2);
    padding: 10px 16px; border-radius: var(--radius); font-size: 12px; font-weight: 600;
    cursor: pointer; display: flex; align-items: center; gap: 8px;
    backdrop-filter: blur(8px); transition: all 0.3s ease;
    animation: helpFadeIn 0.4s ease-out;
  }
  .iframe-help-btn:hover { background: var(--accent); border-color: var(--accent); transform: translateY(-2px); }
  @keyframes helpFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* Hidden thumbnail pre-loader */
  .thumb-preloader { display: none; }

  /* Review panel */
  .review-panel {
    width: 580px; min-width: 500px; max-width: 700px; background: var(--surface);
    border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden;
  }

  .review-body {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  .step-indicator { font-size: 12px; color: var(--text-muted); font-weight: 600; }

  /* Vertical Stepper */
  .step-stepper {
    width: 160px;
    flex-shrink: 0;
    background: var(--surface2);
    border-right: 1px solid var(--border);
    overflow-y: auto;
    padding: 12px 0;
    scrollbar-width: thin;
    scrollbar-color: var(--surface3) transparent;
  }
  .stepper-progress { padding: 0 14px 14px; border-bottom: 1px solid var(--border); margin-bottom: 8px; }
  .stepper-progress-label { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
  .stepper-progress-row { display: flex; align-items: center; gap: 8px; }
  .stepper-progress-bar { height: 4px; background: var(--surface3); border-radius: 2px; overflow: hidden; flex: 1; }
  .stepper-progress-fill { height: 100%; border-radius: 2px; transition: width 0.4s ease; }
  .stepper-progress-pct { font-size: 12px; font-weight: 800; white-space: nowrap; }
  .step-stepper::-webkit-scrollbar { width: 4px; }
  .step-stepper::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 2px; }

  .stepper-item {
    display: flex;
    gap: 10px;
    padding: 0 14px;
    cursor: pointer;
    transition: background 0.15s;
  }
  .stepper-item:hover { background: var(--surface2); }

  .stepper-track {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-shrink: 0;
    align-self: stretch;
  }

  .stepper-circle {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    border: 2px solid;
    flex-shrink: 0;
    transition: all 0.2s;
  }

  .stepper-line {
    width: 2px;
    flex: 1;
    transition: background 0.2s;
    margin: -1px 0;
  }
  .stepper-line.line-top { min-height: 10px; }
  .stepper-line.line-btm { min-height: 10px; }
  .stepper-line.line-hidden { background: transparent !important; }

  .stepper-label {
    font-size: 11px;
    font-weight: 600;
    line-height: 1.3;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: color 0.2s;
  }
  .stepper-info { display: flex; flex-direction: column; justify-content: center; min-height: 26px; padding: 3px 0; overflow: hidden; min-width: 0; }

  /* Stepper states */
  .stepper-item.pending .stepper-circle { border-color: var(--border); color: var(--text-muted); background: transparent; }
  .stepper-item.pending .stepper-line { background: var(--border); }
  .stepper-item.pending .stepper-label { color: var(--text-muted); }

  .stepper-item.active .stepper-circle { border-color: var(--accent); color: #fff; background: var(--accent); box-shadow: 0 0 12px rgba(255,107,0,0.4); }
  .stepper-item.active .stepper-line { background: var(--border); }
  .stepper-item.active .stepper-label { color: var(--accent); font-weight: 700; }

  .stepper-item.completed .stepper-circle { border-color: var(--green); color: #fff; background: var(--green); }
  .stepper-item.completed .stepper-line { background: var(--green); }
  .stepper-item.completed .stepper-label { color: var(--green); }

  .stepper-meta { font-size: 10px; font-weight: 400; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; margin-top: 1px; color: var(--text-muted); }

  /* Questions */
  .questions-area {
    flex: 1; overflow-y: auto; padding: 20px; min-width: 0;
  }
  .questions-area::-webkit-scrollbar { width: 6px; }
  .questions-area::-webkit-scrollbar-track { background: transparent; }
  .questions-area::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 3px; }

  .category-title { font-size: 18px; font-weight: 800; margin-bottom: 4px; }
  .category-desc { font-size: 13px; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5; }

  .question-card {
    background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 16px; margin-bottom: 12px; transition: border-color 0.2s;
  }
  .question-card:hover { border-color: #444; }
  .question-card.answered { border-color: rgba(34,197,94,0.3); }
  .question-card.answered-nvt { border-color: rgba(100,100,100,0.3); opacity: 0.55; }

  .question-label { font-size: 13px; font-weight: 600; margin-bottom: 10px; line-height: 1.5; }
  .question-label .q-num { color: var(--accent); margin-right: 6px; }
  .auto-badge { display: inline-flex; align-items: center; gap: 3px; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--blue); background: rgba(59,130,246,0.12); padding: 2px 6px; border-radius: 4px; margin-left: 6px; vertical-align: middle; }
  .auto-badge .lucide { width: 10px; height: 10px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .btn-icon [data-lucide="loader"] { animation: spin 1s linear infinite; }

  .score-row { display: flex; gap: 6px; margin-bottom: 10px; }

  .score-btn {
    flex: 1; padding: 8px 4px; border: 1px solid var(--border); border-radius: var(--radius-sm);
    background: var(--surface); color: var(--text-muted); font-size: 12px; font-weight: 600;
    cursor: pointer; transition: all 0.2s; text-align: center;
  }
  .score-btn:hover { border-color: #555; color: var(--text); }
  .score-btn.selected.score-bad { border-color: var(--red); color: var(--red); background: rgba(239,68,68,0.1); }
  .score-btn.selected.score-ok { border-color: var(--yellow); color: var(--yellow); background: rgba(234,179,8,0.1); }
  .score-btn.selected.score-good { border-color: var(--green); color: var(--green); background: rgba(34,197,94,0.1); }
  .score-btn.selected.score-nvt { border-color: #666; color: #999; background: rgba(100,100,100,0.15); }

  .notes-input {
    width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm);
    padding: 10px 12px; color: var(--text); font-size: 13px; font-family: inherit;
    resize: vertical; min-height: 60px; outline: none; transition: border-color 0.2s; margin-top: 2px;
  }
  .notes-input:focus { border-color: var(--accent); }
  .notes-input::placeholder { color: #555; }

  .screenshot-row { display: flex; align-items: center; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
  .screenshot-thumb { position: relative; display: inline-block; }
  .screenshot-btn {
    padding: 6px 12px; border-radius: var(--radius-sm); font-size: 11px; font-weight: 600;
    cursor: pointer; border: 1px dashed var(--border); background: transparent;
    color: var(--text-muted); transition: all 0.2s; display: flex; align-items: center; gap: 4px;
  }
  .screenshot-btn:hover { border-color: var(--accent); color: var(--accent); }
  .screenshot-btn.capture-primary {
    border-style: solid; background: var(--accent); color: #fff; border-color: var(--accent);
  }
  .screenshot-btn.capture-primary:hover { background: var(--accent-hover); border-color: var(--accent-hover); color: #fff; }
  .screenshot-btn.capture-primary:disabled { opacity: 0.6; cursor: wait; }
  .screenshot-hint { font-size: 10px; color: var(--text-muted); opacity: 0.6; display: flex; align-items: center; gap: 3px; }
  .screenshot-row.paste-target { border-left: 2px solid var(--accent); padding-left: 8px; }
  .screenshot-row.paste-target .screenshot-hint { color: var(--accent); opacity: 1; }
  .capture-flash {
    position: absolute; inset: 0; background: rgba(255,255,255,0.8); z-index: 100;
    display: flex; align-items: center; justify-content: center; border-radius: var(--radius);
    animation: flashFade 0.5s ease-out forwards;
  }
  @keyframes flashFade { from { opacity: 1; } to { opacity: 0; } }
  .screenshot-preview {
    width: 80px; height: 50px; border-radius: 6px; object-fit: cover;
    border: 1px solid var(--border); cursor: pointer; transition: transform 0.2s;
  }
  .screenshot-preview:hover { transform: scale(1.05); }
  .screenshot-remove {
    position: absolute; top: -6px; right: -6px;
    width: 18px; height: 18px; border-radius: 50%; border: none; background: var(--red);
    color: #fff; font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.2s;
  }
  .screenshot-thumb:hover .screenshot-remove { opacity: 1; }
  .screenshot-lightbox {
    position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
  }
  .screenshot-lightbox img { max-width: 90%; max-height: 90%; border-radius: var(--radius); }

  .severity-row { display: flex; gap: 6px; margin-top: 8px; margin-bottom: 10px; }

  .sev-btn {
    padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;
    cursor: pointer; border: 1px solid var(--border); background: var(--surface);
    color: var(--text-muted); transition: all 0.2s;
  }
  .sev-btn:hover { border-color: #555; }
  .sev-btn.selected.sev-quickwin { background: rgba(34,197,94,0.15); color: var(--green); border-color: var(--green); }
  .sev-btn.selected.sev-strategic { background: rgba(59,130,246,0.15); color: var(--blue); border-color: var(--blue); }
  .sev-btn.selected.sev-filler { background: rgba(234,179,8,0.15); color: var(--yellow); border-color: var(--yellow); }
  .sev-btn.selected.sev-notnow { background: rgba(255,255,255,0.08); color: var(--text-muted); border-color: var(--text-muted); }

  .score-summary {
    display: flex; align-items: center; gap: 12px; padding: 12px 16px;
    background: var(--surface2); border-radius: var(--radius); margin-bottom: 16px;
  }

  .score-circle {
    width: 52px; height: 52px; border-radius: 50%; display: flex; align-items: center;
    justify-content: center; font-size: 20px; font-weight: 800; border: 3px solid; flex-shrink: 0;
  }
  .score-circle.good { border-color: var(--green); color: var(--green); }
  .score-circle.ok { border-color: var(--yellow); color: var(--yellow); }
  .score-circle.bad { border-color: var(--red); color: var(--red); }
  .score-circle.neutral { border-color: var(--border); color: var(--text-muted); }

  .score-meta { flex: 1; }
  .score-meta .label { font-size: 13px; font-weight: 600; }
  .score-meta .sublabel { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

  /* Footer nav (removed - nav buttons now in topbar) */

  /* ═══ SCREEN 4: SCORECARD ═══ */
  /* ═══ DASHBOARD SCORECARD ═══ */
  .scorecard-overlay {
    position: fixed; inset: 0; background: var(--bg); z-index: 2000;
    overflow-y: auto; padding: 0;
  }
  .scorecard-container { max-width: 1240px; margin: 0 auto; padding: 0 24px 40px; }

  /* ─ Scorecard Topbar (full-width, outside container) ─ */
  #scorecardTopbar .dash-topbar {
    height: 56px; position: sticky; top: 0; z-index: 100;
    background: var(--surface); border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between; padding: 0 24px; gap: 16px;
  }
  #scorecardTopbar .dash-topbar-left { display: flex; align-items: center; gap: 12px; }
  #scorecardTopbar .dash-topbar-left .logo { font-size: 18px; }
  #scorecardTopbar .dash-topbar-title { font-size: 14px; font-weight: 400; color: var(--text-muted); padding-left: 16px; border-left: 1px solid var(--border); }
  #scorecardTopbar .dash-topbar-meta { font-size: 11px; color: var(--text-muted); padding-right: 8px; border-right: 1px solid var(--border); }
  #scorecardTopbar .dash-topbar-right { display: flex; gap: 8px; align-items: center; }

  /* ─ KPI Strip ─ */
  .kpi-strip { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 20px 0; }
  .kpi-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 20px; display: flex; flex-direction: column; gap: 4px; position: relative; overflow: hidden;
  }
  .kpi-card.kpi-accent { border-color: rgba(255,80,3,0.3); }
  .kpi-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); }
  .kpi-value { font-size: 32px; font-weight: 900; line-height: 1.1; }
  .kpi-value.sc-good { color: var(--green); }
  .kpi-value.sc-ok { color: var(--yellow); }
  .kpi-value.sc-bad { color: var(--red); }
  .kpi-sub { font-size: 11px; color: var(--text-muted); }
  .kpi-bar { width: 100%; height: 4px; background: var(--surface2); border-radius: 2px; margin-top: 8px; overflow: hidden; }
  .kpi-bar-fill { height: 100%; border-radius: 2px; transition: width 1s ease; }

  /* ─ Dashboard Grid ─ */
  .dash-grid { display: grid; grid-template-columns: 3fr 2fr; gap: 16px; margin-bottom: 16px; }
  .dash-grid-full { grid-column: 1 / -1; }

  /* ─ Dashboard Card ─ */
  .dash-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    overflow: hidden; display: flex; flex-direction: column;
  }
  .dash-card-head {
    display: flex; align-items: center; justify-content: space-between; gap: 8px;
    padding: 14px 20px; border-bottom: 1px solid var(--border); flex-shrink: 0;
  }
  .dash-card-head h3 { font-size: 13px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
  .dash-card-body { padding: 16px 20px; flex: 1; overflow-y: auto; }
  .dash-card-body.compact { padding: 0; }

  /* ─ AI Plan in dashboard ─ */
  .ai-plan-section { margin: 0; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
  .ai-plan-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 14px 20px; background: linear-gradient(135deg, rgba(59,130,246,0.08), rgba(168,85,247,0.08)); border-bottom: 1px solid var(--border); }
  .ai-plan-header h3 { font-size: 13px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
  .ai-plan-header h3 .lucide { color: var(--purple); }
  .ai-plan-generate { background: var(--purple); color: #fff; border: none; padding: 8px 16px; border-radius: var(--radius-sm); font-size: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: all 0.15s; }
  .ai-plan-generate:hover { filter: brightness(1.15); transform: translateY(-1px); }
  .ai-plan-generate:disabled { opacity: 0.5; pointer-events: none; }
  .ai-plan-body { padding: 20px; max-height: 500px; overflow-y: auto; }
  .ai-plan-empty { text-align: center; padding: 24px; color: var(--text-muted); font-size: 12px; line-height: 1.8; }
  .ai-plan-content { font-size: 13px; line-height: 1.7; color: var(--text); }
  .ai-plan-content h2 { font-size: 16px; font-weight: 800; margin: 20px 0 8px; color: var(--text); }
  .ai-plan-content h2:first-child { margin-top: 0; }
  .ai-plan-content h3 { font-size: 14px; font-weight: 700; margin: 16px 0 6px; color: var(--accent); }
  .ai-plan-content p { margin-bottom: 8px; }
  .ai-plan-content ul, .ai-plan-content ol { margin: 6px 0 12px 18px; }
  .ai-plan-content li { margin-bottom: 4px; }
  .ai-plan-content strong { color: var(--text); }
  .ai-plan-content em { color: var(--text-muted); font-style: italic; }
  .ai-plan-content blockquote { border-left: 3px solid var(--accent); padding: 6px 14px; margin: 10px 0; background: rgba(255,80,3,0.05); border-radius: 0 var(--radius-sm) var(--radius-sm) 0; font-size: 12px; }
  .ai-plan-actions { display: flex; gap: 8px; justify-content: flex-end; padding: 10px 20px; border-top: 1px solid var(--border); background: var(--surface2); }
  .ai-plan-actions button { font-size: 11px; padding: 5px 12px; border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; gap: 4px; }

  /* ─ Category rows ─ */
  .cat-row { display: flex; align-items: center; gap: 12px; padding: 10px 20px; border-bottom: 1px solid var(--border); transition: background 0.1s; }
  .cat-row:last-child { border-bottom: none; }
  .cat-row:hover { background: var(--surface2); }
  .cat-row-score { font-size: 14px; font-weight: 800; width: 36px; text-align: right; flex-shrink: 0; }
  .cat-row-score.sc-good { color: var(--green); }
  .cat-row-score.sc-ok { color: var(--yellow); }
  .cat-row-score.sc-bad { color: var(--red); }
  .cat-row-score.sc-na { color: var(--text-muted); }
  .cat-row-name { font-size: 12px; font-weight: 600; flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .cat-row-bar { width: 80px; height: 6px; background: var(--surface3); border-radius: 3px; overflow: hidden; flex-shrink: 0; }
  .cat-row-fill { height: 100%; border-radius: 3px; }
  .cat-row-status { font-size: 10px; font-weight: 600; width: 60px; text-align: right; flex-shrink: 0; }
  .cat-row-status.st-good { color: var(--green); }
  .cat-row-status.st-ok { color: var(--yellow); }
  .cat-row-status.st-bad { color: var(--red); }
  .cat-row-status.st-na { color: var(--text-muted); }

  /* ─ Quick Win / Strategic items ─ */
  .action-item { padding: 10px 20px; border-bottom: 1px solid var(--border); font-size: 12px; line-height: 1.5; display: flex; gap: 8px; align-items: flex-start; }
  .action-item:last-child { border-bottom: none; }
  .action-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; margin-top: 5px; }
  .action-dot.green { background: var(--green); }
  .action-dot.blue { background: var(--blue); }
  .action-dot.yellow { background: var(--yellow); }
  .action-dot.muted { background: var(--text-muted); }
  .action-text { color: var(--text-muted); }
  .action-empty { padding: 20px; text-align: center; font-size: 11px; color: #555; }

  /* ─ Priority Matrix compact ─ */
  .matrix-compact { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; border-radius: var(--radius-sm); overflow: hidden; }
  .matrix-compact .mc { padding: 12px; background: var(--surface2); }
  .matrix-compact .mc h4 { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
  .matrix-compact .mc.qw h4 { color: var(--green); }
  .matrix-compact .mc.sp h4 { color: var(--blue); }
  .matrix-compact .mc.fi h4 { color: var(--yellow); }
  .matrix-compact .mc.nn h4 { color: var(--text-muted); }
  .matrix-compact .mc .mc-count { font-size: 24px; font-weight: 900; line-height: 1; }

  /* ─ Collapsible findings ─ */
  .findings-toggle {
    width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 14px 20px; display: flex; align-items: center; justify-content: space-between;
    cursor: pointer; font-size: 13px; font-weight: 700; color: var(--text); transition: background 0.15s;
  }
  .findings-toggle:hover { background: var(--surface2); }
  .findings-toggle .ft-arrow { transition: transform 0.2s; font-size: 16px; color: var(--text-muted); }
  .findings-toggle.open .ft-arrow { transform: rotate(180deg); }
  .findings-body { background: var(--surface); border: 1px solid var(--border); border-top: none; border-radius: 0 0 var(--radius) var(--radius); padding: 0 20px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
  .findings-body.open { max-height: 5000px; padding: 16px 20px; }
  .issue-row { display: flex; align-items: flex-start; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); }
  .issue-row:last-child { border-bottom: none; }
  .issue-badge { padding: 2px 8px; border-radius: 20px; font-size: 10px; font-weight: 700; flex-shrink: 0; text-transform: uppercase; }
  .issue-badge.ib-high { background: rgba(234,179,8,0.15); color: var(--yellow); }
  .issue-badge.ib-low { background: rgba(100,100,100,0.15); color: var(--text-muted); }
  .issue-text { font-size: 12px; line-height: 1.5; }
  .issue-note { font-size: 11px; color: var(--text-muted); margin-top: 3px; }
  .issue-screenshot { width: 120px; height: 72px; border-radius: 6px; object-fit: cover; border: 1px solid var(--border); cursor: pointer; transition: transform 0.2s; flex-shrink: 0; margin-top: 6px; }
  .issue-screenshot:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
  .action-screenshot { width: 40px; height: 28px; border-radius: 4px; object-fit: cover; border: 1px solid var(--border); cursor: pointer; flex-shrink: 0; }
  .action-screenshot:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.3); }

  /* ─ Upsell (kept) ─ */
  .upsell-card { background: linear-gradient(135deg, #1a1205, #1a0f05); border: 2px solid var(--accent); border-radius: var(--radius); padding: 32px; text-align: center; margin-bottom: 16px; position: relative; overflow: hidden; }
  .upsell-card * { position: relative; z-index: 1; }
  .upsell-card .upsell-tag { display: inline-block; padding: 3px 12px; background: var(--accent); color: #fff; border-radius: 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; margin-bottom: 12px; }
  .upsell-card h2 { font-size: 20px; font-weight: 800; margin-bottom: 6px; }
  .upsell-card p { color: var(--text-muted); font-size: 13px; line-height: 1.6; margin-bottom: 16px; }
  .upsell-benefits { display: flex; justify-content: center; gap: 20px; font-size: 11px; color: var(--text-muted); }
  .upsell-benefits span::before { content: '✓ '; color: var(--green); font-weight: 700; }
  .lead-gated { filter: blur(6px); pointer-events: none; user-select: none; }
  .ai-key-setup { display: flex; gap: 8px; align-items: center; }
  .ai-key-setup input { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); padding: 8px 12px; font-size: 12px; font-family: monospace; width: 280px; }
  .ai-key-setup input::placeholder { color: var(--text-muted); }
  @keyframes aiPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  .ai-loading { animation: aiPulse 1.5s ease-in-out infinite; }

  .priority-matrix {
    display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto auto;
    gap: 2px; margin-top: 20px; border-radius: var(--radius); overflow: hidden;
  }

  .matrix-cell { padding: 16px; background: var(--surface2); }
  .matrix-cell h4 { font-size: 12px; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
  .matrix-cell.qw h4 { color: var(--green); }
  .matrix-cell.sp h4 { color: var(--blue); }
  .matrix-cell.fi h4 { color: var(--yellow); }
  .matrix-cell.nn h4 { color: var(--text-muted); }
  .matrix-cell ul { list-style: none; font-size: 12px; color: var(--text-muted); line-height: 1.8; }

  .matrix-label-row {
    display: grid; grid-template-columns: 1fr 1fr; gap: 2px; text-align: center;
    font-size: 11px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px;
  }

  /* ═══ MODALS ═══ */
  /* ─── CONTRAST CHECKER PANEL ─── */
  .cc-panel {
    position: fixed; top: 64px; right: 0; width: 340px; height: calc(100vh - 64px);
    background: var(--surface); border-left: 1px solid var(--border);
    z-index: 900; overflow-y: auto; padding: 24px;
    transform: translateX(100%); transition: transform 0.25s ease;
  }
  .cc-panel.open { transform: translateX(0); }
  .cc-panel h3 { font-size: 16px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; }
  .cc-panel h3 button { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 18px; }
  .cc-panel h3 button:hover { color: var(--text); }
  .cc-colors { display: flex; gap: 12px; margin-bottom: 16px; }
  .cc-color-group { flex: 1; }
  .cc-color-group label { font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 4px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
  .cc-color-input {
    display: flex; align-items: center; gap: 8px; background: var(--surface2); border: 1px solid var(--border);
    border-radius: var(--radius-sm); padding: 6px 10px;
  }
  .cc-color-input input[type="color"] { width: 28px; height: 28px; border: none; cursor: pointer; background: none; padding: 0; }
  .cc-color-input input[type="text"] {
    background: none; border: none; color: var(--text); font-size: 13px; font-family: monospace; width: 80px; outline: none;
  }
  .cc-swap { background: none; border: 1px solid var(--border); color: var(--text-muted); cursor: pointer; border-radius: 6px; padding: 4px 8px; font-size: 14px; align-self: flex-end; margin-bottom: 16px; }
  .cc-swap:hover { border-color: var(--accent); color: var(--accent); }
  .cc-preview {
    border-radius: var(--radius); padding: 20px; text-align: center; margin-bottom: 16px;
    border: 1px solid var(--border);
  }
  .cc-preview .preview-large { font-size: 22px; font-weight: 700; margin-bottom: 4px; }
  .cc-preview .preview-small { font-size: 14px; }
  .cc-ratio-display { text-align: center; margin-bottom: 20px; }
  .cc-ratio-num { font-size: 36px; font-weight: 900; }
  .cc-ratio-label { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
  .cc-results { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px; }
  .cc-result {
    background: var(--surface2); border-radius: var(--radius-sm); padding: 12px; text-align: center;
    border: 1px solid var(--border);
  }
  .cc-result .cc-level { font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em; }
  .cc-result .cc-status { font-size: 14px; font-weight: 800; }
  .cc-result .cc-status.pass { color: var(--green); }
  .cc-result .cc-status.fail { color: var(--red); }
  .cc-result .cc-req { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
  .cc-presets { margin-top: 16px; }
  .cc-presets h4 { font-size: 12px; font-weight: 700; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; }
  .cc-preset-btn {
    display: flex; align-items: center; gap: 8px; width: 100%; background: var(--surface2);
    border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 8px 12px;
    cursor: pointer; margin-bottom: 4px; color: var(--text); font-size: 12px;
  }
  .cc-preset-btn:hover { border-color: var(--accent); }
  .cc-preset-swatch { width: 24px; height: 16px; border-radius: 3px; border: 1px solid rgba(255,255,255,0.1); }

  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7);
    display: flex; align-items: center; justify-content: center; z-index: 3000;
  }

  .modal {
    background: var(--surface); border: 1px solid var(--border); border-radius: 20px;
    padding: 32px; width: 500px; max-height: 80vh; overflow-y: auto;
  }
  .modal h2 { font-size: 18px; margin-bottom: 16px; }
  .modal pre {
    background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 16px; font-size: 12px; color: var(--text); white-space: pre-wrap;
    word-break: break-word; max-height: 400px; overflow-y: auto;
  }
  .modal-actions { display: flex; gap: 8px; margin-top: 16px; justify-content: flex-end; }

  .upsell-success {
    text-align: center;
    padding: 20px;
    background: rgba(34,197,94,0.1);
    border: 1px solid rgba(34,197,94,0.3);
    border-radius: var(--radius);
    margin-top: 16px;
    font-size: 14px;
    color: var(--green);
  }

  @media (max-width: 1200px) {
    .review-panel { width: 460px; min-width: 400px; }
    .step-stepper { width: 44px; }
    .stepper-label { display: none; }
    .stepper-progress { display: none; }
    .stepper-item { padding: 0 9px; }
    .topbar-subtitle { font-size: 10px; gap: 4px; }
    .dash-stats { grid-template-columns: repeat(2, 1fr); }
    /* Buttons: icon-only on small screens */
    .btn-label { display: none; }
    .btn-open-ext { padding: 0 10px; }
    .screenshot-btn { padding: 6px 8px; }
    .screenshot-hint { display: none; }
    .btn-nav { padding: 4px 10px; font-size: 12px; }
    .topbar-right .btn-icon { display: none; }
    /* Review mode stays full-width at small screens too */
    .main.review-mode .review-panel { width: 100%; min-width: 100%; }
    .main.review-mode .step-stepper { width: 160px; }
    .main.review-mode .stepper-label { display: block; }
    .main.review-mode .stepper-progress { display: block; }
  }

  /* ─ Scorecard Dashboard responsive ─ */
  @media (max-width: 900px) {
    .scorecard-container { padding: 0 12px 24px; }
    #scorecardTopbar .dash-topbar { padding: 0 12px; }
    #scorecardTopbar .dash-topbar-meta { display: none; }
    .kpi-strip { grid-template-columns: repeat(2, 1fr); gap: 8px; margin: 12px 0; }
    .kpi-card { padding: 14px; }
    .kpi-value { font-size: 24px; }
    .dash-grid { grid-template-columns: 1fr; gap: 12px; margin-bottom: 12px; }
    .cat-row-bar { width: 60px; }
    .cat-row-status { width: 50px; font-size: 9px; }
  }
  @media (max-width: 480px) {
    .kpi-strip { grid-template-columns: 1fr 1fr; gap: 6px; }
    .kpi-card { padding: 10px; }
    .kpi-value { font-size: 20px; }
    .kpi-label { font-size: 9px; }
    #scorecardTopbar .dash-topbar-title { font-size: 12px; }
    #scorecardTopbar .dash-topbar-right .btn-icon { font-size: 10px; padding: 0 8px; height: 30px; }
  }
</style>
<!-- Firebase SDK (compat for single-file usage) -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>
<script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.min.js"></script>
</head>
<body>

<!-- ═══ SCREEN 0A: AUTH (Login / Register) ═══ -->
<div id="authScreen" class="auth-screen">
  <div class="auth-card">
    <div class="logo" id="authLogo"></div>
    <h1><span>Gratis</span> UX Review</h1>
    <p class="auth-sub">Ontdek in 15 minuten waarom je website niet converteert.<br>Ontvang direct je score en verbeterpunten.</p>

    <div id="authFormLogin">
      <div class="form-group">
        <label>E-mailadres</label>
        <input type="email" id="authEmail" class="form-input" placeholder="naam@bedrijf.nl" onkeydown="if(event.key==='Enter')document.getElementById('authPassword').focus()">
      </div>
      <div class="form-group">
        <label>Wachtwoord</label>
        <input type="password" id="authPassword" class="form-input" placeholder="••••••••" onkeydown="if(event.key==='Enter')handleAuth()">
        <div class="auth-forgot" id="authForgotLink"><a onclick="resetPassword()">Wachtwoord vergeten?</a></div>
      </div>
      <button class="auth-cta" id="authBtn" onclick="handleAuth()">Inloggen →</button>
      <div id="authError" class="auth-error hidden"></div>
      <div class="auth-toggle" id="authToggle">Nog geen account? <a onclick="toggleAuthMode()">Registreer gratis</a></div>
    </div>

    <div class="auth-steps">
      <div class="auth-step"><div class="step-num">1</div><br>Maak een account</div>
      <div class="auth-step"><div class="step-num">2</div><br>Beantwoord 85 vragen</div>
      <div class="auth-step"><div class="step-num">3</div><br>Ontvang je scorecard</div>
    </div>
  </div>
</div>

<!-- ═══ SCREEN 1: DASHBOARD ═══ -->
<div id="dashboardScreen" class="dashboard">
  <div class="dash-topbar">
    <div class="topbar-left" style="display:flex;align-items:center;gap:16px">
      <div class="logo" id="dashLogo"></div>
    </div>
    <div class="dash-topbar-right">
      <span class="role-badge" id="dashRoleBadge"></span>
      <span style="font-size:12px;color:var(--text-muted)" id="dashUserEmail"></span>
      <button class="user-logout" onclick="logoutUser()">Uitloggen</button>
    </div>
  </div>
  <div class="dash-content">
    <div class="dash-hero">
      <h1><span>UX</span> Review Platform</h1>
      <p>Ontdek waarom je website niet converteert. Doorloop een professionele UX audit.</p>
    </div>

    <div class="dash-stats" id="dashStats"></div>

    <div class="dash-section-header">
      <h2>Projecten</h2>
    </div>

    <div class="projects-grid" id="projectsGrid"></div>
  </div>
</div>

<!-- ═══ SCREEN 2: NEW PROJECT ═══ -->
<div id="newProjectScreen" class="new-project-screen hidden">
  <div class="np-card">
    <span class="logo" id="npLogo"></span>
    <div class="np-subtitle">UX Review Platform</div>
    <h2>Nieuw Project</h2>

    <div class="form-group">
      <label>Website URL *</label>
      <input type="url" id="npUrl" class="form-input" placeholder="https://jouwwebsite.nl">
    </div>

    <div class="form-group">
      <label>Projectnaam *</label>
      <input type="text" id="npName" class="form-input" placeholder="bijv. Webshop Review">
    </div>

    <!-- Admin-only: professional mode fields -->
    <div id="npAdminFields" class="hidden">
      <div class="form-group">
        <label>Modus</label>
        <div class="mode-choice">
          <div class="mode-option selected" onclick="selectMode('self-service', this)">
            <div class="mode-icon"><i data-lucide="scan-search"></i></div>
            <div class="mode-name">Self-Service</div>
            <div class="mode-desc">Klant doorloopt zelf.</div>
          </div>
          <div class="mode-option" onclick="selectMode('professional', this)">
            <div class="mode-icon"><i data-lucide="user"></i></div>
            <div class="mode-name">Professional</div>
            <div class="mode-desc">Jij voert de audit uit.</div>
          </div>
        </div>
      </div>
      <div class="form-group" id="npClientGroup" class="hidden">
        <label>Bedrijfsnaam klant</label>
        <input type="text" id="npClient" class="form-input" placeholder="bijv. Bakkerij de Goudkorst">
      </div>
      <div class="form-group" id="npPackageGroup" class="hidden">
        <label>Pakket</label>
        <select id="npPackage" class="form-select">
          <option value="quick">Quick Scan — €497</option>
          <option value="deep">Deep Review — €997</option>
          <option value="full">Full Audit + Redesign — €2.497</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label>Doelgroep (optioneel)</label>
      <input type="text" id="npAudience" class="form-input" placeholder="bijv. Jonge ouders, 25-40 jaar">
    </div>

    <div class="np-actions">
      <button class="btn btn-secondary" onclick="showDashboard()">Annuleer</button>
      <button class="btn btn-primary btn-lg" onclick="createProject()">Start Review →</button>
    </div>
  </div>
</div>

<!-- ═══ SCREEN 3: REVIEW INTERFACE ═══ -->
<div id="reviewScreen" class="hidden">
  <!-- URL bar (full-width, top) -->
  <div class="url-toolbar" id="urlToolbar">
    <button class="back-btn" onclick="backToDashboard()" title="Dashboard"><svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1.5" y="1.5" width="5" height="5.5" rx="1"/><rect x="9.5" y="1.5" width="5" height="3.5" rx="1"/><rect x="1.5" y="9.5" width="5" height="3.5" rx="1"/><rect x="9.5" y="7.5" width="5" height="5.5" rx="1"/></svg></button>
    <div class="url-bar">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
      <input type="url" id="urlInput" placeholder="Voer URL in..." onkeydown="if(event.key==='Enter')loadUrl()">
    </div>
    <button class="btn-go" onclick="loadUrl()">Laden</button>
    <button class="btn-go btn-open-ext" id="btnOpenExt" onclick="toggleSiteWindow()" title="Open site in apart venster"><i data-lucide="external-link" style="width:13px;height:13px"></i><span class="btn-label"> Open in venster</span></button>
  </div>

  <!-- Navigation topbar -->
  <div class="topbar">
    <div class="topbar-row">
      <div class="topbar-left">
        <button class="btn-nav btn-prev" onclick="prevStep()"><i data-lucide="chevron-left"></i> Vorige</button>
      </div>
      <div class="topbar-center">
        <div class="topbar-title">UX Review</div>
        <div class="topbar-subtitle">
          <span class="step-indicator" id="stepIndicator">Stap 1 / 19</span>
          <div id="deviceBarReview">
            <span class="topbar-sep">·</span>
            <span class="dot-live"></span>
            <span>Site in apart venster</span>
            <span class="topbar-sep">·</span>
            <a href="#" onclick="event.preventDefault();toggleSiteWindow()" style="color:var(--accent);text-decoration:none;font-weight:600">Terug naar preview</a>
          </div>
        </div>
      </div>
      <div class="topbar-right">
        <button class="btn-icon" onclick="toggleContrastChecker()" style="border-color:var(--purple);color:var(--purple)" title="Contrast"><i data-lucide="contrast"></i></button>
        <button class="btn-icon" onclick="runAutoScan()" id="btnAutoScan" style="border-color:var(--blue);color:var(--blue)" title="Auto-Scan"><i data-lucide="zap"></i></button>
        <button class="btn-icon" onclick="showScorecard()" style="border-color:var(--green);color:var(--green)" title="Scorecard"><i data-lucide="check-circle"></i></button>
        <button class="btn-icon" onclick="exportResults()" title="Exporteer"><i data-lucide="download"></i></button>
        <button class="btn-nav btn-next" id="btnNext" onclick="nextStep()">Volgende →</button>
      </div>
    </div>
  </div>

  <!-- Main content -->
  <div class="main">
    <div class="review-panel">
      <div class="review-body">
        <div class="step-stepper" id="stepStepper"></div>
        <div class="questions-area" id="questionsArea"></div>
      </div>
    </div>

    <div class="preview-panel">
      <div id="deviceBarNormal" class="preview-device-bar">
        <button class="device-btn active" onclick="switchDevice('desktop', this)">Desktop</button>
        <button class="device-btn" onclick="switchDevice('tablet', this)">Tablet</button>
        <button class="device-btn" onclick="switchDevice('mobile', this)">Mobile</button>
      </div>
      <div id="previewWrapper" class="preview-frame-wrapper desktop">
        <div id="previewEmpty" class="preview-empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          <p>Voer een URL in om de website te bekijken</p>
        </div>
        <iframe id="previewFrame" class="hidden" sandbox="allow-scripts allow-same-origin allow-forms" loading="lazy"></iframe>
      </div>
    </div>
  </div>
</div>

<!-- ═══ SCORECARD SCREEN ═══ -->
<div id="scorecardScreen" class="scorecard-overlay hidden">
  <div id="scorecardTopbar"></div>
  <div class="scorecard-container" id="scorecardContent"></div>
</div>

<!-- ═══ CONTRAST CHECKER PANEL ═══ -->
<div id="contrastPanel" class="cc-panel">
  <h3>Contrast Checker <button onclick="toggleContrastChecker()">×</button></h3>

  <div class="cc-colors">
    <div class="cc-color-group">
      <label>Voorgrond (tekst)</label>
      <div class="cc-color-input">
        <input type="color" id="ccFg" value="#333333" oninput="syncColorText('ccFg','ccFgHex');updateContrast()">
        <input type="text" id="ccFgHex" value="#333333" oninput="syncColorPicker('ccFgHex','ccFg');updateContrast()" maxlength="7">
      </div>
    </div>
    <div class="cc-color-group">
      <label>Achtergrond</label>
      <div class="cc-color-input">
        <input type="color" id="ccBg" value="#FFFFFF" oninput="syncColorText('ccBg','ccBgHex');updateContrast()">
        <input type="text" id="ccBgHex" value="#FFFFFF" oninput="syncColorPicker('ccBgHex','ccBg');updateContrast()" maxlength="7">
      </div>
    </div>
  </div>

  <div style="text-align:center;margin-bottom:12px">
    <button class="cc-swap" onclick="swapColors()">⇅ Wissel kleuren</button>
  </div>

  <div class="cc-preview" id="ccPreview" style="background:#FFFFFF;color:#333333">
    <div class="preview-large">Aa Tekst Voorbeeld</div>
    <div class="preview-small">Dit is een voorbeeld van de leesbaarheid van deze kleurencombinatie op jouw website.</div>
  </div>

  <div class="cc-ratio-display">
    <div class="cc-ratio-num" id="ccRatio">—</div>
    <div class="cc-ratio-label">Contrast ratio</div>
  </div>

  <div class="cc-results" id="ccResults">
    <div class="cc-result">
      <div class="cc-level">AA Normaal</div>
      <div class="cc-status" id="ccAAnorm">—</div>
      <div class="cc-req">≥ 4.5:1</div>
    </div>
    <div class="cc-result">
      <div class="cc-level">AA Groot</div>
      <div class="cc-status" id="ccAAlarge">—</div>
      <div class="cc-req">≥ 3:1</div>
    </div>
    <div class="cc-result">
      <div class="cc-level">AAA Normaal</div>
      <div class="cc-status" id="ccAAAnorm">—</div>
      <div class="cc-req">≥ 7:1</div>
    </div>
    <div class="cc-result">
      <div class="cc-level">AAA Groot</div>
      <div class="cc-status" id="ccAAAlarge">—</div>
      <div class="cc-req">≥ 4.5:1</div>
    </div>
  </div>

  <div class="cc-presets">
    <h4>Veel voorkomend</h4>
    <button class="cc-preset-btn" onclick="setContrastColors('#000000','#FFFFFF')">
      <div class="cc-preset-swatch" style="background:#000;border:1px solid #333"></div> Zwart op wit (21:1)
    </button>
    <button class="cc-preset-btn" onclick="setContrastColors('#FFFFFF','#ff5003')">
      <div class="cc-preset-swatch" style="background:#ff5003"></div> Wit op BOLD700 oranje
    </button>
    <button class="cc-preset-btn" onclick="setContrastColors('#FFFFFF','#1728c8')">
      <div class="cc-preset-swatch" style="background:#1728c8"></div> Wit op BOLD700 blauw
    </button>
    <button class="cc-preset-btn" onclick="setContrastColors('#767676','#FFFFFF')">
      <div class="cc-preset-swatch" style="background:#767676"></div> Grijs op wit (AA grens)
    </button>
  </div>
</div>

<!-- ═══ EXPORT MODAL ═══ -->
<div id="exportModal" class="modal-overlay hidden" onclick="if(event.target===this)closeExport()">
  <div class="modal">
    <h2>Exporteer Review Resultaten</h2>
    <pre id="exportContent"></pre>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeExport()">Sluiten</button>
      <button class="btn btn-primary" onclick="copyExport()">Kopieer naar Klembord</button>
    </div>
  </div>
</div>

<script>
// ═══════════════ BRAND LOGO SVG ═══════════════
function brandLogo(size, animate) {
  return `<svg class="brand-b${animate ? ' animate' : ''}" viewBox="0 0 238 245" style="height:${size || '1em'}" xmlns="http://www.w3.org/2000/svg">
    <path d="M194.252 118.59C207.964 113.052 218.412 104.907 226.247 94.1556C234.082 83.4043 238 70.6981 238 55.7114C238 37.7926 230.818 23.7832 216.453 14.3351C202.741 5.21277 183.805 0.325798 158.993 0H0V61.25H46.3594V46.2633H88.8011L0 245H116.878C150.178 245 176.949 238.484 197.191 225.452C217.432 212.42 227.226 193.198 227.226 167.786C227.226 155.731 224.288 145.957 218.738 137.487C213.188 129.016 205.026 122.826 194.252 118.59ZM157.687 193.198C148.872 199.388 136.466 202.32 120.469 202.32H69.5391L96.6365 141.722H134.181C158.667 141.722 171.073 150.193 171.073 166.809C171.073 178.537 166.502 187.008 157.687 193.198ZM166.176 92.2008C158.014 97.7394 146.261 100.672 131.243 100.672H114.919L139.078 46.5891H142.669C166.829 46.5891 178.908 53.7566 178.908 68.0918C178.582 78.5173 174.337 86.6622 166.176 92.2008Z"/>
  </svg>`;
}

// ═══════════════════════════════════════════════════════════
// DATA: All review steps from the BOLD700 UX Review Playbook
// ═══════════════════════════════════════════════════════════
const reviewSteps = [
  {
    id: 'heuristic1', title: '1. Zichtbaarheid Systeemstatus', shortTitle: 'Systeemstatus', impact: 'high',
    desc: 'Nielsen Heuristic #1 — Het systeem moet gebruikers altijd op de hoogte houden van wat er gebeurt.',
    questions: [
      { id: 'h1q1', text: 'Ziet de gebruiker waar hij/zij zich bevindt in de navigatie? (breadcrumbs, actieve menu-items)' },
      { id: 'h1q2', text: 'Is er een laad-indicator wanneer content wordt geladen?' },
      { id: 'h1q3', text: 'Krijgt de gebruiker bevestiging na een actie? (formulier verstuurd, item in wagen)' },
      { id: 'h1q4', text: 'Is er een progressie-indicator bij multi-step processen?' },
      { id: 'h1q5', text: 'Wordt de huidige pagina/sectie visueel onderscheiden in het menu?' },
      { id: 'h1q6', text: 'Bij e-commerce: is de winkelwagen-status altijd zichtbaar?' },
      { id: 'h1q7', text: 'Bij formulieren: is er real-time validatie?' }
    ]
  },
  {
    id: 'heuristic2', title: '2. Aansluiting Echte Wereld', shortTitle: 'Echte Wereld', impact: 'low',
    desc: 'Nielsen Heuristic #2 — Het systeem moet de taal van de gebruiker spreken.',
    questions: [
      { id: 'h2q1', text: 'Is de taal begrijpelijk voor de doelgroep? (geen jargon tenzij verwacht)' },
      { id: 'h2q2', text: 'Worden iconen gebruikt die universeel begrepen worden?' },
      { id: 'h2q3', text: 'Volgt de informatieopbouw een logische, natuurlijke volgorde?' },
      { id: 'h2q4', text: 'Zijn labels en knoppen beschrijvend? ("Verstuur aanvraag" i.p.v. "Submit")' },
      { id: 'h2q5', text: 'Gebruikt de site metaforen die aansluiten bij de echte wereld?' },
      { id: 'h2q6', text: 'Is de tone of voice consistent met het merk en de doelgroep?' }
    ]
  },
  {
    id: 'heuristic3', title: '3. Gebruikerscontrole & Vrijheid', shortTitle: 'Controle', impact: 'high',
    desc: 'Nielsen Heuristic #3 — Gebruikers hebben een duidelijke "nooduitgang" nodig.',
    questions: [
      { id: 'h3q1', text: 'Kan de gebruiker een stap terug in het proces?' },
      { id: 'h3q2', text: 'Is er een duidelijke "terug"-knop of annuleeroptie?' },
      { id: 'h3q3', text: 'Kan een formulier verlaten worden zonder data te verliezen?' },
      { id: 'h3q4', text: 'Is er undo/redo functionaliteit waar relevant?' },
      { id: 'h3q5', text: 'Kan de gebruiker eenvoudig een item uit de winkelwagen verwijderen?' },
      { id: 'h3q6', text: 'Zijn pop-ups en modals makkelijk te sluiten?' }
    ]
  },
  {
    id: 'heuristic4', title: '4. Consistentie & Standaarden', shortTitle: 'Consistentie', impact: 'low',
    desc: 'Nielsen Heuristic #4 — Volg platform- en industrieconventies.',
    questions: [
      { id: 'h4q1', text: 'Zijn knoppen consistent in stijl, kleur en positie?' },
      { id: 'h4q2', text: 'Wordt dezelfde terminologie overal op de site gebruikt?' },
      { id: 'h4q3', text: 'Volgt het ontwerp gangbare webconventies? (logo links = home, etc.)' },
      { id: 'h4q4', text: 'Is de typografie consistent? (fonts, groottes, hiërarchie)' },
      { id: 'h4q5', text: 'Gedragen interactieve elementen zich voorspelbaar? (hover states, klik-feedback)' },
      { id: 'h4q6', text: 'Is de layout consistent tussen pagina\'s?' }
    ]
  },
  {
    id: 'heuristic5', title: '5. Foutpreventie', shortTitle: 'Foutpreventie', impact: 'high',
    desc: 'Nielsen Heuristic #5 — Voorkom problemen door zorgvuldig ontwerp.',
    questions: [
      { id: 'h5q1', text: 'Worden formuliervelden gevalideerd vóór versturen?' },
      { id: 'h5q2', text: 'Zijn er bevestigingsdialogen bij onomkeerbare acties?' },
      { id: 'h5q3', text: 'Worden invulvelden voorzien van hints en voorbeelden?' },
      { id: 'h5q4', text: 'Is het duidelijk welke velden verplicht zijn?' },
      { id: 'h5q5', text: 'Worden fouten voorkomen door slim ontwerp? (datumkiezers i.p.v. tekst)' },
      { id: 'h5q6', text: 'Zijn destructieve knoppen visueel onderscheiden van constructieve?' }
    ]
  },
  {
    id: 'heuristic6', title: '6. Herkenning > Herinnering', shortTitle: 'Herkenning', impact: 'low',
    desc: 'Nielsen Heuristic #6 — Minimaliseer de geheugenbelasting.',
    questions: [
      { id: 'h6q1', text: 'Zijn de belangrijkste acties altijd zichtbaar? (niet in menu\'s verstopt)' },
      { id: 'h6q2', text: 'Worden recent bekeken items of pagina\'s getoond?' },
      { id: 'h6q3', text: 'Is de navigatie altijd bereikbaar? (sticky header/sidebar)' },
      { id: 'h6q4', text: 'Bij formulieren: zijn eerder ingevulde gegevens zichtbaar bij overzicht?' },
      { id: 'h6q5', text: 'Worden opties getoond i.p.v. dat de gebruiker ze moet onthouden?' },
      { id: 'h6q6', text: 'Is de zoekfunctie makkelijk vindbaar en bruikbaar?' }
    ]
  },
  {
    id: 'heuristic7', title: '7. Flexibiliteit & Efficiëntie', shortTitle: 'Flexibiliteit', impact: 'low',
    desc: 'Nielsen Heuristic #7 — Bedien zowel beginners als ervaren gebruikers.',
    questions: [
      { id: 'h7q1', text: 'Zijn er snelkoppelingen voor veelgebruikte acties?' },
      { id: 'h7q2', text: 'Kunnen ervaren gebruikers stappen overslaan?' },
      { id: 'h7q3', text: 'Is er een zoekfunctie naast navigatie?' },
      { id: 'h7q4', text: 'Zijn formulieren slim? (auto-complete, adres-lookup)' },
      { id: 'h7q5', text: 'Is het mogelijk om acties in bulk uit te voeren?' }
    ]
  },
  {
    id: 'heuristic8', title: '8. Esthetisch & Minimalistisch Design', shortTitle: 'Design', impact: 'low',
    desc: 'Nielsen Heuristic #8 — Elk extra element concurreert met relevante informatie.',
    questions: [
      { id: 'h8q1', text: 'Is er een duidelijke visuele hiërarchie? (primaire vs. secundaire content)' },
      { id: 'h8q2', text: 'Is er voldoende white space / ademruimte tussen elementen?' },
      { id: 'h8q3', text: 'Staat de belangrijkste informatie above the fold?' },
      { id: 'h8q4', text: 'Zijn er afleidende elementen? (auto-play video, pop-ups, banners)' },
      { id: 'h8q5', text: 'Zijn CTA\'s duidelijk en niet overwoekerd door andere content?' },
      { id: 'h8q6', text: 'Ondersteunen afbeeldingen de boodschap of zijn ze decoratief?' }
    ]
  },
  {
    id: 'heuristic9', title: '9. Foutherstel', shortTitle: 'Foutherstel', impact: 'high',
    desc: 'Nielsen Heuristic #9 — Foutmeldingen moeten in gewone taal en constructief zijn.',
    questions: [
      { id: 'h9q1', text: 'Zijn foutmeldingen in begrijpelijke taal? (niet "Error 404")' },
      { id: 'h9q2', text: 'Wordt er aangegeven wat de gebruiker moet doen om de fout op te lossen?' },
      { id: 'h9q3', text: 'Zijn foutmeldingen visueel opvallend? (rode rand, icoon)' },
      { id: 'h9q4', text: 'Wordt de fout bij het juiste veld getoond?' },
      { id: 'h9q5', text: 'Is de 404-pagina nuttig? (zoekfunctie, links)' },
      { id: 'h9q6', text: 'Worden technische foutmeldingen vertaald naar gebruikerstaal?' }
    ]
  },
  {
    id: 'heuristic10', title: '10. Help & Documentatie', shortTitle: 'Help', impact: 'low',
    desc: 'Nielsen Heuristic #10 — Bied hulp en documentatie die taakgericht is.',
    questions: [
      { id: 'h10q1', text: 'Is er een FAQ-sectie die veelgestelde vragen beantwoordt?' },
      { id: 'h10q2', text: 'Is er contextgevoelige hulp? (tooltips, inline uitleg)' },
      { id: 'h10q3', text: 'Is contactinformatie makkelijk te vinden?' },
      { id: 'h10q4', text: 'Bij complexe producten: is er een onboarding flow?' },
      { id: 'h10q5', text: 'Is er een chatfunctie of ander direct contactkanaal?' },
      { id: 'h10q6', text: 'Zijn helpartikelen doorzoekbaar en goed georganiseerd?' }
    ]
  },
  {
    id: 'honeycomb', title: '11. UX Honeycomb', shortTitle: 'Honeycomb', impact: 'low',
    desc: 'Peter Morville\'s 7 facetten van gebruikerservaring — score elk facet.',
    questions: [
      { id: 'hcq1', text: 'Useful — Lost dit product een echt probleem op?' },
      { id: 'hcq2', text: 'Usable — Is het makkelijk te gebruiken?' },
      { id: 'hcq3', text: 'Desirable — Wil je het gebruiken? Voelt het goed?' },
      { id: 'hcq4', text: 'Findable — Kun je vinden wat je zoekt?' },
      { id: 'hcq5', text: 'Accessible — Is het toegankelijk voor iedereen?' },
      { id: 'hcq6', text: 'Credible — Vertrouw je het?' },
      { id: 'hcq7', text: 'Valuable — Levert het waarde?' }
    ]
  },
  {
    id: 'conversion', title: '12. Conversie & Performance', shortTitle: 'Conversie', impact: 'high',
    desc: 'Harde metrics en conversie-elementen die direct omzet beïnvloeden.',
    questions: [
      { id: 'cvq1', text: 'Is de primaire CTA direct zichtbaar boven de fold?' },
      { id: 'cvq2', text: 'Is de waardepropositie binnen 5 seconden duidelijk?' },
      { id: 'cvq3', text: 'Zijn er vertrouwenssignalen? (reviews, keurmerken, klantenlogo\'s)' },
      { id: 'cvq4', text: 'Is het contactformulier kort genoeg?' },
      { id: 'cvq5', text: 'Is er social proof zichtbaar op de belangrijkste pagina\'s?' },
      { id: 'cvq6', text: 'Laadtijd: onder 3 seconden (liefst onder 2)?' },
      { id: 'cvq7', text: 'LCP onder 2,5 seconden? CLS onder 0,1? INP onder 200ms?' }
    ]
  },
  {
    id: 'mobile', title: '13. Mobiele Ervaring', shortTitle: 'Mobiel', impact: 'high',
    desc: 'Specifieke checks voor de mobiele gebruikerservaring.',
    questions: [
      { id: 'mbq1', text: 'Is de site volledig responsive?' },
      { id: 'mbq2', text: 'Zijn touch targets groot genoeg? (min 44x44px)' },
      { id: 'mbq3', text: 'Is tekst leesbaar zonder zoomen?' },
      { id: 'mbq4', text: 'Werken formulieren goed op mobiel? (juiste toetsenbordtypes)' },
      { id: 'mbq5', text: 'Is de mobiele navigatie intuïtief? (hamburger, sticky nav)' }
    ]
  },
  {
    id: 'seo', title: '14. SEO & Vindbaarheid', shortTitle: 'SEO', impact: 'low',
    desc: 'Basis SEO-checks die bijdragen aan vindbaarheid en professionele uitstraling.',
    questions: [
      { id: 'seq1', text: 'Heeft elke pagina een unieke, beschrijvende title tag?' },
      { id: 'seq2', text: 'Zijn meta descriptions ingevuld en aantrekkelijk?' },
      { id: 'seq3', text: 'Worden heading tags (H1, H2, H3) correct gebruikt?' },
      { id: 'seq4', text: 'Zijn afbeeldingen voorzien van alt-teksten?' },
      { id: 'seq5', text: 'Is de URL-structuur clean en logisch?' }
    ]
  },
  {
    id: 'a11y', title: '15. Toegankelijkheid & Contrast', shortTitle: 'Contrast', impact: 'high',
    desc: 'WCAG-richtlijnen voor kleurcontrast, leesbaarheid en toegankelijkheid. Gebruik de ingebouwde contrast checker om kleuren te testen.',
    questions: [
      { id: 'a11q1', text: 'Heeft de body tekst voldoende contrast? (WCAG AA: 4.5:1 ratio)', hasContrastChecker: true },
      { id: 'a11q2', text: 'Hebben knoppen en links voldoende contrast met hun achtergrond?' },
      { id: 'a11q3', text: 'Is placeholder tekst in formulieren leesbaar? (vaak te licht)' },
      { id: 'a11q4', text: 'Is tekst op afbeeldingen/banners leesbaar? (overlay contrast)' },
      { id: 'a11q5', text: 'Wordt kleur niet als enige middel gebruikt om info over te brengen?' },
      { id: 'a11q6', text: 'Zijn focus-states duidelijk zichtbaar voor toetsenbordnavigatie?' },
      { id: 'a11q7', text: 'Is de tekst minstens 16px en de regelafstand minstens 1.5?' }
    ]
  },
  {
    id: 'wcag_keyboard', title: '16. Toetsenbord & Navigatie', shortTitle: 'Toetsenbord', impact: 'high',
    desc: 'WCAG 2.1.1, 2.1.2, 2.4.1, 2.4.2, 2.4.3, 2.4.5, 2.4.7 — Alle functionaliteit moet bereikbaar zijn via het toetsenbord met logische focusvolgorde.',
    questions: [
      { id: 'kb1', text: 'Is alle functionaliteit bereikbaar met alleen het toetsenbord? (WCAG 2.1.1)' },
      { id: 'kb2', text: 'Kan de gebruiker nergens vast komen te zitten met het toetsenbord? Geen keyboard traps? (WCAG 2.1.2)' },
      { id: 'kb3', text: 'Is er een "Skip to content" link aanwezig om navigatie over te slaan? (WCAG 2.4.1)' },
      { id: 'kb4', text: 'Heeft elke pagina een beschrijvende, unieke \\u003Ctitle\\u003E? (WCAG 2.4.2)' },
      { id: 'kb5', text: 'Is de tab-volgorde logisch en voorspelbaar? (WCAG 2.4.3)' },
      { id: 'kb6', text: 'Zijn er meerdere manieren om pagina\'s te vinden? (menu, zoekfunctie, sitemap) (WCAG 2.4.5)' },
      { id: 'kb7', text: 'Is de focus-indicator altijd duidelijk zichtbaar bij toetsenbordnavigatie? (WCAG 2.4.7)' }
    ]
  },
  {
    id: 'wcag_media', title: '17. Media & Timing', shortTitle: 'Media', impact: 'low',
    desc: 'WCAG 1.2.1–1.2.5, 1.4.2, 2.2.1, 2.2.2, 2.3.1 — Tijdgebaseerde media moet alternatieven bieden, auto-play onder controle, en geen content die aanvallen kan veroorzaken.',
    questions: [
      { id: 'md1', text: 'Hebben audio-only bestanden een teksttranscriptie? (WCAG 1.2.1)' },
      { id: 'md2', text: 'Hebben video\'s ondertiteling (captions)? (WCAG 1.2.2)' },
      { id: 'md3', text: 'Is er een audiodescriptie of tekst-alternatief voor video-inhoud? (WCAG 1.2.3 / 1.2.5)' },
      { id: 'md4', text: 'Hebben live video-uitzendingen ondertiteling? (WCAG 1.2.4)' },
      { id: 'md5', text: 'Kan audio die automatisch afspeelt gepauzeerd of gedempt worden? (WCAG 1.4.2)' },
      { id: 'md6', text: 'Kan de gebruiker tijdslimieten verlengen, uitschakelen of aanpassen? (WCAG 2.2.1)' },
      { id: 'md7', text: 'Kan bewegende, knipperende of auto-scrollende content gepauzeerd worden? (WCAG 2.2.2)' },
      { id: 'md8', text: 'Bevat de pagina geen content die meer dan 3x per seconde flitst? (WCAG 2.3.1)' }
    ]
  },
  {
    id: 'wcag_forms', title: '18. Formulieren & Foutafhandeling', shortTitle: 'Formulieren', impact: 'high',
    desc: 'WCAG 1.3.1, 3.3.1, 3.3.2, 3.3.3, 3.3.4, 3.1.1, 3.1.2 — Formulieren moeten labels hebben, fouten duidelijk melden, en taalinstelling correct zijn.',
    questions: [
      { id: 'fm1', text: 'Heeft elk formulierveld een zichtbaar en gekoppeld \\u003Clabel\\u003E? (WCAG 3.3.2 / 1.3.1)' },
      { id: 'fm2', text: 'Worden fouten duidelijk geïdentificeerd en in tekst beschreven? (WCAG 3.3.1)' },
      { id: 'fm3', text: 'Worden suggesties gegeven bij invoerfouten? (bijv. "Voer een geldig e-mailadres in") (WCAG 3.3.3)' },
      { id: 'fm4', text: 'Kunnen juridische/financiële acties ongedaan gemaakt, gecontroleerd of bevestigd worden? (WCAG 3.3.4)' },
      { id: 'fm5', text: 'Heeft de HTML-pagina een correct lang-attribuut? (bijv. lang="nl") (WCAG 3.1.1)' },
      { id: 'fm6', text: 'Worden wisselingen van taal in de content gemarkeerd met lang-attribuut? (WCAG 3.1.2)' },
      { id: 'fm7', text: 'Zijn verplichte velden duidelijk aangegeven (niet alleen met kleur)? (WCAG 1.3.1)' },
      { id: 'fm8', text: 'Worden instructies gegeven vóór het formulier waar nodig? (formaat, vereisten) (WCAG 3.3.2)' }
    ]
  },
  {
    id: 'wcag_structure', title: '19. Semantiek & Structuur', shortTitle: 'Semantiek', impact: 'low',
    desc: 'WCAG 1.3.1, 1.3.2, 1.3.3, 1.3.4, 1.3.5, 1.4.4, 1.4.10, 1.4.13, 4.1.1, 4.1.2, 2.5.1, 2.5.2, 2.5.3, 2.5.4 — Correcte HTML-structuur, ARIA-gebruik, responsive zoom en touch-interacties.',
    questions: [
      { id: 'sm1', text: 'Is de heading-hiërarchie logisch (h1 → h2 → h3, geen niveaus overgeslagen)? (WCAG 1.3.1)' },
      { id: 'sm2', text: 'Hebben alle interactieve elementen een toegankelijke naam (aria-label of zichtbare tekst)? (WCAG 4.1.2)' },
      { id: 'sm3', text: 'Zijn ARIA-rollen correct gebruikt? (geen div als button zonder role="button") (WCAG 4.1.2)' },
      { id: 'sm4', text: 'Is de volgorde van content in de DOM logisch, ook zonder CSS? (WCAG 1.3.2)' },
      { id: 'sm5', text: 'Werkt de layout correct bij 200% zoom zonder horizontaal scrollen? (WCAG 1.4.4 / 1.4.10)' },
      { id: 'sm6', text: 'Verdwijnt content die verschijnt bij hover/focus niet onverwacht? Kan deze gesloten worden? (WCAG 1.4.13)' },
      { id: 'sm7', text: 'Hebben formuliervelden autocomplete-attributen voor persoonlijke data? (naam, e-mail, adres) (WCAG 1.3.5)' },
      { id: 'sm8', text: 'Werkt de content in zowel portrait als landscape modus? (WCAG 1.3.4)' },
      { id: 'sm9', text: 'Zijn complexe gebaren (pinch, swipe) ook beschikbaar via een single-pointer alternatief? (WCAG 2.5.1)' },
      { id: 'sm10', text: 'Kan een pointer-actie afgebroken worden? (geen actie bij alleen down-event) (WCAG 2.5.2)' },
      { id: 'sm11', text: 'Komt de accessible name overeen met de zichtbare labeltekst? (WCAG 2.5.3)' },
      { id: 'sm12', text: 'Is er geen functionaliteit die alleen via device-motion werkt (schudden, kantelen) zonder alternatief? (WCAG 2.5.4)' }
    ]
  }
];

// ═══════════════ TIPS PER VRAAG ═══════════════
const questionTips = {
  h1q1:'Voeg breadcrumbs toe en markeer actieve menu-item visueel',
  h1q2:'Implementeer skeleton loaders bij asynchroon laden',
  h1q3:'Toon visuele feedback (toast/animatie) na elke actie',
  h1q4:'Voeg een progress bar toe voor multi-step processen',
  h1q5:'Markeer huidige pagina in menu met duidelijke active state',
  h1q6:'Maak winkelwagen-totaal en aantal items altijd zichtbaar',
  h1q7:'Valideer formuliervelden live terwijl de gebruiker typt',
  h2q1:'Vereenvoudig taal naar het niveau van je doelgroep',
  h2q2:'Kies universeel erkende iconen of voeg labels toe',
  h2q3:'Reorganiseer informatie in logische, natuurlijke volgorde',
  h2q4:'Maak knoplabels beschrijvend en actiegericht',
  h2q5:'Gebruik metaforen die aansluiten bij de echte wereld',
  h2q6:'Zet tone of voice consistent in met merkidentiteit',
  h3q1:'Voeg terug-functie toe zodat gebruiker vorige stap kan bereiken',
  h3q2:'Plaats duidelijke terug/annuleer knop op alle pagina\'s',
  h3q3:'Sla formuliergegevens automatisch op bij paginaverlating',
  h3q4:'Voeg undo/redo-functie toe waar acties onomkeerbaar zijn',
  h3q5:'Maak winkelwagenitems eenvoudig verwijderbaar',
  h3q6:'Maak pop-ups sluitbaar met X-knop en ESC-toets',
  h4q1:'Standaardiseer knoppen in kleur, grootte en positie',
  h4q2:'Gebruik dezelfde termen consistent op de hele site',
  h4q3:'Volg gevestigde webconventies (logo links, etc.)',
  h4q4:'Zorg dat fonts, groottes en gewichten consistent zijn',
  h4q5:'Maak hover/klik-states voorspelbaar en consistent',
  h4q6:'Herhaal layout-structuur consistent over pagina\'s',
  h5q1:'Valideer alle verplichte velden vóór formulierinzending',
  h5q2:'Toon bevestigingsdialoog voor onomkeerbare acties',
  h5q3:'Voeg hints en voorbeeldtekst toe in formuliervelden',
  h5q4:'Markeer verplichte velden met asterisk (*) of label',
  h5q5:'Gebruik datumkiezers en dropdowns i.p.v. vrije tekst',
  h5q6:'Maak destructieve knoppen visueel anders (rood/oranje)',
  h6q1:'Maak primaire acties altijd zichtbaar zonder scrollen',
  h6q2:'Toon recent bekeken items voor snelle terugkeer',
  h6q3:'Maak navigatie sticky zodat deze altijd bereikbaar is',
  h6q4:'Toon eerder ingevulde gegevens in formulieroverzicht',
  h6q5:'Toon beschikbare opties i.p.v. gebruiker te laten raden',
  h6q6:'Plaats zoekfunctie prominent bovenaan de pagina',
  h7q1:'Bied keyboard shortcuts aan voor veelgebruikte acties',
  h7q2:'Laat ervaren gebruikers intro-stappen overslaan',
  h7q3:'Zet zoekfunctie naast of boven primaire navigatie',
  h7q4:'Vul formuliervelden slim in met auto-complete',
  h7q5:'Voeg bulk-acties toe voor meervoudig items verwerken',
  h8q1:'Maak visuele hiërarchie duidelijk via grootte en kleur',
  h8q2:'Voeg voldoende witruimte toe rond elementen',
  h8q3:'Zorg dat belangrijkste content above the fold staat',
  h8q4:'Verwijder afleidende pop-ups, autoplay en banners',
  h8q5:'Maak CTA\'s opvallend via kleur, grootte en plaatsing',
  h8q6:'Kies afbeeldingen die de boodschap ondersteunen',
  h9q1:'Schrijf foutmeldingen in begrijpelijke, niet-technische taal',
  h9q2:'Geef duidelijke instructies wat gebruiker moet doen',
  h9q3:'Maak foutmeldingen visueel opvallend (rood + icoon)',
  h9q4:'Toon foutmeldingen inline bij het juiste veld',
  h9q5:'Maak nuttige 404-pagina met zoekfunctie en links',
  h9q6:'Vertaal technische foutcodes naar gebruikerstaal',
  h10q1:'Maak FAQ-sectie met veelgestelde vragen',
  h10q2:'Voeg contextgevoelige tooltips en inline uitleg toe',
  h10q3:'Plaats contactinfo makkelijk vindbaar in footer/header',
  h10q4:'Maak onboarding-flow voor complexe producten',
  h10q5:'Voeg chatfunctie of WhatsApp-knop toe',
  h10q6:'Zorg dat helpartikelen doorzoekbaar en geordend zijn',
  hcq1:'Maak duidelijk welk probleem je product oplost',
  hcq2:'Vereenvoudig interface en workflows voor intuïtief gebruik',
  hcq3:'Maak het product visueel aantrekkelijk en wenselijk',
  hcq4:'Verbeter navigatie en zoekfunctionaliteit',
  hcq5:'Implementeer WCAG-richtlijnen voor toegankelijkheid',
  hcq6:'Voeg vertrouwenssignalen toe (certificaten, reviews)',
  hcq7:'Toon concrete waarde en voordelen voor gebruiker',
  cvq1:'Plaats primaire CTA direct zichtbaar boven de fold',
  cvq2:'Maak waardepropositie binnen 5 seconden glashelder',
  cvq3:'Voeg reviews, keurmerken en klantenlogo\'s toe',
  cvq4:'Houd contactformulier kort: max 5 velden',
  cvq5:'Toon testimonials, ratings en gebruikersaantallen',
  cvq6:'Optimaliseer laadtijd: onder 3 seconden (liefst 2)',
  cvq7:'Optimaliseer Core Web Vitals (LCP, CLS, INP)',
  mbq1:'Zorg dat site responsive is op alle schermgroottes',
  mbq2:'Maak touch targets minstens 44×44px groot',
  mbq3:'Zorg voor leesbare tekst zonder zoomen (min 16px)',
  mbq4:'Optimaliseer formulieren voor mobiel (juiste keyboards)',
  mbq5:'Maak intuïtief mobiel menu (hamburger + sticky nav)',
  seq1:'Geef elke pagina een unieke, beschrijvende title tag',
  seq2:'Vul meta descriptions in voor alle pagina\'s',
  seq3:'Gebruik heading tags (H1-H6) correct en hiërarchisch',
  seq4:'Voeg beschrijvende alt-teksten toe aan afbeeldingen',
  seq5:'Maak URL-structuur schoon, leesbaar en logisch',
  a11q1:'Body tekst moet minimaal 4.5:1 contrast ratio hebben (WCAG AA). Test met de contrast checker: klik de Contrast-knop hierboven.',
  a11q2:'Knoppen, links en interactieve elementen moeten opvallen. Minimaal 3:1 voor grote tekst, 4.5:1 voor normale tekst.',
  a11q3:'Placeholder tekst is vaak #999 op #fff (2.7:1) — dat faalt WCAG. Gebruik labels in plaats van alleen placeholders.',
  a11q4:'Tekst op hero images/banners moet leesbaar zijn. Gebruik een semi-transparante overlay of text-shadow.',
  a11q5:'Gebruik niet alleen kleur (bijv. rood/groen) om fouten of succes te tonen. Voeg ook iconen of tekst toe.',
  a11q6:'Tab door de pagina — elk interactief element moet een duidelijk zichtbare focus ring hebben.',
  a11q7:'Gebruik minimaal font-size: 16px voor body tekst en line-height: 1.5 voor goede leesbaarheid.',
  kb1:'Tab door de hele pagina. Elke knop, link, formulierveld en interactief element moet bereikbaar zijn zonder muis.',
  kb2:'Let op modals, dropdowns en sliders — de focus mag niet "gevangen" raken. Escape moet altijd werken om te sluiten.',
  kb3:'Voeg bovenaan de pagina een verborgen "Skip to main content" link toe die zichtbaar wordt bij focus: &lt;a href="#main" class="skip-link"&gt;.',
  kb4:'Elke pagina moet een unieke &lt;title&gt; hebben die de inhoud beschrijft, bijv. "Winkelwagen | Webshop" in plaats van alleen "Webshop".',
  kb5:'Tab door de pagina en controleer of de volgorde visueel logisch is: van links naar rechts, van boven naar beneden. Geen rare sprongen.',
  kb6:'Bied minstens twee navigatiemethoden: hoofdmenu, zoekfunctie, sitemap, of breadcrumbs.',
  kb7:'De focus-ring moet altijd zichtbaar zijn. Gebruik outline: 2px solid en verwijder nooit outline:none zonder vervanging.',
  md1:'Bied een volledige tekstversie aan van audio-only content (bijv. podcasts). Plaats het transcript direct onder de speler.',
  md2:'Voeg ondertiteling toe aan alle video\\u0027s. Gebruik &lt;track kind="captions"&gt; voor HTML5 video of de ingebouwde captioning van YouTube/Vimeo.',
  md3:'Beschrijf visuele content in video\'s via audiodescriptie of een tekst-alternatief dat de visuele informatie dekt.',
  md4:'Live streams moeten real-time ondertiteling hebben. Gebruik services als Google Live Transcribe of professionele CART-diensten.',
  md5:'Audio mag niet automatisch starten, of moet binnen 3 seconden te stoppen/dempen zijn. Bied een duidelijke mute-knop.',
  md6:'Als er een tijdslimiet is (bijv. sessie-timeout), waarschuw 20 sec. van tevoren en laat de gebruiker verlengen.',
  md7:'Carousels, nieuws-tickers, auto-play video\'s: bied een duidelijke pauze/stop-knop. Content mag niet oneindig bewegen.',
  md8:'Geen content die meer dan 3x per seconde knippert of flitst. Dit kan epileptische aanvallen veroorzaken.',
  fm1:'Elk input-veld moet een &lt;label for="id"&gt; hebben, of gebruik aria-label. Placeholder alleen is NIET voldoende als label.',
  fm2:'Toon foutmeldingen in tekst bij het veld zelf (niet alleen rood kleuren). Gebruik role="alert" voor schermlezers.',
  fm3:'Geef specifieke hints: "Voer een e-mailadres in zoals naam@voorbeeld.nl" in plaats van alleen "Ongeldig".',
  fm4:'Bij bestellingen of juridische acties: toon een bevestigingspagina, of bied een "ongedaan maken" optie na verzending.',
  fm5:'Voeg lang="nl" toe aan het &lt;html&gt; element. Dit helpt schermlezers de juiste taal en uitspraak te kiezen.',
  fm6:'Als een alinea of citaat in een andere taal is, markeer dit met lang="en" op dat element.',
  fm7:'Markeer verplichte velden met een asterisk (*) en leg bovenaan uit: "* = verplicht". Gebruik ook aria-required="true".',
  fm8:'Geef vóór complexe formulieren instructies over formaat (bijv. "Datum: DD-MM-JJJJ") en vereisten.',
  sm1:'Gebruik één h1 per pagina, gevolgd door h2 voor secties, h3 voor subsecties. Sla geen niveaus over (geen h1 → h3).',
  sm2:'Knoppen met alleen een icoon moeten een aria-label hebben, bijv. &lt;button aria-label="Sluiten"&gt;✕&lt;/button&gt;.',
  sm3:'Gebruik &lt;button&gt; voor klikbare acties, &lt;a&gt; voor navigatie. Vermijd &lt;div onclick=""&gt;. Gebruik role en tabindex als het niet anders kan.',
  sm4:'Schakel CSS uit en controleer of de content in een logische leesvolgorde staat. DOM-volgorde = leesvolgorde.',
  sm5:'Zoom naar 200% en controleer of alle content zichtbaar blijft zonder horizontaal te scrollen (op 1280px viewport).',
  sm6:'Tooltips en hover-content moeten: (1) zichtbaar blijven tot de gebruiker ze sluit, (2) hoverable zijn, (3) met Escape te sluiten.',
  sm7:'Gebruik autocomplete="name", autocomplete="email", autocomplete="street-address" etc. op formuliervelden voor persoonlijke data.',
  sm8:'Test de site in zowel portrait als landscape. Content mag niet beperkt zijn tot één oriëntatie, tenzij noodzakelijk.',
  sm9:'Bied voor pinch-to-zoom, multi-finger swipes etc. altijd een single-tap of knop-alternatief.',
  sm10:'Gebruik onclick (up-event) in plaats van onmousedown. Gebruikers moeten een klik kunnen annuleren door weg te slepen.',
  sm11:'Als een knop "Zoeken" zegt, moet de aria-label ook "Zoeken" zijn — niet iets anders. Zichtbare tekst = accessible name.',
  sm12:'Als je device-motion gebruikt (schudden om te resetten), bied dan altijd een knop-alternatief en laat de motion uitschakelbaar zijn.'
};

// ═══════════════ FIREBASE CONFIG ═══════════════
const firebaseConfig = {
  apiKey: "AIzaSyDPQdEZk574PO7ft7aHTSPjzxwgSXFtf-o",
  authDomain: "bold700-ux-reviews.firebaseapp.com",
  projectId: "bold700-ux-reviews",
  storageBucket: "bold700-ux-reviews.firebasestorage.app",
  messagingSenderId: "61806362887",
  appId: "1:61806362887:web:8e0667d1d01119279fc5a2",
  measurementId: "G-94SCL9W7X3"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// ═══════════════ STATE ═══════════════
let projects = [];
let activeProjectId = null;
let currentStep = 0;
let newProjectMode = 'self-service';
let isAdmin = false;
let currentUser = null;    // Firebase Auth user object
let userProfile = null;    // Firestore user profile { role, createdAt, ... }
let saveTimer = null;
let authMode = 'login';    // 'login' or 'register'

// URL params
const urlParams = new URLSearchParams(window.location.search);
const urlProjectId = urlParams.get('p');

function getActiveProject() { return projects.find(p => p.id === activeProjectId); }
function getAnswers() { const p = getActiveProject(); return p ? p.answers : {}; }

// ── Debounced save: writes to Firestore + localStorage backup ──
function saveState() {
  // Always save to localStorage as backup
  try { localStorage.setItem('bold700_projects', JSON.stringify(projects)); } catch(e) {}

  // Debounce Firestore writes (500ms)
  if (saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    const project = getActiveProject();
    if (project) syncProjectToFirestore(project);
  }, 500);
}

// ── Sync single project to Firestore ──
async function syncProjectToFirestore(project) {
  try {
    const docData = { ...project, updatedAt: new Date().toISOString() };
    // Ensure userId and email are always stored
    if (currentUser && !docData.userId) docData.userId = currentUser.uid;
    if (currentUser && !docData.leadEmail) docData.leadEmail = currentUser.email;
    // Don't store base64 screenshots in Firestore (too large)
    // They'll be uploaded to Storage separately
    const cleanAnswers = {};
    for (const [qId, ans] of Object.entries(docData.answers || {})) {
      cleanAnswers[qId] = { ...ans };
      delete cleanAnswers[qId].screenshot; // Remove base64, use Storage instead
      delete cleanAnswers[qId].screenshots;
    }
    docData.answers = cleanAnswers;
    await db.collection('projects').doc(project.id).set(docData, { merge: true });
  } catch(e) {
    console.warn('[Firebase] Save failed:', e.message);
  }
}

// ── Load from Firestore based on auth state ──
async function loadState() {
  if (!currentUser) { projects = []; return; }

  try {
    if (isAdmin) {
      // Admin: load ALL projects
      const snapshot = await db.collection('projects').orderBy('createdAt', 'desc').get();
      projects = snapshot.docs.map(d => ({ ...d.data(), id: d.id }));
      console.log('[Firebase] Loaded', projects.length, 'projects (admin mode)');
    } else {
      // Regular user: load only their projects by userId
      let snapshot;
      try {
        snapshot = await db.collection('projects').where('userId', '==', currentUser.uid).orderBy('createdAt', 'desc').get();
      } catch(indexErr) {
        console.warn('[Firebase] Index not ready, using fallback:', indexErr.message);
        snapshot = await db.collection('projects').where('userId', '==', currentUser.uid).get();
      }
      projects = snapshot.docs.map(d => ({ ...d.data(), id: d.id }));
      projects.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));
      console.log('[Firebase] Loaded', projects.length, 'projects for user', currentUser.uid);

      // Migrate any localStorage projects that don't have a userId
      try {
        const saved = localStorage.getItem('bold700_projects');
        if (saved) {
          const localProjects = JSON.parse(saved);
          for (const lp of localProjects) {
            if (!projects.find(p => p.id === lp.id)) {
              lp.userId = currentUser.uid;
              lp.leadEmail = currentUser.email;
              projects.push(lp);
              await syncProjectToFirestore(lp);
            }
          }
          localStorage.removeItem('bold700_projects'); // Clean up after migration
          console.log('[Firebase] Migrated localStorage projects');
        }
      } catch(e) {}
    }
  } catch(e) {
    console.warn('[Firebase] Load failed:', e.message);
    projects = [];
  }
}

// ── Upload screenshot to Firebase Storage ──
async function uploadScreenshotToStorage(projectId, questionId, dataUrl) {
  try {
    const ref = storage.ref(`screenshots/${projectId}/${questionId}.jpg`);
    await ref.putString(dataUrl, 'data_url');
    const downloadUrl = await ref.getDownloadURL();
    return downloadUrl;
  } catch(e) {
    console.warn('[Firebase] Screenshot upload failed:', e.message);
    return null;
  }
}

// ── Get screenshot URL from Firebase Storage ──
async function getScreenshotFromStorage(projectId, questionId) {
  try {
    const ref = storage.ref(`screenshots/${projectId}/${questionId}.jpg`);
    return await ref.getDownloadURL();
  } catch(e) {
    return null;
  }
}

function calcProjectScore(project) {
  const ans = project.answers || {};
  const totalQ = reviewSteps.reduce((s, st) => s + st.questions.length, 0);
  const nvtCount = Object.values(ans).filter(a => a.score === 'nvt').length;
  const scored = Object.values(ans).filter(a => a.score && a.score !== 'nvt');
  const effectiveTotal = totalQ - nvtCount;
  if (effectiveTotal === 0) return { avg: 0, answered: 0, total: totalQ, effectiveTotal: 0, nvt: nvtCount };
  // Unanswered questions count as 0 — only scored questions contribute points
  const sum = scored.reduce((s, a) => s + (a.score === 'good' ? 10 : a.score === 'ok' ? 6 : 3), 0);
  const avg = sum / effectiveTotal;
  return { avg, answered: scored.length, total: totalQ, effectiveTotal, nvt: nvtCount };
}

// ═══════════════ DASHBOARD ═══════════════
function showDashboard() {
  if (!currentUser) { showAuthScreen(); return; }
  document.getElementById('authScreen').classList.add('hidden');
  document.getElementById('dashboardScreen').classList.remove('hidden');

  document.getElementById('newProjectScreen').classList.add('hidden');
  document.getElementById('reviewScreen').classList.add('hidden');
  document.getElementById('scorecardScreen').classList.add('hidden');
  document.body.style.overflow = 'hidden';
  // Show email + role badge
  const emailEl = document.getElementById('dashUserEmail');
  if (emailEl && currentUser) emailEl.textContent = currentUser.email;
  const roleBadge = document.getElementById('dashRoleBadge');
  if (roleBadge) {
    const role = isAdmin ? 'admin' : (userProfile && userProfile.plan === 'pro') ? 'pro' : 'free';
    const labels = { admin: 'Admin', pro: 'Pro', free: 'Free' };
    roleBadge.textContent = labels[role];
    roleBadge.className = 'role-badge role-' + role;
  }
  renderDashboard();
}

function renderDashboard() {
  const statsEl = document.getElementById('dashStats');
  const gridEl = document.getElementById('projectsGrid');

  const totalProjects = projects.length;
  const completedProjects = projects.filter(p => {
    const s = calcProjectScore(p);
    return (s.answered + (s.nvt||0)) === s.total;
  }).length;
  const needsHelp = projects.filter(p => { const s = calcProjectScore(p); return s.avg > 0 && s.avg < 7; }).length;
  const isFree = !isAdmin && !(userProfile && userProfile.plan === 'pro');
  const remaining = FREE_PROJECT_LIMIT - totalProjects;

  // Stats row — admin sees leads, users see their limit
  if (isAdmin) {
    const leadsCollected = projects.filter(p => p.leadEmail).length;
    statsEl.innerHTML = `
      <div class="stat-card"><div class="stat-num accent">${totalProjects}</div><div class="stat-label">Projecten</div></div>
      <div class="stat-card"><div class="stat-num green">${completedProjects}</div><div class="stat-label">Afgerond</div></div>
      <div class="stat-card"><div class="stat-num red">${needsHelp}</div><div class="stat-label">Hulp Nodig</div></div>
      <div class="stat-card"><div class="stat-num ${leadsCollected > 0 ? 'accent' : 'yellow'}">${leadsCollected}</div><div class="stat-label">Leads</div></div>
    `;
  } else {
    statsEl.innerHTML = `
      <div class="stat-card"><div class="stat-num accent">${totalProjects}</div><div class="stat-label">Projecten</div></div>
      <div class="stat-card"><div class="stat-num green">${completedProjects}</div><div class="stat-label">Afgerond</div></div>
      <div class="stat-card"><div class="stat-num red">${needsHelp}</div><div class="stat-label">Hulp Nodig</div></div>
      ${isFree ? `<div class="stat-card"><div class="stat-num ${remaining > 0 ? 'yellow' : 'red'}">${remaining > 0 ? remaining : 0}</div><div class="stat-label">Reviews over</div></div>` :
      `<div class="stat-card"><div class="stat-num green">∞</div><div class="stat-label">Onbeperkt</div></div>`}
    `;
  }

  // New project card — check free limit
  const canCreate = isAdmin || !isFree || remaining > 0;
  let cards = '';
  if (canCreate) {
    cards += `
      <div class="project-card new-project" onclick="showNewProject()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        <span>Nieuw Project</span>
      </div>
    `;
  } else {
    cards += `
      <div class="project-card new-project" onclick="alert('Je hebt je 3 gratis reviews gebruikt. Upgrade naar Pro voor onbeperkte reviews.')" style="opacity:0.5">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        <span>Upgrade naar Pro</span>
      </div>
    `;
  }

  projects.slice().reverse().forEach(p => {
    const score = calcProjectScore(p);
    const pct = Math.round((score.answered / score.total) * 100);
    const scoreClass = score.avg >= 7.5 ? 'good' : score.avg >= 5 ? 'ok' : score.avg > 0 ? 'bad' : 'na';
    const status = pct === 100 ? 'completed' : pct > 0 ? 'in-progress' : 'not-started';
    const statusLabel = pct === 100 ? 'Afgerond' : pct > 0 ? `${pct}% klaar` : 'Niet gestart';
    const pkgLabels = { quick: 'Quick Scan', deep: 'Deep Review', full: 'Full Audit' };

    // Admin: show extra info (lead email, share link)
    const adminInfo = isAdmin && p.leadEmail ? `<div style="font-size:11px;color:var(--green);margin-top:4px"><i data-lucide="mail" style="width:12px;height:12px"></i> ${p.leadEmail}</div>` : '';
    const shareLink = isAdmin ? `<button class="pc-share-btn" onclick="event.stopPropagation();copyShareLink('${p.id}')" title="Kopieer deelbare link" style="position:absolute;top:8px;right:32px;background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px;padding:4px"><i data-lucide="link" style="width:14px;height:14px"></i></button>` : '';

    cards += `
      <div class="project-card" onclick="openProject('${p.id}')" style="position:relative">
        ${shareLink}
        <button class="pc-delete" onclick="event.stopPropagation();deleteProject('${p.id}')" title="Verwijder project">×</button>
        <div class="pc-header">
          <div>
            <div class="pc-name">${p.name}</div>
            ${p.client ? `<div class="pc-client">${p.client}</div>` : ''}
          </div>
          <span class="pc-badge ${status}">${statusLabel}</span>
        </div>
        <div class="pc-url">${p.url}</div>
        ${adminInfo}
        <div class="pc-score-bar">
          <div class="bar-track"><div class="bar-fill ${scoreClass}" style="width:${score.avg > 0 ? score.avg * 10 : 0}%"></div></div>
          <div class="pc-score-num ${scoreClass}">${score.avg > 0 ? score.avg.toFixed(1) : '—'}</div>
        </div>
        <div class="pc-footer">
          <span class="pc-package">${p.mode === 'self-service' ? 'Self-Service' : pkgLabels[p.package] || 'Review'}</span>
          <span>${new Date(p.createdAt).toLocaleDateString('nl-NL')}</span>
        </div>
      </div>
    `;
  });

  gridEl.innerHTML = cards;
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

function copyShareLink(projectId) {
  const link = getShareableLink(projectId);
  navigator.clipboard.writeText(link).then(() => {
    // Brief visual feedback
    const toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--green);color:#fff;padding:10px 24px;border-radius:8px;font-size:13px;font-weight:600;z-index:5000';
    toast.innerHTML = '<i data-lucide="check" style="width:14px;height:14px"></i> Link gekopieerd!'; lucide.createIcons({nodes:[toast]});
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
  });
}



async function deleteProject(id) {
  if (!confirm('Weet je zeker dat je dit project wilt verwijderen?')) return;
  projects = projects.filter(p => p.id !== id);
  saveState();
  // Also delete from Firestore
  try { await db.collection('projects').doc(id).delete(); } catch(e) { console.warn('[Firebase] Delete failed:', e); }
  renderDashboard();
}

// ═══════════════ NEW PROJECT ═══════════════
function showNewProject() {
  document.getElementById('dashboardScreen').classList.add('hidden');
  document.getElementById('newProjectScreen').classList.remove('hidden');
  newProjectMode = 'self-service';
  // Show admin fields (modus, klant, pakket) only for admin
  const adminFields = document.getElementById('npAdminFields');
  if (adminFields) {
    if (isAdmin) { adminFields.classList.remove('hidden'); }
    else { adminFields.classList.add('hidden'); }
  }
  updateNewProjectForm();
}

function selectMode(mode, el) {
  newProjectMode = mode;
  document.querySelectorAll('.mode-option').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  updateNewProjectForm();
}

function updateNewProjectForm() {
  const clientGroup = document.getElementById('npClientGroup');
  const packageGroup = document.getElementById('npPackageGroup');
  if (newProjectMode === 'self-service') {
    clientGroup.classList.add('hidden');
    packageGroup.classList.add('hidden');
  } else {
    clientGroup.classList.remove('hidden');
    packageGroup.classList.remove('hidden');
  }
}

function createProject() {
  const url = document.getElementById('npUrl').value.trim();
  const name = document.getElementById('npName').value.trim();
  const client = document.getElementById('npClient').value.trim();
  const pkg = document.getElementById('npPackage').value;
  const audience = document.getElementById('npAudience').value.trim();

  if (!url || !name) { alert('Vul minimaal een URL en projectnaam in.'); return; }

  // Check free limit for non-admin, non-pro users
  const isFreeUser = !isAdmin && !(userProfile && userProfile.plan === 'pro');
  if (isFreeUser && projects.length >= FREE_PROJECT_LIMIT) {
    alert('Je hebt je ' + FREE_PROJECT_LIMIT + ' gratis reviews gebruikt. Upgrade naar Pro voor onbeperkte reviews.');
    return;
  }

  // Generate Firestore-friendly ID
  const projectId = 'proj_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);

  const project = {
    id: projectId,
    name, url, client: newProjectMode === 'professional' ? client : '',
    package: newProjectMode === 'professional' ? pkg : 'self-service',
    audience, mode: newProjectMode,
    userId: currentUser ? currentUser.uid : null,
    leadEmail: currentUser ? currentUser.email : '',
    answers: {}, currentStep: 0, createdAt: new Date().toISOString()
  };

  projects.push(project);
  saveState();

  // Update URL so the visitor can bookmark/share their project
  updateUrlParam('p', projectId);

  openProject(projectId);
}

// ═══════════════ AUTH ═══════════════
const FREE_PROJECT_LIMIT = 3;

function toggleAuthMode() {
  authMode = authMode === 'login' ? 'register' : 'login';
  document.getElementById('authBtn').textContent = authMode === 'login' ? 'Inloggen →' : 'Account aanmaken →';
  document.getElementById('authToggle').innerHTML = authMode === 'login'
    ? 'Nog geen account? <a onclick="toggleAuthMode()">Registreer gratis</a>'
    : 'Al een account? <a onclick="toggleAuthMode()">Inloggen</a>';
  document.getElementById('authForgotLink').style.display = authMode === 'login' ? '' : 'none';
  document.getElementById('authError').classList.add('hidden');
}

async function handleAuth() {
  const email = document.getElementById('authEmail').value.trim();
  const password = document.getElementById('authPassword').value;
  const errorEl = document.getElementById('authError');
  const btn = document.getElementById('authBtn');

  if (!email || !email.includes('@')) { errorEl.textContent = 'Vul een geldig e-mailadres in.'; errorEl.classList.remove('hidden'); return; }
  if (!password || password.length < 6) { errorEl.textContent = 'Wachtwoord moet minimaal 6 tekens zijn.'; errorEl.classList.remove('hidden'); return; }

  btn.disabled = true;
  btn.textContent = 'Even geduld...';
  errorEl.classList.add('hidden');

  try {
    if (authMode === 'register') {
      const cred = await auth.createUserWithEmailAndPassword(email, password);
      // Create user profile in Firestore
      await db.collection('users').doc(cred.user.uid).set({
        email: email,
        role: 'user',
        plan: 'free',
        createdAt: new Date().toISOString()
      });
      console.log('[Auth] Registered:', email);
    } else {
      await auth.signInWithEmailAndPassword(email, password);
      console.log('[Auth] Logged in:', email);
    }
    // onAuthStateChanged will handle the rest
  } catch(e) {
    const messages = {
      'auth/email-already-in-use': 'Dit e-mailadres is al geregistreerd. Probeer in te loggen.',
      'auth/invalid-email': 'Ongeldig e-mailadres.',
      'auth/wrong-password': 'Verkeerd wachtwoord.',
      'auth/user-not-found': 'Geen account gevonden met dit e-mailadres.',
      'auth/weak-password': 'Wachtwoord moet minimaal 6 tekens zijn.',
      'auth/too-many-requests': 'Te veel pogingen. Probeer later opnieuw.',
      'auth/invalid-credential': 'Onjuiste inloggegevens. Controleer je e-mail en wachtwoord.'
    };
    errorEl.textContent = messages[e.code] || e.message;
    errorEl.classList.remove('hidden');
    btn.disabled = false;
    btn.textContent = authMode === 'login' ? 'Inloggen →' : 'Account aanmaken →';
  }
}

async function resetPassword() {
  const email = document.getElementById('authEmail').value.trim();
  if (!email || !email.includes('@')) { alert('Vul eerst je e-mailadres in.'); return; }
  try {
    await auth.sendPasswordResetEmail(email);
    alert('Reset-link verstuurd naar ' + email + '. Check je inbox.');
  } catch(e) {
    alert('Kon geen reset-link versturen: ' + e.message);
  }
}

function logoutUser() {
  auth.signOut();
}

function showAuthScreen() {
  document.getElementById('authScreen').classList.remove('hidden');

  document.getElementById('dashboardScreen').classList.add('hidden');
  document.getElementById('reviewScreen').classList.add('hidden');
  document.getElementById('newProjectScreen').classList.add('hidden');
  document.getElementById('scorecardScreen').classList.add('hidden');
}

// ── Show user dashboard (after login) — alias ──
// Legacy alias — now everyone uses the dashboard
function showLanding() {
  showDashboard();
}

// ── URL parameter management ──
function updateUrlParam(key, value) {
  const url = new URL(window.location.href);
  url.searchParams.set(key, value);
  window.history.replaceState({}, '', url.toString());
}

function getShareableLink(projectId) {
  const url = new URL(window.location.href);
  url.search = ''; // Clear all params
  url.searchParams.set('p', projectId);
  return url.toString();
}

// ═══════════════ OPEN PROJECT ═══════════════
function openProject(id) {
  activeProjectId = id;
  const project = getActiveProject();
  if (!project) return;

  currentStep = project.currentStep || 0;

  // Update URL to reflect current project
  updateUrlParam('p', id);


  document.getElementById('dashboardScreen').classList.add('hidden');
  document.getElementById('newProjectScreen').classList.add('hidden');
  document.getElementById('reviewScreen').classList.remove('hidden');
  const pnEl = document.getElementById('displayProjectName');
  if (pnEl) pnEl.textContent = project.name + (project.client ? ' — ' + project.client : '');
  document.getElementById('urlInput').value = project.url;

  buildStepper();
  renderStep(currentStep);
  loadUrl();
}

function backToDashboard() {
  saveCurrentAnswers();
  const project = getActiveProject();
  if (project) { project.currentStep = currentStep; saveState(); }
  document.getElementById('reviewScreen').classList.add('hidden');
  showDashboard();
}

// ═══════════════ URL & DEVICE ═══════════════
function loadUrl() {
  const url = document.getElementById('urlInput').value.trim();
  if (!url) return;
  const frame = document.getElementById('previewFrame');
  const empty = document.getElementById('previewEmpty');
  frame.classList.remove('hidden');
  empty.classList.add('hidden');
  let finalUrl = url;
  if (!url.startsWith('http://') && !url.startsWith('https://')) finalUrl = 'https://' + url;
  const domain = finalUrl.replace('https://','').replace('http://','').split('/')[0];

  const wrapper = document.getElementById('previewWrapper');
  let blocked = false;
  let iframeConfirmed = false; // true if we positively confirmed iframe loaded

  // ── Pre-load thumbnail in background immediately ──
  const thumbUrl = `https://image.thum.io/get/width/1280/crop/900/${finalUrl}`;
  let thumbLoaded = false;
  let thumbDataUrl = null;
  const preloadImg = new Image();
  preloadImg.crossOrigin = 'anonymous';
  preloadImg.onload = () => { thumbLoaded = true; };
  preloadImg.src = thumbUrl;

  // ── Show static thumbnail preview ──
  function showBlocked() {
    if (blocked) return;
    blocked = true;

    // Remove help button if present
    const helpBtn = wrapper.querySelector('.iframe-help-btn');
    if (helpBtn) helpBtn.remove();

    frame.classList.add('hidden');
    empty.classList.remove('hidden');

    empty.innerHTML = `
      <div class="static-preview">
        <div class="static-preview-loading" id="thumbLoader" ${thumbLoaded ? 'style="display:none"' : ''}>
          <div class="static-preview-spinner"></div>
          <p style="font-size:12px">Statische preview laden van <strong>${domain}</strong>...</p>
        </div>
        <img class="static-preview-img" id="thumbImg" ${thumbLoaded ? '' : 'style="display:none"'}
          src="${thumbUrl}" alt="Preview van ${domain}">
        <div class="static-preview-error" id="thumbError" style="display:none">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:48px;height:48px;opacity:0.4">
            <rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>
          </svg>
          <p style="max-width:300px;line-height:1.6"><strong style="color:var(--accent)">${domain}</strong> blokkeert iframe-embedding.<br>Open de site naast deze tool om te reviewen.</p>
        </div>
        <div class="static-preview-badge">
          <span class="badge-label"><span class="dot"></span> Statische preview — iframe geblokkeerd</span>
          <div class="static-preview-actions">
            <button onclick="openSideBySide('${finalUrl}')" class="btn-open">↗ Open naast review</button>
            <a href="${finalUrl}" target="_blank" class="btn-side">↗ Nieuw tabblad</a>
            <button onclick="refreshThumbnail('${finalUrl}')" class="btn-side">↻ Ververs</button>
          </div>
        </div>
      </div>`;

    // Handle thumbnail load/error for the visible image
    const visImg = document.getElementById('thumbImg');
    const loader = document.getElementById('thumbLoader');
    const errDiv = document.getElementById('thumbError');
    if (!thumbLoaded) {
      visImg.onload = () => { loader.style.display = 'none'; visImg.style.display = 'block'; };
      visImg.onerror = () => { loader.style.display = 'none'; errDiv.style.display = 'flex'; };
      setTimeout(() => {
        if (loader.style.display !== 'none') { loader.style.display = 'none'; errDiv.style.display = 'flex'; }
      }, 15000);
    }
  }

  // ── Load iframe ──
  frame.src = finalUrl;
  frame.onerror = showBlocked;

  frame.onload = () => {
    // Check 1: about:blank means blocked
    try {
      const loc = frame.contentWindow?.location?.href;
      if (loc === 'about:blank') { showBlocked(); return; }
      // If we can read the full URL without error → same-origin, iframe loaded fine
      iframeConfirmed = true;
    } catch(e) {
      // Cross-origin: can't determine if loaded or blocked
      // Check if we can access contentDocument (same-origin error pages)
      try {
        const doc = frame.contentDocument;
        if (doc && doc.body) {
          const text = (doc.body.innerText || '').toLowerCase();
          if (doc.body.innerHTML.trim() === '' ||
              text.includes('geweigerd') || text.includes('refused') ||
              text.includes('blocked') || text.includes('err_')) {
            showBlocked();
            return;
          }
          iframeConfirmed = true;
        }
      } catch(e2) { /* truly cross-origin */ }
    }
  };

  // ── Fallback: after 1.5s show floating help button for cross-origin iframes ──
  setTimeout(() => {
    if (blocked || iframeConfirmed) return;
    if (frame.classList.contains('hidden')) return;

    // We can't tell if the iframe loaded or is showing an error page
    // Show a help button with prominent "open in venster" option
    const existingBtn = wrapper.querySelector('.iframe-help-btn');
    if (existingBtn) return;

    const helpBtn = document.createElement('button');
    helpBtn.className = 'iframe-help-btn';
    helpBtn.innerHTML = '<i data-lucide="shield-alert" style="width:14px;height:14px"></i> Site niet zichtbaar? <span style="text-decoration:underline">Open in venster</span>';
    helpBtn.onclick = () => { showBlocked(); openSideBySide(finalUrl); };
    wrapper.appendChild(helpBtn);
    if (typeof lucide !== 'undefined') lucide.createIcons({nodes:[helpBtn]});
  }, 1500);
}

let siteWindow = null;

function toggleSiteWindow() {
  const main = document.querySelector('.main');
  const isReviewMode = main && main.classList.contains('review-mode');
  if (isReviewMode) {
    exitReviewMode();
  } else {
    const url = document.getElementById('urlInput').value.trim();
    if (!url) { alert('Voer eerst een URL in.'); return; }
    let finalUrl = url;
    if (!url.startsWith('http://') && !url.startsWith('https://')) finalUrl = 'https://' + url;
    openSideBySide(finalUrl);
  }
}

function openSideBySide(url) {
  const w = Math.floor(screen.width / 2);
  // Close previous window if still open
  if (siteWindow && !siteWindow.closed) siteWindow.close();
  siteWindow = window.open(url, 'bold700_preview', `width=${w},height=${screen.height},left=${screen.width - w},top=0`);
  // Resize our own window to the left half
  try { window.resizeTo(w, screen.height); window.moveTo(0, 0); } catch(e) {}
  // Activate review mode
  enterReviewMode();
}

function enterReviewMode() {
  const main = document.querySelector('.main');
  if (main) main.classList.add('review-mode');
  // Hide preview panel
  const pp = document.querySelector('.preview-panel');
  if (pp) pp.style.display = 'none';
  const rp = document.querySelector('.review-panel');
  if (rp) { rp.style.width = '100%'; rp.style.maxWidth = '100%'; rp.style.minWidth = '100%'; rp.style.borderRight = 'none'; }
  // Hide URL toolbar (site opened in external window)
  const urlBar = document.getElementById('urlToolbar');
  if (urlBar) urlBar.style.display = 'none';
  // Adjust topbar sticky position
  const topbar = document.querySelector('.topbar');
  if (topbar) topbar.style.top = '0';
  // Adjust main height
  if (main) main.style.height = 'calc(100vh - 44px)';
  // Show review mode info in topbar subtitle
  const review = document.getElementById('deviceBarReview');
  if (review) review.style.display = 'inline-flex';
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

function exitReviewMode() {
  const main = document.querySelector('.main');
  if (main) main.classList.remove('review-mode');
  // Restore preview panel
  const pp = document.querySelector('.preview-panel');
  if (pp) pp.style.display = '';
  const rp = document.querySelector('.review-panel');
  if (rp) { rp.style.width = ''; rp.style.maxWidth = ''; rp.style.minWidth = ''; rp.style.borderRight = ''; }
  // Restore URL toolbar
  const urlBar = document.getElementById('urlToolbar');
  if (urlBar) urlBar.style.display = '';
  // Restore topbar sticky position
  const topbar = document.querySelector('.topbar');
  if (topbar) topbar.style.top = '';
  // Restore main height
  if (main) main.style.height = '';
  // Hide review mode info in topbar subtitle
  const review = document.getElementById('deviceBarReview');
  if (review) review.style.display = 'none';
  if (typeof lucide !== 'undefined') lucide.createIcons();
  // Close site window
  if (siteWindow && !siteWindow.closed) siteWindow.close();
  siteWindow = null;
}

// focusSiteWindow and captureExternalScreenshot removed — simplified to toggle + Ctrl+V paste

function refreshThumbnail(url) {
  const img = document.getElementById('thumbImg');
  const loader = document.getElementById('thumbLoader');
  const errDiv = document.getElementById('thumbError');
  if (!img || !loader) return;
  img.style.display = 'none';
  if (errDiv) errDiv.style.display = 'none';
  loader.style.display = 'flex';
  // Cache-bust with timestamp
  img.src = `https://image.thum.io/get/width/1280/crop/900/${url}?t=${Date.now()}`;
}

function switchDevice(device, btn) {
  document.querySelectorAll('.device-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('previewWrapper').className = 'preview-frame-wrapper ' + device;
}

// ═══════════════ STEP NAVIGATION ═══════════════
function buildStepper() {
  const answers = getAnswers();
  const stepper = document.getElementById('stepStepper');
  // Progress at top of stepper
  const totalQ = reviewSteps.reduce((sum, s) => sum + s.questions.length, 0);
  const answeredQ = Object.values(answers).filter(a => a.score).length;
  const pct = totalQ > 0 ? Math.round((answeredQ / totalQ) * 100) : 0;
  const progressColor = pct === 100 ? 'var(--green)' : 'var(--accent)';

  stepper.innerHTML = `
    <div class="stepper-progress">
      <div class="stepper-progress-label">Voortgang</div>
      <div class="stepper-progress-row">
        <div class="stepper-progress-bar"><div class="stepper-progress-fill" style="width:${pct}%;background:${progressColor}"></div></div>
        <div class="stepper-progress-pct" id="progressPct" style="color:${progressColor}">${pct}%</div>
      </div>
    </div>` + reviewSteps.map((step, i) => {
    const scored = step.questions.filter(q => answers[q.id]?.score && answers[q.id].score !== 'nvt');
    const total = step.questions.length;
    const isCompleted = step.questions.every(q => answers[q.id]?.score);
    const isLast = i === reviewSteps.length - 1;

    let avg = 0;
    let meta = '';

    if (scored.length > 0) {
      const sum = scored.reduce((s, q) => {
        const sc = answers[q.id].score;
        return s + (sc === 'good' ? 10 : sc === 'ok' ? 5 : 0);
      }, 0);
      avg = sum / scored.length;
      meta = `<div class="stepper-meta">${avg.toFixed(1)} · ${scored.length}/${total} beoordeeld</div>`;
    }

    const isActive = i === currentStep;
    const status = isActive ? 'active' : isCompleted ? 'completed' : 'pending';

    const isFirst = i === 0;
    const chk = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';

    return `
      <div class="stepper-item ${status}" onclick="goToStep(${i})">
        <div class="stepper-track">
          <div class="stepper-line line-top${isFirst?' line-hidden':''}"></div>
          <div class="stepper-circle">${isCompleted && !isActive ? chk : i + 1}</div>
          <div class="stepper-line line-btm${isLast?' line-hidden':''}"></div>
        </div>
        <div class="stepper-info">
          <div class="stepper-label">${step.shortTitle}</div>
          ${meta}
        </div>
      </div>`;
  }).join('');
  // Scroll active step into view
  setTimeout(() => {
    const active = stepper.querySelector('.stepper-item.active');
    if (active) active.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 50);
}

function goToStep(i) { saveCurrentAnswers(); currentStep = i; renderStep(i); buildStepper(); }

function nextStep() {
  saveCurrentAnswers();
  if (currentStep < reviewSteps.length - 1) { currentStep++; renderStep(currentStep); buildStepper(); }
  else showScorecard();
}

function prevStep() {
  saveCurrentAnswers();
  if (currentStep > 0) { currentStep--; renderStep(currentStep); buildStepper(); }
}

// ═══════════════ RENDER STEP ═══════════════
function renderStep(stepIndex, resetScroll) {
  if (resetScroll === undefined) resetScroll = true;
  if (resetScroll) lastActiveQId = null; // reset paste target on step change
  const step = reviewSteps[stepIndex];
  const answers = getAnswers();
  const area = document.getElementById('questionsArea');
  const prevScrollTop = area.scrollTop;
  document.getElementById('stepIndicator').textContent = `Stap ${stepIndex + 1} / ${reviewSteps.length}`;

  const stepScored = step.questions.filter(q => answers[q.id]?.score && answers[q.id].score !== 'nvt');
  const stepNvt = step.questions.filter(q => answers[q.id]?.score === 'nvt').length;
  const stepEffective = step.questions.length - stepNvt;
  const stepAnswered = stepScored.length + stepNvt;
  // Unanswered count as 0 — divide by effectiveTotal (excl. nvt)
  const avgScore = stepEffective > 0
    ? stepScored.reduce((sum, q) => sum + (answers[q.id].score === 'good' ? 10 : answers[q.id].score === 'ok' ? 6 : 3), 0) / stepEffective : 0;
  const scoreClass = stepEffective === 0 ? 'neutral' : avgScore >= 8 ? 'good' : avgScore >= 5 ? 'ok' : 'bad';

  area.innerHTML = `
    <div class="category-title">${step.title}</div>
    <div class="category-desc">${step.desc}</div>
    <div class="score-summary">
      <div class="score-circle ${scoreClass}">${stepEffective > 0 ? avgScore.toFixed(1) : '—'}</div>
      <div class="score-meta">
        <div class="label">Categorie Score</div>
        <div class="sublabel">${stepScored.length} / ${stepEffective} beoordeeld${stepNvt > 0 ? ` · ${stepNvt} n.v.t.` : ''}${stepScored.length < stepEffective ? ' · onbeantwoord = 0 punten' : ''}</div>
      </div>
    </div>
    ${step.questions.map((q, qi) => {
      const a = answers[q.id] || {};
      return `
        <div class="question-card ${a.score === 'nvt' ? 'answered-nvt' : a.score ? 'answered' : ''}" id="card-${q.id}" onclick="setActiveQuestion('${q.id}')">
          <div class="question-label"><span class="q-num">${qi + 1}.</span>${q.text}${a.autoScanned ? '<span class="auto-badge"><i data-lucide="zap"></i> auto</span>' : ''}</div>
          <div class="score-row">
            <button class="score-btn score-bad ${a.score==='bad'?'selected':''}" onclick="setScore('${q.id}','bad')"><i data-lucide="x"></i> Niet OK</button>
            <button class="score-btn score-ok ${a.score==='ok'?'selected':''}" onclick="setScore('${q.id}','ok')">~ Matig</button>
            <button class="score-btn score-good ${a.score==='good'?'selected':''}" onclick="setScore('${q.id}','good')"><i data-lucide="check"></i> Goed</button>
            <button class="score-btn score-nvt ${a.score==='nvt'?'selected':''}" onclick="setScore('${q.id}','nvt')">N.v.t.</button>
          </div>
          ${a.score==='ok'||a.score==='bad' ? (()=>{ const sev = a.severity || step.impact || 'low'; const isHigh = sev==='high'; return a.score==='ok' ? `<div class="severity-row">
            <button class="sev-btn sev-quickwin ${isHigh?'selected':''}" onclick="setSeverity('${q.id}','high',this)"><i data-lucide="zap"></i> Quick Win</button>
            <button class="sev-btn sev-filler ${!isHigh?'selected':''}" onclick="setSeverity('${q.id}','low',this)"><i data-lucide="archive"></i> Opvuller</button>
          </div>` : `<div class="severity-row">
            <button class="sev-btn sev-strategic ${isHigh?'selected':''}" onclick="setSeverity('${q.id}','high',this)"><i data-lucide="target"></i> Strategisch</button>
            <button class="sev-btn sev-notnow ${!isHigh?'selected':''}" onclick="setSeverity('${q.id}','low',this)"><i data-lucide="pause"></i> Niet Nu</button>
          </div>`; })() : ''}
          <textarea class="notes-input" id="notes-${q.id}" placeholder="Notities, bevindingen, aanbevelingen...">${a.notes||''}</textarea>
          <div class="screenshot-row">
            ${getScreenshots(q.id).map((src, si) => `
              <div class="screenshot-thumb">
                <img class="screenshot-preview" src="${src}" onclick="showLightbox('${q.id}',${si})" title="Klik om te vergroten">
                <button class="screenshot-remove" onclick="removeScreenshot('${q.id}',${si})" title="Verwijder">×</button>
              </div>
            `).join('')}
            <button class="screenshot-btn capture-primary" id="capBtn-${q.id}" onclick="capturePreviewScreenshot('${q.id}')" title="Capture preview"><i data-lucide="camera"></i><span class="btn-label"> Capture</span></button>
            <button class="screenshot-btn" onclick="document.getElementById('file-${q.id}').click()" title="Upload"><i data-lucide="upload"></i><span class="btn-label"> Upload</span></button>
            <span class="screenshot-hint"><i data-lucide="clipboard" style="width:11px;height:11px"></i> Ctrl+V</span>
            <input type="file" id="file-${q.id}" accept="image/*" style="display:none" onchange="handleScreenshot('${q.id}', this)">
          </div>
          ${q.hasContrastChecker ? `
          <div class="inline-cc" style="margin-top:12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:16px">
            <div style="font-size:13px;font-weight:700;margin-bottom:12px;color:var(--text)"><i data-lucide="contrast"></i> Contrast Checker</div>
            <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">
              <div>
                <label style="font-size:10px;color:var(--text-muted);display:block;margin-bottom:3px">TEKST</label>
                <div class="cc-color-input"><input type="color" id="iccFg" value="#333333" oninput="syncColorText('iccFg','iccFgHex');updateInlineCC()"><input type="text" id="iccFgHex" value="#333333" oninput="syncColorPicker('iccFgHex','iccFg');updateInlineCC()" maxlength="7"></div>
              </div>
              <div>
                <label style="font-size:10px;color:var(--text-muted);display:block;margin-bottom:3px">ACHTERGROND</label>
                <div class="cc-color-input"><input type="color" id="iccBg" value="#FFFFFF" oninput="syncColorText('iccBg','iccBgHex');updateInlineCC()"><input type="text" id="iccBgHex" value="#FFFFFF" oninput="syncColorPicker('iccBgHex','iccBg');updateInlineCC()" maxlength="7"></div>
              </div>
              <button class="cc-swap" onclick="swapInlineCC()" style="margin-bottom:0">⇅</button>
            </div>
            <div style="display:flex;gap:12px;margin-top:12px;align-items:center">
              <div id="iccPreview" style="flex:1;padding:12px;border-radius:8px;background:#fff;color:#333;text-align:center;border:1px solid var(--border)">
                <div style="font-size:18px;font-weight:700">Aa Voorbeeld</div>
                <div style="font-size:12px">Leesbaarheid test</div>
              </div>
              <div style="text-align:center;min-width:80px">
                <div id="iccRatio" style="font-size:28px;font-weight:900">—</div>
                <div style="font-size:10px;color:var(--text-muted)">ratio</div>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;margin-top:10px">
              <div style="text-align:center;padding:6px;background:var(--surface);border-radius:6px">
                <div style="font-size:9px;color:var(--text-muted)">AA Norm</div>
                <div id="iccAAnorm" style="font-size:12px;font-weight:800">—</div>
              </div>
              <div style="text-align:center;padding:6px;background:var(--surface);border-radius:6px">
                <div style="font-size:9px;color:var(--text-muted)">AA Groot</div>
                <div id="iccAAlarge" style="font-size:12px;font-weight:800">—</div>
              </div>
              <div style="text-align:center;padding:6px;background:var(--surface);border-radius:6px">
                <div style="font-size:9px;color:var(--text-muted)">AAA Norm</div>
                <div id="iccAAAnorm" style="font-size:12px;font-weight:800">—</div>
              </div>
              <div style="text-align:center;padding:6px;background:var(--surface);border-radius:6px">
                <div style="font-size:9px;color:var(--text-muted)">AAA Groot</div>
                <div id="iccAAAlarge" style="font-size:12px;font-weight:800">—</div>
              </div>
            </div>
          </div>` : ''}
        </div>`;
    }).join('')}`;

  if (resetScroll) { area.scrollTop = 0; } else { area.scrollTop = prevScrollTop; }
  updateProgress();

  const btnNext = document.getElementById('btnNext');
  if (stepIndex === reviewSteps.length - 1) {
    btnNext.innerHTML = '<i data-lucide="check-circle"></i> Voltooi Review'; lucide.createIcons({nodes:[btnNext]});
    btnNext.style.background = 'var(--green)';
    btnNext.style.borderColor = 'var(--green)';
  } else {
    btnNext.innerHTML = 'Volgende <i data-lucide="chevron-right"></i>';
    btnNext.style.background = 'var(--accent)';
    btnNext.style.borderColor = 'var(--accent)';
  }
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

// ═══════════════ SCORING ═══════════════
function setScore(qId, score) {
  const answers = getAnswers();
  if (!answers[qId]) answers[qId] = {};
  // Save ALL notes on current step before re-render
  const step = reviewSteps[currentStep];
  step.questions.forEach(q => {
    const ne = document.getElementById('notes-' + q.id);
    if (ne) {
      if (!answers[q.id]) answers[q.id] = {};
      answers[q.id].notes = ne.value;
    }
  });
  answers[qId].score = score;
  if (score === 'nvt' || score === 'good') { delete answers[qId].severity; }
  saveState();
  renderStep(currentStep, false);
  buildStepper();
}

function setSeverity(qId, severity, btn) {
  const answers = getAnswers();
  if (!answers[qId]) answers[qId] = {};
  answers[qId].severity = severity;
  const card = document.getElementById('card-' + qId);
  card.querySelectorAll('.sev-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  saveState();
}

function saveCurrentAnswers() {
  const project = getActiveProject();
  if (!project) return;
  const step = reviewSteps[currentStep];
  step.questions.forEach(q => {
    const notesEl = document.getElementById('notes-' + q.id);
    if (notesEl) {
      if (!project.answers[q.id]) project.answers[q.id] = {};
      project.answers[q.id].notes = notesEl.value;
    }
  });
  saveState();
}

// ═══════════════ SCREENSHOTS ═══════════════
function handleScreenshot(qId, input) {
  if (!input.files || !input.files[0]) return;
  const file = input.files[0];
  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      const maxW = 800;
      const scale = Math.min(1, maxW / img.width);
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
      addScreenshot(qId, dataUrl);
      renderStep(currentStep, false);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// ── Multi-screenshot helpers ──
function getScreenshots(qId) {
  const a = getAnswers()[qId];
  if (!a) return [];
  if (a.screenshots && Array.isArray(a.screenshots)) return a.screenshots;
  if (a.screenshot) return [a.screenshot]; // backward compat
  return [];
}

function addScreenshot(qId, dataUrl) {
  const answers = getAnswers();
  if (!answers[qId]) answers[qId] = {};
  // Migrate old single screenshot to array
  if (answers[qId].screenshot && !answers[qId].screenshots) {
    answers[qId].screenshots = [answers[qId].screenshot];
    delete answers[qId].screenshot;
  }
  if (!answers[qId].screenshots) answers[qId].screenshots = [];
  answers[qId].screenshots.push(dataUrl);
  saveState();
  // Upload to Firebase
  const project = getActiveProject();
  const idx = answers[qId].screenshots.length - 1;
  if (project) uploadScreenshotToStorage(project.id, qId + '_' + idx, dataUrl);
}

function removeScreenshot(qId, idx) {
  const answers = getAnswers();
  if (!answers[qId]) return;
  // Migrate old format
  if (answers[qId].screenshot && !answers[qId].screenshots) {
    answers[qId].screenshots = [answers[qId].screenshot];
    delete answers[qId].screenshot;
  }
  if (answers[qId].screenshots) {
    answers[qId].screenshots.splice(idx, 1);
    if (answers[qId].screenshots.length === 0) delete answers[qId].screenshots;
  }
  delete answers[qId].screenshot; // clean up old field
  saveState();
  renderStep(currentStep, false);
}

// ── Auto-paste screenshot on Ctrl+V ──
let lastActiveQId = null; // tracks which question user last interacted with

function setActiveQuestion(qId) {
  lastActiveQId = qId;
  // Visual indicator: highlight active question's screenshot row
  document.querySelectorAll('.screenshot-row').forEach(r => r.classList.remove('paste-target'));
  const row = document.querySelector(`#notes-${qId}`)?.closest('.question-card')?.querySelector('.screenshot-row');
  if (row) row.classList.add('paste-target');
}

function getActiveQuestionId() {
  // 1. If a notes textarea is focused, use that question
  const focused = document.activeElement;
  if (focused && focused.id && focused.id.startsWith('notes-')) {
    return focused.id.replace('notes-', '');
  }
  // 2. Use last actively clicked/interacted question
  if (lastActiveQId) {
    // Verify it's still on the current step
    if (typeof reviewSteps !== 'undefined' && reviewSteps[currentStep]) {
      const onStep = reviewSteps[currentStep].questions.some(q => q.id === lastActiveQId);
      if (onStep) return lastActiveQId;
    }
  }
  // 3. Fallback: first question in current step without a screenshot
  if (typeof reviewSteps !== 'undefined' && typeof currentStep !== 'undefined' && reviewSteps[currentStep]) {
    const answers = getAnswers();
    for (const q of reviewSteps[currentStep].questions) {
      if (!answers[q.id]?.screenshot) return q.id;
    }
    return reviewSteps[currentStep].questions[0]?.id;
  }
  return null;
}

// Global paste listener — works automatically, no need to click "Plak" first
document.addEventListener('paste', function(e) {
  // Only on review screen
  const reviewScreen = document.getElementById('reviewScreen');
  if (!reviewScreen || reviewScreen.classList.contains('hidden')) return;
  // Don't intercept if typing in a text field (unless it's a notes textarea)
  const focused = document.activeElement;
  const isTextInput = focused && (focused.tagName === 'INPUT' && focused.type !== 'file');
  if (isTextInput) return;

  const items = e.clipboardData?.items;
  if (!items) return;
  for (const item of items) {
    if (item.type.startsWith('image/')) {
      e.preventDefault();
      const targetQId = getActiveQuestionId();
      if (!targetQId) return;
      const blob = item.getAsFile();
      const reader = new FileReader();
      reader.onload = function(ev) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const maxW = 800;
          const scale = Math.min(1, maxW / img.width);
          canvas.width = img.width * scale;
          canvas.height = img.height * scale;
          canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
          const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
          addScreenshot(targetQId, dataUrl);
          // Flash the card to confirm paste
          const card = document.getElementById('card-' + targetQId);
          if (card) { card.style.boxShadow = '0 0 0 2px var(--accent)'; setTimeout(() => card.style.boxShadow = '', 800); }
          renderStep(currentStep, false);
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(blob);
      return;
    }
  }
});

// ═══════════════ DIRECT PREVIEW CAPTURE (Screen Capture API) ═══════════════
async function capturePreviewScreenshot(qId) {
  const btn = document.getElementById('capBtn-' + qId);
  if (btn) { btn.disabled = true; btn.textContent = '⏳ Delen...'; }

  try {
    // Request screen capture — preferCurrentTab hints to share this tab
    const stream = await navigator.mediaDevices.getDisplayMedia({
      video: { displaySurface: 'browser' },
      preferCurrentTab: true
    });

    if (btn) { btn.innerHTML = '<i data-lucide="camera"></i> Vastleggen...'; lucide.createIcons({nodes:[btn]}); }

    const track = stream.getVideoTracks()[0];
    const video = document.createElement('video');
    video.srcObject = stream;
    video.muted = true;
    await video.play();

    // Wait for real video frames using requestVideoFrameCallback (reliable)
    // or a generous timeout as fallback
    await new Promise(resolve => {
      if ('requestVideoFrameCallback' in video) {
        video.requestVideoFrameCallback(() => {
          video.requestVideoFrameCallback(resolve); // wait 2 frames
        });
      } else {
        setTimeout(resolve, 1200);
      }
    });

    const vw = video.videoWidth;
    const vh = video.videoHeight;
    console.log('[Capture] Video dimensions:', vw, 'x', vh, '| Viewport:', window.innerWidth, 'x', window.innerHeight);

    if (vw === 0 || vh === 0) {
      throw new Error('Video dimensions are 0 — frame not ready');
    }

    // Grab full frame
    const fullCanvas = document.createElement('canvas');
    fullCanvas.width = vw;
    fullCanvas.height = vh;
    fullCanvas.getContext('2d').drawImage(video, 0, 0, vw, vh);

    // Stop stream
    stream.getTracks().forEach(t => t.stop());
    video.srcObject = null;

    // Get preview area bounds (viewport-relative)
    const previewEl = document.getElementById('previewWrapper');
    const rect = previewEl.getBoundingClientRect();

    // Detect if this is a tab capture (dimensions roughly match viewport * DPR)
    // or a full screen capture (dimensions much larger)
    const dpr = window.devicePixelRatio || 1;
    const expectedTabW = window.innerWidth * dpr;
    const expectedTabH = window.innerHeight * dpr;
    const isTabCapture = Math.abs(vw - expectedTabW) < 200 && Math.abs(vh - expectedTabH) < 200;
    console.log('[Capture] DPR:', dpr, '| Expected tab:', expectedTabW, 'x', expectedTabH, '| isTabCapture:', isTabCapture);

    let canvas = null;

    if (isTabCapture && rect.width > 0 && rect.height > 0) {
      // Tab capture: coordinates map directly (scaled by DPR)
      const scaleX = vw / window.innerWidth;
      const scaleY = vh / window.innerHeight;

      let cropX = Math.round(rect.left * scaleX);
      let cropY = Math.round(rect.top * scaleY);
      let cropW = Math.round(rect.width * scaleX);
      let cropH = Math.round(rect.height * scaleY);

      // Clamp to valid bounds
      cropX = Math.max(0, Math.min(cropX, vw - 1));
      cropY = Math.max(0, Math.min(cropY, vh - 1));
      cropW = Math.min(cropW, vw - cropX);
      cropH = Math.min(cropH, vh - cropY);

      console.log('[Capture] Crop:', cropX, cropY, cropW, cropH);

      if (cropW > 50 && cropH > 50) {
        const maxW = 800;
        const ratio = Math.min(1, maxW / cropW);
        canvas = document.createElement('canvas');
        canvas.width = Math.round(cropW * ratio);
        canvas.height = Math.round(cropH * ratio);
        canvas.getContext('2d').drawImage(fullCanvas, cropX, cropY, cropW, cropH, 0, 0, canvas.width, canvas.height);
      }
    }

    // Fallback: use full capture (uncropped) if crop failed or not tab capture
    if (!canvas || canvas.width < 10) {
      console.log('[Capture] Using full frame (no crop)');
      const maxW = 800;
      const ratio = Math.min(1, maxW / vw);
      canvas = document.createElement('canvas');
      canvas.width = Math.round(vw * ratio);
      canvas.height = Math.round(vh * ratio);
      canvas.getContext('2d').drawImage(fullCanvas, 0, 0, canvas.width, canvas.height);
    }

    // Validate: check canvas has actual pixels (not blank)
    const testData = canvas.getContext('2d').getImageData(
      Math.floor(canvas.width / 2), Math.floor(canvas.height / 2), 1, 1
    ).data;
    if (testData[0] === 0 && testData[1] === 0 && testData[2] === 0 && testData[3] === 0) {
      console.warn('[Capture] Center pixel is transparent, using full frame fallback');
      const maxW = 800;
      const ratio = Math.min(1, maxW / vw);
      canvas = document.createElement('canvas');
      canvas.width = Math.round(vw * ratio);
      canvas.height = Math.round(vh * ratio);
      canvas.getContext('2d').drawImage(fullCanvas, 0, 0, canvas.width, canvas.height);
    }

    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);

    // Validate data URL
    if (!dataUrl || dataUrl === 'data:,' || dataUrl.length < 200) {
      throw new Error('Generated empty image data (length: ' + (dataUrl?.length || 0) + ')');
    }

    console.log('[Capture] Success! Image size:', Math.round(dataUrl.length / 1024), 'KB');

    // Flash effect on preview
    const flash = document.createElement('div');
    flash.className = 'capture-flash';
    flash.innerHTML = '<i data-lucide="camera"></i>'; lucide.createIcons({nodes:[flash]});
    flash.style.fontSize = '48px';
    previewEl.style.position = 'relative';
    previewEl.appendChild(flash);
    setTimeout(() => flash.remove(), 600);

    // Store screenshot
    addScreenshot(qId, dataUrl);
    renderStep(currentStep, false);

  } catch (e) {
    if (e.name === 'NotAllowedError') {
      if (btn) { btn.disabled = false; btn.innerHTML = '<i data-lucide="camera"></i> Capture preview'; lucide.createIcons({nodes:[btn]}); }
      return;
    }
    console.error('[Capture] Failed:', e);
    if (btn) { btn.disabled = false; btn.innerHTML = '<i data-lucide="camera"></i> Capture preview'; lucide.createIcons({nodes:[btn]}); }
  }
}

function showLightbox(qId, idx) {
  const shots = getScreenshots(qId);
  if (!shots.length) return;
  const src = idx !== undefined ? shots[idx] : shots[0];
  if (!src) return;
  const lb = document.createElement('div');
  lb.className = 'screenshot-lightbox';
  lb.onclick = () => lb.remove();
  lb.innerHTML = `<img src="${src}">`;
  document.body.appendChild(lb);
}

function updateProgress() {
  const answers = getAnswers();
  const total = reviewSteps.reduce((sum, s) => sum + s.questions.length, 0);
  const answered = Object.values(answers).filter(a => a.score).length;
  const pct = total > 0 ? Math.round((answered / total) * 100) : 0;
  const progressColor = pct === 100 ? 'var(--green)' : 'var(--accent)';
  const pctEl = document.getElementById('progressPct');
  if (pctEl) { pctEl.textContent = pct + '%'; pctEl.style.color = progressColor; }
  const fill = document.querySelector('.stepper-progress-fill');
  if (fill) { fill.style.width = pct + '%'; fill.style.background = progressColor; }
}

// ═══════════════ AUTO-SCAN (PageSpeed Insights) ═══════════════
const DEFAULT_PSI_KEY = 'AIzaSyALFIQC3M_3aS7xtPDCXqWEB6dDXVPGS-c';

function getApiKey() {
  try { return localStorage.getItem('bold700_psi_key') || DEFAULT_PSI_KEY; } catch(e) { return DEFAULT_PSI_KEY; }
}

function setApiKey(key) {
  try { localStorage.setItem('bold700_psi_key', key); } catch(e) {}
}

function promptApiKey() {
  const current = getApiKey();
  const key = prompt('Voer je Google PageSpeed Insights API key in.\n\nGratis aanmaken op: https://developers.google.com/speed/docs/insights/v5/get-started#key\n\nHuidige key:', current || '');
  if (key !== null) { setApiKey(key.trim()); return key.trim(); }
  return current;
}

async function runAutoScan() {
  const project = getActiveProject();
  if (!project) return;

  let url = project.url;
  if (!url) { alert('Voer eerst een URL in'); return; }
  if (!url.startsWith('http')) url = 'https://' + url;

  const btn = document.getElementById('btnAutoScan');
  btn.innerHTML = '<i data-lucide="loader"></i> Scanning…'; lucide.createIcons({nodes:[btn]});
  btn.style.pointerEvents = 'none';

  const answers = project.answers;

  // Helper: auto-fill a question (skip if already manually answered)
  function autoFill(qId, score, note) {
    if (!answers[qId]) answers[qId] = {};
    // Don't overwrite manually scored answers
    if (answers[qId].score && !answers[qId].autoScanned) return;
    answers[qId].score = score;
    answers[qId].notes = (answers[qId].notes ? answers[qId].notes + '\n' : '') + '[Auto-scan] ' + note;
    answers[qId].autoScanned = true;
  }

  let domFilled = 0;
  let psiFilled = 0;

  // ── Phase 1: DOM-based checks (fast, works always) ──
  try {
    btn.innerHTML = '<i data-lucide="loader"></i> DOM analyse…'; lucide.createIcons({nodes:[btn]});
    const pageData = await getPageDocument(url);
    if (pageData) {
      domFilled = runDomChecks(pageData, answers, autoFill);
    }
  } catch(e) { console.warn('DOM checks error:', e); }

  // Save intermediate results so user sees DOM results even if PSI fails
  saveState();
  renderStep(currentStep, false);
  buildStepper();

  // ── Phase 2: PageSpeed Insights API (slower, richer data) ──
  // Only run for professional mode
  const isPro = project.mode !== 'self-service';

  if (isPro) {
    let apiKey = getApiKey();
    try {
      btn.innerHTML = '<i data-lucide="loader"></i> PageSpeed… (10-30s)'; lucide.createIcons({nodes:[btn]});
      const apiUrl = `https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=${encodeURIComponent(url)}&category=performance&category=seo&category=accessibility&strategy=mobile&key=${encodeURIComponent(apiKey)}`;
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 60000);
      const resp = await fetch(apiUrl, { signal: controller.signal });
      clearTimeout(timeout);
      if (!resp.ok) {
        const errData = await resp.json().catch(() => ({}));
        throw new Error(errData.error?.message || `API fout (${resp.status})`);
      }
      const data = await resp.json();
      const audits = data.lighthouseResult?.audits || {};
      const cats = data.lighthouseResult?.categories || {};

      // Performance scores
      const perfScore = (cats.performance?.score || 0) * 100;
      const lcp = audits['largest-contentful-paint']?.numericValue;
      const cls = audits['cumulative-layout-shift']?.numericValue;
      const inp = audits['interaction-to-next-paint']?.numericValue;
      const fcp = audits['first-contentful-paint']?.numericValue;
      const speed = audits['speed-index']?.numericValue;

      if (speed !== undefined) {
        const speedSec = speed / 1000;
        const score = speedSec < 2 ? 'good' : speedSec < 3 ? 'ok' : 'bad';
        autoFill('cvq6', score, `Speed Index: ${speedSec.toFixed(1)}s. FCP: ${(fcp/1000).toFixed(1)}s. Performance score: ${perfScore.toFixed(0)}/100`);
        psiFilled++;
      }

      if (lcp !== undefined) {
        const lcpOk = lcp < 2500;
        const clsOk = cls !== undefined ? cls < 0.1 : true;
        const inpOk = inp !== undefined ? inp < 200 : true;
        const allGood = lcpOk && clsOk && inpOk;
        const anyBad = (!lcpOk && lcp > 4000) || (cls > 0.25) || (inp > 500);
        const score = allGood ? 'good' : anyBad ? 'bad' : 'ok';
        let note = `LCP: ${(lcp/1000).toFixed(1)}s`;
        if (cls !== undefined) note += ` · CLS: ${cls.toFixed(3)}`;
        if (inp !== undefined) note += ` · INP: ${inp.toFixed(0)}ms`;
        autoFill('cvq7', score, note);
        psiFilled++;
      }

      // Touch targets
      const tapAudit = audits['tap-targets'];
      if (tapAudit) {
        const failCount = tapAudit.details?.items?.length || 0;
        autoFill('mbq2', tapAudit.score === 1 ? 'good' : failCount > 5 ? 'bad' : 'ok',
          tapAudit.score === 1 ? 'Touch targets zijn groot genoeg' : `${failCount} element(en) te klein voor touch`);
        psiFilled++;
      }

      // Font size (mobile)
      const fontAudit = audits['font-size'];
      if (fontAudit) {
        autoFill('mbq3', fontAudit.score === 1 ? 'good' : 'ok', fontAudit.score === 1 ? 'Lettergrootte is leesbaar op mobiel' : 'Sommige tekst te klein op mobiel');
        psiFilled++;
      }

      // Accessibility score (enriches DOM-based hcq5)
      const a11yScore = (cats.accessibility?.score || 0) * 100;
      if (a11yScore > 0) {
        autoFill('hcq5', a11yScore >= 90 ? 'good' : a11yScore >= 50 ? 'ok' : 'bad', `Lighthouse Accessibility: ${a11yScore.toFixed(0)}/100`);
        psiFilled++;
      }

      saveState();
      renderStep(currentStep, false);
      buildStepper();

    } catch(err) {
      const msg = err.name === 'AbortError' ? 'Timeout — probeer opnieuw' : (err.message || 'Onbekende fout');
      const isQuota = msg.toLowerCase().includes('quota') || msg.toLowerCase().includes('rate');
      if (isQuota) {
        const newKey = promptApiKey();
        if (newKey && newKey !== apiKey) {
          btn.innerHTML = '<i data-lucide="zap"></i> Auto-Scan'; lucide.createIcons({nodes:[btn]});
          btn.style.pointerEvents = '';
          runAutoScan();
          return;
        }
      }
      // If DOM checks worked but PSI failed, still show partial success
      if (domFilled > 0) {
        console.warn('PSI failed but DOM checks succeeded:', msg);
      } else {
        btn.innerHTML = '<i data-lucide="alert-circle"></i> ' + msg.substring(0, 35); lucide.createIcons({nodes:[btn]});
        btn.style.borderColor = 'var(--red)';
        btn.style.color = 'var(--red)';
        setTimeout(() => {
          btn.innerHTML = '<i data-lucide="zap"></i> Auto-Scan'; lucide.createIcons({nodes:[btn]});
          btn.style.borderColor = 'var(--blue)';
          btn.style.color = 'var(--blue)';
          btn.style.pointerEvents = '';
        }, 5000);
        console.error('Auto-scan error:', err);
        return;
      }
    }
  }

  // ── Show results ──
  const totalFilled = Object.values(answers).filter(a => a.autoScanned).length;
  btn.innerHTML = `<i data-lucide="check"></i> ${totalFilled} vragen ingevuld`; lucide.createIcons({nodes:[btn]});
  btn.style.borderColor = 'var(--green)';
  btn.style.color = 'var(--green)';
  setTimeout(() => {
    btn.innerHTML = '<i data-lucide="zap"></i> Auto-Scan'; lucide.createIcons({nodes:[btn]});
    btn.style.borderColor = 'var(--blue)';
    btn.style.color = 'var(--blue)';
    btn.style.pointerEvents = '';
  }, 3000);
}

// ═══════════════ DOM-BASED AUTO-CHECKS ═══════════════
async function getPageDocument(url) {
  // Try 1: iframe DOM (same-origin)
  try {
    const frame = document.getElementById('previewFrame');
    if (frame && frame.contentDocument && frame.contentDocument.body) {
      const test = frame.contentDocument.title; // throws if cross-origin
      return { doc: frame.contentDocument, source: 'iframe', css: true };
    }
  } catch(e) { /* cross-origin */ }

  // Try 2: fetch + DOMParser (cross-origin fallback)
  try {
    const resp = await fetch(url, { mode: 'cors', redirect: 'follow' });
    if (!resp.ok) throw new Error(resp.status);
    const html = await resp.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    return { doc, source: 'fetch', css: false };
  } catch(e) { /* CORS blocked */ }

  // Try 3: proxy fallback
  try {
    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
    const resp = await fetch(proxyUrl);
    if (!resp.ok) throw new Error(resp.status);
    const html = await resp.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    return { doc, source: 'proxy', css: false };
  } catch(e) { /* proxy failed too */ }

  return null;
}

function runDomChecks(pageData, answers, autoFill) {
  if (!pageData || !pageData.doc) return 0;
  const doc = pageData.doc;
  const canCSS = pageData.css; // only true for same-origin iframe
  let filled = 0;

  // ── sm1: Heading hierarchy (h1 → h2 → h3, no skipping) ──
  try {
    const headings = Array.from(doc.querySelectorAll('h1,h2,h3,h4,h5,h6'));
    if (headings.length > 0) {
      const levels = headings.map(h => parseInt(h.tagName[1]));
      const h1Count = levels.filter(l => l === 1).length;
      let skipped = false;
      for (let i = 1; i < levels.length; i++) {
        if (levels[i] - levels[i-1] > 1) { skipped = true; break; }
      }
      const hasH1 = h1Count >= 1;
      const multiH1 = h1Count > 1;
      const structure = levels.slice(0, 10).map(l => 'h' + l).join(' → ');
      if (hasH1 && !skipped && !multiH1) {
        autoFill('sm1', 'good', `Heading hiërarchie correct: ${structure}${levels.length > 10 ? '…' : ''}`);
      } else {
        const issues = [];
        if (!hasH1) issues.push('geen h1 gevonden');
        if (multiH1) issues.push(h1Count + ' h1-tags (verwacht: 1)');
        if (skipped) issues.push('niveaus overgeslagen');
        autoFill('sm1', multiH1 || !hasH1 ? 'bad' : 'ok', `Headings: ${issues.join(', ')}. Structuur: ${structure}${levels.length > 10 ? '…' : ''}`);
      }
      filled++;
    }
  } catch(e) {}

  // ── kb4 + seq1: Title tag ──
  try {
    const title = doc.querySelector('title');
    const titleText = title ? title.textContent.trim() : '';
    if (titleText.length > 0) {
      const isGood = titleText.length >= 10 && titleText.length <= 70;
      const score = isGood ? 'good' : 'ok';
      const note = `Title: "${titleText.substring(0, 60)}${titleText.length > 60 ? '…' : ''}" (${titleText.length} tekens)`;
      autoFill('kb4', score, note);
      autoFill('seq1', score, note);
      filled += 2;
    } else {
      autoFill('kb4', 'bad', 'Geen title tag gevonden of leeg');
      autoFill('seq1', 'bad', 'Geen title tag gevonden of leeg');
      filled += 2;
    }
  } catch(e) {}

  // ── seq2: Meta description ──
  try {
    const meta = doc.querySelector('meta[name="description"]');
    const desc = meta ? meta.getAttribute('content')?.trim() : '';
    if (desc && desc.length > 0) {
      const isGood = desc.length >= 50 && desc.length <= 160;
      autoFill('seq2', isGood ? 'good' : 'ok', `Meta description: "${desc.substring(0, 80)}${desc.length > 80 ? '…' : ''}" (${desc.length} tekens)`);
    } else {
      autoFill('seq2', 'bad', 'Meta description ontbreekt');
    }
    filled++;
  } catch(e) {}

  // ── seq4: Alt-teksten op afbeeldingen ──
  try {
    const imgs = Array.from(doc.querySelectorAll('img'));
    if (imgs.length > 0) {
      const missingAlt = imgs.filter(img => !img.hasAttribute('alt') || img.getAttribute('alt').trim() === '');
      // Exclude decorative / tiny images
      const significant = missingAlt.filter(img => {
        const w = img.getAttribute('width');
        const h = img.getAttribute('height');
        if (w && h && parseInt(w) < 5 && parseInt(h) < 5) return false;
        if (img.getAttribute('role') === 'presentation') return false;
        return true;
      });
      if (significant.length === 0) {
        autoFill('seq4', 'good', `Alle ${imgs.length} afbeeldingen hebben alt-teksten`);
      } else {
        autoFill('seq4', significant.length > 3 ? 'bad' : 'ok', `${significant.length} van ${imgs.length} afbeeldingen missen alt-teksten`);
      }
      filled++;
    }
  } catch(e) {}

  // ── seq3: Heading tags correct (duplicate of sm1 but for SEO step) ──
  try {
    const headings = Array.from(doc.querySelectorAll('h1,h2,h3,h4,h5,h6'));
    if (headings.length > 0) {
      const levels = headings.map(h => parseInt(h.tagName[1]));
      const h1s = levels.filter(l => l === 1).length;
      let skipFound = false;
      for (let i = 1; i < levels.length; i++) { if (levels[i] - levels[i-1] > 1) { skipFound = true; break; } }
      if (h1s === 1 && !skipFound) {
        autoFill('seq3', 'good', `${headings.length} headings, hiërarchie correct`);
      } else {
        const issues = [];
        if (h1s !== 1) issues.push(h1s + ' h1-tags');
        if (skipFound) issues.push('niveaus overgeslagen');
        autoFill('seq3', 'ok', `${headings.length} headings — ${issues.join(', ')}`);
      }
      filled++;
    }
  } catch(e) {}

  // ── kb3: Skip-to-content link ──
  try {
    const links = Array.from(doc.querySelectorAll('a[href^="#"]'));
    const skipLink = links.find(a => {
      const text = (a.textContent || '').toLowerCase();
      const href = (a.getAttribute('href') || '').toLowerCase();
      return text.includes('skip') || text.includes('direct naar') || text.includes('naar content') ||
             text.includes('ga naar inhoud') || href.includes('main') || href.includes('content');
    });
    if (skipLink) {
      autoFill('kb3', 'good', `Skip-link gevonden: "${skipLink.textContent.trim().substring(0, 40)}"`);
    } else {
      autoFill('kb3', 'bad', 'Geen "skip to content" link gevonden');
    }
    filled++;
  } catch(e) {}

  // ── fm5: lang attribute on <html> ──
  try {
    const htmlEl = doc.querySelector('html');
    const lang = htmlEl ? htmlEl.getAttribute('lang') : null;
    if (lang && lang.trim().length >= 2) {
      autoFill('fm5', 'good', `lang="${lang}" correct ingesteld op html-element`);
    } else {
      autoFill('fm5', 'bad', 'Geen lang-attribuut op html-element gevonden');
    }
    filled++;
  } catch(e) {}

  // ── fm1: Form fields with <label> ──
  try {
    const inputs = Array.from(doc.querySelectorAll('input:not([type="hidden"]):not([type="submit"]):not([type="button"]):not([type="reset"]), select, textarea'));
    if (inputs.length > 0) {
      const noLabel = inputs.filter(inp => {
        const id = inp.getAttribute('id');
        if (id && doc.querySelector(`label[for="${id}"]`)) return false;
        if (inp.closest('label')) return false;
        if (inp.getAttribute('aria-label') || inp.getAttribute('aria-labelledby')) return false;
        if (inp.getAttribute('title')) return false;
        return true;
      });
      if (noLabel.length === 0) {
        autoFill('fm1', 'good', `Alle ${inputs.length} formuliervelden hebben een label`);
      } else {
        autoFill('fm1', noLabel.length > 2 ? 'bad' : 'ok', `${noLabel.length} van ${inputs.length} velden missen een gekoppeld label`);
      }
      filled++;
    }
  } catch(e) {}

  // ── fm7: Required fields marked ──
  try {
    const inputs = Array.from(doc.querySelectorAll('input[required], select[required], textarea[required], input[aria-required="true"], select[aria-required="true"], textarea[aria-required="true"]'));
    const allInputs = Array.from(doc.querySelectorAll('input:not([type="hidden"]):not([type="submit"]):not([type="button"]):not([type="reset"]), select, textarea'));
    if (allInputs.length > 0) {
      if (inputs.length > 0) {
        autoFill('fm7', 'good', `${inputs.length} van ${allInputs.length} velden gemarkeerd als verplicht (required/aria-required)`);
      } else {
        autoFill('fm7', 'ok', `${allInputs.length} formuliervelden gevonden, maar geen "required" of "aria-required" attributen`);
      }
      filled++;
    }
  } catch(e) {}

  // ── sm7: Autocomplete attributes on personal data fields ──
  try {
    const personalFields = Array.from(doc.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], input[name*="name"], input[name*="email"], input[name*="phone"], input[name*="address"], input[name*="city"], input[name*="zip"], input[name*="postal"]'));
    if (personalFields.length > 0) {
      const hasAutocomplete = personalFields.filter(f => f.getAttribute('autocomplete'));
      if (hasAutocomplete.length === personalFields.length) {
        autoFill('sm7', 'good', `Alle ${personalFields.length} relevante velden hebben autocomplete-attributen`);
      } else if (hasAutocomplete.length > 0) {
        autoFill('sm7', 'ok', `${hasAutocomplete.length} van ${personalFields.length} relevante velden hebben autocomplete-attributen`);
      } else {
        autoFill('sm7', 'bad', `${personalFields.length} persoonlijke-data velden zonder autocomplete-attributen`);
      }
      filled++;
    }
  } catch(e) {}

  // ── sm2: Interactive elements with accessible name ──
  try {
    const interactive = Array.from(doc.querySelectorAll('button, a[href], input:not([type="hidden"]), select, textarea, [role="button"], [role="link"], [role="tab"]'));
    if (interactive.length > 0) {
      const noName = interactive.filter(el => {
        const text = (el.textContent || '').trim();
        const ariaLabel = el.getAttribute('aria-label');
        const ariaLabelledBy = el.getAttribute('aria-labelledby');
        const title = el.getAttribute('title');
        const alt = el.querySelector('img[alt]')?.getAttribute('alt');
        const value = el.getAttribute('value');
        return !text && !ariaLabel && !ariaLabelledBy && !title && !alt && !value;
      });
      if (noName.length === 0) {
        autoFill('sm2', 'good', `Alle ${interactive.length} interactieve elementen hebben een toegankelijke naam`);
      } else {
        autoFill('sm2', noName.length > 5 ? 'bad' : 'ok', `${noName.length} van ${interactive.length} interactieve elementen missen een toegankelijke naam`);
      }
      filled++;
    }
  } catch(e) {}

  // ── sm3: ARIA roles (divs/spans acting as buttons without role) ──
  try {
    const clickable = Array.from(doc.querySelectorAll('[onclick], [tabindex]'));
    const badRole = clickable.filter(el => {
      const tag = el.tagName.toLowerCase();
      if (['button','a','input','select','textarea','summary','details'].includes(tag)) return false;
      if (el.getAttribute('role')) return false;
      return true;
    });
    if (clickable.length > 0) {
      if (badRole.length === 0) {
        autoFill('sm3', 'good', 'Alle klikbare elementen hebben correcte ARIA-rollen of zijn native HTML-elementen');
      } else {
        autoFill('sm3', badRole.length > 3 ? 'bad' : 'ok', `${badRole.length} klikbare elementen zonder juiste role-attribuut`);
      }
      filled++;
    }
  } catch(e) {}

  // ── mbq1: Viewport meta tag (responsive) ──
  try {
    const viewport = doc.querySelector('meta[name="viewport"]');
    if (viewport) {
      const content = viewport.getAttribute('content') || '';
      const hasWidth = content.includes('width=device-width');
      autoFill('mbq1', hasWidth ? 'good' : 'ok', `Viewport meta: "${content.substring(0, 60)}"`);
    } else {
      autoFill('mbq1', 'bad', 'Geen viewport meta tag gevonden — site is niet responsive');
    }
    filled++;
  } catch(e) {}

  // ── a11q7: Text min 16px and line-height min 1.5 (CSS check — only iframe) ──
  if (canCSS) {
    try {
      const body = doc.body;
      const cs = doc.defaultView.getComputedStyle(body);
      const fontSize = parseFloat(cs.fontSize);
      const lineHeight = parseFloat(cs.lineHeight);
      const lhRatio = lineHeight / fontSize;
      const sizeOk = fontSize >= 16;
      const lhOk = lhRatio >= 1.4;
      if (sizeOk && lhOk) {
        autoFill('a11q7', 'good', `Body font-size: ${fontSize}px, line-height: ${lhRatio.toFixed(2)} — beide voldoende`);
      } else {
        const issues = [];
        if (!sizeOk) issues.push(`font-size ${fontSize}px (min 16px)`);
        if (!lhOk) issues.push(`line-height ${lhRatio.toFixed(2)} (min 1.5)`);
        autoFill('a11q7', 'ok', `Body tekst: ${issues.join(', ')}`);
      }
      filled++;
    } catch(e) {}
  }

  // ── hcq5: Basic accessibility check via tag count (aria, roles, alt) ──
  try {
    const ariaCount = doc.querySelectorAll('[aria-label],[aria-labelledby],[aria-describedby],[role]').length;
    const altCount = doc.querySelectorAll('img[alt]').length;
    const imgTotal = doc.querySelectorAll('img').length;
    const labelCount = doc.querySelectorAll('label').length;
    const total = ariaCount + altCount + labelCount;
    if (total > 20) {
      autoFill('hcq5', 'good', `Goede a11y basis: ${ariaCount} ARIA attrs, ${altCount}/${imgTotal} img met alt, ${labelCount} labels`);
    } else if (total > 5) {
      autoFill('hcq5', 'ok', `Basis a11y aanwezig: ${ariaCount} ARIA attrs, ${altCount}/${imgTotal} img met alt, ${labelCount} labels`);
    } else {
      autoFill('hcq5', 'bad', `Minimale a11y: ${ariaCount} ARIA attrs, ${altCount}/${imgTotal} img met alt, ${labelCount} labels`);
    }
    filled++;
  } catch(e) {}

  // ── md5: Auto-playing audio/video ──
  try {
    const autoplayMedia = doc.querySelectorAll('audio[autoplay], video[autoplay]');
    const allMedia = doc.querySelectorAll('audio, video');
    if (allMedia.length > 0) {
      if (autoplayMedia.length === 0) {
        autoFill('md5', 'good', `${allMedia.length} media-element(en) gevonden, geen autoplay`);
      } else {
        autoFill('md5', 'ok', `${autoplayMedia.length} media-element(en) met autoplay gevonden`);
      }
      filled++;
    }
  } catch(e) {}

  // ── seq5: Clean URL (is-crawlable via robots meta) ──
  try {
    const robotsMeta = doc.querySelector('meta[name="robots"]');
    const content = robotsMeta ? (robotsMeta.getAttribute('content') || '').toLowerCase() : '';
    if (content.includes('noindex')) {
      autoFill('seq5', 'bad', `Pagina is noindex: robots meta = "${content}"`);
      filled++;
    } else if (robotsMeta) {
      autoFill('seq5', 'good', `Pagina is indexeerbaar: robots meta = "${content || 'geen restrictie'}"`);
      filled++;
    }
  } catch(e) {}

  // ── h6q6 + h7q3 + kb6: Zoekfunctie aanwezig ──
  try {
    const searchInput = doc.querySelector('input[type="search"], [role="search"], input[name*="search"], input[name*="zoek"], input[placeholder*="zoek" i], input[placeholder*="search" i]');
    const sitemapLink = doc.querySelector('a[href*="sitemap"], a[href*="site-map"]');
    const navEl = doc.querySelector('nav, [role="navigation"]');
    const found = [];
    if (navEl) found.push('navigatie');
    if (searchInput) found.push('zoekfunctie');
    if (sitemapLink) found.push('sitemap');
    if (searchInput) {
      autoFill('h6q6', 'good', `Zoekfunctie gevonden op de pagina`);
      autoFill('h7q3', 'good', `Zoekfunctie aanwezig naast navigatie`);
      filled += 2;
    } else {
      autoFill('h6q6', 'bad', 'Geen zoekfunctie gevonden (geen input[type="search"] of [role="search"])');
      autoFill('h7q3', 'bad', 'Geen zoekfunctie gevonden');
      filled += 2;
    }
    // kb6: multiple ways to find pages
    if (found.length >= 2) {
      autoFill('kb6', 'good', `${found.length} manieren gevonden: ${found.join(', ')}`);
    } else if (found.length === 1) {
      autoFill('kb6', 'ok', `Slechts 1 manier gevonden: ${found[0]}. Voeg zoekfunctie of sitemap toe.`);
    } else {
      autoFill('kb6', 'bad', 'Geen navigatie, zoekfunctie of sitemap gevonden');
    }
    filled++;
  } catch(e) {}

  // ── h10q3: Contactinformatie makkelijk te vinden ──
  try {
    const telLink = doc.querySelector('a[href^="tel:"]');
    const mailLink = doc.querySelector('a[href^="mailto:"]');
    const contactLink = doc.querySelector('a[href*="contact"], a[href*="kontakt"]');
    const found = [];
    if (telLink) found.push('telefoonnummer');
    if (mailLink) found.push('e-mailadres');
    if (contactLink) found.push('contactpagina');
    if (found.length >= 2) {
      autoFill('h10q3', 'good', `Contactinfo gevonden: ${found.join(', ')}`);
    } else if (found.length === 1) {
      autoFill('h10q3', 'ok', `Contactinfo deels aanwezig: ${found[0]}`);
    } else {
      autoFill('h10q3', 'bad', 'Geen telefoonnummer, e-mail of contactpagina-link gevonden');
    }
    filled++;
  } catch(e) {}

  // ── h10q5: Chatfunctie / direct contactkanaal ──
  try {
    const chatIndicators = doc.querySelectorAll(
      '[id*="intercom"], [class*="intercom"], [id*="drift"], [class*="drift"], ' +
      '[id*="tawk"], [class*="tawk"], [id*="zendesk"], [class*="zendesk"], ' +
      '[id*="crisp"], [class*="crisp"], [id*="livechat"], [class*="livechat"], ' +
      '[id*="hubspot"], [class*="hubspot-messages"], [id*="tidio"], [class*="tidio"], ' +
      '[id*="chat-widget"], [class*="chat-widget"], [id*="chatbot"], [class*="chatbot"], ' +
      'iframe[src*="tawk.to"], iframe[src*="intercom"], iframe[src*="drift"]'
    );
    if (chatIndicators.length > 0) {
      autoFill('h10q5', 'good', `Chatwidget gedetecteerd (${chatIndicators.length} indicator(en))`);
    } else {
      autoFill('h10q5', 'ok', 'Geen bekende chatwidget gedetecteerd (Intercom, Drift, Tawk, Zendesk, Crisp, Tidio, HubSpot)');
    }
    filled++;
  } catch(e) {}

  // ── md2: Video's met ondertiteling (captions) ──
  try {
    const videos = Array.from(doc.querySelectorAll('video'));
    if (videos.length > 0) {
      const withTrack = videos.filter(v => v.querySelector('track[kind="captions"], track[kind="subtitles"]'));
      if (withTrack.length === videos.length) {
        autoFill('md2', 'good', `Alle ${videos.length} video('s) hebben ondertiteling (track-element)`);
      } else if (withTrack.length > 0) {
        autoFill('md2', 'ok', `${withTrack.length} van ${videos.length} video('s) hebben ondertiteling`);
      } else {
        autoFill('md2', 'bad', `${videos.length} video('s) zonder ondertiteling (geen track-element gevonden)`);
      }
      filled++;
    }
  } catch(e) {}

  // ── md7: Bewegende/auto-scrollende content ──
  try {
    const marquee = doc.querySelectorAll('marquee');
    const blink = doc.querySelectorAll('blink');
    const autoScroll = marquee.length + blink.length;
    if (autoScroll > 0) {
      autoFill('md7', 'bad', `${autoScroll} verouderde bewegende elementen gevonden (marquee/blink)`);
      filled++;
    }
  } catch(e) {}

  // ── mbq4: Mobiel formulier keyboard types ──
  try {
    const emailInputs = doc.querySelectorAll('input[type="email"], input[inputmode="email"]');
    const telInputs = doc.querySelectorAll('input[type="tel"], input[inputmode="tel"]');
    const urlInputs = doc.querySelectorAll('input[type="url"], input[inputmode="url"]');
    const numInputs = doc.querySelectorAll('input[type="number"], input[inputmode="numeric"], input[inputmode="decimal"]');
    const allInputs = doc.querySelectorAll('input:not([type="hidden"]):not([type="submit"]):not([type="button"]):not([type="reset"]):not([type="checkbox"]):not([type="radio"])');
    if (allInputs.length > 0) {
      const typed = emailInputs.length + telInputs.length + urlInputs.length + numInputs.length;
      const details = [];
      if (emailInputs.length) details.push(`${emailInputs.length}× email`);
      if (telInputs.length) details.push(`${telInputs.length}× tel`);
      if (urlInputs.length) details.push(`${urlInputs.length}× url`);
      if (numInputs.length) details.push(`${numInputs.length}× number`);
      if (typed > 0) {
        autoFill('mbq4', typed >= allInputs.length * 0.3 ? 'good' : 'ok', `Mobiel keyboard types: ${details.join(', ')} van ${allInputs.length} velden`);
      } else {
        autoFill('mbq4', 'ok', `${allInputs.length} invoervelden zonder specifiek inputmode/type — standaard toetsenbord wordt gebruikt`);
      }
      filled++;
    }
  } catch(e) {}

  // ── kb5: Tab-volgorde (positive tabindex = anti-pattern) ──
  try {
    const positiveTabindex = Array.from(doc.querySelectorAll('[tabindex]')).filter(el => {
      const val = parseInt(el.getAttribute('tabindex'));
      return val > 0;
    });
    if (positiveTabindex.length > 0) {
      autoFill('kb5', 'ok', `${positiveTabindex.length} elementen met positieve tabindex (anti-pattern — verstoort natuurlijke tab-volgorde)`);
      filled++;
    } else {
      const tabindexEls = doc.querySelectorAll('[tabindex]').length;
      if (tabindexEls > 0) {
        autoFill('kb5', 'good', `${tabindexEls} elementen met tabindex, geen positieve waarden (correcte aanpak)`);
        filled++;
      }
    }
  } catch(e) {}

  // ── h1q1: Breadcrumbs / actieve menu-items ──
  try {
    const breadcrumb = doc.querySelector('[aria-label*="breadcrumb" i], .breadcrumb, .breadcrumbs, nav.breadcrumb, [role="navigation"][aria-label*="broodkruimel" i], ol.breadcrumb');
    const ariaCurrent = doc.querySelector('[aria-current="page"], [aria-current="step"], .active[role="menuitem"], nav .active, nav .current');
    const found = [];
    if (breadcrumb) found.push('breadcrumbs');
    if (ariaCurrent) found.push('actief menu-item (aria-current/active)');
    if (found.length >= 2) {
      autoFill('h1q1', 'good', `Navigatie-indicatoren: ${found.join(' + ')}`);
    } else if (found.length === 1) {
      autoFill('h1q1', 'ok', `Deels: ${found[0]} gevonden, maar ${!breadcrumb ? 'geen breadcrumbs' : 'geen actief menu-item'}`);
    } else {
      autoFill('h1q1', 'bad', 'Geen breadcrumbs of aria-current/active menu-indicatie gevonden');
    }
    filled++;
  } catch(e) {}

  // ── h6q3: Sticky/fixed navigatie ──
  if (canCSS) {
    try {
      const navEls = doc.querySelectorAll('nav, header, [role="navigation"]');
      let hasSticky = false;
      navEls.forEach(el => {
        const cs = doc.defaultView.getComputedStyle(el);
        if (cs.position === 'sticky' || cs.position === 'fixed') hasSticky = true;
      });
      if (hasSticky) {
        autoFill('h6q3', 'good', 'Navigatie is sticky/fixed — altijd bereikbaar');
      } else if (navEls.length > 0) {
        autoFill('h6q3', 'ok', `Navigatie gevonden maar niet sticky/fixed — verdwijnt bij scrollen`);
      } else {
        autoFill('h6q3', 'bad', 'Geen nav of header element gevonden');
      }
      filled++;
    } catch(e) {}
  }

  // ── cvq3 + cvq5: Vertrouwenssignalen / social proof ──
  try {
    const trustIndicators = [];
    // Reviews / ratings
    if (doc.querySelector('[class*="review"], [class*="rating"], [class*="testimonial"], [class*="getuigenis"], [itemtype*="Review"], [class*="trustpilot"]')) trustIndicators.push('reviews/ratings');
    // Trust badges / keurmerken
    if (doc.querySelector('[class*="trust"], [class*="keurmerk"], [class*="badge"], [alt*="keurmerk" i], [alt*="trusted" i], [alt*="ssl" i], [alt*="secure" i]')) trustIndicators.push('vertrouwensbadges');
    // Client logos
    if (doc.querySelector('[class*="client"], [class*="partner"], [class*="logo-grid"], [class*="klant"], [alt*="klant" i], [alt*="partner" i]')) trustIndicators.push('klant/partner logo\'s');
    // Star ratings
    if (doc.querySelector('[class*="star"], [class*="ster"], .fa-star, [aria-label*="star" i]')) trustIndicators.push('sterren-rating');

    if (trustIndicators.length >= 2) {
      autoFill('cvq3', 'good', `Vertrouwenssignalen: ${trustIndicators.join(', ')}`);
      autoFill('cvq5', 'good', `Social proof aanwezig: ${trustIndicators.join(', ')}`);
    } else if (trustIndicators.length === 1) {
      autoFill('cvq3', 'ok', `1 type vertrouwenssignaal: ${trustIndicators[0]}`);
      autoFill('cvq5', 'ok', `Beperkte social proof: ${trustIndicators[0]}`);
    } else {
      autoFill('cvq3', 'bad', 'Geen vertrouwenssignalen gevonden (reviews, badges, klantenlogo\'s)');
      autoFill('cvq5', 'bad', 'Geen social proof elementen gevonden');
    }
    filled += 2;
  } catch(e) {}

  // ── sm4: Semantische structuur (header/main/footer/nav) ──
  try {
    const semantic = [];
    if (doc.querySelector('header')) semantic.push('header');
    if (doc.querySelector('nav, [role="navigation"]')) semantic.push('nav');
    if (doc.querySelector('main, [role="main"]')) semantic.push('main');
    if (doc.querySelector('footer')) semantic.push('footer');
    if (doc.querySelector('aside, [role="complementary"]')) semantic.push('aside');
    if (doc.querySelector('article')) semantic.push('article');
    if (doc.querySelector('section')) semantic.push('section');
    if (semantic.length >= 4) {
      autoFill('sm4', 'good', `Goede semantische structuur: ${semantic.join(', ')}`);
    } else if (semantic.length >= 2) {
      autoFill('sm4', 'ok', `Basis semantiek: ${semantic.join(', ')} — voeg meer landmarks toe`);
    } else {
      autoFill('sm4', 'bad', `Minimale semantiek: ${semantic.length > 0 ? semantic.join(', ') : 'geen landmarks'}. Gebruik header, nav, main, footer.`);
    }
    filled++;
  } catch(e) {}

  // ── cvq4: Contactformulier kort genoeg ──
  try {
    const forms = Array.from(doc.querySelectorAll('form'));
    if (forms.length > 0) {
      const shortestForm = forms.reduce((min, form) => {
        const fields = form.querySelectorAll('input:not([type="hidden"]):not([type="submit"]):not([type="button"]), select, textarea').length;
        return fields < min.fields ? { form, fields } : min;
      }, { form: null, fields: 999 });
      if (shortestForm.fields <= 4) {
        autoFill('cvq4', 'good', `Kortste formulier: ${shortestForm.fields} velden — beknopt`);
      } else if (shortestForm.fields <= 7) {
        autoFill('cvq4', 'ok', `Kortste formulier: ${shortestForm.fields} velden — overweeg reductie`);
      } else {
        autoFill('cvq4', 'bad', `Kortste formulier: ${shortestForm.fields} velden — te lang, verhoogt uitval`);
      }
      filled++;
    }
  } catch(e) {}

  // ── h4q3: Webconventies (logo links = home) ──
  try {
    const logoLink = doc.querySelector('header a[href="/"], header a[href="./"], a.logo[href], .logo a[href], a[class*="logo"][href], header a:first-child[href]');
    if (logoLink) {
      const href = logoLink.getAttribute('href') || '';
      const isHome = href === '/' || href === './' || href === '#' || href.endsWith('/') && href.split('/').filter(Boolean).length <= 1;
      if (isHome) {
        autoFill('h4q3', 'good', 'Logo linkt naar homepage — volgt webconventies');
      } else {
        autoFill('h4q3', 'ok', `Logo linkt naar "${href}" — niet direct naar homepage`);
      }
    } else {
      autoFill('h4q3', 'ok', 'Geen duidelijke logo-link in header gevonden');
    }
    filled++;
  } catch(e) {}

  // ── h1q6: Winkelwagen status zichtbaar (e-commerce) ──
  try {
    const cartIndicators = doc.querySelector('[class*="cart"], [class*="basket"], [class*="wagen"], [class*="winkelwagen"], [id*="cart"], [aria-label*="cart" i], [aria-label*="winkelwagen" i], a[href*="cart"], a[href*="winkelwagen"]');
    if (cartIndicators) {
      autoFill('h1q6', 'good', 'Winkelwagen-element gevonden in de pagina');
      filled++;
    }
    // Only fill if we find e-commerce indicators, otherwise skip (n.v.t.)
  } catch(e) {}

  // ── h10q1: FAQ sectie ──
  try {
    const faqLink = doc.querySelector('a[href*="faq" i], a[href*="veelgestelde" i]');
    const faqSection = doc.querySelector('[id*="faq" i], [class*="faq" i], details, [itemtype*="FAQPage"]');
    const accordion = doc.querySelectorAll('details, [class*="accordion"]');
    if (faqSection || accordion.length >= 3) {
      autoFill('h10q1', 'good', `FAQ/accordion gevonden${accordion.length > 0 ? ` (${accordion.length} items)` : ''}`);
    } else if (faqLink) {
      autoFill('h10q1', 'ok', 'Link naar FAQ-pagina gevonden, maar geen inline FAQ op deze pagina');
    } else {
      autoFill('h10q1', 'bad', 'Geen FAQ-sectie of veelgestelde-vragen link gevonden');
    }
    filled++;
  } catch(e) {}

  // ── Open Graph & structured data (bonus info in notes) ──
  try {
    const ogTitle = doc.querySelector('meta[property="og:title"]');
    const ogDesc = doc.querySelector('meta[property="og:description"]');
    const ogImg = doc.querySelector('meta[property="og:image"]');
    const schema = doc.querySelector('script[type="application/ld+json"]');
    const ogParts = [];
    if (ogTitle) ogParts.push('og:title');
    if (ogDesc) ogParts.push('og:description');
    if (ogImg) ogParts.push('og:image');
    if (schema) ogParts.push('structured data (JSON-LD)');
    // No direct question for this, but enrich seq2 notes if possible
  } catch(e) {}

  return filled;
}

// ═══════════════ SCORECARD ═══════════════
function showScorecard() {
  saveCurrentAnswers();
  const project = getActiveProject();
  const answers = project ? project.answers : {};
  const container = document.getElementById('scorecardContent');

  const totalQ = reviewSteps.reduce((s, st) => s + st.questions.length, 0);
  const allNvt = Object.values(answers).filter(a => a.score === 'nvt').length;
  const allScored = Object.values(answers).filter(a => a.score && a.score !== 'nvt');
  const overallEffective = totalQ - allNvt;
  // Unanswered questions count as 0 — divide by effective total
  const overallAvg = overallEffective > 0
    ? allScored.reduce((s, a) => s + (a.score==='good'?10:a.score==='ok'?6:3), 0) / overallEffective : 0;
  const overallClass = overallAvg >= 7.5 ? 'sc-good' : overallAvg >= 5 ? 'sc-ok' : 'sc-bad';
  const overallVerdict = overallAvg >= 8 ? 'Uitstekend' : overallAvg >= 7 ? 'Goed' : overallAvg >= 5 ? 'Voldoende — ruimte voor verbetering' : overallAvg >= 3 ? 'Onvoldoende — actie nodig' : 'Kritiek — directe actie vereist';

  const catScores = reviewSteps.map(step => {
    const scored = step.questions.filter(q => answers[q.id]?.score && answers[q.id].score !== 'nvt');
    const nvt = step.questions.filter(q => answers[q.id]?.score === 'nvt').length;
    const effective = step.questions.length - nvt;
    // Unanswered count as 0
    const avg = effective > 0 ? scored.reduce((s, q) => s + (answers[q.id].score==='good'?10:answers[q.id].score==='ok'?6:3), 0) / effective : -1;
    const cls = effective === 0 ? 'sc-na' : avg >= 7.5 ? 'sc-good' : avg >= 5 ? 'sc-ok' : 'sc-bad';
    const status = effective === 0 ? 'Alles n.v.t.' : avg >= 7.5 ? 'Goed' : avg >= 5 ? 'Aandacht nodig' : 'Kritiek';
    const stCls = effective === 0 ? 'st-na' : avg >= 7.5 ? 'st-good' : avg >= 5 ? 'st-ok' : 'st-bad';
    return { ...step, avg, cls, status, stCls, effective, nvt };
  });

  const allIssues = [];
  reviewSteps.forEach(step => {
    step.questions.forEach(q => {
      const a = answers[q.id];
      if (a && (a.score==='bad'||a.score==='ok')) {
        const shots = getScreenshots(q.id);
        allIssues.push({ id: q.id, text: q.text, tip: questionTips[q.id]||'', score: a.score, impact: a.severity||step.impact||'low', notes: a.notes||'', category: step.shortTitle, screenshots: shots, screenshot: shots[0]||'' });
      }
    });
  });
  allIssues.sort((a, b) => ({ high:0, low:1 }[a.impact]||1) - ({ high:0, low:1 }[b.impact]||1));

  const quickWins = allIssues.filter(i => i.impact==='high' && i.score==='ok');
  const strategic = allIssues.filter(i => i.impact==='high' && i.score==='bad');
  const fillers = allIssues.filter(i => i.impact==='low' && i.score==='ok');
  const notNow = allIssues.filter(i => i.impact==='low' && i.score==='bad');

  // Lead gate no longer needed — email is captured at the landing page
  const isSelfService = project && project.mode === 'self-service';
  const hasProvidedEmail = project && project.leadEmail;
  const showLeadGate = false; // Email already captured at landing

  // Render full-width topbar separately
  document.getElementById('scorecardTopbar').innerHTML = `
    <div class="dash-topbar">
      <div class="dash-topbar-left">
        <button class="back-btn" onclick="backToDashboardFromScorecard()" title="Dashboard"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1.5" y="1.5" width="5" height="5.5" rx="1"/><rect x="9.5" y="1.5" width="5" height="3.5" rx="1"/><rect x="1.5" y="9.5" width="5" height="3.5" rx="1"/><rect x="9.5" y="7.5" width="5" height="5.5" rx="1"/></svg></button>
        <span class="logo">${brandLogo('18px', true)}</span>
        <div class="dash-topbar-title">${project?.name || 'UX Review'}${project?.client ? ' — ' + project.client : ''}</div>
      </div>
      <div class="dash-topbar-right">
        <div class="dash-topbar-meta">${new Date().toLocaleDateString('nl-NL')} · ${allScored.length}/${overallEffective} beoordeeld${allNvt > 0 ? ` · ${allNvt} n.v.t.` : ''}</div>
        <button class="btn-icon" onclick="closeScorecard()"><i data-lucide="chevron-left" style="width:14px;height:14px"></i> Terug</button>
        <button class="btn-icon" onclick="exportResults()" style="border-color:var(--accent);color:var(--accent)"><i data-lucide="download" style="width:14px;height:14px"></i> Exporteer</button>
      </div>
    </div>`;

  container.innerHTML = `
    <div class="kpi-strip">
      <div class="kpi-card kpi-accent">
        <div class="kpi-label">Totaalscore</div>
        <div class="kpi-value ${overallClass}">${overallAvg.toFixed(1)}</div>
        <div class="kpi-sub">${overallVerdict}</div>
        <div class="kpi-bar"><div class="kpi-bar-fill" style="width:${overallAvg * 10}%;background:${overallClass === 'sc-good' ? 'var(--green)' : overallClass === 'sc-ok' ? 'var(--yellow)' : 'var(--red)'}"></div></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Beoordeeld</div>
        <div class="kpi-value">${allScored.length}<span style="font-size:16px;font-weight:400;color:var(--text-muted)">/${overallEffective}</span></div>
        <div class="kpi-sub">${overallEffective > 0 ? Math.round(allScored.length / overallEffective * 100) : 0}% voltooid</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Verbeterpunten</div>
        <div class="kpi-value" style="color:${allIssues.length > 0 ? 'var(--yellow)' : 'var(--green)'}">${allIssues.length}</div>
        <div class="kpi-sub">${allIssues.filter(i => i.impact === 'high').length} hoge impact</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Quick Wins</div>
        <div class="kpi-value" style="color:var(--green)">${quickWins.length}</div>
        <div class="kpi-sub">Direct oppakken</div>
      </div>
    </div>

    ${isSelfService && overallAvg > 0 && overallAvg < 7 ? `
    <div class="upsell-card" style="margin-bottom:16px">
      <div class="upsell-tag">Hulp nodig?</div>
      <h2>Wij helpen je van een ${overallAvg.toFixed(1)} naar een 8+</h2>
      <p>Ons team van UX experts maakt een volledig rapport met wireframes en een implementatieplan. Inclusief een strategie call.</p>
      <div class="upsell-benefits">
        <span>Expert analyse</span>
        <span>Concreet actieplan</span>
        <span>Gratis intake call</span>
      </div>
    </div>` : ''}

    <div class="dash-grid">
      <div class="ai-plan-section" id="aiPlanSection">
        <div class="ai-plan-header">
          <h3><i data-lucide="sparkles"></i> AI Actieplan</h3>
          <div style="display:flex;gap:8px;align-items:center">
            ${isSelfService ? `
              <span style="font-size:12px;color:var(--text-muted)"><i data-lucide="lock" style="width:13px;height:13px"></i> Professional</span>
            ` : `
              <button class="ai-plan-generate" onclick="generateAiPlan()" id="btnAiPlan"><i data-lucide="sparkles"></i> ${project?.aiPlan ? 'Opnieuw' : 'Genereer'}</button>
            `}
          </div>
        </div>
        <div class="ai-plan-body" id="aiPlanBody">
          ${isSelfService ? `
          <div class="ai-plan-empty">
            <i data-lucide="lock" style="width:32px;height:32px;opacity:0.3;margin-bottom:12px;display:block;margin-inline:auto"></i>
            <strong style="font-size:15px;color:var(--text);display:block;margin-bottom:8px">AI Actieplan — Professional Feature</strong>
            De AI maakt een kant-en-klaar actieplan voor je klant:<br>
            concrete actiepunten, business impact, en prioriteiten — geen technisch jargon.<br><br>
            <button class="ai-plan-generate" onclick="upgradeForAi()" style="margin-top:4px"><i data-lucide="sparkles"></i> Upgrade naar Professional</button>
          </div>
          ` : project?.aiPlan ? `<div class="ai-plan-content">${markdownToHtml(project.aiPlan)}</div>` : `
          <div class="ai-plan-empty">
            <i data-lucide="sparkles" style="width:32px;height:32px;opacity:0.3;margin-bottom:8px;display:block;margin-inline:auto"></i>
            Genereer een klantgericht actieplan op basis van de review resultaten.
          </div>`}
        </div>
        ${!isSelfService && project?.aiPlan ? `<div class="ai-plan-actions">
          <button class="btn btn-secondary" onclick="copyAiPlan()"><i data-lucide="copy" style="width:12px;height:12px"></i> Kopieer</button>
          <span style="font-size:10px;color:var(--text-muted)">Gegenereerd: ${project.aiPlanDate ? new Date(project.aiPlanDate).toLocaleDateString('nl-NL') : ''}</span>
        </div>` : ''}
      </div>

      <div class="dash-card">
        <div class="dash-card-head">
          <h3><i data-lucide="zap" style="width:14px;height:14px;color:var(--green)"></i> Quick Wins & Strategisch</h3>
          <span style="font-size:11px;color:var(--text-muted)">${quickWins.length + strategic.length} items</span>
        </div>
        <div class="dash-card-body compact" style="max-height:400px;overflow-y:auto">
          ${quickWins.length > 0 ? quickWins.map(i => `
            <div class="action-item">
              <div class="action-dot green"></div>
              <div class="action-text">${i.tip || i.text}</div>
              ${i.screenshot ? `<img class="action-screenshot" src="${i.screenshot}" onclick="showLightbox('${i.id}',0)" title="Screenshot">` : ''}
            </div>`).join('') : ''}
          ${strategic.length > 0 ? strategic.map(i => `
            <div class="action-item">
              <div class="action-dot blue"></div>
              <div class="action-text">${i.tip || i.text}</div>
              ${i.screenshot ? `<img class="action-screenshot" src="${i.screenshot}" onclick="showLightbox('${i.id}',0)" title="Screenshot">` : ''}
            </div>`).join('') : ''}
          ${quickWins.length === 0 && strategic.length === 0 ? '<div class="action-empty">Geen hoge-impact items gevonden</div>' : ''}
        </div>
      </div>
    </div>

    <div class="dash-grid">
      <div class="dash-card">
        <div class="dash-card-head">
          <h3><i data-lucide="bar-chart-3" style="width:14px;height:14px;color:var(--accent)"></i> Categorie Scores</h3>
          <span style="font-size:11px;color:var(--text-muted)">${catScores.filter(c => c.effective > 0).length} categorieën</span>
        </div>
        <div class="dash-card-body compact" style="max-height:500px;overflow-y:auto">
          ${catScores.map(c => `
            <div class="cat-row">
              <div class="cat-row-score ${c.cls}">${c.avg >= 0 ? c.avg.toFixed(1) : '—'}</div>
              <div class="cat-row-name">${c.title}</div>
              <div class="cat-row-bar"><div class="cat-row-fill" style="width:${c.avg >= 0 ? c.avg * 10 : 0}%;background:${c.cls === 'sc-good' ? 'var(--green)' : c.cls === 'sc-ok' ? 'var(--yellow)' : c.cls === 'sc-bad' ? 'var(--red)' : 'var(--border)'}"></div></div>
              <div class="cat-row-status ${c.stCls}">${c.status}</div>
            </div>`).join('')}
        </div>
      </div>

      <div class="dash-card">
        <div class="dash-card-head">
          <h3><i data-lucide="grid-2x2" style="width:14px;height:14px;color:var(--blue)"></i> Prioriteitenmatrix</h3>
        </div>
        <div class="dash-card-body">
          <div class="matrix-compact">
            <div class="mc qw">
              <h4><i data-lucide="zap" style="width:10px;height:10px"></i> Quick Wins</h4>
              <div class="mc-count" style="color:var(--green)">${quickWins.length}</div>
            </div>
            <div class="mc sp">
              <h4><i data-lucide="target" style="width:10px;height:10px"></i> Strategisch</h4>
              <div class="mc-count" style="color:var(--blue)">${strategic.length}</div>
            </div>
            <div class="mc fi">
              <h4><i data-lucide="archive" style="width:10px;height:10px"></i> Opvullers</h4>
              <div class="mc-count" style="color:var(--yellow)">${fillers.length}</div>
            </div>
            <div class="mc nn">
              <h4><i data-lucide="pause" style="width:10px;height:10px"></i> Niet Nu</h4>
              <div class="mc-count" style="color:var(--text-muted)">${notNow.length}</div>
            </div>
          </div>
          <div style="margin-top:12px;font-size:10px;color:var(--text-muted);line-height:1.6">
            <strong style="color:var(--green)">Quick Wins</strong> = Matig + hoge impact ·
            <strong style="color:var(--blue)">Strategisch</strong> = Niet OK + hoge impact<br>
            <strong style="color:var(--yellow)">Opvullers</strong> = Matig + lage impact ·
            <span>Niet Nu</span> = Niet OK + lage impact
          </div>
        </div>
      </div>
    </div>

    ${allIssues.length > 0 ? `
    <button class="findings-toggle" onclick="toggleFindings()" id="findingsToggle">
      <span><i data-lucide="list" style="width:14px;height:14px"></i> Alle Bevindingen (${allIssues.length})</span>
      <span class="ft-arrow">▼</span>
    </button>
    <div class="findings-body" id="findingsBody">
      ${allIssues.map(i => `
        <div class="issue-row">
          <span class="issue-badge ib-${i.impact}">${i.impact}</span>
          <div style="flex:1;min-width:0">
            <div class="issue-text">${i.text}</div>
            ${i.tip ? `<div class="issue-note" style="color:var(--accent);font-weight:600"><i data-lucide="lightbulb" style="width:14px;height:14px"></i> ${i.tip}</div>` : ''}
            ${i.notes ? `<div class="issue-note">${i.notes}</div>` : ''}
            <div class="issue-note" style="font-style:italic">Categorie: ${i.category}</div>
            ${(i.screenshots||[]).length ? `<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">${i.screenshots.map((s,si) => `<img class="issue-screenshot" src="${s}" onclick="showLightbox('${i.id}',${si})" title="Klik om te vergroten">`).join('')}</div>` : ''}
          </div>
        </div>`).join('')}
    </div>` : ''}
  `;

  document.getElementById('scorecardScreen').classList.remove('hidden');
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

function submitLeadGate() {
  const email = document.getElementById('upsellEmail').value.trim();
  if (!email || !email.includes('@')) { alert('Vul een geldig e-mailadres in.'); return; }
  const project = getActiveProject();
  if (project) { project.leadEmail = email; project.leadDate = new Date().toISOString(); saveState(); }
  // Unlock the scorecard
  const details = document.getElementById('scorecardDetails');
  if (details) details.classList.remove('lead-gated');
  document.getElementById('upsellForm').classList.add('hidden');
  document.getElementById('upsellSuccess').classList.remove('hidden');
  // Update dashboard stats
  setTimeout(() => { renderDashboard(); }, 500);
}

function closeScorecard() { document.getElementById('scorecardScreen').classList.add('hidden'); }

function toggleFindings() {
  const toggle = document.getElementById('findingsToggle');
  const body = document.getElementById('findingsBody');
  if (!toggle || !body) return;
  const isOpen = toggle.classList.toggle('open');
  body.classList.toggle('open', isOpen);
}

function backToDashboardFromScorecard() {
  document.getElementById('scorecardScreen').classList.add('hidden');
  document.getElementById('reviewScreen').classList.add('hidden');
  showDashboard();
}

// ═══════════════ EXPORT ═══════════════
function exportResults() {
  saveCurrentAnswers();
  const project = getActiveProject();
  const answers = project ? project.answers : {};
  const lines = [];
  lines.push('══════════════════════════════════════════');
  lines.push('  BOLD700 UX REVIEW RESULTATEN');
  lines.push('══════════════════════════════════════════');
  lines.push('');
  lines.push(`Project:     ${project?.name||'—'}`);
  lines.push(`Klant:       ${project?.client||'—'}`);
  lines.push(`URL:         ${project?.url||'—'}`);
  lines.push(`Datum:       ${new Date().toLocaleDateString('nl-NL')}`);
  lines.push('');

  const expScore = calcProjectScore(project || { answers: {} });
  lines.push(`TOTAALSCORE: ${expScore.avg.toFixed(1)} / 10`);
  lines.push(`(${expScore.answered} beoordeeld, ${expScore.nvt||0} n.v.t., ${expScore.effectiveTotal - expScore.answered} onbeantwoord = 0 punten)`);
  lines.push('');
  lines.push('── SCORES PER CATEGORIE ──');
  lines.push('');

  reviewSteps.forEach(step => {
    const stepAns = step.questions.filter(q => answers[q.id]?.score && answers[q.id].score !== 'nvt');
    const stepNvt = step.questions.filter(q => answers[q.id]?.score === 'nvt').length;
    const effective = step.questions.length - stepNvt;
    const avg = effective > 0 ? stepAns.reduce((s, q) => s + (answers[q.id].score==='good'?10:answers[q.id].score==='ok'?6:3), 0) / effective : 0;
    const status = effective === 0 ? 'Alles n.v.t.' : avg >= 8 ? 'Goed' : avg >= 5 ? 'Aandacht nodig' : 'Kritiek';
    lines.push(`${step.title.padEnd(40)} ${effective>0?avg.toFixed(1):'—'}/10  [${status}]${stepNvt > 0 ? ` (${stepNvt} n.v.t.)` : ''}`);
  });

  lines.push('');
  lines.push('── BEVINDINGEN ──');
  lines.push('');
  let n = 1;
  reviewSteps.forEach(step => {
    step.questions.forEach(q => {
      const a = answers[q.id]; if (!a?.score) return;
      if (a.score === 'nvt') { lines.push(`  #${n++} ${q.text}`); lines.push('     ○ N.v.t.'); lines.push(''); return; }
      const lbl = a.score==='good'?'✓ Goed':a.score==='ok'?'~ Matig':'✗ Niet OK';
      lines.push(`  #${n++} ${q.text}`);
      lines.push(`     ${lbl}${a.severity?' ['+a.severity.toUpperCase()+']':''}`);
      if (a.notes) lines.push(`     ${a.notes}`);
      lines.push('');
    });
  });

  lines.push('══════════════════════════════════════════');
  lines.push('  Gegenereerd door BOLD700 UX Review Tool');
  lines.push('══════════════════════════════════════════');

  document.getElementById('exportContent').textContent = lines.join('\n');
  document.getElementById('exportModal').classList.remove('hidden');
}

function copyExport() {
  navigator.clipboard.writeText(document.getElementById('exportContent').textContent).then(() => {
    const btn = event.target;
    btn.innerHTML = '<i data-lucide="check" style="width:14px;height:14px"></i> Gekopieerd!'; lucide.createIcons({nodes:[btn]});
    setTimeout(() => btn.textContent = 'Kopieer naar Klembord', 2000);
  });
}

function closeExport() { document.getElementById('exportModal').classList.add('hidden'); }

// ═══════════════ AI ACTIEPLAN (Claude API) ═══════════════
// Built-in API key — AI Actieplan is a BOLD700 Professional feature
const BOLD700_AI_KEY = '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';

function getClaudeKey() {
  // First check for built-in key, then fallback to localStorage override
  if (BOLD700_AI_KEY && BOLD700_AI_KEY !== 'YOUR_ANTHROPIC_API_KEY_HERE') return BOLD700_AI_KEY;
  try { return localStorage.getItem('bold700_claude_key') || ''; } catch(e) { return ''; }
}

function isAiAvailable() {
  const project = getActiveProject();
  return project && project.mode === 'professional' && !!getClaudeKey();
}

function upgradeForAi() {
  const project = getActiveProject();
  if (!project) return;
  const upgrade = confirm('Upgrade naar Professional om het AI Actieplan te gebruiken.\n\nProfessional bevat:\n• AI Actieplan — klantgerichte actiepunten\n• Auto-Scan — automatische website analyse\n• Prioriteitenmatrix\n• Volledige exportopties\n\nWil je upgraden?');
  if (upgrade) {
    project.mode = 'professional';
    saveState();
    showScorecard(); // Re-render with AI enabled
  }
}

function buildAiPromptData() {
  const project = getActiveProject();
  if (!project) return null;
  const answers = project.answers || {};

  const issues = [];
  const strengths = [];
  reviewSteps.forEach(step => {
    step.questions.forEach(q => {
      const a = answers[q.id];
      if (!a || !a.score || a.score === 'nvt') return;
      const item = {
        category: step.shortTitle,
        question: q.text,
        score: a.score,
        impact: a.severity || step.impact || 'low',
        notes: (a.notes || '').replace(/\[Auto-scan\]\s*/g, '').trim(),
        tip: questionTips[q.id] || ''
      };
      if (a.score === 'bad' || a.score === 'ok') issues.push(item);
      else strengths.push(item);
    });
  });

  // Sort: high impact first
  issues.sort((a, b) => (a.impact === 'high' ? 0 : 1) - (b.impact === 'high' ? 0 : 1));

  return {
    project: { name: project.name, client: project.client, url: project.url },
    issues,
    strengths: strengths.length,
    totalQuestions: reviewSteps.reduce((s, st) => s + st.questions.length, 0)
  };
}

async function generateAiPlan() {
  const project = getActiveProject();
  if (!project || project.mode === 'self-service') { upgradeForAi(); return; }

  const apiKey = getClaudeKey();
  if (!apiKey) { alert('AI Actieplan is momenteel niet beschikbaar. Neem contact op met BOLD700.'); return; }

  const data = buildAiPromptData();
  if (!data || data.issues.length === 0) {
    document.getElementById('aiPlanBody').innerHTML = '<div class="ai-plan-empty">Geen verbeterpunten gevonden — alles is goed beoordeeld!</div>';
    return;
  }

  const btn = document.getElementById('btnAiPlan');
  if (btn) { btn.disabled = true; btn.innerHTML = '<i data-lucide="loader"></i> Genereren…'; lucide.createIcons({nodes:[btn]}); }

  const body = document.getElementById('aiPlanBody');
  body.innerHTML = '<div class="ai-plan-empty ai-loading"><i data-lucide="sparkles" style="width:32px;height:32px;opacity:0.5;margin-bottom:8px;display:block;margin-inline:auto"></i>AI analyseert de review resultaten…</div>';
  if (typeof lucide !== 'undefined') lucide.createIcons({nodes:[body]});

  const issuesSummary = data.issues.map(i => {
    const scoreLabel = i.score === 'bad' ? 'Niet OK' : 'Matig';
    const impactLabel = i.impact === 'high' ? 'Hoog' : 'Laag';
    let line = `- [${scoreLabel}] [Impact: ${impactLabel}] ${i.question}`;
    if (i.notes) line += ` | Notitie reviewer: "${i.notes}"`;
    if (i.tip) line += ` | Suggestie: ${i.tip}`;
    line += ` (${i.category})`;
    return line;
  }).join('\n');

  const systemPrompt = `Je bent een senior UX consultant van BOLD700, een bureau dat bedrijven helpt met UX design en development. Je schrijft in het Nederlands, direct en to-the-point. Geen vakjargon — schrijf alsof je tegen een ondernemer of marketing manager praat.

Je doel: maak een kort, helder actieplan dat de klant overtuigt om te investeren in verbeteringen. Focus op RESULTAAT en BUSINESS IMPACT, niet op technische details.`;

  const userPrompt = `Hier zijn de resultaten van een UX review van ${data.project.url || 'een website'}${data.project.name ? ' ('+data.project.name+')' : ''}${data.project.client ? ' voor '+data.project.client : ''}.

Van de ${data.totalQuestions} beoordeelde punten zijn er ${data.issues.length} verbeterpunten gevonden en ${data.strengths} punten goed beoordeeld.

VERBETERPUNTEN:
${issuesSummary}

Maak een klantgericht actieplan met deze structuur:

## Samenvatting
Een korte samenvatting (2-3 zinnen) over de staat van de website. Begin positief (wat gaat goed), dan wat er beter kan.

## Top Prioriteiten
De 3-5 belangrijkste acties. Per actie:
### [Korte titel]
**Wat:** Wat moet er gebeuren (1 zin, simpel)
**Waarom:** Wat levert het op voor de business (meer leads, minder uitval, betere vindbaarheid, etc.)
**Impact:** Hoog/Midden/Laag
**Effort:** Klein/Middel/Groot

## Quick Wins
Punten die snel gefixt kunnen worden met groot effect. Kort en bondig, max 5 items als bullet points.

## Overige Aanbevelingen
De rest van de verbeterpunten, gegroepeerd en kort samengevat. Niet elk punt apart — groepeer gerelateerde items.

Regels:
- Schrijf in het Nederlands
- Gebruik GEEN technische termen (geen WCAG codes, geen HTML-termen, geen developer jargon)
- Focus op wat het de klant OPLEVERT (meer klanten, minder uitval, betere Google positie, professionelere uitstraling)
- Wees concreet maar kort
- Gebruik Markdown formatting`;

  try {
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 2000,
        system: systemPrompt,
        messages: [{ role: 'user', content: userPrompt }]
      })
    });

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      throw new Error(err.error?.message || `API fout (${resp.status})`);
    }

    const result = await resp.json();
    const text = result.content?.[0]?.text || 'Geen resultaat ontvangen';

    // Simple Markdown → HTML conversion
    const html = markdownToHtml(text);

    body.innerHTML = `<div class="ai-plan-content">${html}</div>`;
    // Add action bar
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'ai-plan-actions';
    actionsDiv.innerHTML = `
      <button class="btn btn-secondary" onclick="copyAiPlan()"><i data-lucide="copy" style="width:12px;height:12px"></i> Kopieer</button>
      <button class="btn btn-secondary" onclick="generateAiPlan()"><i data-lucide="refresh-cw" style="width:12px;height:12px"></i> Opnieuw</button>
    `;
    body.parentElement.appendChild(actionsDiv);

    // Store in project
    if (project) { project.aiPlan = text; project.aiPlanDate = new Date().toISOString(); saveState(); }

  } catch(err) {
    const msg = err.message || 'Onbekende fout';
    body.innerHTML = `<div class="ai-plan-empty" style="color:var(--red)">
      <i data-lucide="alert-circle" style="width:32px;height:32px;opacity:0.5;margin-bottom:8px;display:block;margin-inline:auto"></i>
      ${msg.includes('401') || msg.includes('auth') ? 'AI service configuratiefout. Neem contact op met BOLD700.' :
        msg.includes('429') ? 'De AI is even druk bezet. Probeer het over een minuut opnieuw.' :
        msg.includes('fetch') || msg.includes('network') || msg.includes('Failed') ? 'Geen verbinding met de AI service. Controleer je internetverbinding en probeer opnieuw.' :
        'Er ging iets mis: ' + msg.substring(0, 60) + '. Probeer het opnieuw.'}
    </div>`;
    if (typeof lucide !== 'undefined') lucide.createIcons({nodes:[body]});
  }

  if (btn) { btn.disabled = false; btn.innerHTML = '<i data-lucide="sparkles"></i> Genereer Actieplan'; lucide.createIcons({nodes:[btn]}); }
}

function markdownToHtml(md) {
  let html = md
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    // Headers
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^# (.+)$/gm, '<h2>$1</h2>')
    // Bold + italic
    .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    // Blockquote
    .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
    // Lists
    .replace(/^- (.+)$/gm, '<li>$1</li>')
    .replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>');

  // Wrap consecutive <li> in <ul>
  html = html.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
  // Paragraphs (lines not already wrapped)
  html = html.split('\n').map(line => {
    const trimmed = line.trim();
    if (!trimmed) return '';
    if (trimmed.startsWith('<h') || trimmed.startsWith('<ul') || trimmed.startsWith('<li') ||
        trimmed.startsWith('<blockquote') || trimmed.startsWith('</')) return line;
    return `<p>${line}</p>`;
  }).join('\n');

  return html;
}

function copyAiPlan() {
  const project = getActiveProject();
  if (project?.aiPlan) {
    navigator.clipboard.writeText(project.aiPlan).then(() => {
      const btns = document.querySelectorAll('.ai-plan-actions button');
      if (btns[0]) { btns[0].innerHTML = '<i data-lucide="check" style="width:12px;height:12px"></i> Gekopieerd!'; lucide.createIcons({nodes:[btns[0]]}); setTimeout(() => { btns[0].innerHTML = '<i data-lucide="copy" style="width:12px;height:12px"></i> Kopieer'; lucide.createIcons({nodes:[btns[0]]}); }, 2000); }
    });
  }
}

// ═══════════════ CONTRAST CHECKER ═══════════════

function toggleContrastChecker() {
  document.getElementById('contrastPanel').classList.toggle('open');
  updateContrast();
}

// WCAG relative luminance calculation
function getLuminance(hex) {
  const r = parseInt(hex.slice(1,3), 16) / 255;
  const g = parseInt(hex.slice(3,5), 16) / 255;
  const b = parseInt(hex.slice(5,7), 16) / 255;
  const toLinear = c => c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
  return 0.2126 * toLinear(r) + 0.7152 * toLinear(g) + 0.0722 * toLinear(b);
}

function getContrastRatio(hex1, hex2) {
  const l1 = getLuminance(hex1);
  const l2 = getLuminance(hex2);
  const lighter = Math.max(l1, l2);
  const darker = Math.min(l1, l2);
  return (lighter + 0.05) / (darker + 0.05);
}

function updateContrast() {
  const fg = document.getElementById('ccFg').value;
  const bg = document.getElementById('ccBg').value;
  const ratio = getContrastRatio(fg, bg);

  // Preview
  const preview = document.getElementById('ccPreview');
  preview.style.color = fg;
  preview.style.background = bg;

  // Ratio display
  const ratioEl = document.getElementById('ccRatio');
  ratioEl.textContent = ratio.toFixed(2) + ':1';
  ratioEl.style.color = ratio >= 4.5 ? 'var(--green)' : ratio >= 3 ? 'var(--yellow)' : 'var(--red)';

  // WCAG results
  const check = (el, threshold) => {
    const pass = ratio >= threshold;
    el.innerHTML = pass ? '<i data-lucide="check" style="width:12px;height:12px"></i> Slaagt' : '<i data-lucide="x" style="width:12px;height:12px"></i> Faalt'; lucide.createIcons({nodes:[el]});
    el.className = 'cc-status ' + (pass ? 'pass' : 'fail');
  };
  check(document.getElementById('ccAAnorm'), 4.5);
  check(document.getElementById('ccAAlarge'), 3);
  check(document.getElementById('ccAAAnorm'), 7);
  check(document.getElementById('ccAAAlarge'), 4.5);
}

function syncColorText(colorId, textId) {
  document.getElementById(textId).value = document.getElementById(colorId).value.toUpperCase();
}

function syncColorPicker(textId, colorId) {
  let val = document.getElementById(textId).value;
  if (!val.startsWith('#')) val = '#' + val;
  if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
    document.getElementById(colorId).value = val;
  }
}

function swapColors() {
  const fg = document.getElementById('ccFg').value;
  const bg = document.getElementById('ccBg').value;
  document.getElementById('ccFg').value = bg;
  document.getElementById('ccBg').value = fg;
  document.getElementById('ccFgHex').value = bg.toUpperCase();
  document.getElementById('ccBgHex').value = fg.toUpperCase();
  updateContrast();
}

// ── Inline contrast checker (embedded in step) ──
function updateInlineCC() {
  const fgEl = document.getElementById('iccFg');
  const bgEl = document.getElementById('iccBg');
  if (!fgEl || !bgEl) return;
  const fg = fgEl.value;
  const bg = bgEl.value;
  const ratio = getContrastRatio(fg, bg);

  const preview = document.getElementById('iccPreview');
  if (preview) { preview.style.color = fg; preview.style.background = bg; }

  const ratioEl = document.getElementById('iccRatio');
  if (ratioEl) {
    ratioEl.textContent = ratio.toFixed(2) + ':1';
    ratioEl.style.color = ratio >= 4.5 ? 'var(--green)' : ratio >= 3 ? 'var(--yellow)' : 'var(--red)';
  }

  const check = (id, threshold) => {
    const el = document.getElementById(id);
    if (!el) return;
    const pass = ratio >= threshold;
    el.textContent = pass ? '✓' : '✗';
    el.style.color = pass ? 'var(--green)' : 'var(--red)';
  };
  check('iccAAnorm', 4.5);
  check('iccAAlarge', 3);
  check('iccAAAnorm', 7);
  check('iccAAAlarge', 4.5);
}

function swapInlineCC() {
  const fgEl = document.getElementById('iccFg');
  const bgEl = document.getElementById('iccBg');
  if (!fgEl || !bgEl) return;
  const fg = fgEl.value;
  const bg = bgEl.value;
  fgEl.value = bg; bgEl.value = fg;
  document.getElementById('iccFgHex').value = bg.toUpperCase();
  document.getElementById('iccBgHex').value = fg.toUpperCase();
  updateInlineCC();
}

function setContrastColors(fg, bg) {
  document.getElementById('ccFg').value = fg;
  document.getElementById('ccBg').value = bg;
  document.getElementById('ccFgHex').value = fg.toUpperCase();
  document.getElementById('ccBgHex').value = bg.toUpperCase();
  updateContrast();
}

// ═══════════════ INIT ═══════════════
function initLogos() {
  const logoMap = { dashLogo: '28px', npLogo: '36px', reviewLogo: '24px', landingLogo: '28px', authLogo: '36px' };
  for (const [id, size] of Object.entries(logoMap)) {
    const el = document.getElementById(id);
    if (el) el.innerHTML = brandLogo(size, id === 'authLogo' || id === 'dashLogo');
  }
}

// Main auth state listener — drives the entire app
auth.onAuthStateChanged(async (user) => {
  initLogos();
  if (typeof lucide !== 'undefined') lucide.createIcons();

  if (!user) {
    // Not logged in → show auth screen
    currentUser = null;
    userProfile = null;
    isAdmin = false;
    projects = [];
    showAuthScreen();
    return;
  }

  // User is logged in
  currentUser = user;
  document.body.style.cursor = 'wait';

  // Load user profile from Firestore
  try {
    const userDoc = await db.collection('users').doc(user.uid).get();
    if (userDoc.exists) {
      userProfile = userDoc.data();
      isAdmin = userProfile.role === 'admin';
    } else {
      // Profile doesn't exist yet (legacy user) — create it
      userProfile = { email: user.email, role: 'user', plan: 'free', createdAt: new Date().toISOString() };
      await db.collection('users').doc(user.uid).set(userProfile);
    }
  } catch(e) {
    console.warn('[Firebase] Could not load user profile:', e.message);
    userProfile = { role: 'user', plan: 'free' };
  }

  await loadState();
  document.body.style.cursor = '';

  // Hide auth screen
  document.getElementById('authScreen').classList.add('hidden');

  // URL routing
  if (urlProjectId && projects.find(p => p.id === urlProjectId)) {
    openProject(urlProjectId);
    return;
  }

  // Everyone goes to the dashboard
  if (isAdmin) console.log('[Admin] Alle', projects.length, 'projecten zichtbaar.');
  showDashboard();
});
</script>
</body>
</html>
